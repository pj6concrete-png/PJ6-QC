<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n + Mix Design + Trial Mixes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #06b6d4;
            --purple: #16a34a;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-content h1 {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .header-content p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .header-logo {
            max-width: 150px;
            max-height: 80px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-logo img {
            max-width: 100%;
            max-height: 60px;
        }

        .header-logo.empty {
            border: 2px dashed rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 12px;
            text-align: center;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .tab:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .card h2 {
            margin-bottom: 20px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h3 {
            margin-top: 25px;
            margin-bottom: 15px;
            color: var(--text);
            font-size: 1.2rem;
            border-bottom: 2px solid var(--border);
            padding-bottom: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-grid.cols-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .form-grid.cols-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .form-grid.cols-4 {
            grid-template-columns: repeat(4, 1fr);
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 500;
            margin-bottom: 5px;
            color: var(--text);
            font-size: 14px;
        }

        label small {
            color: var(--text-light);
            font-weight: 400;
            margin-left: 5px;
        }

        input, select, textarea {
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        input[readonly] {
            background: #f1f5f9;
            color: var(--text-light);
            cursor: not-allowed;
        }

        input.calculated {
            background: #fef3c7;
            font-weight: 600;
            color: #92400e;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        button {
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            font-size: 14px;
        }

        button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        button:disabled {
            background: var(--text-light);
            cursor: not-allowed;
            transform: none;
        }

        button.secondary {
            background: var(--secondary);
        }

        button.secondary:hover {
            background: #059669;
        }

        button.danger {
            background: var(--danger);
        }

        button.danger:hover {
            background: #dc2626;
        }

        button.warning {
            background: var(--warning);
        }

        button.info {
            background: var(--info);
        }

        button.purple {
            background: var(--purple);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th {
            background: var(--primary);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 500;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        tr:hover {
            background: var(--bg);
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        .actions button {
            padding: 6px 12px;
            font-size: 13px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin: 0 0 10px 0;
            border: none;
            padding: 0;
            color: white;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px;
            font-size: 15px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge.active {
            background: #dcfce7;
            color: #166534;
        }

        .badge.inactive {
            background: #fee2e2;
            color: #991b1b;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert.info {
            background: #dbeafe;
            color: #1e40af;
        }

        .alert.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .alert.success {
            background: #dcfce7;
            color: #166534;
        }

        .mix-design-preview {
            background: var(--bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .mix-design-preview h4 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .mix-design-preview .detail {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .mix-design-preview .detail:last-child {
            border-bottom: none;
        }

        .cylinders-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .cylinder-item {
            background: var(--bg);
            padding: 15px;
            border-radius: 8px;
            border: 2px solid var(--border);
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 15px;
            align-items: center;
        }

        .cylinder-item .number {
            background: var(--primary);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .cylinder-item .fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .cylinder-item button {
            padding: 8px 12px;
        }

        .trial-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 16px;
            background: linear-gradient(135deg, var(--purple) 0%, #16a34a 100%);
            color: white;
            margin-bottom: 10px;
        }

        .calendario-item {
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .calendario-item:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .calendario-item.vencido {
            border-color: var(--danger);
            background: #fef2f2;
        }

        .calendario-item.completado {
            border-color: var(--secondary);
            background: #f0fdf4;
        }

        .calendario-item.hoy {
            border-color: var(--warning);
            background: #fffbeb;
        }

        .calendario-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        .calendario-fecha {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary);
        }

        .calendario-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .calendario-status.pendiente {
            background: #fef3c7;
            color: #92400e;
        }

        .calendario-status.vencido {
            background: #fee2e2;
            color: #991b1b;
        }

        .calendario-status.completado {
            background: #dcfce7;
            color: #166534;
        }

        .calendario-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .calendario-detail {
            font-size: 14px;
        }

        .calendario-detail strong {
            color: var(--text);
        }

        @media print {
            .no-print {
                display: none !important;
            }
            
            .card {
                page-break-inside: avoid;
            }
        }

        @media (max-width: 768px) {
            .form-grid.cols-2,
            .form-grid.cols-3,
            .form-grid.cols-4 {
                grid-template-columns: 1fr;
            }

            .tabs {
                overflow-x: auto;
            }

            .cylinder-item {
                grid-template-columns: 1fr;
            }

            .cylinder-item .fields {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1>üèóÔ∏è Sistema de Gesti√≥n de Concreto</h1>
                <p>Mix Design Profesional + Trial Mixes</p>
            </div>
            <div class="header-logo empty" id="logo-container" onclick="document.getElementById('logo-upload').click()">
                <span>Click para subir logo</span>
            </div>
            <input type="file" id="logo-upload" accept="image/*" style="display: none;">
        </header>

        <!-- Tabs Navigation -->
        <div class="tabs no-print">
            <div class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</div>
            <div class="tab" onclick="switchTab('clientes')">üë• Clientes</div>
            <div class="tab" onclick="switchTab('proyectos')">üìÅ Proyectos</div>
            <div class="tab" onclick="switchTab('materiales')">üì¶ Materiales</div>
            <div class="tab" onclick="switchTab('cotizaciones')">üí∞ Cotizaciones</div>
            <div class="tab" onclick="switchTab('mixdesign')">üß™ Mix Design</div>
            <div class="tab" onclick="switchTab('trials')">üî¨ Trial Mixes</div>
            <div class="tab" onclick="switchTab('analisis')">üìà An√°lisis de Data</div>
            <div class="tab" onclick="switchTab('calendario')">üìÖ Calendario Roturas</div>
        </div>

        <!-- DASHBOARD -->
        <div id="tab-dashboard" class="tab-content active">
            <div class="stats">
                <div class="stat-card">
                    <h3>Clientes</h3>
                    <div class="number" id="stat-clientes">0</div>
                </div>
                <div class="stat-card">
                    <h3>Proyectos Activos</h3>
                    <div class="number" id="stat-proyectos">0</div>
                </div>
                <div class="stat-card">
                    <h3>Cotizaciones</h3>
                    <div class="number" id="stat-cotizaciones">0</div>
                </div>
                <div class="stat-card">
                    <h3>Mix Designs</h3>
                    <div class="number" id="stat-mixdesigns">0</div>
                </div>
                <div class="stat-card">
                    <h3>Trial Mixes</h3>
                    <div class="number" id="stat-trials">0</div>
                </div>
            </div>

            <div class="card">
                <h2>üí∞ Resumen de Cotizaciones</h2>
                <div id="dashboard-cotizaciones-summary"></div>
            </div>

            <div class="card">
                <h2>üíæ Gesti√≥n de Datos</h2>
                <div class="button-group">
                    <button type="button" class="success" onclick="exportarTodaLaData()">üì• Exportar Toda la Data</button>
                    <button type="button" class="info" onclick="document.getElementById('import-file').click()">üì§ Importar Data</button>
                    <input type="file" id="import-file" accept=".json" style="display:none" onchange="importarData(event)">
                </div>
                <p style="margin-top:15px;color:#666;font-size:14px">
                    <strong>Exportar:</strong> Descarga todos tus datos (clientes, proyectos, materiales, mix designs, trials) en formato JSON.<br>
                    <strong>Importar:</strong> Restaura datos desde un archivo JSON exportado previamente.
                </p>
            </div>

            <div class="card">
                <h2>üìã Mix Designs Recientes</h2>
                <div id="recent-mixdesigns"></div>
            </div>

            <div class="card">
                <h2>üî¨ Trial Mixes Recientes</h2>
                <div id="recent-trials"></div>
            </div>
        </div>

        <!-- CLIENTES -->
        <div id="tab-clientes" class="tab-content">
            <div class="card">
                <h2>‚ûï Nuevo Cliente</h2>
                <form id="form-cliente">
                    <input type="hidden" id="edit-cliente-id">
                    <div class="form-grid cols-2">
                        <div class="form-group">
                            <label>Nombre *</label>
                            <input type="text" id="cliente-nombre" required>
                        </div>
                        <div class="form-group">
                            <label>Empresa</label>
                            <input type="text" id="cliente-empresa">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="cliente-email">
                        </div>
                        <div class="form-group">
                            <label>Tel√©fono</label>
                            <input type="tel" id="cliente-telefono">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notas</label>
                        <textarea id="cliente-notas"></textarea>
                    </div>
                    <div class="button-group">
                        <button type="submit">üíæ Guardar Cliente</button>
                        <button type="button" class="secondary" onclick="clearForm('cliente')">üîÑ Limpiar</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h2>üìã Lista de Clientes</h2>
                <div class="search-box">
                    <input type="text" id="search-clientes" placeholder="üîç Buscar cliente..." onkeyup="filterClientes()">
                </div>
                <div id="lista-clientes"></div>
            </div>
        </div>

        <!-- PROYECTOS -->
        <div id="tab-proyectos" class="tab-content">
            <div class="card">
                <h2>‚ûï Nuevo Proyecto</h2>
                <form id="form-proyecto">
                    <input type="hidden" id="edit-proyecto-id">
                    <div class="form-grid cols-2">
                        <div class="form-group">
                            <label>Nombre del Proyecto *</label>
                            <input type="text" id="proyecto-nombre" required>
                        </div>
                        <div class="form-group">
                            <label>Cliente</label>
                            <select id="proyecto-cliente">
                                <option value="">Seleccionar...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ubicaci√≥n</label>
                            <input type="text" id="proyecto-ubicacion">
                        </div>
                        <div class="form-group">
                            <label>Estado</label>
                            <select id="proyecto-estado">
                                <option value="active">Activo</option>
                                <option value="completed">Completado</option>
                                <option value="on-hold">En Espera</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Descripci√≥n</label>
                        <textarea id="proyecto-descripcion"></textarea>
                    </div>
                    <div class="button-group">
                        <button type="submit">üíæ Guardar Proyecto</button>
                        <button type="button" class="secondary" onclick="clearForm('proyecto')">üîÑ Limpiar</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h2>üìã Lista de Proyectos</h2>
                <div class="search-box">
                    <input type="text" id="search-proyectos" placeholder="üîç Buscar proyecto..." onkeyup="filterProyectos()">
                </div>
                <div id="lista-proyectos"></div>
            </div>
        </div>

        <!-- MATERIALES -->
        <div id="tab-materiales" class="tab-content">
            <div class="card">
                <h2>‚ûï Nuevo Material</h2>
                <form id="form-material">
                    <input type="hidden" id="edit-material-id">
                    <div class="form-grid cols-3">
                        <div class="form-group">
                            <label>Nombre *</label>
                            <input type="text" id="material-nombre" required>
                        </div>
                        <div class="form-group">
                            <label>Categor√≠a *</label>
                            <select id="material-categoria" required>
                                <option value="">Seleccionar...</option>
                                <option value="cemento">Cemento</option>
                                <option value="agregados">Agregados</option>
                                <option value="aditivos">Aditivos</option>
                                <option value="agua">Agua</option>
                                <option value="otros">Otros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Unidad</label>
                            <select id="material-unidad">
                                <option value="kg">Kilogramos (kg)</option>
                                <option value="lb">Libras (lb)</option>
                                <option value="ton">Toneladas</option>
                                <option value="gal">Galones</option>
                                <option value="L">Litros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Cantidad en Inventario</label>
                            <input type="number" id="material-cantidad" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label>Precio Unitario ($)</label>
                            <input type="number" id="material-precio" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label>Proveedor</label>
                            <input type="text" id="material-proveedor">
                        </div>
                    </div>
                    <div class="button-group">
                        <button type="submit">üíæ Guardar Material</button>
                        <button type="button" class="secondary" onclick="clearForm('material')">üîÑ Limpiar</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h2>üìã Inventario de Materiales</h2>
                <div class="search-box">
                    <input type="text" id="search-materiales" placeholder="üîç Buscar material..." onkeyup="filterMateriales()">
                </div>
                <div id="lista-materiales"></div>
            </div>
        </div>

        <!-- SECCI√ìN: COTIZACIONES -->
        <div id="tab-cotizaciones" class="tab-content">
            <div class="card">
                <h2>üí∞ Nueva Cotizaci√≥n</h2>
                <form id="form-cotizacion">
                    <input type="hidden" id="edit-cotizacion-id">
                    
                    <div class="alert info">
                        <span>‚ÑπÔ∏è</span>
                        <span>Complete la informaci√≥n del cliente y agregue las l√≠neas de cotizaci√≥n</span>
                    </div>

                    <h3>üìã Informaci√≥n del Cliente</h3>
                    <div class="form-grid cols-3">
                        <div class="form-group">
                            <label>N√∫mero de Cotizaci√≥n</label>
                            <input type="text" id="cotizacion-numero" readonly class="calculated">
                        </div>
                        <div class="form-group">
                            <label>Fecha *</label>
                            <input type="date" id="cotizacion-fecha" required>
                        </div>
                        <div class="form-group">
                            <label>V√°lida hasta</label>
                            <input type="date" id="cotizacion-valida-hasta">
                        </div>
                    </div>

                    <div class="form-grid cols-4">
                        <div class="form-group">
                            <label>Status *</label>
                            <select id="cotizacion-status" required>
                                <option value="Pendiente">‚è≥ Pendiente</option>
                                <option value="Aprobada">‚úÖ Aprobada</option>
                                <option value="Rechazada">‚ùå Rechazada</option>
                                <option value="En Revisi√≥n">üëÅÔ∏è En Revisi√≥n</option>
                                <option value="Cancelada">üö´ Cancelada</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Nombre del Cliente *</label>
                            <input type="text" id="cotizacion-cliente-nombre" required placeholder="Ej: Juan P√©rez">
                        </div>
                        <div class="form-group">
                            <label>Tel√©fono</label>
                            <input type="tel" id="cotizacion-cliente-tel" placeholder="787-123-4567">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="cotizacion-cliente-email" placeholder="cliente@email.com">
                        </div>
                    </div>

                    <div class="form-grid cols-2">
                        <div class="form-group">
                            <label>Nombre del Proyecto *</label>
                            <input type="text" id="cotizacion-proyecto" required placeholder="Ej: Construcci√≥n Edificio XYZ">
                        </div>
                        <div class="form-group">
                            <label>Ubicaci√≥n del Proyecto</label>
                            <input type="text" id="cotizacion-ubicacion" placeholder="Ej: San Juan, PR">
                        </div>
                    </div>

                    <h3>üìù L√≠neas de Cotizaci√≥n</h3>
                    <div style="margin-bottom: 15px;">
                        <button type="button" class="btn success" onclick="agregarLineaCotizacion()">‚ûï Agregar L√≠nea</button>
                    </div>

                    <table id="tabla-cotizacion-lineas">
                        <thead>
                            <tr>
                                <th style="width: 50%">Descripci√≥n</th>
                                <th style="width: 15%">Cantidad (yd¬≥)</th>
                                <th style="width: 20%">Precio Unitario</th>
                                <th style="width: 15%">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="cotizacion-lineas-body">
                            <!-- Las l√≠neas se agregan din√°micamente -->
                        </tbody>
                        <tfoot>
                            <tr style="background: #e0f2fe; font-weight: bold;">
                                <td style="text-align: right; padding: 12px;">TOTAL YD¬≥:</td>
                                <td id="cotizacion-total-yd" style="font-size: 18px; color: #0369a1;">0.00 yd¬≥</td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>

                    <h3>üìÑ Notas y Condiciones</h3>
                    <div class="form-group">
                        <label>Notas Adicionales</label>
                        <textarea id="cotizacion-notas" rows="3" placeholder="Informaci√≥n adicional, t√©rminos, condiciones de pago, tiempo de entrega, etc."></textarea>
                    </div>

                    <div class="button-group">
                        <button type="button" class="secondary" onclick="nuevaCotizacion()">‚ûï Nueva Cotizaci√≥n</button>
                        <button type="submit" class="primary">üíæ Guardar Cotizaci√≥n</button>
                        <button type="button" class="success" id="btn-imprimir-cotizacion" onclick="imprimirCotizacion()" disabled>üñ®Ô∏è Imprimir</button>
                        <button type="button" class="secondary" onclick="limpiarFormularioCotizacion()">üîÑ Limpiar</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h2>üìã Cotizaciones Guardadas</h2>
                <div class="search-box">
                    <input type="text" id="search-cotizaciones" placeholder="üîç Buscar cotizaci√≥n..." onkeyup="filterCotizaciones()">
                </div>
                <div id="lista-cotizaciones"></div>
            </div>
        </div>

        <!-- MIX DESIGN (contenido original mantenido) -->
        <div id="tab-mixdesign" class="tab-content">
            <div class="card">
                <h2>üß™ Nuevo Mix Design</h2>
                <form id="form-mixdesign">
                    <input type="hidden" id="edit-mixdesign-id">
                    
                    <h3>üìã Informaci√≥n General</h3>
                    <div class="form-grid cols-3">
                        <div class="form-group">
                        <label>Logo de la Empresa (opcional)</label>
                        <input type="file" id="mix-logo" accept="image/*" onchange="cargarLogo()">
                        <small style="color:#666;display:block;margin-top:5px">Sube tu logo para que aparezca en el reporte</small>
                        <img id="logo-preview" style="max-width:200px;max-height:80px;margin-top:10px;display:none;border:1px solid #ddd;padding:5px;border-radius:4px">
                    </div>
                    
                    <div class="form-group">
                            <label>Mix ID</label>
                            <input type="text" id="mix-id-display" readonly class="calculated">
                        </div>
                        <div class="form-group">
                            <label>Nombre del Mix *</label>
                            <input type="text" id="mix-nombre" required>
                        </div>
                        <div class="form-group">
                            <label>Fecha</label>
                            <input type="date" id="mix-fecha" required>
                        </div>
                        <div class="form-group">
                        <label>Cliente</label>
                        <div style="display:flex;gap:10px">
                            <select id="mix-cliente" onchange="filtrarProyectosPorCliente()" style="flex:1">
                                <option value="">Seleccione cliente...</option>
                            </select>
                            <button type="button" class="btn success" onclick="nuevoClienteRapido()" style="padding:8px 15px;margin:0" title="Nuevo Cliente">‚ûï</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Proyecto Asociado</label>
                        <div style="display:flex;gap:10px">
                            <select id="mix-proyecto" style="flex:1">
                                <option value="">Sin proyecto</option>
                            </select>
                            <button type="button" class="btn success" onclick="nuevoProyectoRapido()" style="padding:8px 15px;margin:0" title="Nuevo Proyecto">‚ûï</button>
                        </div>
                    </div>
                    </div>

                    <h3>üéØ Especificaciones de Dise√±o</h3>
                    <div class="form-grid cols-4">
                        <div class="form-group">
                            <label>Resistencia (PSI) *</label>
                            <input type="number" id="mix-resistencia" required value="3000">
                        </div>
                        <div class="form-group">
                            <label>Slump (in) *</label>
                            <input type="number" id="mix-slump" step="0.5" required value="4">
                        </div>
                        <div class="form-group">
                            <label>Tama√±o M√°x. Agregado (in)</label>
                            <input type="number" id="mix-tma" step="0.25" value="0.75">
                        </div>
                        <div class="form-group">
                            <label>% Aire *</label>
                            <input type="number" id="mix-aire" step="0.1" required value="2.0">
                        </div>
                        <div class="form-group">
                            <label>Aplicaci√≥n</label>
                            <input type="text" id="mix-aplicacion" list="aplicaciones-list" placeholder="Seleccionar o escribir...">
                            <datalist id="aplicaciones-list">
                                <option value="Pavimento">
                                <option value="Columnas">
                                <option value="Vigas">
                                <option value="Losas">
                                <option value="Muros">
                                <option value="Cimentaci√≥n">
                                <option value="Prefabricados">
                                <option value="Arquitect√≥nico">
                                <option value="Estructural">
                            </datalist>
                        </div>
                    </div>

                    <h3>üèóÔ∏è Cemento - Propiedades y Peso</h3>
                    <div class="form-grid cols-4">
                        <div class="form-group">
                            <label>Tipo de Cemento</label>
                            <select id="tipo-cemento">
                                <option value="Tipo I">Tipo I - Normal</option>
                                <option value="Tipo II">Tipo II - Moderado</option>
                                <option value="Tipo III">Tipo III - Alta Resistencia</option>
                                <option value="Tipo IV">Tipo IV - Bajo Calor</option>
                                <option value="Tipo V">Tipo V - Sulfato Resistente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Peso de Cemento (lb/yd¬≥) *</label>
                            <input type="number" id="peso-cemento" step="0.1" value="564" required>
                        </div>
                        <div class="form-group">
                            <label>Gravedad Espec√≠fica</label>
                            <input type="number" id="ge-cemento" step="0.01" value="3.15">
                        </div>
                        <div class="form-group">
                            <label>Precio ($/saco 94lb)</label>
                            <input type="number" id="precio-cemento" step="0.01" value="8.50">
                        </div>
                    </div>

                    <h3>üíß Agua</h3>
                    <div class="form-grid cols-3">
                        <div class="form-group">
                            <label>Peso de Agua (lb/yd¬≥) *</label>
                            <input type="number" id="peso-agua" step="0.1" value="310" required>
                        </div>
                        <div class="form-group">
                            <label>Relaci√≥n W/C <small>(calculada)</small></label>
                            <input type="number" id="wc-ratio" step="0.01" readonly class="calculated">
                        </div>
                        <div class="form-group">
                            <label>Precio Agua ($/gal)</label>
                            <input type="number" id="precio-agua" step="0.01" value="0.05">
                        </div>
                    </div>

                    <h3>ü™® Agregado Grueso - Propiedades y Peso</h3>
                    <div class="form-grid cols-4">
                        <div class="form-group">
                            <label>Peso Agregado Grueso (lb/yd¬≥) *</label>
                            <input type="number" id="peso-grueso" step="0.1" value="1800" required>
                        </div>
                        <div class="form-group">
                            <label>Gravedad Espec√≠fica (Bulk SSD)</label>
                            <input type="number" id="ge-grueso" step="0.01" value="2.65">
                        </div>
                        <div class="form-group">
                            <label>Absorci√≥n (%)</label>
                            <input type="number" id="abs-grueso" step="0.01" value="1.5">
                        </div>
                        <div class="form-group">
                            <label>Humedad (%)</label>
                            <input type="number" id="hum-grueso" step="0.01" value="0.5">
                        </div>
                    </div>
                    <div class="form-grid cols-2">
                        <div class="form-group">
                            <label>Precio ($/ton)</label>
                            <input type="number" id="precio-grueso" step="0.01" value="15.00">
                        </div>
                        <div class="form-group">
                            <label>Peso Unitario Compactado (lb/ft¬≥)</label>
                            <input type="number" id="puc-grueso" step="0.1" value="105">
                        </div>
                    </div>

                    <h3>üî∑ Agregado Intermedio - Propiedades y Peso</h3>
                    <div class="form-grid cols-4">
                        <div class="form-group">
                            <label>Peso Agregado Intermedio (lb/yd¬≥) *</label>
                            <input type="number" id="peso-intermedio" step="0.1" value="0" required>
                        </div>
                        <div class="form-group">
                            <label>Gravedad Espec√≠fica (Bulk SSD)</label>
                            <input type="number" id="ge-intermedio" step="0.01" value="2.62">
                        </div>
                        <div class="form-group">
                            <label>Absorci√≥n (%)</label>
                            <input type="number" id="abs-intermedio" step="0.01" value="1.8">
                        </div>
                        <div class="form-group">
                            <label>Humedad (%)</label>
                            <input type="number" id="hum-intermedio" step="0.01" value="1.0">
                        </div>
                    </div>
                    <div class="form-grid cols-2">
                        <div class="form-group">
                            <label>Precio ($/ton)</label>
                            <input type="number" id="precio-intermedio" step="0.01" value="12.00">
                        </div>
                        <div class="form-group">
                            <label>Peso Unitario Compactado (lb/ft¬≥)</label>
                            <input type="number" id="puc-intermedio" step="0.1" value="100">
                        </div>
                    </div>

                    <h3>üèñÔ∏è Agregado Fino (Arenas) - Calculadas por Diferencia de Volumen</h3>
                    
                    <div class="alert info">
                        <span>‚ÑπÔ∏è</span>
                        <div>
                            <strong>Las arenas se calculan autom√°ticamente</strong> como la diferencia entre el volumen total (27 ft¬≥) 
                            menos los vol√∫menes de: cemento, agua, aire, agregado grueso, agregado intermedio y aditivos.
                        </div>
                    </div>
                    
                    <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <strong>Arena 1:</strong>
                    </div>
                    <div class="form-grid cols-4">
                        <div class="form-group">
                            <label>Gravedad Espec√≠fica (Bulk SSD)</label>
                            <input type="number" id="ge-arena1" step="0.01" value="2.60">
                        </div>
                        <div class="form-group">
                            <label>Absorci√≥n (%)</label>
                            <input type="number" id="abs-arena1" step="0.01" value="2.0">
                        </div>
                        <div class="form-group">
                            <label>Humedad (%)</label>
                            <input type="number" id="hum-arena1" step="0.01" value="3.0">
                        </div>
                        <div class="form-group">
                            <label>M√≥dulo de Finura</label>
                            <input type="number" id="mf-arena1" step="0.01" value="2.80">
                        </div>
                    </div>
                    <div class="form-grid cols-2">
                        <div class="form-group">
                            <label>Precio ($/ton)</label>
                            <input type="number" id="precio-arena1" step="0.01" value="12.00">
                        </div>
                        <div class="form-group">
                            <label>% en Mezcla de Arenas</label>
                            <input type="number" id="pct-arena1" step="1" value="60" min="0" max="100" oninput="ajustarPorcentajesArenas(1)">
                        </div>
                    </div>

                    <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 15px; margin-top: 20px;">
                        <strong>Arena 2:</strong>
                    </div>
                    <div class="form-grid cols-4">
                        <div class="form-group">
                            <label>Gravedad Espec√≠fica (Bulk SSD)</label>
                            <input type="number" id="ge-arena2" step="0.01" value="2.58">
                        </div>
                        <div class="form-group">
                            <label>Absorci√≥n (%)</label>
                            <input type="number" id="abs-arena2" step="0.01" value="2.5">
                        </div>
                        <div class="form-group">
                            <label>Humedad (%)</label>
                            <input type="number" id="hum-arena2" step="0.01" value="4.0">
                        </div>
                        <div class="form-group">
                            <label>M√≥dulo de Finura</label>
                            <input type="number" id="mf-arena2" step="0.01" value="3.20">
                        </div>
                    </div>
                    <div class="form-grid cols-2">
                        <div class="form-group">
                            <label>Precio ($/ton)</label>
                            <input type="number" id="precio-arena2" step="0.01" value="10.00">
                        </div>
                        <div class="form-group">
                            <label>% en Mezcla de Arenas</label>
                            <input type="number" id="pct-arena2" step="1" value="40" min="0" max="100" oninput="ajustarPorcentajesArenas(2)">
                        </div>
                    </div>

                    <div class="alert info">
                        <span>‚ÑπÔ∏è</span>
                        <div>
                            <strong>M√≥dulo de Finura Combinado:</strong> <span id="mf-combinado">3.04</span><br>
                            <small>Se calcula autom√°ticamente seg√∫n los porcentajes de cada arena</small>
                        </div>
                    </div>

                    <h3>üå¨Ô∏è Contenido de Aire</h3>
                    <div class="form-grid cols-2">
                        <div class="form-group">
                            <label>Contenido de Aire (%)</label>
                            <input type="number" id="contenido-aire" step="0.1" value="2.0">
                        </div>
                        <div class="form-group">
                            <label>Volumen de Aire <small>(calculado)</small></label>
                            <input type="number" id="volumen-aire" step="0.01" readonly class="calculated">
                        </div>
                    </div>

                    <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <strong>Aditivo 1:</strong>
                    </div>
                    <div class="form-grid cols-4">
                        <div class="form-group">
                            <label>Nombre Aditivo</label>
                            <select id="nombre-aditivo1">
                                <option value="">Ninguno</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Dosis (oz/cwt)</label>
                            <input type="number" id="dosis-aditivo1" step="0.1" value="0">
                        </div>
                        <div class="form-group">
                            <label>Gravedad Espec√≠fica</label>
                            <input type="number" id="ge-aditivo1" step="0.01" value="1.0">
                        </div>
                        <div class="form-group">
                            <label>Precio ($/gal)</label>
                            <input type="number" id="precio-aditivo1" step="0.01" value="0">
                        </div>
                    </div>

                    <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <strong>Aditivo 2:</strong>
                    </div>
                    <div class="form-grid cols-4">
                        <div class="form-group">
                            <label>Nombre Aditivo</label>
                            <select id="nombre-aditivo2">
                                <option value="">Ninguno</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Dosis (oz/cwt)</label>
                            <input type="number" id="dosis-aditivo2" step="0.1" value="0">
                        </div>
                        <div class="form-group">
                            <label>Gravedad Espec√≠fica</label>
                            <input type="number" id="ge-aditivo2" step="0.01" value="1.0">
                        </div>
                        <div class="form-group">
                            <label>Precio ($/gal)</label>
                            <input type="number" id="precio-aditivo2" step="0.01" value="0">
                        </div>
                    </div>

                    <div style="background: #f3e8ff; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <strong>Aditivo 3:</strong>
                    </div>
                    <div class="form-grid cols-4">
                        <div class="form-group">
                            <label>Nombre Aditivo</label>
                            <select id="nombre-aditivo3">
                                <option value="">Ninguno</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Dosis (oz/cwt)</label>
                            <input type="number" id="dosis-aditivo3" step="0.1" value="0">
                        </div>
                        <div class="form-group">
                            <label>Gravedad Espec√≠fica</label>
                            <input type="number" id="ge-aditivo3" step="0.01" value="1.0">
                        </div>
                        <div class="form-group">
                            <label>Precio ($/gal)</label>
                            <input type="number" id="precio-aditivo3" step="0.01" value="0">
                        </div>
                    </div>

                    <div class="button-group">
                        <button type="button" class="secondary" onclick="nuevoMixDesign()">‚ûï Nuevo Mix Design</button>
                        <button type="button" class="warning" onclick="calcularVolumenes()">üßÆ Calcular Vol√∫menes</button>
                        <button type="submit" id="btn-mixdesign" disabled>üíæ Guardar Mix Design</button>
                        <button type="button" class="info" id="btn-reporte" onclick="generarReporteMixDesign()" disabled>üìÑ Generar Reporte (Ventana)</button>
                        <button type="button" class="success" id="btn-reporte-download" onclick="descargarReporteMixDesign()" disabled>üíæ Descargar Reporte</button>
                        <button type="button" class="warning" id="btn-reporte-costos" onclick="generarReporteCostosMix()" disabled>üí∞ Reporte de Costos</button>
                        <button type="button" class="success" onclick="generarReportePrueba()">üß™ Probar Reporte</button>
                        <button type="button" class="secondary" onclick="clearForm('mixdesign')">üîÑ Limpiar</button>
                    </div>
                </form>
            </div>

            <!-- Resultados del C√°lculo -->
            <div class="card" id="mix-results" style="display: none;">
                <h2>üìä Resultados del Mix Design</h2>
                
                <div class="alert success">
                    <span>‚úÖ</span>
                    <span>C√°lculo completado exitosamente</span>
                </div>

                <h3>üéØ Cantidades por Yarda C√∫bica</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Material</th>
                            <th>Peso (lb/yd¬≥)</th>
                            <th>Volumen (ft¬≥)</th>
                            <th>Costo ($/yd¬≥)</th>
                        </tr>
                    </thead>
                    <tbody id="resultados-cantidades"></tbody>
                </table>

                <h3>üìà Resumen del Mix Design</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Par√°metro</th>
                            <th>Valor</th>
                        </tr>
                    </thead>
                    <tbody id="resultados-resumen"></tbody>
                </table>

                <h3>üí∞ An√°lisis de Costos</h3>
                <div id="resultados-costos"></div>
            </div>

            <div class="card">
                <h2>üìã Mix Designs Guardados</h2>
                <div class="search-box">
                    <input type="text" id="search-mixdesigns" placeholder="üîç Buscar mix design..." onkeyup="filterMixDesigns()">
                </div>
                <div class="button-group" style="margin-bottom:15px">
                    <button type="button" class="info" onclick="seleccionarTodosMixDesigns()">‚òëÔ∏è Seleccionar Todos</button>
                    <button type="button" class="secondary" onclick="deseleccionarTodosMixDesigns()">‚òê Deseleccionar Todos</button>
                    <button type="button" class="success" id="btn-generar-pdf-multiple" onclick="generarPDFMultiple()" disabled>üìÑ Generar PDF con Seleccionados (<span id="count-selected">0</span>)</button>
                    <button type="button" class="warning" id="btn-generar-costos-multiple" onclick="generarReportesCostosMultiple()" disabled>üí∞ Reportes de Costos (<span id="count-selected-costos">0</span>)</button>
                </div>
                <div id="lista-mixdesigns"></div>
            </div>
        </div>

        <!-- NUEVA SECCI√ìN: TRIAL MIXES -->
        <div id="tab-trials" class="tab-content">
            <div class="card">
                <h2>üî¨ Nuevo Trial Mix</h2>
                <form id="form-trial">
                    <input type="hidden" id="edit-trial-id">
                    
                    <div class="alert info">
                        <span>‚ÑπÔ∏è</span>
                        <span>Selecciona un Mix Design base y registra los resultados del trial batch</span>
                    </div>

                    <h3>üìã Informaci√≥n del Trial</h3>
                    <div class="form-grid cols-3">
                        <div class="form-group">
                            <label>Trial Mix ID</label>
                            <input type="text" id="trial-id-display" readonly class="calculated">
                        </div>
                        <div class="form-group">
                            <label>Fecha del Trial *</label>
                            <input type="date" id="trial-fecha" required>
                        </div>
                        <div class="form-group">
                            <label>Hora del Trial</label>
                            <input type="time" id="trial-hora">
                        </div>
                    </div>

                    <div class="form-grid cols-2">
                        <div class="form-group">
                            <label>Seleccionar Mix Design Base *</label>
                            <select id="trial-mixdesign" required onchange="cargarInfoMixDesign()">
                                <option value="">Seleccionar...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tama√±o del Trial Batch (ft¬≥) *</label>
                            <select id="trial-tamano" required onchange="calcularCantidadesTrial()">
                                <option value="">Seleccionar...</option>
                                <option value="1">1 ft¬≥</option>
                                <option value="2">2 ft¬≥</option>
                                <option value="3">3 ft¬≥</option>
                                <option value="4">4 ft¬≥</option>
                                <option value="5">5 ft¬≥</option>
                                <option value="6.75">1/4 yd¬≥ (6.75 ft¬≥)</option>
                                <option value="13.5">1/2 yd¬≥ (13.5 ft¬≥)</option>
                                <option value="27">1 yd¬≥ (27 ft¬≥)</option>
                                <option value="custom">Tama√±o personalizado</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" id="trial-tamano-custom-group" style="display: none;">
                        <label>Tama√±o Personalizado (ft¬≥)</label>
                        <input type="number" id="trial-tamano-custom" step="0.01" min="0.1" onchange="calcularCantidadesTrial()">
                    </div>

                    <!-- Preview del Mix Design seleccionado -->
                    <div id="mix-design-preview" class="mix-design-preview" style="display: none;">
                        <h4>üìä Mix Design Seleccionado</h4>
                        <div class="detail">
                            <span><strong>Nombre:</strong></span>
                            <span id="preview-nombre">-</span>
                        </div>
                        <div class="detail">
                            <span><strong>Resistencia:</strong></span>
                            <span id="preview-resistencia">-</span>
                        </div>
                        <div class="detail">
                            <span><strong>W/C Ratio:</strong></span>
                            <span id="preview-wc">-</span>
                        </div>
                        <div class="detail">
                            <span><strong>Slump Objetivo:</strong></span>
                            <span id="preview-slump">-</span>
                        </div>
                    </div>

                    <!-- Cantidades calculadas para el trial -->
                    <div id="trial-cantidades" style="display: none;">
                        <h3>‚öñÔ∏è Cantidades para el Trial Batch</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Material</th>
                                    <th>Cantidad (lb)</th>
                                </tr>
                            </thead>
                            <tbody id="trial-cantidades-tabla"></tbody>
                        </table>
                    </div>

                    <h3>üß™ Resultados del Trial - Propiedades del Concreto Fresco</h3>
                    <div class="form-grid cols-4">
                        <div class="form-group">
                            <label>Slump Obtenido (in)</label>
                            <input type="number" id="trial-slump" step="0.25" placeholder="ej: 4.5">
                        </div>
                        <div class="form-group">
                            <label>Temperatura (¬∞F)</label>
                            <input type="number" id="trial-temperatura" step="0.1" placeholder="ej: 72.5">
                        </div>
                        <div class="form-group">
                            <label>Contenido de Aire (%)</label>
                            <input type="number" id="trial-aire" step="0.1" placeholder="ej: 2.5">
                        </div>
                        <div class="form-group">
                            <label>Peso Unitario (lb/ft¬≥)</label>
                            <input type="number" id="trial-peso-unitario" step="0.1" placeholder="ej: 145.2">
                        </div>
                    </div>

                    <h3>üèóÔ∏è Informaci√≥n de Cilindros</h3>
                    <div class="form-group">
                        <label>N√∫mero de Cilindros</label>
                        <input type="number" id="trial-num-cilindros" min="0" max="20" value="6" onchange="generarCamposCilindros()">
                    </div>

                    <div id="cilindros-container" class="cylinders-list"></div>

                    <h3>üìù Observaciones y Notas</h3>
                    <div class="form-group">
                        <label>Observaciones del Trial</label>
                        <textarea id="trial-observaciones" rows="4" placeholder="Ej: Buena trabajabilidad, sin segregaci√≥n, tiempo de mezclado 3 minutos..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>T√©cnico Responsable</label>
                        <input type="text" id="trial-tecnico" placeholder="Nombre del t√©cnico">
                    </div>

                    <div class="button-group">
                        <button type="submit">üíæ Guardar Trial Mix</button>
                        <button type="button" class="success" onclick="nuevoTrialMix()">‚ûï Nuevo Trial Mix</button>
                        <button type="button" class="info" id="btn-reporte-trial" onclick="generarReporteTrial()" disabled>üìÑ Generar Reporte</button>
                        <button type="button" class="purple" id="btn-qr-trial" onclick="generarQRTrial()" disabled>üì± Generar QR Code</button>
                        <button type="button" class="secondary" onclick="clearForm('trial')">üîÑ Limpiar</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h2>üìã Trial Mixes Registrados</h2>
                <div class="search-box">
                    <input type="text" id="search-trials" placeholder="üîç Buscar trial mix..." onkeyup="filterTrials()">
                </div>
                <div id="lista-trials"></div>
            </div>
        </div>

        <!-- SECCI√ìN: AN√ÅLISIS DE DATA -->
        <div id="tab-analisis" class="tab-content">
            <div class="card">
                <h2>üìà An√°lisis de Resistencia de Concreto</h2>
                
                <div class="alert info">
                    <span>‚ÑπÔ∏è</span>
                    <span>An√°lisis estad√≠stico de los resultados de Trial Mixes. Los gr√°ficos se generan autom√°ticamente con los datos de cilindros rotos.</span>
                </div>

                <!-- Controles y Filtros -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <div class="form-grid cols-3">
                        <div class="form-group">
                            <label>Seleccionar Trial Mixes</label>
                            <div style="position: relative;">
                                <button type="button" class="secondary" onclick="toggleAnalisisMixFilter()" style="width: 100%; text-align: left; display: flex; justify-content: space-between; align-items: center;">
                                    <span id="analisis-filter-label">Todas las mezclas</span>
                                    <span>‚ñº</span>
                                </button>
                                <div id="analisis-mix-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; margin-top: 5px; max-height: 300px; overflow-y: auto; z-index: 10; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                    <div style="padding: 10px; border-bottom: 1px solid #eee;">
                                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 5px;">
                                            <input type="checkbox" value="all" checked onchange="handleAnalisisMixFilterChange(this)">
                                            <strong>Seleccionar Todas</strong>
                                        </label>
                                    </div>
                                    <div id="analisis-mix-checkboxes" style="padding: 10px;"></div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Tipo de Vista</label>
                            <select id="analisis-view-type" onchange="updateAnalisisCharts()">
                                <option value="evolution">Evoluci√≥n de Resistencia</option>
                                <option value="efficiency">% de Resistencia (f'c)</option>
                                <option value="comparison">Comparaci√≥n entre Mezclas</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Acciones</label>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button type="button" class="success" onclick="updateAnalisisCharts()" style="flex: 1;">üîÑ Actualizar</button>
                                <button type="button" class="info" onclick="exportarAnalisisPDF()" style="flex: 1;">üìÑ Exportar PDF</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>An√°lisis Inteligente</label>
                            <button type="button" onclick="abrirAnalisisIA()" style="width: 100%; padding: 12px 20px; background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 12px rgba(124,58,237,0.4); transition: all 0.2s;">
                                ü§ñ Analizar con IA
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Estad√≠sticas Resumen -->
                <div id="analisis-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;"></div>

                <!-- Gr√°fico Principal -->
                <div style="background: white; padding: 25px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 20px; color: #16a34a;">üìä Gr√°fico de An√°lisis</h3>
                    <div style="position: relative; height: 500px;">
                        <canvas id="analisis-chart-main"></canvas>
                    </div>
                </div>

                <!-- Tabla de Datos Detallados -->
                <div class="card">
                    <h3>üìã Datos Detallados por Trial Mix</h3>
                    <div id="analisis-table-container"></div>
                </div>
            </div>
        </div>

        <!-- CALENDARIO DE ROTURAS -->
        <div id="tab-calendario" class="tab-content">
            <div class="card">
                <h2>üìÖ Calendario de Roturas de Cilindros</h2>
                
                <div class="alert info">
                    <span>‚ÑπÔ∏è</span>
                    <div>
                        <strong>Calendario de Ensayos Programados</strong><br>
                        Vista de todos los cilindros pendientes y programados para ensayo. Los ensayos vencidos aparecen en rojo.
                    </div>
                </div>

                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <div class="form-group" style="flex: 1;">
                        <label>Filtrar por mes</label>
                        <input type="month" id="filtro-mes-calendario" onchange="cargarCalendario()">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Filtrar por estado</label>
                        <select id="filtro-estado-calendario" onchange="cargarCalendario()">
                            <option value="todos">Todos</option>
                            <option value="pendientes">Solo Pendientes</option>
                            <option value="completados">Solo Completados</option>
                            <option value="vencidos">Solo Vencidos</option>
                        </select>
                    </div>
                </div>

                <div id="calendario-container"></div>
            </div>
        </div>
    </div>

    <script>

        // MIX ID
        async function generarMixId() {
            try {
                const mixdesigns = await getAllRecords('mixdesigns');
                const year = new Date().getFullYear();
                const numero = (mixdesigns ? mixdesigns.length : 0) + 1;
                return 'MX-' + year + '-' + String(numero).padStart(4, '0');
            } catch(e) {
                return 'MX-2026-0001';
            }
        }

        // FUNCIONES PARA BOTONES NUEVO
        function nuevoMixDesign() {
            clearForm('mixdesign');
            generarMixId().then(id => {
                const elem = document.getElementById('mix-id-display');
                if (elem) elem.value = id;
            });
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function nuevoTrial() {
            clearForm('trial');
            const trialId = await generarTrialId();
            document.getElementById('trial-id-display').value = trialId;
            document.getElementById('trial-fecha').valueAsDate = new Date();
            generarCamposCilindros();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }


        // ============ BASE DE DATOS ============
        let db;
        let currentMixResults = null;

        // Variable global para guardar el logo
        let logoEmpresa = null;
        
        // Funci√≥n para cargar el logo
        function cargarLogo() {
            const input = document.getElementById('mix-logo');
            const preview = document.getElementById('logo-preview');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    logoEmpresa = e.target.result;
                    preview.src = logoEmpresa;
                    preview.style.display = 'block';
                    console.log('Logo cargado exitosamente');
                };
                
                reader.readAsDataURL(input.files[0]);
            }
        }
        


        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('ConcretoManagementDB', 4); // Incrementar versi√≥n
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    
                    if (!db.objectStoreNames.contains('clientes')) {
                        db.createObjectStore('clientes', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('proyectos')) {
                        db.createObjectStore('proyectos', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('materiales')) {
                        db.createObjectStore('materiales', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('cotizaciones')) {
                        db.createObjectStore('cotizaciones', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('mixdesigns')) {
                        db.createObjectStore('mixdesigns', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('trials')) {
                        db.createObjectStore('trials', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings', { keyPath: 'key' });
                    }
                };
            });
        }

        function addRecord(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(data);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function updateRecord(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function deleteRecord(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function getRecord(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(id);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function getAllRecords(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // ============ EXPORTAR / IMPORTAR DATA ============
        async function exportarTodaLaData() {
            try {
                const data = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    clientes: await getAllRecords('clientes'),
                    proyectos: await getAllRecords('proyectos'),
                    materiales: await getAllRecords('materiales'),
                    mixdesigns: await getAllRecords('mixdesigns'),
                    trials: await getAllRecords('trials')
                };
                
                // Incluir logo si existe
                try {
                    const transaction = db.transaction(['settings'], 'readonly');
                    const store = transaction.objectStore('settings');
                    const request = store.get('logo');
                    
                    await new Promise((resolve) => {
                        request.onsuccess = () => {
                            if (request.result && request.result.value) {
                                data.logo = request.result.value;
                            }
                            resolve();
                        };
                        request.onerror = () => resolve();
                    });
                } catch (error) {
                    console.log('No logo to export');
                }
                
                // Crear archivo JSON
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // Crear nombre de archivo con fecha
                const fecha = new Date().toISOString().split('T')[0];
                const nombreArchivo = `mixtec-backup-${fecha}.json`;
                
                // Descargar
                const a = document.createElement('a');
                a.href = url;
                a.download = nombreArchivo;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert(`‚úÖ Data exportada exitosamente!\n\nArchivo: ${nombreArchivo}\n\n` +
                      `Clientes: ${data.clientes.length}\n` +
                      `Proyectos: ${data.proyectos.length}\n` +
                      `Materiales: ${data.materiales.length}\n` +
                      `Mix Designs: ${data.mixdesigns.length}\n` +
                      `Trial Mixes: ${data.trials.length}`);
                
            } catch (error) {
                console.error('Error exportando:', error);
                alert('‚ùå Error al exportar datos: ' + error.message);
            }
        }

        async function importarData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Confirmaci√≥n
            if (!confirm('‚ö†Ô∏è ADVERTENCIA: Al importar datos se REEMPLAZAR√Å toda la informaci√≥n actual.\n\n' +
                        '¬øEst√°s seguro de que deseas continuar?\n\n' +
                        'Recomendaci√≥n: Exporta tus datos actuales primero como respaldo.')) {
                event.target.value = ''; // Reset file input
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validar estructura
                    if (!data.version || !data.clientes || !data.proyectos || !data.materiales || !data.mixdesigns || !data.trials) {
                        throw new Error('Archivo JSON inv√°lido o incompleto');
                    }
                    
                    // Limpiar todas las tablas primero
                    const stores = ['clientes', 'proyectos', 'materiales', 'mixdesigns', 'trials'];
                    
                    for (const storeName of stores) {
                        const transaction = db.transaction([storeName], 'readwrite');
                        const store = transaction.objectStore(storeName);
                        await store.clear();
                    }
                    
                    // Importar datos
                    let importados = {
                        clientes: 0,
                        proyectos: 0,
                        materiales: 0,
                        mixdesigns: 0,
                        trials: 0
                    };
                    
                    // Importar cada categor√≠a
                    for (const cliente of data.clientes) {
                        await addRecord('clientes', cliente);
                        importados.clientes++;
                    }
                    
                    for (const proyecto of data.proyectos) {
                        await addRecord('proyectos', proyecto);
                        importados.proyectos++;
                    }
                    
                    for (const material of data.materiales) {
                        await addRecord('materiales', material);
                        importados.materiales++;
                    }
                    
                    for (const mix of data.mixdesigns) {
                        await addRecord('mixdesigns', mix);
                        importados.mixdesigns++;
                    }
                    
                    for (const trial of data.trials) {
                        await addRecord('trials', trial);
                        importados.trials++;
                    }
                    
                    // Importar logo si existe
                    if (data.logo) {
                        await guardarLogo(data.logo);
                        mostrarLogo(data.logo);
                    }
                    
                    alert(`‚úÖ Importaci√≥n exitosa!\n\n` +
                          `Clientes: ${importados.clientes}\n` +
                          `Proyectos: ${importados.proyectos}\n` +
                          `Materiales: ${importados.materiales}\n` +
                          `Mix Designs: ${importados.mixdesigns}\n` +
                          `Trial Mixes: ${importados.trials}\n\n` +
                          `Fecha de exportaci√≥n original: ${new Date(data.exportDate).toLocaleString('es-ES')}`);
                    
                    // Recargar dashboard
                    updateDashboard();
                    
                } catch (error) {
                    console.error('Error importando:', error);
                    alert('‚ùå Error al importar datos: ' + error.message + '\n\nAseg√∫rate de que el archivo sea un backup v√°lido.');
                }
                
                // Reset file input
                event.target.value = '';
            };
            
            reader.onerror = function() {
                alert('‚ùå Error al leer el archivo');
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }


        // ============ NAVEGACI√ìN ============
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Cargar datos cuando se cambia de tab
            if (tabName === 'clientes') loadClientes();
            if (tabName === 'proyectos') {
                loadProyectos();
                loadClientesSelect();
            }
            if (tabName === 'materiales') loadMateriales();
            if (tabName === 'cotizaciones') loadCotizaciones();
            if (tabName === 'mixdesign') {
                loadMixDesigns();
                loadClientesSelect();
                loadProyectosSelect();
            }
            if (tabName === 'trials') {
                loadTrials();
                loadMixDesignsSelect();
            }
            if (tabName === 'analisis') {
                updateAnalisisMixFilter();
                updateAnalisisCharts();
            }
            if (tabName === 'calendario') {
                cargarCalendario();
            }
            if (tabName === 'dashboard') updateDashboard();
        }

        // ============ LOGO ============
        document.getElementById('logo-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const logoData = event.target.result;
                    guardarLogo(logoData);
                    mostrarLogo(logoData);
                };
                reader.readAsDataURL(file);
            }
        });

        async function guardarLogo(logoData) {
            const transaction = db.transaction(['settings'], 'readwrite');
            const store = transaction.objectStore('settings');
            await store.put({ key: 'logo', value: logoData });
        }

        async function cargarLogoGuardado() {
            try {
                const transaction = db.transaction(['settings'], 'readonly');
                const store = transaction.objectStore('settings');
                const request = store.get('logo');
                
                request.onsuccess = () => {
                    if (request.result && request.result.value) {
                        mostrarLogo(request.result.value);
                    }
                };
            } catch (error) {
                console.log('No hay logo guardado');
            }
        }

        function mostrarLogo(logoData) {
            const container = document.getElementById('logo-container');
            container.innerHTML = `<img src="${logoData}" alt="Logo">`;
            container.classList.remove('empty');
        }

        // ============ APLICACIONES ============
        async function cargarAplicaciones() {
            const aplicaciones = [
                'Losas', 'Columnas', 'Vigas', 'Muros', 'Cimientos',
                'Pavimento', 'Aceras', 'Estructural', 'Arquitect√≥nico', 'Otro'
            ];
            
            const select = document.getElementById('mix-aplicacion');
            aplicaciones.forEach(app => {
                select.innerHTML += `<option value="${app}">${app}</option>`;
            });
        }

        // ============ CLIENTES ============
        document.getElementById('form-cliente').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const cliente = {
                nombre: document.getElementById('cliente-nombre').value,
                empresa: document.getElementById('cliente-empresa').value,
                email: document.getElementById('cliente-email').value,
                telefono: document.getElementById('cliente-telefono').value,
                notas: document.getElementById('cliente-notas').value,
                fechaCreacion: new Date().toISOString()
            };

            const editId = document.getElementById('edit-cliente-id').value;

            try {
                if (editId) {
                    cliente.id = parseInt(editId);
                    await updateRecord('clientes', cliente);
                    alert('‚úÖ Cliente actualizado');
                } else {
                    await addRecord('clientes', cliente);
                    alert('‚úÖ Cliente guardado');
                }
                clearForm('cliente');
                loadClientes();
                updateDashboard();
            } catch (error) {
                alert('‚ùå Error: ' + error);
            }
        });

        async function loadClientes() {
            const clientes = await getAllRecords('clientes');
            const container = document.getElementById('lista-clientes');
            
            if (clientes.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay clientes registrados</div>';
                return;
            }
            
            let html = '<table><thead><tr><th>Nombre</th><th>Empresa</th><th>Email</th><th>Tel√©fono</th><th>Acciones</th></tr></thead><tbody>';
            clientes.forEach(c => {
                html += `<tr>
                    <td><strong>${c.nombre}</strong></td>
                    <td>${c.empresa || '-'}</td>
                    <td>${c.email || '-'}</td>
                    <td>${c.telefono || '-'}</td>
                    <td class="actions">
                        <button class="secondary" onclick="editCliente(${c.id})">Editar</button>
                        <button class="danger" onclick="deleteCliente(${c.id})">Eliminar</button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function editCliente(id) {
            const cliente = await getRecord('clientes', id);
            if (!cliente) return;
            
            document.getElementById('edit-cliente-id').value = cliente.id;
            document.getElementById('cliente-nombre').value = cliente.nombre;
            document.getElementById('cliente-empresa').value = cliente.empresa || '';
            document.getElementById('cliente-email').value = cliente.email || '';
            document.getElementById('cliente-telefono').value = cliente.telefono || '';
            document.getElementById('cliente-notas').value = cliente.notas || '';
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function deleteCliente(id) {
            if (confirm('¬øEliminar este cliente?')) {
                await deleteRecord('clientes', id);
                loadClientes();
                updateDashboard();
            }
        }

        function filterClientes() {
            const search = document.getElementById('search-clientes').value.toLowerCase();
            document.querySelectorAll('#lista-clientes table tbody tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        // ============ PROYECTOS ============
        document.getElementById('form-proyecto').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const proyecto = {
                nombre: document.getElementById('proyecto-nombre').value,
                cliente: document.getElementById('proyecto-cliente').value,
                ubicacion: document.getElementById('proyecto-ubicacion').value,
                descripcion: document.getElementById('proyecto-descripcion').value,
                estado: document.getElementById('proyecto-estado').value,
                fechaCreacion: new Date().toISOString()
            };

            const editId = document.getElementById('edit-proyecto-id').value;

            try {
                if (editId) {
                    proyecto.id = parseInt(editId);
                    await updateRecord('proyectos', proyecto);
                    alert('‚úÖ Proyecto actualizado');
                } else {
                    await addRecord('proyectos', proyecto);
                    alert('‚úÖ Proyecto guardado');
                }
                clearForm('proyecto');
                loadProyectos();
                updateDashboard();
            } catch (error) {
                alert('‚ùå Error: ' + error);
            }
        });

        async function loadProyectos() {
            const proyectos = await getAllRecords('proyectos');
            const clientes = await getAllRecords('clientes');
            const container = document.getElementById('lista-proyectos');
            
            if (proyectos.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay proyectos</div>';
                return;
            }
            
            let html = '<table><thead><tr><th>Proyecto</th><th>Cliente</th><th>Ubicaci√≥n</th><th>Estado</th><th>Acciones</th></tr></thead><tbody>';
            proyectos.forEach(p => {
                const cliente = clientes.find(c => c.id == p.cliente);
                const estadoBadge = p.estado === 'active' ? 'active' : 'inactive';
                const estadoTexto = p.estado === 'active' ? 'Activo' : p.estado === 'completed' ? 'Completado' : 'En Espera';
                
                html += `<tr>
                    <td><strong>${p.nombre}</strong></td>
                    <td>${cliente ? cliente.nombre : '-'}</td>
                    <td>${p.ubicacion || '-'}</td>
                    <td><span class="badge ${estadoBadge}">${estadoTexto}</span></td>
                    <td class="actions">
                        <button class="secondary" onclick="editProyecto(${p.id})">Editar</button>
                        <button class="danger" onclick="deleteProyecto(${p.id})">Eliminar</button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function editProyecto(id) {
            const proyecto = await getRecord('proyectos', id);
            if (!proyecto) return;
            
            document.getElementById('edit-proyecto-id').value = proyecto.id;
            document.getElementById('proyecto-nombre').value = proyecto.nombre;
            document.getElementById('proyecto-cliente').value = proyecto.cliente || '';
            document.getElementById('proyecto-ubicacion').value = proyecto.ubicacion || '';
            document.getElementById('proyecto-descripcion').value = proyecto.descripcion || '';
            document.getElementById('proyecto-estado').value = proyecto.estado;
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function deleteProyecto(id) {
            if (confirm('¬øEliminar este proyecto?')) {
                await deleteRecord('proyectos', id);
                loadProyectos();
                updateDashboard();
            }
        }

        function filterProyectos() {
            const search = document.getElementById('search-proyectos').value.toLowerCase();
            document.querySelectorAll('#lista-proyectos table tbody tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        
        // Abrir modal de nuevo cliente
        function nuevoClienteRapido() {
            document.getElementById('modal-cliente-rapido').style.display = 'flex';
            document.getElementById('nuevo-cliente-nombre').value = '';
            document.getElementById('nuevo-cliente-email').value = '';
            document.getElementById('nuevo-cliente-telefono').value = '';
            document.getElementById('nuevo-cliente-nombre').focus();
        }
        
        // Cerrar modal
        function cerrarModalCliente() {
            document.getElementById('modal-cliente-rapido').style.display = 'none';
        }
        
        // Nuevo Proyecto R√°pido
        function nuevoProyectoRapido() {
            // Cargar clientes primero en el select del modal
            loadClientesSelectModal();
            document.getElementById('modal-proyecto-rapido').style.display = 'flex';
            document.getElementById('nuevo-proyecto-nombre').value = '';
            document.getElementById('nuevo-proyecto-ubicacion').value = '';
            document.getElementById('nuevo-proyecto-nombre').focus();
        }
        
        // Cerrar modal proyecto
        function cerrarModalProyecto() {
            document.getElementById('modal-proyecto-rapido').style.display = 'none';
        }
        
        // Cargar clientes en el select del modal
        async function loadClientesSelectModal() {
            const clientes = await getAllRecords('clientes');
            const select = document.getElementById('nuevo-proyecto-cliente');
            if (select) {
                select.innerHTML = '<option value="">Seleccionar cliente...</option>';
                clientes.forEach(c => {
                    select.innerHTML += `<option value="${c.id}">${c.nombre}</option>`;
                });
            }
        }
        
        // Guardar proyecto r√°pido
        async function guardarProyectoRapido() {
            const nombre = document.getElementById('nuevo-proyecto-nombre').value.trim();
            const clienteId = document.getElementById('nuevo-proyecto-cliente').value;
            
            if (!nombre) {
                alert('‚ö†Ô∏è El nombre del proyecto es obligatorio');
                return;
            }
            
            if (!clienteId) {
                alert('‚ö†Ô∏è Debes seleccionar un cliente');
                return;
            }
            
            const proyecto = {
                nombre: nombre,
                clienteId: parseInt(clienteId),
                ubicacion: document.getElementById('nuevo-proyecto-ubicacion').value.trim(),
                estado: 'Activo',
                fechaCreacion: new Date().toISOString()
            };
            
            try {
                const id = await addRecord('proyectos', proyecto);
                
                // Cargar el cliente en el select de mix design
                document.getElementById('mix-cliente').value = clienteId;
                await filtrarProyectosPorCliente();
                
                // Esperar un momento para que se cargue el select
                setTimeout(() => {
                    document.getElementById('mix-proyecto').value = id;
                }, 100);
                
                cerrarModalProyecto();
                alert('‚úÖ Proyecto creado exitosamente');
            } catch (error) {
                alert('‚ùå Error al crear proyecto: ' + error.message);
            }
        }
        
        // Guardar cliente r√°pido
        async function guardarClienteRapido() {
            const nombre = document.getElementById('nuevo-cliente-nombre').value.trim();
            
            if (!nombre) {
                alert('‚ö†Ô∏è El nombre del cliente es obligatorio');
                return;
            }
            
            const cliente = {
                nombre: nombre,
                email: document.getElementById('nuevo-cliente-email').value.trim(),
                telefono: document.getElementById('nuevo-cliente-telefono').value.trim(),
                fechaCreacion: new Date().toISOString()
            };
            
            try {
                const id = await addRecord('clientes', cliente);
                await loadClientesSelect();
                
                // Esperar un momento para que se cargue el select
                setTimeout(() => {
                    document.getElementById('mix-cliente').value = id;
                    // Trigger del filtrado de proyectos
                    filtrarProyectosPorCliente();
                }, 100);
                await filtrarProyectosPorCliente();
                
                cerrarModalCliente();
                alert('‚úÖ Cliente creado exitosamente');
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error al crear cliente: ' + error.message);
            }
        }
        

        async function loadClientesSelect() {
            const clientes = await getAllRecords('clientes');
            
            // Cargar en select de proyectos
            const selectProyecto = document.getElementById('proyecto-cliente');
            if (selectProyecto) {
                selectProyecto.innerHTML = '<option value="">Seleccionar...</option>';
                clientes.forEach(c => {
                    selectProyecto.innerHTML += `<option value="${c.id}">${c.nombre}</option>`;
                });
            }
            
            // Cargar en select de mix design
            const selectMix = document.getElementById('mix-cliente');
            if (selectMix) {
                selectMix.innerHTML = '<option value="">Seleccione cliente...</option>';
                clientes.forEach(c => {
                    selectMix.innerHTML += `<option value="${c.id}">${c.nombre}</option>`;
                });
            }
        }

        async function loadProyectosSelect() {
            const proyectos = await getAllRecords('proyectos');
            const select = document.getElementById('mix-proyecto');
            select.innerHTML = '<option value="">Sin proyecto</option>';
            proyectos.forEach(p => {
                select.innerHTML += `<option value="${p.id}">${p.nombre}</option>`;
            });
        }
        
        // Filtrar proyectos por cliente seleccionado
        async function filtrarProyectosPorCliente() {
            const clienteSelect = document.getElementById('mix-cliente');
            const proyectoSelect = document.getElementById('mix-proyecto');
            
            if (!clienteSelect || !proyectoSelect) return;
            
            const clienteId = clienteSelect.value;
            
            if (!clienteId) {
                // Si no hay cliente seleccionado, mostrar todos los proyectos
                await loadProyectosSelect();
                return;
            }
            
            // Filtrar proyectos del cliente seleccionado
            const proyectos = await getAllRecords('proyectos');
            const proyectosFiltrados = proyectos.filter(p => p.clienteId == clienteId);
            
            proyectoSelect.innerHTML = '<option value="">Seleccione proyecto...</option>';
            
            if (proyectosFiltrados.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No hay proyectos para este cliente';
                option.disabled = true;
                proyectoSelect.appendChild(option);
            } else {
                proyectosFiltrados.forEach(proyecto => {
                    const option = document.createElement('option');
                    option.value = proyecto.id;
                    option.textContent = proyecto.nombre;
                    proyectoSelect.appendChild(option);
                });
            }
        }


        // ============ MATERIALES ============
        document.getElementById('form-material').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const material = {
                nombre: document.getElementById('material-nombre').value,
                categoria: document.getElementById('material-categoria').value,
                cantidad: parseFloat(document.getElementById('material-cantidad').value) || 0,
                unidad: document.getElementById('material-unidad').value,
                precio: parseFloat(document.getElementById('material-precio').value) || 0,
                proveedor: document.getElementById('material-proveedor').value,
                fechaCreacion: new Date().toISOString()
            };

            const editId = document.getElementById('edit-material-id').value;

            try {
                if (editId) {
                    material.id = parseInt(editId);
                    await updateRecord('materiales', material);
                    alert('‚úÖ Material actualizado');
                } else {
                    await addRecord('materiales', material);
                    alert('‚úÖ Material guardado');
                }
                clearForm('material');
                loadMateriales();
                cargarAditivosEnSelects();
            setTimeout(async function() {
                const mixId = await generarMixId();
                const elem = document.getElementById('mix-id-display');
                if (elem) elem.value = mixId;
            }, 500);
                updateDashboard();
            } catch (error) {
                alert('‚ùå Error: ' + error);
            }
        });

        async function loadMateriales() {
            const materiales = await getAllRecords('materiales');
            const container = document.getElementById('lista-materiales');
            
            if (materiales.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay materiales</div>';
                return;
            }
            
            let html = '<table><thead><tr><th>Nombre</th><th>Categor√≠a</th><th>Cantidad</th><th>Precio</th><th>Total</th><th>Acciones</th></tr></thead><tbody>';
            materiales.forEach(m => {
                const total = m.cantidad * m.precio;
                html += `<tr>
                    <td><strong>${m.nombre}</strong></td>
                    <td>${m.categoria}</td>
                    <td>${m.cantidad} ${m.unidad || ''}</td>
                    <td>$${m.precio.toFixed(2)}</td>
                    <td>$${total.toFixed(2)}</td>
                    <td class="actions">
                        <button class="secondary" onclick="editMaterial(${m.id})">Editar</button>
                        <button class="danger" onclick="deleteMaterial(${m.id})">Eliminar</button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function editMaterial(id) {
            const material = await getRecord('materiales', id);
            if (!material) return;
            
            document.getElementById('edit-material-id').value = material.id;
            document.getElementById('material-nombre').value = material.nombre;
            document.getElementById('material-categoria').value = material.categoria;
            document.getElementById('material-cantidad').value = material.cantidad;
            document.getElementById('material-unidad').value = material.unidad || '';
            document.getElementById('material-precio').value = material.precio;
            document.getElementById('material-proveedor').value = material.proveedor || '';
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function deleteMaterial(id) {
            if (confirm('¬øEliminar este material?')) {
                await deleteRecord('materiales', id);
                loadMateriales();
                updateDashboard();
            }
        }

        function filterMateriales() {
            const search = document.getElementById('search-materiales').value.toLowerCase();
            document.querySelectorAll('#lista-materiales table tbody tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        // ============ COTIZACIONES ============
        
        let lineaCotizacionCounter = 0;

        async function generarNumeroCotizacion() {
            const cotizaciones = await getAllRecords('cotizaciones');
            const year = new Date().getFullYear();
            const numero = (cotizaciones ? cotizaciones.length : 0) + 1;
            return 'COT-' + year + '-' + String(numero).padStart(4, '0');
        }

        function nuevaCotizacion() {
            limpiarFormularioCotizacion();
            generarNumeroCotizacion().then(numero => {
                document.getElementById('cotizacion-numero').value = numero;
            });
            // Agregar una l√≠nea inicial
            agregarLineaCotizacion();
        }

        function agregarLineaCotizacion() {
            lineaCotizacionCounter++;
            const tbody = document.getElementById('cotizacion-lineas-body');
            const row = document.createElement('tr');
            row.id = `linea-${lineaCotizacionCounter}`;
            
            row.innerHTML = `
                <td><input type="text" class="linea-descripcion" placeholder="Ej: Concreto 3000 PSI" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></td>
                <td><input type="number" class="linea-cantidad" step="0.01" min="0" value="0" onchange="calcularTotalGeneral()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></td>
                <td><input type="number" class="linea-precio" step="0.01" min="0" value="0" onchange="calcularTotalGeneral()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></td>
                <td style="text-align: center;">
                    <button type="button" class="danger" onclick="eliminarLineaCotizacion(${lineaCotizacionCounter})" style="padding: 6px 12px;">üóëÔ∏è</button>
                </td>
            `;
            
            tbody.appendChild(row);
        }

        function calcularTotalGeneral() {
            const tbody = document.getElementById('cotizacion-lineas-body');
            let totalDinero = 0;
            let totalYd = 0;
            
            tbody.querySelectorAll('tr').forEach(row => {
                const cantidad = parseFloat(row.querySelector('.linea-cantidad').value) || 0;
                const precio = parseFloat(row.querySelector('.linea-precio').value) || 0;
                totalDinero += cantidad * precio;
                totalYd += cantidad;
            });
            
            document.getElementById('cotizacion-total-yd').textContent = totalYd.toFixed(2) + ' yd¬≥';
        }

        function eliminarLineaCotizacion(lineaId) {
            const row = document.getElementById(`linea-${lineaId}`);
            if (row) {
                row.remove();
                calcularTotalGeneral();
            }
        }

        function limpiarFormularioCotizacion() {
            document.getElementById('form-cotizacion').reset();
            document.getElementById('edit-cotizacion-id').value = '';
            document.getElementById('cotizacion-lineas-body').innerHTML = '';
            document.getElementById('cotizacion-total-yd').textContent = '0.00 yd¬≥';
            document.getElementById('cotizacion-status').value = 'Pendiente';
            document.getElementById('btn-imprimir-cotizacion').disabled = true;
            lineaCotizacionCounter = 0;
            
            // Generar nuevo n√∫mero
            generarNumeroCotizacion().then(numero => {
                document.getElementById('cotizacion-numero').value = numero;
            });
            
            // Fecha de hoy
            document.getElementById('cotizacion-fecha').valueAsDate = new Date();
            
            // Fecha v√°lida hasta (30 d√≠as)
            const validaHasta = new Date();
            validaHasta.setDate(validaHasta.getDate() + 30);
            document.getElementById('cotizacion-valida-hasta').valueAsDate = validaHasta;
        }

        document.getElementById('form-cotizacion').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Recopilar l√≠neas
            const tbody = document.getElementById('cotizacion-lineas-body');
            const lineas = [];
            
            tbody.querySelectorAll('tr').forEach(row => {
                const descripcion = row.querySelector('.linea-descripcion').value;
                const cantidad = parseFloat(row.querySelector('.linea-cantidad').value) || 0;
                const precio = parseFloat(row.querySelector('.linea-precio').value) || 0;
                const total = cantidad * precio;
                
                if (descripcion && cantidad > 0) {
                    lineas.push({ descripcion, cantidad, precio, total });
                }
            });
            
            if (lineas.length === 0) {
                alert('‚ö†Ô∏è Agrega al menos una l√≠nea de cotizaci√≥n');
                return;
            }
            
            const totalGeneral = lineas.reduce((sum, linea) => sum + linea.total, 0);
            const totalYd = lineas.reduce((sum, linea) => sum + linea.cantidad, 0);
            
            const cotizacion = {
                numero: document.getElementById('cotizacion-numero').value,
                fecha: document.getElementById('cotizacion-fecha').value,
                validaHasta: document.getElementById('cotizacion-valida-hasta').value,
                status: document.getElementById('cotizacion-status').value,
                clienteNombre: document.getElementById('cotizacion-cliente-nombre').value,
                clienteTel: document.getElementById('cotizacion-cliente-tel').value,
                clienteEmail: document.getElementById('cotizacion-cliente-email').value,
                proyecto: document.getElementById('cotizacion-proyecto').value,
                ubicacion: document.getElementById('cotizacion-ubicacion').value,
                lineas: lineas,
                total: totalGeneral,
                totalYd: totalYd,
                notas: document.getElementById('cotizacion-notas').value,
                fechaCreacion: new Date().toISOString()
            };
            
            const editId = document.getElementById('edit-cotizacion-id').value;
            
            try {
                if (editId) {
                    cotizacion.id = parseInt(editId);
                    await updateRecord('cotizaciones', cotizacion);
                    alert('‚úÖ Cotizaci√≥n actualizada');
                } else {
                    await addRecord('cotizaciones', cotizacion);
                    alert('‚úÖ Cotizaci√≥n guardada exitosamente');
                }
                
                document.getElementById('btn-imprimir-cotizacion').disabled = false;
                await loadCotizaciones();
                
            } catch (error) {
                console.error('Error al guardar cotizaci√≥n:', error);
                alert('‚ùå Error al guardar: ' + error.message);
            }
        });

        async function loadCotizaciones() {
            const cotizaciones = await getAllRecords('cotizaciones');
            const container = document.getElementById('lista-cotizaciones');
            
            if (cotizaciones.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay cotizaciones</div>';
                return;
            }
            
            cotizaciones.sort((a, b) => new Date(b.fechaCreacion) - new Date(a.fechaCreacion));
            
            // Funci√≥n para obtener emoji del status
            const getStatusEmoji = (status) => {
                const emojis = {
                    'Pendiente': '‚è≥',
                    'Aprobada': '‚úÖ',
                    'Rechazada': '‚ùå',
                    'En Revisi√≥n': 'üëÅÔ∏è',
                    'Cancelada': 'üö´'
                };
                return emojis[status] || 'üìÑ';
            };
            
            // Funci√≥n para obtener color del status
            const getStatusColor = (status) => {
                const colors = {
                    'Pendiente': '#f59e0b',
                    'Aprobada': '#16a34a',
                    'Rechazada': '#dc2626',
                    'En Revisi√≥n': '#0369a1',
                    'Cancelada': '#6b7280'
                };
                return colors[status] || '#6b7280';
            };
            
            let html = '<table><thead><tr><th>N√∫mero</th><th>Status</th><th>Cliente</th><th>Proyecto</th><th>Fecha</th><th>Total YD¬≥</th><th>Acciones</th></tr></thead><tbody>';
            cotizaciones.forEach(c => {
                const statusColor = getStatusColor(c.status || 'Pendiente');
                const statusEmoji = getStatusEmoji(c.status || 'Pendiente');
                html += `<tr>
                    <td><strong>${c.numero}</strong></td>
                    <td><span style="background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: bold; white-space: nowrap;">${statusEmoji} ${c.status || 'Pendiente'}</span></td>
                    <td>${c.clienteNombre}</td>
                    <td>${c.proyecto}</td>
                    <td>${new Date(c.fecha).toLocaleDateString('es-ES')}</td>
                    <td style="color: #0369a1; font-weight: bold;">${(c.totalYd || 0).toFixed(2)} yd¬≥</td>
                    <td class="actions">
                        <button class="info" onclick="verCotizacion(${c.id})">Ver</button>
                        <button class="secondary" onclick="editCotizacion(${c.id})">Editar</button>
                        <button class="success" onclick="imprimirCotizacionGuardada(${c.id})">üñ®Ô∏è</button>
                        <button class="danger" onclick="deleteCotizacion(${c.id})">Eliminar</button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function verCotizacion(id) {
            const cotizacion = await getRecord('cotizaciones', id);
            if (!cotizacion) return;
            
            let detalles = `
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
   COTIZACI√ìN ${cotizacion.numero}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìÖ Fecha: ${new Date(cotizacion.fecha).toLocaleDateString('es-ES')}
üìÖ V√°lida hasta: ${new Date(cotizacion.validaHasta).toLocaleDateString('es-ES')}

üë§ CLIENTE
Nombre: ${cotizacion.clienteNombre}
Tel: ${cotizacion.clienteTel || 'N/A'}
Email: ${cotizacion.clienteEmail || 'N/A'}

üìÅ PROYECTO
Nombre: ${cotizacion.proyecto}
Ubicaci√≥n: ${cotizacion.ubicacion || 'N/A'}

üìù L√çNEAS DE COTIZACI√ìN
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
`;
            
            cotizacion.lineas.forEach((linea, index) => {
                detalles += `
${index + 1}. ${linea.descripcion}
   Cantidad: ${linea.cantidad} yd¬≥
   Precio: $${linea.precio.toFixed(2)}/yd¬≥
   Total: $${linea.total.toFixed(2)}
`;
            });
            
            detalles += `
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
TOTAL GENERAL: $${cotizacion.total.toFixed(2)}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
`;
            
            if (cotizacion.notas) {
                detalles += `\nüìÑ NOTAS:\n${cotizacion.notas}`;
            }
            
            alert(detalles);
        }

        async function editCotizacion(id) {
            const cotizacion = await getRecord('cotizaciones', id);
            if (!cotizacion) return;
            
            document.getElementById('edit-cotizacion-id').value = id;
            document.getElementById('cotizacion-numero').value = cotizacion.numero;
            document.getElementById('cotizacion-fecha').value = cotizacion.fecha;
            document.getElementById('cotizacion-valida-hasta').value = cotizacion.validaHasta;
            document.getElementById('cotizacion-status').value = cotizacion.status || 'Pendiente';
            document.getElementById('cotizacion-cliente-nombre').value = cotizacion.clienteNombre;
            document.getElementById('cotizacion-cliente-tel').value = cotizacion.clienteTel || '';
            document.getElementById('cotizacion-cliente-email').value = cotizacion.clienteEmail || '';
            document.getElementById('cotizacion-proyecto').value = cotizacion.proyecto;
            document.getElementById('cotizacion-ubicacion').value = cotizacion.ubicacion || '';
            document.getElementById('cotizacion-notas').value = cotizacion.notas || '';
            
            // Limpiar l√≠neas existentes
            document.getElementById('cotizacion-lineas-body').innerHTML = '';
            lineaCotizacionCounter = 0;
            
            // Agregar l√≠neas guardadas
            cotizacion.lineas.forEach(linea => {
                lineaCotizacionCounter++;
                const tbody = document.getElementById('cotizacion-lineas-body');
                const row = document.createElement('tr');
                row.id = `linea-${lineaCotizacionCounter}`;
                
                row.innerHTML = `
                    <td><input type="text" class="linea-descripcion" value="${linea.descripcion}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></td>
                    <td><input type="number" class="linea-cantidad" step="0.01" min="0" value="${linea.cantidad}" onchange="calcularTotalGeneral()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></td>
                    <td><input type="number" class="linea-precio" step="0.01" min="0" value="${linea.precio}" onchange="calcularTotalGeneral()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></td>
                    <td style="text-align: center;">
                        <button type="button" class="danger" onclick="eliminarLineaCotizacion(${lineaCotizacionCounter})" style="padding: 6px 12px;">üóëÔ∏è</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            calcularTotalGeneral();
            document.getElementById('btn-imprimir-cotizacion').disabled = false;
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function deleteCotizacion(id) {
            if (!confirm('¬øEliminar esta cotizaci√≥n?')) return;
            
            await deleteRecord('cotizaciones', id);
            await loadCotizaciones();
            alert('‚úÖ Cotizaci√≥n eliminada');
        }

        function filterCotizaciones() {
            const searchTerm = document.getElementById('search-cotizaciones').value.toLowerCase();
            const rows = document.querySelectorAll('#lista-cotizaciones table tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        async function imprimirCotizacion() {
            // Recopilar datos del formulario actual
            const tbody = document.getElementById('cotizacion-lineas-body');
            const lineas = [];
            
            tbody.querySelectorAll('tr').forEach(row => {
                const descripcion = row.querySelector('.linea-descripcion').value;
                const cantidad = parseFloat(row.querySelector('.linea-cantidad').value) || 0;
                const precio = parseFloat(row.querySelector('.linea-precio').value) || 0;
                const total = cantidad * precio;
                
                if (descripcion && cantidad > 0) {
                    lineas.push({ descripcion, cantidad, precio, total });
                }
            });
            
            const cotizacion = {
                numero: document.getElementById('cotizacion-numero').value,
                fecha: document.getElementById('cotizacion-fecha').value,
                validaHasta: document.getElementById('cotizacion-valida-hasta').value,
                clienteNombre: document.getElementById('cotizacion-cliente-nombre').value,
                clienteTel: document.getElementById('cotizacion-cliente-tel').value,
                clienteEmail: document.getElementById('cotizacion-cliente-email').value,
                proyecto: document.getElementById('cotizacion-proyecto').value,
                ubicacion: document.getElementById('cotizacion-ubicacion').value,
                lineas: lineas,
                total: lineas.reduce((sum, linea) => sum + linea.total, 0),
                notas: document.getElementById('cotizacion-notas').value
            };
            
            generarPDFCotizacion(cotizacion);
        }

        async function imprimirCotizacionGuardada(id) {
            const cotizacion = await getRecord('cotizaciones', id);
            if (!cotizacion) return;
            
            generarPDFCotizacion(cotizacion);
        }

        async function generarPDFCotizacion(cotizacion) {
            const logo = await obtenerLogo();
            const logoHtml = logo 
                ? `<img src="${logo}" style="max-height: 120px; max-width: 350px;">` 
                : `<div style="background: #16a34a; color: white; padding: 10px 20px; border-radius: 6px; font-weight: bold; font-size: 18px;">MIXTEC PRO</div>`;
            
            const html = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Cotizaci√≥n ${cotizacion.numero}</title>
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; padding: 40px; color: #333; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 3px solid #16a34a; padding-bottom: 20px; }
    .header h1 { color: #16a34a; font-size: 28px; }
    .info-section { margin-bottom: 25px; }
    .info-section h3 { color: #16a34a; margin-bottom: 10px; font-size: 16px; text-transform: uppercase; }
    .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
    .info-item { padding: 10px; background: #f8f9fa; border-radius: 4px; }
    .info-label { font-size: 11px; color: #666; font-weight: bold; text-transform: uppercase; }
    .info-value { font-size: 14px; color: #222; font-weight: 500; margin-top: 3px; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    thead { background: #16a34a; color: white; }
    th { padding: 12px; text-align: left; font-weight: bold; }
    td { padding: 12px; border-bottom: 1px solid #ddd; }
    .total-row { background: #f0fdf4; font-weight: bold; font-size: 18px; }
    .notas { background: #fffbeb; padding: 15px; border-left: 4px solid #f59e0b; margin-top: 20px; }
    .footer { margin-top: 40px; text-align: center; font-size: 12px; color: #666; border-top: 2px solid #ddd; padding-top: 20px; }
    @media print {
        body { padding: 20px; }
        @page { size: letter; margin: 0.5in; }
    }
</style>
</head>
<body>
    <div class="header">
        <div>${logoHtml}</div>
        <div style="text-align: right;">
            <h1>COTIZACI√ìN</h1>
            <p style="font-size: 18px; color: #666; margin-top: 5px;">${cotizacion.numero}</p>
        </div>
    </div>

    <div class="info-section">
        <h3>üìÖ Informaci√≥n de la Cotizaci√≥n</h3>
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Fecha de Emisi√≥n</div>
                <div class="info-value">${new Date(cotizacion.fecha).toLocaleDateString('es-ES', {year: 'numeric', month: 'long', day: 'numeric'})}</div>
            </div>
            <div class="info-item">
                <div class="info-label">V√°lida Hasta</div>
                <div class="info-value">${new Date(cotizacion.validaHasta).toLocaleDateString('es-ES', {year: 'numeric', month: 'long', day: 'numeric'})}</div>
            </div>
        </div>
    </div>

    <div class="info-section">
        <h3>üë§ Informaci√≥n del Cliente</h3>
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Nombre</div>
                <div class="info-value">${cotizacion.clienteNombre}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Tel√©fono</div>
                <div class="info-value">${cotizacion.clienteTel || 'N/A'}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Email</div>
                <div class="info-value">${cotizacion.clienteEmail || 'N/A'}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Proyecto</div>
                <div class="info-value">${cotizacion.proyecto}</div>
            </div>
        </div>
        ${cotizacion.ubicacion ? `<div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
            <div class="info-label">Ubicaci√≥n</div>
            <div class="info-value">${cotizacion.ubicacion}</div>
        </div>` : ''}
    </div>

    <h3 style="color: #16a34a; margin: 25px 0 15px 0;">üìù Detalle de la Cotizaci√≥n</h3>
    <table>
        <thead>
            <tr>
                <th style="width: 60%">Descripci√≥n</th>
                <th style="width: 20%; text-align: center;">Cantidad (yd¬≥)</th>
                <th style="width: 20%; text-align: right;">Precio Unit.</th>
            </tr>
        </thead>
        <tbody>
            ${cotizacion.lineas.map(linea => `
                <tr>
                    <td>${linea.descripcion}</td>
                    <td style="text-align: center;">${linea.cantidad.toFixed(2)}</td>
                    <td style="text-align: right;">$${linea.precio.toFixed(2)}</td>
                </tr>
            `).join('')}
        </tbody>
        <tfoot>
            <tr style="background: #f3f4f6; font-weight: bold;">
                <td style="text-align: right; padding: 15px;">TOTAL YD¬≥:</td>
                <td style="text-align: center; color: #374151; padding: 15px; font-size: 18px;">${cotizacion.lineas.reduce((sum, l) => sum + l.cantidad, 0).toFixed(2)} yd¬≥</td>
                <td></td>
            </tr>
        </tfoot>
    </table>

    ${cotizacion.notas ? `
        <div class="notas">
            <h4 style="color: #92400e; margin-bottom: 8px;">üìÑ Notas y Condiciones</h4>
            <p style="line-height: 1.6; white-space: pre-wrap;">${cotizacion.notas}</p>
        </div>
    ` : ''}

    <div class="footer">
        <p><strong>Gracias por su preferencia</strong></p>
        <p>Documento generado el ${new Date().toLocaleDateString('es-ES')} a las ${new Date().toLocaleTimeString('es-ES')}</p>
    </div>

<scr` + `ipt>
    window.onload = function() {
        setTimeout(() => window.print(), 500);
    };
</scr` + `ipt>
</body>
</html>`;

            const win = window.open('', '_blank');
            if (!win) {
                alert('‚ùå Bloqueador de ventanas emergentes activo');
                return;
            }
            win.document.write(html);
            win.document.close();
        }

        // ============ MIX DESIGN ============
        function ajustarPorcentajesArenas(cambio) {
            const pct1 = parseFloat(document.getElementById('pct-arena1').value) || 0;
            const pct2 = parseFloat(document.getElementById('pct-arena2').value) || 0;
            
            if (cambio === 1) {
                document.getElementById('pct-arena2').value = Math.max(0, 100 - pct1);
            } else {
                document.getElementById('pct-arena1').value = Math.max(0, 100 - pct2);
            }
            
            calcularModuloFinuraCombinado();
        }

        function calcularModuloFinuraCombinado() {
            const mf1 = parseFloat(document.getElementById('mf-arena1').value) || 0;
            const mf2 = parseFloat(document.getElementById('mf-arena2').value) || 0;
            const pct1 = parseFloat(document.getElementById('pct-arena1').value) || 0;
            const pct2 = parseFloat(document.getElementById('pct-arena2').value) || 0;
            
            const mfCombinado = (mf1 * pct1 + mf2 * pct2) / 100;
            document.getElementById('mf-combinado').textContent = mfCombinado.toFixed(2);
        }

        function calcularVolumenes() {
            try {
                // ============ OBTENER TODOS LOS VALORES ============
                const resistencia = parseFloat(document.getElementById('mix-resistencia').value);
                const slump = parseFloat(document.getElementById('mix-slump').value);
                const tma = parseFloat(document.getElementById('mix-tma').value);
                const contenidoAire = parseFloat(document.getElementById('contenido-aire').value);

                // Cemento
                const pesoCemento = parseFloat(document.getElementById('peso-cemento').value);
                const geCemento = parseFloat(document.getElementById('ge-cemento').value);
                const precioCemento = parseFloat(document.getElementById('precio-cemento').value);

                // Agua
                const pesoAgua = parseFloat(document.getElementById('peso-agua').value);
                const precioAgua = parseFloat(document.getElementById('precio-agua').value);

                // Agregado grueso
                const pesoGrueso = parseFloat(document.getElementById('peso-grueso').value);
                const geGrueso = parseFloat(document.getElementById('ge-grueso').value);
                const absGrueso = parseFloat(document.getElementById('abs-grueso').value) / 100;
                const humGrueso = parseFloat(document.getElementById('hum-grueso').value) / 100;
                const precioGrueso = parseFloat(document.getElementById('precio-grueso').value);

                // Agregado intermedio
                const pesoIntermedio = parseFloat(document.getElementById('peso-intermedio').value);
                const geIntermedio = parseFloat(document.getElementById('ge-intermedio').value);
                const absIntermedio = parseFloat(document.getElementById('abs-intermedio').value) / 100;
                const humIntermedio = parseFloat(document.getElementById('hum-intermedio').value) / 100;
                const precioIntermedio = parseFloat(document.getElementById('precio-intermedio').value);

                // Arena 1
                const geArena1 = parseFloat(document.getElementById('ge-arena1').value);
                const absArena1 = parseFloat(document.getElementById('abs-arena1').value) / 100;
                const humArena1 = parseFloat(document.getElementById('hum-arena1').value) / 100;
                const precioArena1 = parseFloat(document.getElementById('precio-arena1').value);
                const pctArena1 = parseFloat(document.getElementById('pct-arena1').value) / 100;

                // Arena 2
                const geArena2 = parseFloat(document.getElementById('ge-arena2').value);
                const absArena2 = parseFloat(document.getElementById('abs-arena2').value) / 100;
                const humArena2 = parseFloat(document.getElementById('hum-arena2').value) / 100;
                const precioArena2 = parseFloat(document.getElementById('precio-arena2').value);
                const pctArena2 = parseFloat(document.getElementById('pct-arena2').value) / 100;

                // Aditivos
                const dosisAd1 = parseFloat(document.getElementById('dosis-aditivo1').value) || 0;
                const geAd1 = parseFloat(document.getElementById('ge-aditivo1').value);
                const precioAd1 = parseFloat(document.getElementById('precio-aditivo1').value);

                const dosisAd2 = parseFloat(document.getElementById('dosis-aditivo2').value) || 0;
                const geAd2 = parseFloat(document.getElementById('ge-aditivo2').value);
                const precioAd2 = parseFloat(document.getElementById('precio-aditivo2').value);

                const dosisAd3 = parseFloat(document.getElementById('dosis-aditivo3').value) || 0;
                const geAd3 = parseFloat(document.getElementById('ge-aditivo3').value);
                const precioAd3 = parseFloat(document.getElementById('precio-aditivo3').value);

                // ============ C√ÅLCULOS PRINCIPALES ============
                
                // 1. Calcular W/C Ratio
                const wcRatio = pesoAgua / pesoCemento;
                document.getElementById('wc-ratio').value = wcRatio.toFixed(3);
                
                // 2. Vol√∫menes absolutos de materiales ingresados
                const volCemento = pesoCemento / (geCemento * 62.4);
                const volAgua = pesoAgua / 62.4;
                const volAire = (contenidoAire / 100) * 27;
                const volGrueso = pesoGrueso / (geGrueso * 62.4);
                const volIntermedio = pesoIntermedio / (geIntermedio * 62.4);
                
                document.getElementById('volumen-aire').value = volAire.toFixed(2);
                
                // 3. Calcular pesos de aditivos
                const pesoAd1 = (dosisAd1 / 16) * (pesoCemento / 100);
                const pesoAd2 = (dosisAd2 / 16) * (pesoCemento / 100);
                const pesoAd3 = (dosisAd3 / 16) * (pesoCemento / 100);
                
                const volAd1 = pesoAd1 / (geAd1 * 62.4);
                const volAd2 = pesoAd2 / (geAd2 * 62.4);
                const volAd3 = pesoAd3 / (geAd3 * 62.4);
                
                // 4. ARENAS POR DIFERENCIA DE VOLUMEN
                const volumenOcupado = volCemento + volAgua + volAire + volGrueso + volIntermedio + volAd1 + volAd2 + volAd3;
                const volArenaTotal = 27 - volumenOcupado;
                
                if (volArenaTotal < 0) {
                    throw new Error('El volumen de materiales ingresados excede 27 ft¬≥. Reduce las cantidades.');
                }
                
                // 5. Calcular peso de arenas seg√∫n gravedad espec√≠fica combinada
                const geCombinado = (geArena1 * pctArena1 + geArena2 * pctArena2);
                const absCombinado = (absArena1 * pctArena1 + absArena2 * pctArena2);
                const humCombinado = (humArena1 * pctArena1 + humArena2 * pctArena2);
                
                const pesoArenaTotal = volArenaTotal * geCombinado * 62.4;
                
                // 6. Distribuir arenas seg√∫n porcentajes
                const pesoArena1SSD = pesoArenaTotal * pctArena1;
                const pesoArena2SSD = pesoArenaTotal * pctArena2;
                
                // 7. Ajustar por humedad (peso h√∫medo para la mezcla)
                const pesoArena1Humedo = pesoArena1SSD * (1 + humArena1);
                const pesoArena2Humedo = pesoArena2SSD * (1 + humArena2);
                const pesoGruesoHumedo = pesoGrueso * (1 + humGrueso) / (1 + absGrueso);
                const pesoIntermedioHumedo = pesoIntermedio * (1 + humIntermedio) / (1 + absIntermedio);
                
                // 8. Calcular agua efectiva (ajustada por absorci√≥n y humedad)
                const aguaAbsorbidaGrueso = (pesoGrueso / (1 + absGrueso)) * absGrueso;
                const aguaLibreGrueso = pesoGrueso * (humGrueso - absGrueso) / (1 + absGrueso);
                
                const aguaAbsorbidaIntermedio = (pesoIntermedio / (1 + absIntermedio)) * absIntermedio;
                const aguaLibreIntermedio = pesoIntermedio * (humIntermedio - absIntermedio) / (1 + absIntermedio);
                
                const aguaAbsorbidaArena = pesoArenaTotal * absCombinado;
                const aguaLibreArena = (humCombinado - absCombinado) * pesoArenaTotal;
                
                const aguaEfectiva = pesoAgua - aguaAbsorbidaGrueso - aguaAbsorbidaIntermedio - aguaAbsorbidaArena + aguaLibreGrueso + aguaLibreIntermedio + aguaLibreArena;
                
                // ============ C√ÅLCULO DE COSTOS ============
                const costoCemento = (pesoCemento / 94) * precioCemento;
                const costoAgua = (aguaEfectiva / 8.34) * precioAgua;
                const costoGrueso = (pesoGruesoHumedo / 2000) * precioGrueso;
                const costoIntermedio = (pesoIntermedioHumedo / 2000) * precioIntermedio;
                const costoArena1 = (pesoArena1Humedo / 2000) * precioArena1;
                const costoArena2 = (pesoArena2Humedo / 2000) * precioArena2;
                const costoAd1 = (pesoAd1 / 8.34 / geAd1) * precioAd1;
                const costoAd2 = (pesoAd2 / 8.34 / geAd2) * precioAd2;
                const costoAd3 = (pesoAd3 / 8.34 / geAd3) * precioAd3;
                
                const costoTotal = costoCemento + costoAgua + costoGrueso + costoIntermedio + costoArena1 + costoArena2 + costoAd1 + costoAd2 + costoAd3;
                
                const pesoTotal = pesoCemento + aguaEfectiva + pesoGruesoHumedo + pesoIntermedioHumedo + pesoArena1Humedo + pesoArena2Humedo + pesoAd1 + pesoAd2 + pesoAd3;

                // ============ GUARDAR RESULTADOS ============
                currentMixResults = {
                    cemento: { peso: pesoCemento, volumen: volCemento, costo: costoCemento },
                    agua: { peso: aguaEfectiva, volumen: volAgua, costo: costoAgua },
                    grueso: { peso: pesoGruesoHumedo, volumen: volGrueso, costo: costoGrueso },
                    intermedio: { peso: pesoIntermedioHumedo, volumen: volIntermedio, costo: costoIntermedio },
                    arena1: { peso: pesoArena1Humedo, volumen: volArenaTotal * pctArena1, costo: costoArena1 },
                    arena2: { peso: pesoArena2Humedo, volumen: volArenaTotal * pctArena2, costo: costoArena2 },
                    aditivo1: { peso: pesoAd1, volumen: volAd1, costo: costoAd1, nombre: document.getElementById('nombre-aditivo1').value },
                    aditivo2: { peso: pesoAd2, volumen: volAd2, costo: costoAd2, nombre: document.getElementById('nombre-aditivo2').value },
                    aditivo3: { peso: pesoAd3, volumen: volAd3, costo: costoAd3, nombre: document.getElementById('nombre-aditivo3').value },
                    wc: wcRatio,
                    aire: parseFloat(document.getElementById('mix-aire') ? document.getElementById('mix-aire').value : 2.0),
                    costoTotal: costoTotal,
                    pesoTotal: pesoTotal,
                    rendimiento: 27,
                    sacosCemento: pesoCemento / 94,
                    volumenArenas: volArenaTotal
                };

                mostrarResultados();
                document.getElementById('btn-mixdesign').disabled = false;
                document.getElementById('btn-reporte').disabled = false;
                document.getElementById('btn-reporte-download').disabled = false;
                document.getElementById('btn-reporte-costos').disabled = false;

            } catch (error) {
                alert('‚ùå Error en el c√°lculo: ' + error.message);
                console.error(error);
            }
        }

        function mostrarResultados() {
            document.getElementById('mix-results').style.display = 'block';
            
            // Tabla de cantidades
            let htmlCantidades = '';
            
            htmlCantidades += `<tr>
                <td><strong>Cemento</strong></td>
                <td>${currentMixResults.cemento.peso.toFixed(1)} lb</td>
                <td>${currentMixResults.cemento.volumen.toFixed(3)} ft¬≥</td>
                <td>$${currentMixResults.cemento.costo.toFixed(2)}</td>
            </tr>`;
            
            htmlCantidades += `<tr>
                <td><strong>Agua Efectiva</strong></td>
                <td>${currentMixResults.agua.peso.toFixed(1)} lb</td>
                <td>${currentMixResults.agua.volumen.toFixed(3)} ft¬≥</td>
                <td>$${currentMixResults.agua.costo.toFixed(2)}</td>
            </tr>`;
            
            htmlCantidades += `<tr>
                <td><strong>Agregado Grueso</strong></td>
                <td>${currentMixResults.grueso.peso.toFixed(1)} lb</td>
                <td>${currentMixResults.grueso.volumen.toFixed(3)} ft¬≥</td>
                <td>$${currentMixResults.grueso.costo.toFixed(2)}</td>
            </tr>`;
            
            if (currentMixResults.intermedio.peso > 0) {
                htmlCantidades += `<tr>
                    <td><strong>Agregado Intermedio</strong></td>
                    <td>${currentMixResults.intermedio.peso.toFixed(1)} lb</td>
                    <td>${currentMixResults.intermedio.volumen.toFixed(3)} ft¬≥</td>
                    <td>$${currentMixResults.intermedio.costo.toFixed(2)}</td>
                </tr>`;
            }
            
            htmlCantidades += `<tr>
                <td><strong>Arena 1</strong></td>
                <td>${currentMixResults.arena1.peso.toFixed(1)} lb</td>
                <td>${currentMixResults.arena1.volumen.toFixed(3)} ft¬≥</td>
                <td>$${currentMixResults.arena1.costo.toFixed(2)}</td>
            </tr>`;
            
            htmlCantidades += `<tr>
                <td><strong>Arena 2</strong></td>
                <td>${currentMixResults.arena2.peso.toFixed(1)} lb</td>
                <td>${currentMixResults.arena2.volumen.toFixed(3)} ft¬≥</td>
                <td>$${currentMixResults.arena2.costo.toFixed(2)}</td>
            </tr>`;
            
            if (currentMixResults.aditivo1.peso > 0 && currentMixResults.aditivo1.nombre) {
                const dosis1 = parseFloat(document.getElementById('dosis-aditivo1').value) || 0;
                htmlCantidades += `<tr style="background:#fffbeb">
                    <td><strong>${currentMixResults.aditivo1.nombre}</strong></td>
                    <td colspan="2" style="color:#92400e;font-style:italic">Rango: 0 to ${dosis1.toFixed(2)} oz/cwt</td>
                    <td>$${currentMixResults.aditivo1.costo.toFixed(2)}</td>
                </tr>`;
            }
            
            if (currentMixResults.aditivo2.peso > 0 && currentMixResults.aditivo2.nombre) {
                const dosis2 = parseFloat(document.getElementById('dosis-aditivo2').value) || 0;
                htmlCantidades += `<tr style="background:#fffbeb">
                    <td><strong>${currentMixResults.aditivo2.nombre}</strong></td>
                    <td colspan="2" style="color:#92400e;font-style:italic">Rango: 0 to ${dosis2.toFixed(2)} oz/cwt</td>
                    <td>$${currentMixResults.aditivo2.costo.toFixed(2)}</td>
                </tr>`;
            }
            
            if (currentMixResults.aditivo3.peso > 0 && currentMixResults.aditivo3.nombre) {
                const dosis3 = parseFloat(document.getElementById('dosis-aditivo3').value) || 0;
                htmlCantidades += `<tr style="background:#fffbeb">
                    <td><strong>${currentMixResults.aditivo3.nombre}</strong></td>
                    <td colspan="2" style="color:#92400e;font-style:italic">Rango: 0 to ${dosis3.toFixed(2)} oz/cwt</td>
                    <td>$${currentMixResults.aditivo3.costo.toFixed(2)}</td>
                </tr>`;
            }
            
            document.getElementById('resultados-cantidades').innerHTML = htmlCantidades;

            // Resumen
            let htmlResumen = `
                <tr><td><strong>Relaci√≥n W/C</strong></td><td>${currentMixResults.wc.toFixed(3)}</td></tr>
                <tr><td><strong>Volumen Total Arenas</strong></td><td>${currentMixResults.volumenArenas.toFixed(3)} ft¬≥</td></tr>
                <tr><td><strong>Peso Total</strong></td><td>${currentMixResults.pesoTotal.toFixed(1)} lb/yd¬≥</td></tr>
                <tr><td><strong>Rendimiento</strong></td><td>${currentMixResults.rendimiento.toFixed(2)} ft¬≥</td></tr>
                <tr><td><strong>Sacos de Cemento</strong></td><td>${currentMixResults.sacosCemento.toFixed(2)}</td></tr>
                <tr><td><strong>Costo Total</strong></td><td>$${currentMixResults.costoTotal.toFixed(2)}/yd¬≥</td></tr>
            `;
            document.getElementById('resultados-resumen').innerHTML = htmlResumen;

            // Costos
            const costoAgregados = currentMixResults.grueso.costo + currentMixResults.intermedio.costo + currentMixResults.arena1.costo + currentMixResults.arena2.costo;
            const costoAditivos = currentMixResults.aditivo1.costo + currentMixResults.aditivo2.costo + currentMixResults.aditivo3.costo;
            
            let htmlCostos = `
                <div class="alert success">
                    <div>
                        <strong>üí∞ Costo Total por Yarda C√∫bica: $${currentMixResults.costoTotal.toFixed(2)}</strong><br>
                        <small>Distribuido en: Cemento $${currentMixResults.cemento.costo.toFixed(2)} | 
                        Agregados $${costoAgregados.toFixed(2)} | 
                        Agua $${currentMixResults.agua.costo.toFixed(2)} | 
                        Aditivos $${costoAditivos.toFixed(2)}</small>
                    </div>
                </div>
            `;
            document.getElementById('resultados-costos').innerHTML = htmlCostos;

            window.scrollTo({ top: document.getElementById('mix-results').offsetTop - 20, behavior: 'smooth' });
        }

        document.getElementById('form-mixdesign').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentMixResults) {
                alert('‚ö†Ô∏è Primero debes calcular los vol√∫menes');
                return;
            }

            const mixDesign = {
                nombre: document.getElementById('mix-nombre').value,
                fecha: document.getElementById('mix-fecha').value,
                clienteId: document.getElementById('mix-cliente').value || null,
                proyectoId: document.getElementById('mix-proyecto').value || null,
                proyecto: document.getElementById('mix-proyecto').value,
                resistencia: parseFloat(document.getElementById('mix-resistencia').value),
                slump: parseFloat(document.getElementById('mix-slump').value),
                tma: parseFloat(document.getElementById('mix-tma').value),
                aplicacion: document.getElementById('mix-aplicacion').value,
                
                // Cemento - con peso directo
                tipoCemento: document.getElementById('tipo-cemento').value,
                pesoCemento: parseFloat(document.getElementById('peso-cemento').value),
                geCemento: parseFloat(document.getElementById('ge-cemento').value),
                precioCemento: parseFloat(document.getElementById('precio-cemento').value),
                
                // Agua - con peso directo
                pesoAgua: parseFloat(document.getElementById('peso-agua').value),
                precioAgua: parseFloat(document.getElementById('precio-agua').value),
                
                // Agregado grueso - con peso directo
                pesoGrueso: parseFloat(document.getElementById('peso-grueso').value),
                geGrueso: parseFloat(document.getElementById('ge-grueso').value),
                absGrueso: parseFloat(document.getElementById('abs-grueso').value),
                humGrueso: parseFloat(document.getElementById('hum-grueso').value),
                precioGrueso: parseFloat(document.getElementById('precio-grueso').value),
                pucGrueso: parseFloat(document.getElementById('puc-grueso').value),
                
                // Agregado intermedio - con peso directo
                pesoIntermedio: parseFloat(document.getElementById('peso-intermedio').value),
                geIntermedio: parseFloat(document.getElementById('ge-intermedio').value),
                absIntermedio: parseFloat(document.getElementById('abs-intermedio').value),
                humIntermedio: parseFloat(document.getElementById('hum-intermedio').value),
                precioIntermedio: parseFloat(document.getElementById('precio-intermedio').value),
                pucIntermedio: parseFloat(document.getElementById('puc-intermedio').value),
                
                // Arenas - calculadas por diferencia
                geArena1: parseFloat(document.getElementById('ge-arena1').value),
                absArena1: parseFloat(document.getElementById('abs-arena1').value),
                humArena1: parseFloat(document.getElementById('hum-arena1').value),
                mfArena1: parseFloat(document.getElementById('mf-arena1').value),
                precioArena1: parseFloat(document.getElementById('precio-arena1').value),
                pctArena1: parseFloat(document.getElementById('pct-arena1').value),
                
                geArena2: parseFloat(document.getElementById('ge-arena2').value),
                absArena2: parseFloat(document.getElementById('abs-arena2').value),
                humArena2: parseFloat(document.getElementById('hum-arena2').value),
                mfArena2: parseFloat(document.getElementById('mf-arena2').value),
                precioArena2: parseFloat(document.getElementById('precio-arena2').value),
                pctArena2: parseFloat(document.getElementById('pct-arena2').value),
                
                mfCombinado: parseFloat(document.getElementById('mf-combinado').textContent),
                
                // Aire
                contenidoAire: parseFloat(document.getElementById('contenido-aire').value),
                
                // Aditivos
                nombreAditivo1: document.getElementById('nombre-aditivo1').value,
                dosisAditivo1: parseFloat(document.getElementById('dosis-aditivo1').value) || 0,
                geAditivo1: parseFloat(document.getElementById('ge-aditivo1').value),
                precioAditivo1: parseFloat(document.getElementById('precio-aditivo1').value),
                
                nombreAditivo2: document.getElementById('nombre-aditivo2').value,
                dosisAditivo2: parseFloat(document.getElementById('dosis-aditivo2').value) || 0,
                geAditivo2: parseFloat(document.getElementById('ge-aditivo2').value),
                precioAditivo2: parseFloat(document.getElementById('precio-aditivo2').value),
                
                nombreAditivo3: document.getElementById('nombre-aditivo3').value,
                dosisAditivo3: parseFloat(document.getElementById('dosis-aditivo3').value) || 0,
                geAditivo3: parseFloat(document.getElementById('ge-aditivo3').value),
                precioAditivo3: parseFloat(document.getElementById('precio-aditivo3').value),
                
                resultados: currentMixResults,
                fechaCreacion: new Date().toISOString()
            };
            
            // Agregar resultados del c√°lculo
            mixDesign.resultados = currentMixResults;
            
            const editId = document.getElementById('edit-mixdesign-id');
            
            try {
                if (editId && editId.value) {
                    // Actualizar existente
                    mixDesign.id = parseInt(editId.value);
                    await updateRecord('mixdesigns', mixDesign);
                    alert('‚úÖ Mix Design actualizado exitosamente');
                } else {
                    // Crear nuevo
                    await addRecord('mixdesigns', mixDesign);
                    alert('‚úÖ Mix Design guardado exitosamente con ID: ' + mixDesign.mixId);
                }
                
                // Limpiar formulario y recargar lista
                clearForm('mixdesign');
                await loadMixDesigns();
                updateDashboard();
                
            } catch (error) {
                console.error('Error al guardar:', error);
                alert('‚ùå Error al guardar: ' + error.message);
            }


            // editId ya declarado arriba

            try {
                if (editId) {
                    mixDesign.id = parseInt(editId);
                    await updateRecord('mixdesigns', mixDesign);
                    alert('‚úÖ Mix Design actualizado');
                } else {
                    await addRecord('mixdesigns', mixDesign);
                document.getElementById('btn-reporte').disabled = false;
                document.getElementById('btn-reporte-download').disabled = false;
                    alert('‚úÖ Mix Design guardado');
                    document.getElementById('btn-reporte').disabled = false;
                document.getElementById('btn-reporte-download').disabled = false;
                }
                clearForm('mixdesign');
                loadMixDesigns();
                updateDashboard();
            } catch (error) {
                alert('‚ùå Error: ' + error);
            }
        });

        async function loadMixDesigns() {
            const mixdesigns = await getAllRecords('mixdesigns');
            const proyectos = await getAllRecords('proyectos');
            const container = document.getElementById('lista-mixdesigns');
            
            if (mixdesigns.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay mix designs</div>';
                return;
            }
            
            let html = '<table><thead><tr><th><input type="checkbox" id="select-all-mixdesigns" onchange="toggleAllMixDesigns(this)"></th><th>Nombre</th><th>Resistencia</th><th>W/C</th><th>Proyecto</th><th>Costo</th><th>Fecha</th><th>Acciones</th></tr></thead><tbody>';
            mixdesigns.forEach(m => {
                const proyecto = proyectos.find(p => p.id == m.proyecto);
                html += `<tr>
                    <td><input type="checkbox" class="mix-checkbox" data-id="${m.id}" onchange="updateSelectedCount()"></td>
                    <td><strong>${m.nombre}</strong></td>
                    <td>${m.resistencia} PSI</td>
                    <td>${m.resultados.wc.toFixed(2)}</td>
                    <td>${proyecto ? proyecto.nombre : '-'}</td>
                    <td>$${m.resultados.costoTotal.toFixed(2)}</td>
                    <td>${new Date(m.fechaCreacion).toLocaleDateString()}</td>
                    <td class="actions">
                        <button class="info" onclick="verMixDesign(${m.id})">Ver</button>
                        <button class="secondary" onclick="editMixDesign(${m.id})">Editar</button>
                        <button class="success" onclick="imprimirMixDesign(${m.id})" title="Imprimir Reporte">üñ®Ô∏è</button>
                        <button class="warning" onclick="generarReporteCostosGuardado(${m.id})" title="Reporte de Costos">üí∞</button>
                        <button class="danger" onclick="deleteMixDesign(${m.id})">Eliminar</button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
            updateSelectedCount();
        }

        // ============ FUNCI√ìN CENTRAL DE REPORTE HTML ============
        // Genera el mismo HTML que el bot√≥n "Reporte" pero recibiendo datos del mix guardado
        async function construirHTMLReporte(mix, clienteNombre, proyectoNombre, logoSrc) {
            const r = mix.resultados;
            const mixId = 'MIX-' + mix.id.toString().padStart(4, '0');
            const wc = r.wc ? r.wc.toFixed(3) : '0.000';
            const aplicacion = mix.aplicacion || '-';

            var html = '<!DOCTYPE html><html><head><meta charset="UTF-8">';
            html += '<title>MIX DESIGN SUBMITTAL - ' + mixId + '</title>';
            html += '<style>';
            html += 'body{font-family:Arial,sans-serif;margin:40px;background:white;color:#333}';
            html += '.logo{width:100%;height:auto;display:flex;align-items:center;justify-content:flex-start;margin:0 0 30px 0;padding:0}';
            html += '.header{text-align:center;border-bottom:3px solid #16a34a;padding-bottom:20px;margin-bottom:30px}';
            html += 'h1{color:#16a34a;font-size:2em;margin:0 0 10px 0}';
            html += 'h2{color:#16a34a;margin-top:30px;font-size:1.5em}';
            html += 'table{width:100%;border-collapse:collapse;margin:20px 0}';
            html += 'th,td{border:1px solid #ddd;padding:12px;text-align:left}';
            html += 'th{background:#16a34a;color:white;font-weight:bold}';
            html += '.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:20px 0}';
            html += '.item{background:#f8f9fa;padding:12px;border-radius:5px;border:1px solid #e0e0e0}';
            html += '.item strong{color:#16a34a}';
            html += '.signature-area{margin-top:50px;padding-top:20px;border-top:2px solid #333}';
            html += '.signature-box{display:inline-block;width:45%;margin:10px 2%}';
            html += '.signature-line{border-bottom:2px solid #333;min-height:60px;margin-bottom:5px;margin-top:30px}';
            html += '.signature-label{text-align:center;color:#666;font-size:14px;font-weight:600}';
            html += '@media print{body{margin:20px}}';
            html += '</style></head><body>';

            // Logo
            html += '<div class="logo">';
            if (logoSrc) {
                html += '<img src="' + logoSrc + '" alt="Logo Empresa" style="max-width:450px;max-height:180px;height:auto">';
            } else {
                html += '<img src="data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'450\' height=\'180\' viewBox=\'0 0 450 180\'%3E%3Crect width=\'450\' height=\'180\' fill=\'%2316a34a\' rx=\'8\'/%3E%3Ctext x=\'90\' y=\'35\' font-family=\'Arial,sans-serif\' font-size=\'20\' font-weight=\'bold\' fill=\'white\' text-anchor=\'middle\'%3EMIXTEC PRO%3C/text%3E%3C/svg%3E" alt="Logo" style="max-width:100%;height:auto">';
            }
            html += '</div>';

            // Header
            html += '<div class="header">';
            html += '<h1>MIX DESIGN SUBMITTAL</h1>';
            html += '<p style="font-size:14px;color:#666;margin:10px 0">Fecha: ' + new Date().toLocaleDateString('es-ES') + '</p>';
            html += '</div>';

            // Info General
            html += '<h2>Informaci√≥n General</h2>';
            html += '<div class="grid">';
            html += '<div class="item"><strong>Mix ID:</strong> ' + mixId + '</div>';
            html += '<div class="item"><strong>Nombre:</strong> ' + mix.nombre + '</div>';
            html += '<div class="item"><strong>Cliente:</strong> ' + clienteNombre + '</div>';
            html += '<div class="item"><strong>Proyecto:</strong> ' + proyectoNombre + '</div>';
            html += '<div class="item"><strong>Resistencia:</strong> ' + mix.resistencia + ' psi</div>';
            html += '<div class="item"><strong>Slump:</strong> ' + mix.slump + ' in</div>';
            html += '<div class="item"><strong>Relaci√≥n a/c:</strong> ' + wc + '</div>';
            html += '<div class="item"><strong>TMA:</strong> ' + mix.tma + ' in</div>';
            html += '<div class="item"><strong>Aplicaci√≥n:</strong> ' + aplicacion + '</div>';
            html += '</div>';

            // Cantidades
            html += '<h2>Cantidades por Yarda C√∫bica (yd¬≥)</h2>';
            html += '<table><thead><tr><th>Material</th><th>Peso (lb/yd¬≥)</th><th>Volumen (ft¬≥)</th></tr></thead><tbody>';

            if (r.cemento && r.cemento.peso)
                html += '<tr><td><strong>Cemento</strong></td><td>' + r.cemento.peso.toFixed(1) + '</td><td>' + r.cemento.volumen.toFixed(3) + '</td></tr>';

            if (r.agua && r.agua.peso)
                html += '<tr><td><strong>Agua</strong></td><td>' + r.agua.peso.toFixed(1) + '</td><td>' + r.agua.volumen.toFixed(3) + '</td></tr>';

            if (r.grueso && r.grueso.peso > 0)
                html += '<tr><td><strong>Agregado Grueso</strong></td><td>' + r.grueso.peso.toFixed(1) + '</td><td>' + r.grueso.volumen.toFixed(3) + '</td></tr>';

            if (r.intermedio && r.intermedio.peso > 0)
                html += '<tr><td><strong>Agregado Intermedio</strong></td><td>' + r.intermedio.peso.toFixed(1) + '</td><td>' + r.intermedio.volumen.toFixed(3) + '</td></tr>';

            if (r.arena1 && r.arena1.peso > 0)
                html += '<tr><td><strong>Arena 1</strong></td><td>' + r.arena1.peso.toFixed(1) + '</td><td>' + r.arena1.volumen.toFixed(3) + '</td></tr>';

            if (r.arena2 && r.arena2.peso > 0)
                html += '<tr><td><strong>Arena 2</strong></td><td>' + r.arena2.peso.toFixed(1) + '</td><td>' + r.arena2.volumen.toFixed(3) + '</td></tr>';

            if (r.aditivo1 && r.aditivo1.peso > 0 && r.aditivo1.nombre && mix.dosisAditivo1 > 0)
                html += '<tr><td><strong>' + r.aditivo1.nombre + '</strong></td><td colspan="2">Rango: 0 to ' + mix.dosisAditivo1.toFixed(2) + ' oz/cwt</td></tr>';

            if (r.aditivo2 && r.aditivo2.peso > 0 && r.aditivo2.nombre && mix.dosisAditivo2 > 0)
                html += '<tr><td><strong>' + r.aditivo2.nombre + '</strong></td><td colspan="2">Rango: 0 to ' + mix.dosisAditivo2.toFixed(2) + ' oz/cwt</td></tr>';

            if (r.aditivo3 && r.aditivo3.peso > 0 && r.aditivo3.nombre && mix.dosisAditivo3 > 0)
                html += '<tr><td><strong>' + r.aditivo3.nombre + '</strong></td><td colspan="2">Rango: 0 to ' + mix.dosisAditivo3.toFixed(2) + ' oz/cwt</td></tr>';

            html += '</tbody></table>';

            // Resumen
            html += '<h2>Resumen</h2>';
            html += '<div class="grid">';
            html += '<div class="item"><strong>Relaci√≥n W/C:</strong> ' + wc + '</div>';
            html += '<div class="item"><strong>Volumen Total Arenas:</strong> ' + (r.volumenArenas ? r.volumenArenas.toFixed(3) : '0.000') + ' ft¬≥</div>';
            html += '<div class="item"><strong>Peso Total:</strong> ' + (r.pesoTotal ? r.pesoTotal.toFixed(1) : '0') + ' lbs/yd¬≥</div>';
            html += '<div class="item"><strong>% Aire:</strong> ' + (r.aire || mix.contenidoAire || '0') + ' %</div>';
            html += '<div class="item"><strong>Rendimiento:</strong> ' + (r.rendimiento || 27) + ' ft¬≥</div>';
            html += '</div>';

            // Firmas
            html += '<div class="signature-area">';
            html += '<div class="signature-box">';
            html += '<div class="signature-line"></div>';
            html += '<div class="signature-label">Firma / Nombre</div>';
            html += '</div>';
            html += '<div class="signature-box">';
            html += '<div class="signature-line"></div>';
            html += '<div class="signature-label">Fecha</div>';
            html += '</div>';
            html += '<div style="clear:both"></div>';
            html += '</div>';

            html += '<p style="margin-top:40px;text-align:center;color:#666;font-size:12px">Generado: ' + new Date().toLocaleString('es-ES') + '</p>';
            html += '</body></html>';

            return html;
        }

        // Obtiene el logo guardado como promesa
        function obtenerLogo() {
            return new Promise((resolve) => {
                try {
                    const transaction = db.transaction(['settings'], 'readonly');
                    const store = transaction.objectStore('settings');
                    const request = store.get('logo');
                    request.onsuccess = () => resolve(request.result ? request.result.value : null);
                    request.onerror = () => resolve(null);
                } catch (e) {
                    resolve(logoEmpresa || null);
                }
            });
        }

        // ============ IMPRIMIR MIX DESIGN INDIVIDUAL ============
        async function imprimirMixDesign(id) {
            const mix = await getRecord('mixdesigns', id);
            if (!mix) { alert('‚ùå No se encontr√≥ el mix design'); return; }

            let clienteNombre = 'N/A';
            let proyectoNombre = 'N/A';

            if (mix.clienteId) {
                const clientes = await getAllRecords('clientes');
                const cliente = clientes.find(c => c.id == mix.clienteId);
                if (cliente) clienteNombre = cliente.nombre;
            }

            if (mix.proyectoId) {
                const proyectos = await getAllRecords('proyectos');
                const proyecto = proyectos.find(p => p.id == mix.proyectoId);
                if (proyecto) proyectoNombre = proyecto.nombre;
            }

            const logo = await obtenerLogo();
            const html = await construirHTMLReporte(mix, clienteNombre, proyectoNombre, logo);

            const win = window.open('', '_blank');
            if (!win) { alert('‚ùå Bloqueador de ventanas emergentes activo.'); return; }
            win.document.write(html);
            win.document.close();
            setTimeout(() => win.print(), 600);
        }

        // ============ GENERAR PDF CON M√öLTIPLES MIX DESIGNS ============
        async function generarPDFMultiple() {
            const selectedIds = getSelectedMixDesignIds();
            if (selectedIds.length === 0) { alert('‚ö†Ô∏è Selecciona al menos un mix design'); return; }

            if (selectedIds.length > 10) {
                if (!confirm(`Has seleccionado ${selectedIds.length} mix designs.\n\n¬øDeseas continuar?`)) return;
            }

            const mixdesigns = await getAllRecords('mixdesigns');
            const clientes   = await getAllRecords('clientes');
            const proyectos  = await getAllRecords('proyectos');
            const logo       = await obtenerLogo();

            const selectedMixes = selectedIds.map(id => mixdesigns.find(m => m.id === id)).filter(Boolean);
            if (selectedMixes.length === 0) { alert('‚ùå No se encontraron los mix designs seleccionados'); return; }

            const logoHtml = logo
                ? `<img src="${logo}" alt="Logo" style="max-height:70px;max-width:260px;width:auto;height:auto;object-fit:contain;">`
                : `<div style="background:#16a34a;color:white;font-weight:bold;font-size:18px;padding:10px 24px;border-radius:6px;">MIXTEC PRO</div>`;

            let pagesHtml = '';

            for (let index = 0; index < selectedMixes.length; index++) {
                const mix = selectedMixes[index];
                const r   = mix.resultados;
                const mixId      = 'MIX-' + mix.id.toString().padStart(4, '0');
                const wc         = r.wc ? r.wc.toFixed(3) : '0.000';
                const aplicacion = mix.aplicacion || '-';
                const clienteNombre  = mix.clienteId  ? (clientes.find(c => c.id == mix.clienteId)?.nombre  || 'N/A') : 'N/A';
                const proyectoNombre = mix.proyectoId ? (proyectos.find(p => p.id == mix.proyectoId)?.nombre || 'N/A') : 'N/A';

                // Materiales rows
                let matsRows = '';
                if (r.cemento   && r.cemento.peso   > 0) matsRows += `<tr><td>Cemento (${mix.tipoCemento || 'I'})</td><td>${r.cemento.peso.toFixed(1)}</td><td>${r.cemento.volumen.toFixed(3)}</td></tr>`;
                if (r.agua      && r.agua.peso       > 0) matsRows += `<tr><td>Agua Efectiva</td><td>${r.agua.peso.toFixed(1)}</td><td>${r.agua.volumen.toFixed(3)}</td></tr>`;
                if (r.grueso    && r.grueso.peso     > 0) matsRows += `<tr><td>Agregado Grueso</td><td>${r.grueso.peso.toFixed(1)}</td><td>${r.grueso.volumen.toFixed(3)}</td></tr>`;
                if (r.intermedio && r.intermedio.peso > 0) matsRows += `<tr><td>Agregado Intermedio</td><td>${r.intermedio.peso.toFixed(1)}</td><td>${r.intermedio.volumen.toFixed(3)}</td></tr>`;
                if (r.arena1    && r.arena1.peso     > 0) matsRows += `<tr><td>Arena 1</td><td>${r.arena1.peso.toFixed(1)}</td><td>${r.arena1.volumen.toFixed(3)}</td></tr>`;
                if (r.arena2    && r.arena2.peso     > 0) matsRows += `<tr><td>Arena 2</td><td>${r.arena2.peso.toFixed(1)}</td><td>${r.arena2.volumen.toFixed(3)}</td></tr>`;
                // Aditivos en formato RANGO
                if (r.aditivo1 && r.aditivo1.nombre && mix.dosisAditivo1 > 0) matsRows += `<tr class="aditivo-row"><td><strong>${r.aditivo1.nombre}</strong></td><td colspan="2">Rango: 0 to ${parseFloat(mix.dosisAditivo1).toFixed(2)} oz/cwt</td></tr>`;
                if (r.aditivo2 && r.aditivo2.nombre && mix.dosisAditivo2 > 0) matsRows += `<tr class="aditivo-row"><td><strong>${r.aditivo2.nombre}</strong></td><td colspan="2">Rango: 0 to ${parseFloat(mix.dosisAditivo2).toFixed(2)} oz/cwt</td></tr>`;
                if (r.aditivo3 && r.aditivo3.nombre && mix.dosisAditivo3 > 0) matsRows += `<tr class="aditivo-row"><td><strong>${r.aditivo3.nombre}</strong></td><td colspan="2">Rango: 0 to ${parseFloat(mix.dosisAditivo3).toFixed(2)} oz/cwt</td></tr>`;

                pagesHtml += `
                <div class="page">

                    <!-- ENCABEZADO con logo en cada p√°gina -->
                    <div class="page-header">
                        <div class="header-left">
                            <div class="doc-title">MIX DESIGN SUBMITTAL</div>
                            <div class="doc-sub">${index + 1} de ${selectedMixes.length} &nbsp;¬∑&nbsp; Generado: ${new Date().toLocaleDateString('es-ES')}</div>
                        </div>
                        <div class="header-right">${logoHtml}</div>
                    </div>

                    <!-- INFO GENERAL -->
                    <div class="section-title">Informaci√≥n General</div>
                    <div class="info-grid">
                        <div class="info-cell"><span class="lbl">Mix ID</span><span class="val">${mixId}</span></div>
                        <div class="info-cell"><span class="lbl">Nombre</span><span class="val">${mix.nombre}</span></div>
                        <div class="info-cell"><span class="lbl">Cliente</span><span class="val">${clienteNombre}</span></div>
                        <div class="info-cell"><span class="lbl">Proyecto</span><span class="val">${proyectoNombre}</span></div>
                        <div class="info-cell"><span class="lbl">Resistencia</span><span class="val green">${mix.resistencia} psi</span></div>
                        <div class="info-cell"><span class="lbl">Slump</span><span class="val">${mix.slump} in</span></div>
                        <div class="info-cell"><span class="lbl">Relaci√≥n a/c</span><span class="val">${wc}</span></div>
                        <div class="info-cell"><span class="lbl">TMA</span><span class="val">${mix.tma} in</span></div>
                        <div class="info-cell"><span class="lbl">% Aire</span><span class="val">${mix.contenidoAire || r.aire || '0'} %</span></div>
                        <div class="info-cell"><span class="lbl">Aplicaci√≥n</span><span class="val">${aplicacion}</span></div>
                    </div>

                    <!-- CANTIDADES -->
                    <div class="section-title">Cantidades por Yarda C√∫bica (yd¬≥)</div>
                    <table>
                        <thead><tr><th>Material</th><th>Peso (lb/yd¬≥)</th><th>Volumen (ft¬≥)</th></tr></thead>
                        <tbody>${matsRows}</tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td><strong>TOTAL</strong></td>
                                <td><strong>${r.pesoTotal ? r.pesoTotal.toFixed(1) : '-'}</strong></td>
                                <td><strong>27.000</strong></td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- FIRMAS -->
                    <div class="signatures">
                        <div class="sig-box"><div class="sig-line"></div><div class="sig-lbl">Preparado por / Fecha</div></div>
                        <div class="sig-box"><div class="sig-line"></div><div class="sig-lbl">Aprobado por / Fecha</div></div>
                    </div>

                </div>`;  // end .page
            }

            const fullHtml = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Mix Designs - Reporte M√∫ltiple</title>
<style>
    /* Reset y base */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, Helvetica, sans-serif; background: #e0e0e0; color: #222; font-size: 11px; }

    /* Cada p√°gina = una hoja */
    .page {
        width: 8.5in;
        min-height: 11in;
        max-height: 11in;
        overflow: hidden;
        background: white;
        margin: 0 auto 20px auto;
        padding: 0.45in 0.5in 0.35in 0.5in;
        display: flex;
        flex-direction: column;
        box-shadow: 0 2px 12px rgba(0,0,0,0.18);
        page-break-after: always;
        page-break-inside: avoid;
        break-after: page;
        break-inside: avoid;
    }
    .page:last-child { page-break-after: avoid; break-after: avoid; margin-bottom: 0; }

    /* Encabezado de cada p√°gina */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 3px solid #16a34a;
        padding-bottom: 10px;
        margin-bottom: 12px;
        flex-shrink: 0;
    }
    .doc-title { font-size: 20px; font-weight: bold; color: #16a34a; letter-spacing: 1px; }
    .doc-sub   { font-size: 10px; color: #666; margin-top: 3px; }
    .header-right { text-align: right; }

    /* T√≠tulos de secci√≥n */
    .section-title {
        background: #16a34a;
        color: white;
        font-weight: bold;
        font-size: 11px;
        padding: 5px 10px;
        margin: 10px 0 6px 0;
        letter-spacing: 0.5px;
        flex-shrink: 0;
    }

    /* Grid de info general */
    .info-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 5px;
        margin-bottom: 4px;
        flex-shrink: 0;
    }
    .info-cell {
        border: 1px solid #ddd;
        border-radius: 3px;
        padding: 5px 7px;
        display: flex;
        flex-direction: column;
    }
    .lbl { font-size: 9px; color: #888; font-weight: bold; text-transform: uppercase; }
    .val { font-size: 12px; font-weight: bold; color: #222; margin-top: 2px; }
    .val.green { color: #16a34a; font-size: 14px; }

    /* Tabla de materiales */
    table {
        width: 100%;
        border-collapse: collapse;
        flex-shrink: 0;
    }
    thead tr { background: #16a34a; }
    th { color: white; font-weight: bold; padding: 7px 10px; text-align: left; font-size: 11px; }
    td { padding: 6px 10px; border-bottom: 1px solid #eee; font-size: 11px; }
    tbody tr:nth-child(even) td { background: #f8fffe; }
    tfoot .total-row td { background: #f0fdf4; border-top: 2px solid #16a34a; padding: 7px 10px; }
    .aditivo-row td { background: #fffbeb; font-style: italic; color: #92400e; border-left: 3px solid #f59e0b; }

    /* Firmas */
    .signatures {
        display: flex;
        gap: 40px;
        margin-top: auto;
        padding-top: 14px;
        border-top: 1px solid #ccc;
        flex-shrink: 0;
    }
    .sig-box { flex: 1; }
    .sig-line { border-bottom: 1.5px solid #333; height: 38px; margin-bottom: 4px; }
    .sig-lbl  { text-align: center; font-size: 10px; color: #555; }

    /* PRINT: ocultar sombras, forzar colores */
    @media print {
        body { background: white !important; }
        .page {
            box-shadow: none !important;
            margin: 0 !important;
            width: 100% !important;
            min-height: 100vh !important;
            max-height: none !important;
            padding: 0.4in 0.45in 0.3in 0.45in !important;
        }
        thead tr { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .section-title { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
</style>
</head>
<body>${pagesHtml}</body>
</html>`;

            const win = window.open('', '_blank');
            if (!win) { alert('‚ùå Bloqueador de ventanas emergentes activo.'); return; }
            win.document.write(fullHtml);
            win.document.close();
            setTimeout(() => win.print(), 800);
        }

        function toggleAllMixDesigns(checkbox) {
            const checkboxes = document.querySelectorAll('.mix-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateSelectedCount();
        }

        function seleccionarTodosMixDesigns() {
            const checkboxes = document.querySelectorAll('.mix-checkbox');
            checkboxes.forEach(cb => cb.checked = true);
            document.getElementById('select-all-mixdesigns').checked = true;
            updateSelectedCount();
        }

        function deseleccionarTodosMixDesigns() {
            const checkboxes = document.querySelectorAll('.mix-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            document.getElementById('select-all-mixdesigns').checked = false;
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const selected = document.querySelectorAll('.mix-checkbox:checked');
            const count = selected.length;
            document.getElementById('count-selected').textContent = count;
            document.getElementById('count-selected-costos').textContent = count;
            document.getElementById('btn-generar-pdf-multiple').disabled = count === 0;
            document.getElementById('btn-generar-costos-multiple').disabled = count === 0;
        }

        function getSelectedMixDesignIds() {
            const selected = document.querySelectorAll('.mix-checkbox:checked');
            return Array.from(selected).map(cb => parseInt(cb.dataset.id));
        }

        // ============ IMPRIMIR MIX DESIGN INDIVIDUAL ============
        async function verMixDesign_PLACEHOLDER() {} // placeholder to maintain structure

        function buildMixPageHTML(mix, clienteNombre, proyectoNombre) {
            const mixId   = 'MIX-' + mix.id.toString().padStart(4, '0');
            const r       = mix.resultados;
            const wc      = r.wc ? r.wc.toFixed(3) : '0.000';
            const aplicacion = mix.aplicacion || '-';

            var h = '';

            // Logo
            h += '<div class="logo">';
            if (logoEmpresa) {
                h += '<img src="' + logoEmpresa + '" alt="Logo Empresa" style="max-width:450px;max-height:180px;height:auto">';
            } else {
                h += '<img src="data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'450\' height=\'180\' viewBox=\'0 0 450 180\'%3E%3Crect width=\'450\' height=\'180\' fill=\'%2316a34a\' rx=\'8\'/%3E%3Ctext x=\'225\' y=\'105\' font-family=\'Arial,sans-serif\' font-size=\'40\' font-weight=\'bold\' fill=\'white\' text-anchor=\'middle\'%3EMIXTEC PRO%3C/text%3E%3C/svg%3E" alt="Logo" style="max-width:450px;max-height:180px">';
            }
            h += '</div>';

            // Header
            h += '<div class="header">';
            h += '<h1>MIX DESIGN SUBMITTAL</h1>';
            h += '<p style="font-size:14px;color:#666;margin:10px 0">Fecha: ' + new Date().toLocaleDateString('es-ES') + '</p>';
            h += '</div>';

            // Informaci√≥n General
            h += '<h2>Informaci√≥n General</h2>';
            h += '<div class="grid">';
            h += '<div class="item"><strong>Mix ID:</strong> ' + mixId + '</div>';
            h += '<div class="item"><strong>Nombre:</strong> ' + mix.nombre + '</div>';
            h += '<div class="item"><strong>Cliente:</strong> ' + clienteNombre + '</div>';
            h += '<div class="item"><strong>Proyecto:</strong> ' + proyectoNombre + '</div>';
            h += '<div class="item"><strong>Resistencia:</strong> ' + mix.resistencia + ' psi</div>';
            h += '<div class="item"><strong>Slump:</strong> ' + mix.slump + ' in</div>';
            h += '<div class="item"><strong>Relaci√≥n a/c:</strong> ' + wc + '</div>';
            h += '<div class="item"><strong>TMA:</strong> ' + mix.tma + ' in</div>';
            h += '<div class="item"><strong>Aplicaci√≥n:</strong> ' + aplicacion + '</div>';
            h += '</div>';

            // Cantidades
            h += '<h2>Cantidades por Yarda C√∫bica (yd¬≥)</h2>';
            h += '<table><thead><tr><th>Material</th><th>Peso (lb/yd¬≥)</th><th>Volumen (ft¬≥)</th></tr></thead><tbody>';

            if (r.cemento && r.cemento.peso)
                h += '<tr><td><strong>Cemento</strong></td><td>' + r.cemento.peso.toFixed(1) + '</td><td>' + r.cemento.volumen.toFixed(3) + '</td></tr>';
            if (r.agua && r.agua.peso)
                h += '<tr><td><strong>Agua</strong></td><td>' + r.agua.peso.toFixed(1) + '</td><td>' + r.agua.volumen.toFixed(3) + '</td></tr>';
            if (r.grueso && r.grueso.peso > 0)
                h += '<tr><td><strong>Agregado Grueso</strong></td><td>' + r.grueso.peso.toFixed(1) + '</td><td>' + r.grueso.volumen.toFixed(3) + '</td></tr>';
            if (r.intermedio && r.intermedio.peso > 0)
                h += '<tr><td><strong>Agregado Intermedio</strong></td><td>' + r.intermedio.peso.toFixed(1) + '</td><td>' + r.intermedio.volumen.toFixed(3) + '</td></tr>';
            if (r.arena1 && r.arena1.peso > 0)
                h += '<tr><td><strong>Arena 1</strong></td><td>' + r.arena1.peso.toFixed(1) + '</td><td>' + r.arena1.volumen.toFixed(3) + '</td></tr>';
            if (r.arena2 && r.arena2.peso > 0)
                h += '<tr><td><strong>Arena 2</strong></td><td>' + r.arena2.peso.toFixed(1) + '</td><td>' + r.arena2.volumen.toFixed(3) + '</td></tr>';

            // Aditivos ‚Äî formato "Rango: 0 to X oz/cwt"
            [1, 2, 3].forEach(n => {
                const ad = r['aditivo' + n];
                const nombre = ad ? ad.nombre : (mix['nombreAditivo' + n] || '');
                const dosis  = parseFloat(mix['dosisAditivo' + n]) || 0;
                if (nombre && dosis > 0) {
                    h += '<tr style="background:#fffbeb"><td><strong>' + nombre + '</strong></td><td colspan="2" style="color:#92400e;font-style:italic">Rango: 0 to ' + dosis.toFixed(2) + ' oz/cwt</td></tr>';
                }
            });

            h += '</tbody></table>';

            // Resumen
            h += '<h2>Resumen</h2>';
            h += '<div class="grid">';
            h += '<div class="item"><strong>Relaci√≥n W/C:</strong> ' + wc + '</div>';
            h += '<div class="item"><strong>Volumen Total Arenas:</strong> ' + (r.volumenArenas ? r.volumenArenas.toFixed(3) : '0.000') + ' ft¬≥</div>';
            h += '<div class="item"><strong>Peso Total:</strong> ' + (r.pesoTotal ? r.pesoTotal.toFixed(1) : '0') + ' lbs/yd¬≥</div>';
            h += '<div class="item"><strong>% Aire:</strong> ' + (r.aire || mix.contenidoAire || '0') + ' %</div>';
            h += '<div class="item"><strong>Rendimiento:</strong> ' + (r.rendimiento || 27) + ' ft¬≥</div>';
            h += '</div>';

            // Firma
            h += '<div class="signature-area">';
            h += '<div class="signature-box"><div class="signature-line"></div><div class="signature-label">Firma / Nombre</div></div>';
            h += '<div class="signature-box"><div class="signature-line"></div><div class="signature-label">Fecha</div></div>';
            h += '<div style="clear:both"></div>';
            h += '</div>';

            h += '<p style="margin-top:40px;text-align:center;color:#666;font-size:12px">Generado: ' + new Date().toLocaleString('es-ES') + '</p>';

            return h;
        }

        async function verMixDesign(id) {
            const mix = await getRecord('mixdesigns', id);
            if (!mix) return;
            
            // Cargar listas primero
            await loadClientesSelect();
            await loadProyectosSelect();
            
            // Cargar valores b√°sicos en el formulario
            document.getElementById('mix-nombre').value = mix.nombre;
            document.getElementById('mix-fecha').value = mix.fecha;
            document.getElementById('mix-resistencia').value = mix.resistencia;
            document.getElementById('mix-slump').value = mix.slump;
            document.getElementById('mix-tma').value = mix.tma;
            document.getElementById('mix-aplicacion').value = mix.aplicacion || '';
            
            // Cargar cliente y proyecto con la secuencia correcta
            if (mix.clienteId) {
                // Si hay cliente, cargar cliente y filtrar proyectos
                document.getElementById('mix-cliente').value = mix.clienteId;
                await filtrarProyectosPorCliente();
                
                // Luego cargar el proyecto (ya filtrado)
                if (mix.proyectoId) {
                    document.getElementById('mix-proyecto').value = mix.proyectoId;
                }
            } else {
                // Si no hay cliente, solo cargar el proyecto de la lista completa
                if (mix.proyectoId) {
                    document.getElementById('mix-proyecto').value = mix.proyectoId;
                }
            }
            
            // Cemento - con peso directo
            document.getElementById('tipo-cemento').value = mix.tipoCemento;
            document.getElementById('peso-cemento').value = mix.pesoCemento || 564;
            document.getElementById('ge-cemento').value = mix.geCemento;
            document.getElementById('precio-cemento').value = mix.precioCemento;
            
            // Agua - con peso directo
            document.getElementById('peso-agua').value = mix.pesoAgua || 310;
            document.getElementById('precio-agua').value = mix.precioAgua;
            
            // Agregado grueso - con peso directo
            document.getElementById('peso-grueso').value = mix.pesoGrueso || 1800;
            document.getElementById('ge-grueso').value = mix.geGrueso;
            document.getElementById('abs-grueso').value = mix.absGrueso;
            document.getElementById('hum-grueso').value = mix.humGrueso;
            document.getElementById('precio-grueso').value = mix.precioGrueso;
            document.getElementById('puc-grueso').value = mix.pucGrueso;
            
            // Agregado intermedio - con peso directo
            document.getElementById('peso-intermedio').value = mix.pesoIntermedio || 0;
            document.getElementById('ge-intermedio').value = mix.geIntermedio || 2.62;
            document.getElementById('abs-intermedio').value = mix.absIntermedio || 1.8;
            document.getElementById('hum-intermedio').value = mix.humIntermedio || 1.0;
            document.getElementById('precio-intermedio').value = mix.precioIntermedio || 12.00;
            document.getElementById('puc-intermedio').value = mix.pucIntermedio || 100;
            
            // Arenas
            document.getElementById('ge-arena1').value = mix.geArena1;
            document.getElementById('abs-arena1').value = mix.absArena1;
            document.getElementById('hum-arena1').value = mix.humArena1;
            document.getElementById('mf-arena1').value = mix.mfArena1;
            document.getElementById('precio-arena1').value = mix.precioArena1;
            document.getElementById('pct-arena1').value = mix.pctArena1;
            
            document.getElementById('ge-arena2').value = mix.geArena2;
            document.getElementById('abs-arena2').value = mix.absArena2;
            document.getElementById('hum-arena2').value = mix.humArena2;
            document.getElementById('mf-arena2').value = mix.mfArena2;
            document.getElementById('precio-arena2').value = mix.precioArena2;
            document.getElementById('pct-arena2').value = mix.pctArena2;
            
            calcularModuloFinuraCombinado();
            
            // Aire
            document.getElementById('contenido-aire').value = mix.contenidoAire;
            
            // Aditivos
            document.getElementById('nombre-aditivo1').value = mix.nombreAditivo1 || '';
            document.getElementById('dosis-aditivo1').value = mix.dosisAditivo1 || 0;
            document.getElementById('ge-aditivo1').value = mix.geAditivo1;
            document.getElementById('precio-aditivo1').value = mix.precioAditivo1;
            
            document.getElementById('nombre-aditivo2').value = mix.nombreAditivo2 || '';
            document.getElementById('dosis-aditivo2').value = mix.dosisAditivo2 || 0;
            document.getElementById('ge-aditivo2').value = mix.geAditivo2;
            document.getElementById('precio-aditivo2').value = mix.precioAditivo2;
            
            document.getElementById('nombre-aditivo3').value = mix.nombreAditivo3 || '';
            document.getElementById('dosis-aditivo3').value = mix.dosisAditivo3 || 0;
            document.getElementById('ge-aditivo3').value = mix.geAditivo3;
            document.getElementById('precio-aditivo3').value = mix.precioAditivo3;
            
            // Recalcular el mix design con los valores cargados
            calcularMixDesign();
            
            switchTab('mixdesign');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function editMixDesign(id) {
            const mix = await getRecord('mixdesigns', id);
            if (!mix) return;
            
            document.getElementById('edit-mixdesign-id').value = mix.id;
            await verMixDesign(id);
        }

        async function deleteMixDesign(id) {
            if (confirm('¬øEliminar este mix design?')) {
                await deleteRecord('mixdesigns', id);
                loadMixDesigns();
                updateDashboard();
            }
        }

        function filterMixDesigns() {
            const search = document.getElementById('search-mixdesigns').value.toLowerCase();
            document.querySelectorAll('#lista-mixdesigns table tbody tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

                        



        // ============ TRIAL MIXES ============
        
        async function loadMixDesignsSelect() {
            const mixdesigns = await getAllRecords('mixdesigns');
            const select = document.getElementById('trial-mixdesign');
            select.innerHTML = '<option value="">Seleccionar...</option>';
            mixdesigns.forEach(m => {
                select.innerHTML += `<option value="${m.id}">${m.nombre} - ${m.resistencia} PSI</option>`;
            });
        }

        async function generarTrialId() {
            const trials = await getAllRecords('trials');
            const fecha = new Date();
            const a√±o = fecha.getFullYear().toString().substr(-2);
            const mes = String(fecha.getMonth() + 1).padStart(2, '0');
            const numero = String(trials.length + 1).padStart(4, '0');
            return `TM-${a√±o}${mes}-${numero}`;
        }

        async function cargarInfoMixDesign() {
            const mixId = document.getElementById('trial-mixdesign').value;
            if (!mixId) {
                document.getElementById('mix-design-preview').style.display = 'none';
                document.getElementById('trial-cantidades').style.display = 'none';
                return;
            }

            const mix = await getRecord('mixdesigns', parseInt(mixId));
            if (!mix) return;

            document.getElementById('preview-nombre').textContent = mix.nombre;
            document.getElementById('preview-resistencia').textContent = `${mix.resistencia} PSI`;
            document.getElementById('preview-wc').textContent = mix.resultados.wc.toFixed(2);
            document.getElementById('preview-slump').textContent = `${mix.slump} in`;
            
            document.getElementById('mix-design-preview').style.display = 'block';
            
            if (document.getElementById('trial-tamano').value) {
                calcularCantidadesTrial();
            }
        }

        async function calcularCantidadesTrial() {
            const mixId = document.getElementById('trial-mixdesign').value;
            let tamano = document.getElementById('trial-tamano').value;
            
            if (!mixId || !tamano) {
                document.getElementById('trial-cantidades').style.display = 'none';
                return;
            }

            // Mostrar/ocultar campo personalizado
            if (tamano === 'custom') {
                document.getElementById('trial-tamano-custom-group').style.display = 'block';
                tamano = parseFloat(document.getElementById('trial-tamano-custom').value);
                if (!tamano || tamano <= 0) {
                    document.getElementById('trial-cantidades').style.display = 'none';
                    return;
                }
            } else {
                document.getElementById('trial-tamano-custom-group').style.display = 'none';
                tamano = parseFloat(tamano);
            }

            const mix = await getRecord('mixdesigns', parseInt(mixId));
            if (!mix || !mix.resultados) return;

            // Factor de conversi√≥n: tamano est√° en ft¬≥, resultados est√°n por yd¬≥ (27 ft¬≥)
            const factor = tamano / 27;
            
            let html = '';
            html += `<tr><td><strong>Cemento</strong></td><td>${(mix.resultados.cemento.peso * factor).toFixed(1)} lb</td></tr>`;
            html += `<tr><td><strong>Agua Efectiva</strong></td><td>${(mix.resultados.agua.peso * factor).toFixed(1)} lb</td></tr>`;
            html += `<tr><td><strong>Agregado Grueso</strong></td><td>${(mix.resultados.grueso.peso * factor).toFixed(1)} lb</td></tr>`;
            
            if (mix.resultados.intermedio && mix.resultados.intermedio.peso > 0) {
                html += `<tr><td><strong>Agregado Intermedio</strong></td><td>${(mix.resultados.intermedio.peso * factor).toFixed(1)} lb</td></tr>`;
            }
            
            html += `<tr><td><strong>Arena 1</strong></td><td>${(mix.resultados.arena1.peso * factor).toFixed(1)} lb</td></tr>`;
            html += `<tr><td><strong>Arena 2</strong></td><td>${(mix.resultados.arena2.peso * factor).toFixed(1)} lb</td></tr>`;
            
            if (mix.resultados.aditivo1.peso > 0 && mix.resultados.aditivo1.nombre) {
                html += `<tr><td><strong>${mix.resultados.aditivo1.nombre}</strong></td><td>${(mix.resultados.aditivo1.peso * factor).toFixed(2)} lb</td></tr>`;
            }
            if (mix.resultados.aditivo2.peso > 0 && mix.resultados.aditivo2.nombre) {
                html += `<tr><td><strong>${mix.resultados.aditivo2.nombre}</strong></td><td>${(mix.resultados.aditivo2.peso * factor).toFixed(2)} lb</td></tr>`;
            }
            if (mix.resultados.aditivo3.peso > 0 && mix.resultados.aditivo3.nombre) {
                html += `<tr><td><strong>${mix.resultados.aditivo3.nombre}</strong></td><td>${(mix.resultados.aditivo3.peso * factor).toFixed(2)} lb</td></tr>`;
            }
            
            document.getElementById('trial-cantidades-tabla').innerHTML = html;
            document.getElementById('trial-cantidades').style.display = 'block';
        }

        function generarCamposCilindros() {
            const numCilindros = parseInt(document.getElementById('trial-num-cilindros').value) || 0;
            const container = document.getElementById('cilindros-container');
            
            if (numCilindros === 0) {
                container.innerHTML = '';
                return;
            }

            let html = '';
            for (let i = 1; i <= numCilindros; i++) {
                html += `
                    <div class="cylinder-item">
                        <div class="number">${i}</div>
                        <div class="fields">
                            <div class="form-group">
                                <label>D√≠as de Curado</label>
                                <select id="cilindro-${i}-dias" onchange="calcularFechaRotura(${i})">
                                    <option value="7">7 d√≠as</option>
                                    <option value="14">14 d√≠as</option>
                                    <option value="28" selected>28 d√≠as</option>
                                    <option value="56">56 d√≠as</option>
                                    <option value="custom">Personalizado</option>
                                </select>
                            </div>
                            <div class="form-group" id="cilindro-${i}-dias-custom-group" style="display: none;">
                                <label>D√≠as Personalizados</label>
                                <input type="number" id="cilindro-${i}-dias-custom" min="1" onchange="calcularFechaRotura(${i})">
                            </div>
                            <div class="form-group">
                                <label>Fecha de Ensayo <small>(auto-calculada)</small></label>
                                <input type="date" id="cilindro-${i}-fecha" readonly class="calculated">
                            </div>
                            <div class="form-group">
                                <label>Resistencia (PSI)</label>
                                <input type="number" id="cilindro-${i}-resistencia" step="1" placeholder="ej: 3250">
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;

            // Agregar listeners para d√≠as personalizados
            for (let i = 1; i <= numCilindros; i++) {
                document.getElementById(`cilindro-${i}-dias`).addEventListener('change', function() {
                    const customGroup = document.getElementById(`cilindro-${i}-dias-custom-group`);
                    customGroup.style.display = this.value === 'custom' ? 'block' : 'none';
                });
                
                // Calcular fecha inicial
                calcularFechaRotura(i);
            }
        }

        function calcularFechaRotura(cilindroNum) {
            const fechaTrial = document.getElementById('trial-fecha').value;
            if (!fechaTrial) return;
            
            let diasCurado = document.getElementById(`cilindro-${cilindroNum}-dias`).value;
            
            if (diasCurado === 'custom') {
                diasCurado = parseInt(document.getElementById(`cilindro-${cilindroNum}-dias-custom`).value) || 0;
            } else {
                diasCurado = parseInt(diasCurado);
            }
            
            if (diasCurado > 0) {
                const fechaBase = new Date(fechaTrial);
                fechaBase.setDate(fechaBase.getDate() + diasCurado);
                
                // Formatear fecha para input type="date" (YYYY-MM-DD)
                const fechaFormateada = fechaBase.toISOString().split('T')[0];
                document.getElementById(`cilindro-${cilindroNum}-fecha`).value = fechaFormateada;
            }
        }

        
        // ============ REPORTE MIX DESIGN ============
        
        // FUNCI√ìN DE PRUEBA - Reporte simple
        function generarReportePrueba() {
            const html = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Prueba Reporte</title>
    <style>
        body { font-family: Arial; margin: 40px; }
        h1 { color: #16a34a; }
    </style>
</head>
<body>
    <h1>Reporte de Prueba</h1>
    <p>Si ves esto, la funci√≥n de reporte est√° funcionando correctamente.</p>
    <p>Fecha: ${new Date().toLocaleString()}</p>
</body>
</html>`;
            
            const win = window.open('', '_blank');
            if (win) {
                win.document.write(html);
                win.document.close();
                alert('‚úÖ La funci√≥n de reporte funciona correctamente!');
            } else {
                alert('‚ùå Bloqueador de ventanas emergentes activado. Por favor permite ventanas emergentes para este sitio.');
            }
        }

        
        // Funci√≥n para DESCARGAR el reporte como HTML
        async function descargarReporteMixDesign() {
            console.log('Descargando reporte...');
            
            if (!currentMixResults) {
                alert('‚ö†Ô∏è Primero calcula el mix design');
                return;
            }

            try {
                const nombre = document.getElementById('mix-nombre') ? document.getElementById('mix-nombre').value : 'Sin nombre';
                
                
                // Obtener Cliente y Proyecto directamente de los selects
                let clienteNombre = 'N/A';
                let proyectoNombre = 'N/A';
                
                const clienteSelect = document.getElementById('mix-cliente');
                const proyectoSelect = document.getElementById('mix-proyecto');
                
                console.log('Cliente Select:', clienteSelect ? clienteSelect.value : 'no existe');
                console.log('Proyecto Select:', proyectoSelect ? proyectoSelect.value : 'no existe');
                
                // Obtener Cliente
                if (clienteSelect && clienteSelect.value) {
                    const clienteId = parseInt(clienteSelect.value);
                    console.log('Buscando cliente ID:', clienteId);
                    try {
                        const clientes = await getAllRecords('clientes');
                        console.log('Clientes disponibles:', clientes.length);
                        const cliente = clientes.find(c => c.id === clienteId);
                        if (cliente) {
                            clienteNombre = cliente.nombre || 'N/A';
                            console.log('Cliente encontrado:', clienteNombre);
                        } else {
                            console.log('Cliente no encontrado en la lista');
                        }
                    } catch (e) {
                        console.log('Error al obtener cliente:', e);
                    }
                }
                
                console.log('Cliente final:', clienteNombre);
                
                // Obtener Proyecto
                if (proyectoSelect && proyectoSelect.value) {
                    const proyectoId = parseInt(proyectoSelect.value);
                    try {
                        const proyectos = await getAllRecords('proyectos');
                        const proyecto = proyectos.find(p => p.id === proyectoId);
                        if (proyecto) {
                            proyectoNombre = proyecto.nombre || 'N/A';
                        }
                    } catch (e) {
                        console.log('No se pudo obtener proyecto:', e);
                    }
                }
                
                
                
                // Obtener Cliente y Proyecto
                const resistencia = document.getElementById('mix-resistencia') ? document.getElementById('mix-resistencia').value : '0';
                const slump = document.getElementById('mix-slump') ? document.getElementById('mix-slump').value : '0';
                const tma = document.getElementById('mix-tma') ? document.getElementById('mix-tma').value : '0';
                const aplicacion = document.getElementById('mix-aplicacion') ? document.getElementById('mix-aplicacion').value : '-';
                const wc = currentMixResults.wc ? currentMixResults.wc.toFixed(3) : '0.000';
                
                let mixId = 'MIX-0001';
                const mixIdDisplay = document.getElementById('mix-id-display');
                if (mixIdDisplay && mixIdDisplay.value) {
                    mixId = mixIdDisplay.value;
                } else {
                    const timestamp = Date.now().toString().slice(-4);
                    mixId = 'MIX-' + timestamp;
                }
                
                var html = '<!DOCTYPE html><html><head><meta charset="UTF-8">';
                html += '<title>MIX DESIGN SUBMITTAL - ' + mixId + '</title>';
                html += '<style>';
                html += 'body{font-family:Arial,sans-serif;margin:40px;background:white;color:#333}';
                html += '.logo{width:100%;height:auto;display:flex;align-items:center;justify-content:flex-start;margin:0 0 30px 0;padding:0}';
                html += '.header{text-align:center;border-bottom:3px solid #16a34a;padding-bottom:20px;margin-bottom:30px}';
                html += 'h1{color:#16a34a;font-size:2em;margin:0 0 10px 0}';
                html += 'h2{color:#16a34a;margin-top:30px;font-size:1.5em}';
                html += 'table{width:100%;border-collapse:collapse;margin:20px 0}';
                html += 'th,td{border:1px solid #ddd;padding:12px;text-align:left}';
                html += 'th{background:#16a34a;color:white;font-weight:bold}';
                html += '.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:20px 0}';
                html += '.item{background:#f8f9fa;padding:12px;border-radius:5px;border:1px solid #e0e0e0}';
                html += '.item strong{color:#16a34a}';
                html += '.signature-area{margin-top:50px;padding-top:20px;border-top:2px solid #333}';
                html += '.signature-box{display:inline-block;width:45%;margin:10px 2%}';
                html += '.signature-line{border-bottom:2px solid #333;min-height:60px;margin-bottom:5px;margin-top:30px}';
                html += '.signature-label{text-align:center;color:#666;font-size:14px;font-weight:600}';
                html += '@media print{body{margin:20px}}';
                html += '</style></head><body>';
                
                html += '<div class="logo">';
                if (logoEmpresa) {
                    html += '<img src="' + logoEmpresa + '" alt="Logo Empresa" style="max-width:450px;max-height:180px;height:auto">';
                } else {
                    html += '<img src="data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'450\' height=\'180\' viewBox=\'0 0 450 180\'%3E%3Crect width=\'450\' height=\'180\' fill=\'%2316a34a\' rx=\'8\'/%3E%3Ctext x=\'90\' y=\'35\' font-family=\'Arial,sans-serif\' font-size=\'20\' font-weight=\'bold\' fill=\'white\' text-anchor=\'middle\'%3EMIXTEC PRO%3C/text%3E%3C/svg%3E" alt="Logo" style="max-width:100%;height:auto">';
                }
                html += '</div>';
                html += '<div class="header">';
                html += '<h1>MIX DESIGN SUBMITTAL</h1>';
                html += '<p style="font-size:14px;color:#666;margin:10px 0">Fecha: ' + new Date().toLocaleDateString('es-ES') + '</p>';
                html += '</div>';
                
                html += '<h2>Informaci√≥n General</h2>';
                html += '<div class="grid">';
                html += '<div class="item"><strong>Mix ID:</strong> ' + mixId + '</div>';
                html += '<div class="item"><strong>Nombre:</strong> ' + nombre + '</div>';
                html += '<div class="item"><strong>Cliente:</strong> ' + clienteNombre + '</div>';
                html += '<div class="item"><strong>Proyecto:</strong> ' + proyectoNombre + '</div>';
                html += '<div class="item"><strong>Resistencia:</strong> ' + resistencia + ' psi</div>';
                html += '<div class="item"><strong>Slump:</strong> ' + slump + ' in</div>';
                html += '<div class="item"><strong>Relaci√≥n a/c:</strong> ' + wc + '</div>';
                html += '<div class="item"><strong>TMA:</strong> ' + tma + ' in</div>';
                html += '<div class="item"><strong>Aplicaci√≥n:</strong> ' + aplicacion + '</div>';
                html += '</div>';
                
                html += '<h2>Cantidades por Yarda C√∫bica (yd¬≥)</h2>';
                html += '<table><thead><tr><th>Material</th><th>Peso (lb/yd¬≥)</th><th>Volumen (ft¬≥)</th></tr></thead><tbody>';
                
                if (currentMixResults.cemento && currentMixResults.cemento.peso) {
                    html += '<tr><td><strong>Cemento</strong></td><td>' + currentMixResults.cemento.peso.toFixed(1) + '</td><td>' + currentMixResults.cemento.volumen.toFixed(3) + '</td></tr>';
                }
                
                if (currentMixResults.agua && currentMixResults.agua.peso) {
                    html += '<tr><td><strong>Agua</strong></td><td>' + currentMixResults.agua.peso.toFixed(1) + '</td><td>' + currentMixResults.agua.volumen.toFixed(3) + '</td></tr>';
                }
                
                if (currentMixResults.grueso && currentMixResults.grueso.peso > 0) {
                    html += '<tr><td><strong>Agregado Grueso</strong></td><td>' + currentMixResults.grueso.peso.toFixed(1) + '</td><td>' + currentMixResults.grueso.volumen.toFixed(3) + '</td></tr>';
                }
                
                if (currentMixResults.intermedio && currentMixResults.intermedio.peso > 0) {
                    html += '<tr><td><strong>Agregado Intermedio</strong></td><td>' + currentMixResults.intermedio.peso.toFixed(1) + '</td><td>' + currentMixResults.intermedio.volumen.toFixed(3) + '</td></tr>';
                }
                
                if (currentMixResults.arena1 && currentMixResults.arena1.peso > 0) {
                    html += '<tr><td><strong>Arena 1</strong></td><td>' + currentMixResults.arena1.peso.toFixed(1) + '</td><td>' + currentMixResults.arena1.volumen.toFixed(3) + '</td></tr>';
                }
                
                if (currentMixResults.arena2 && currentMixResults.arena2.peso > 0) {
                    html += '<tr><td><strong>Arena 2</strong></td><td>' + currentMixResults.arena2.peso.toFixed(1) + '</td><td>' + currentMixResults.arena2.volumen.toFixed(3) + '</td></tr>';
                }
                
                // Aditivos ‚Äî formato "Rango: 0 to X oz/cwt"
                [1, 2, 3].forEach(n => {
                    const ad = currentMixResults['aditivo' + n];
                    const dosisInput = document.getElementById('dosis-aditivo' + n);
                    const nombre = ad ? ad.nombre : '';
                    const dosis  = dosisInput ? parseFloat(dosisInput.value) || 0 : 0;
                    if (nombre && dosis > 0) {
                        html += '<tr style="background:#fffbeb"><td><strong>' + nombre + '</strong></td><td colspan="2" style="color:#92400e;font-style:italic">Rango: 0 to ' + dosis.toFixed(2) + ' oz/cwt</td></tr>';
                    }
                });
                
                html += '</tbody></table>';
                
                html += '<h2>Resumen</h2>';
                html += '<div class="grid">';
                html += '<div class="item"><strong>Relaci√≥n W/C:</strong> ' + wc + '</div>';
                html += '<div class="item"><strong>Volumen Total Arenas:</strong> ' + (currentMixResults.volumenArenas ? currentMixResults.volumenArenas.toFixed(3) : '0.000') + ' ft¬≥</div>';
                html += '<div class="item"><strong>Peso Total:</strong> ' + (currentMixResults.pesoTotal ? currentMixResults.pesoTotal.toFixed(1) : '0') + ' lbs/yd¬≥</div>';
                html += '<div class="item"><strong>% Aire:</strong> ' + (currentMixResults.aire || '0') + ' %</div>';
                html += '<div class="item"><strong>Rendimiento:</strong> ' + (currentMixResults.rendimiento || 27) + ' ft¬≥</div>';
                html += '</div>';
                
                html += '<div class="signature-area">';
                html += '<div class="signature-box">';
                html += '<div class="signature-line" contenteditable="true"></div>';
                html += '<div class="signature-label">Firma / Nombre</div>';
                html += '</div>';
                html += '<div class="signature-box">';
                html += '<div class="signature-line" contenteditable="true"></div>';
                html += '<div class="signature-label">Fecha</div>';
                html += '</div>';
                html += '<div style="clear:both"></div>';
                html += '</div>';
                
                html += '<p style="margin-top:40px;text-align:center;color:#666;font-size:12px">Generado: ' + new Date().toLocaleString('es-ES') + '</p>';
                html += '</body></html>';
                
                // Crear blob y descargar
                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'MixDesign_' + mixId + '_' + new Date().toISOString().slice(0,10) + '.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('‚úÖ Reporte descargado! Abre el archivo para verlo e imprimirlo.');
                
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error: ' + error.message);
            }
        }

        async function generarReporteMixDesign() {
            console.log('=== INICIO DEBUG ===');
            console.log('currentMixResults:', currentMixResults);
            
            if (!currentMixResults) {
                const debugHtml = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>DEBUG</title></head><body>
                <h1 style="color:red">‚ö†Ô∏è currentMixResults est√° NULL</h1>
                <p>Debes hacer click en "Calcular Vol√∫menes" primero.</p>
                </body></html>`;
                const win = window.open('', '_blank');
                win.document.write(debugHtml);
                win.document.close();
                return;
            }

            try {
                const nombre = document.getElementById('mix-nombre') ? document.getElementById('mix-nombre').value : 'Sin nombre';
                const resistencia = document.getElementById('mix-resistencia') ? document.getElementById('mix-resistencia').value : '0';
                const slump = document.getElementById('mix-slump') ? document.getElementById('mix-slump').value : '0';
                const tma = document.getElementById('mix-tma') ? document.getElementById('mix-tma').value : '0';
                const aplicacion = document.getElementById('mix-aplicacion') ? document.getElementById('mix-aplicacion').value : '-';
                const wc = currentMixResults.wc ? currentMixResults.wc.toFixed(3) : '0.000';
                
                let mixId = 'MIX-0001';
                const mixIdDisplay = document.getElementById('mix-id-display');
                if (mixIdDisplay && mixIdDisplay.value) {
                    mixId = mixIdDisplay.value;
                } else {
                    const timestamp = Date.now().toString().slice(-4);
                    mixId = 'MIX-' + timestamp;
                }
                
                console.log('Generando reporte...');
                
                var html = '<!DOCTYPE html><html><head><meta charset="UTF-8">';
                html += '<title>MIX DESIGN SUBMITTAL</title>';
                html += '<style>';
                html += 'body{font-family:Arial,sans-serif;margin:40px;background:white;color:#333}';
                html += '.logo{width:100%;height:auto;display:flex;align-items:center;justify-content:flex-start;margin:0 0 30px 0;padding:0}';
                html += '.header{text-align:center;border-bottom:3px solid #16a34a;padding-bottom:20px;margin-bottom:30px}';
                html += 'h1{color:#16a34a;font-size:2em;margin:0 0 10px 0}';
                html += 'h2{color:#16a34a;margin-top:30px;font-size:1.5em}';
                html += 'table{width:100%;border-collapse:collapse;margin:20px 0}';
                html += 'th,td{border:1px solid #ddd;padding:12px;text-align:left}';
                html += 'th{background:#16a34a;color:white;font-weight:bold}';
                html += '.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:20px 0}';
                html += '.item{background:#f8f9fa;padding:12px;border-radius:5px;border:1px solid #e0e0e0}';
                html += '.item strong{color:#16a34a}';
                html += '.signature-area{margin-top:50px;padding-top:20px;border-top:2px solid #333}';
                html += '.signature-box{display:inline-block;width:45%;margin:10px 2%}';
                html += '.signature-line{border-bottom:2px solid #333;min-height:60px;margin-bottom:5px;margin-top:30px}';
                html += '.signature-label{text-align:center;color:#666;font-size:14px;font-weight:600}';
                html += '@media print{body{margin:20px}}';
                html += '</style></head><body>';
                
                html += '<div class="logo">';
                if (logoEmpresa) {
                    html += '<img src="' + logoEmpresa + '" alt="Logo Empresa" style="max-width:450px;max-height:180px;height:auto">';
                } else {
                    html += '<img src="data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'450\' height=\'180\' viewBox=\'0 0 450 180\'%3E%3Crect width=\'450\' height=\'180\' fill=\'%2316a34a\' rx=\'8\'/%3E%3Ctext x=\'90\' y=\'35\' font-family=\'Arial,sans-serif\' font-size=\'20\' font-weight=\'bold\' fill=\'white\' text-anchor=\'middle\'%3EMIXTEC PRO%3C/text%3E%3C/svg%3E" alt="Logo" style="max-width:100%;height:auto">';
                }
                html += '</div>';
                html += '<div class="header">';
                html += '<h1>MIX DESIGN SUBMITTAL</h1>';
                html += '<p style="font-size:14px;color:#666;margin:10px 0">Fecha: ' + new Date().toLocaleDateString('es-ES') + '</p>';
                html += '</div>';
                
                html += '<h2>Informaci√≥n General</h2>';
                html += '<div class="grid">';
                html += '<div class="item"><strong>Mix ID:</strong> ' + mixId + '</div>';
                html += '<div class="item"><strong>Nombre:</strong> ' + nombre + '</div>';
                html += '<div class="item"><strong>Cliente:</strong> ' + clienteNombre + '</div>';
                html += '<div class="item"><strong>Proyecto:</strong> ' + proyectoNombre + '</div>';
                html += '<div class="item"><strong>Resistencia:</strong> ' + resistencia + ' psi</div>';
                html += '<div class="item"><strong>Slump:</strong> ' + slump + ' in</div>';
                html += '<div class="item"><strong>Relaci√≥n a/c:</strong> ' + wc + '</div>';
                html += '<div class="item"><strong>TMA:</strong> ' + tma + ' in</div>';
                html += '<div class="item"><strong>Aplicaci√≥n:</strong> ' + aplicacion + '</div>';
                html += '</div>';
                
                html += '<h2>Cantidades por Yarda C√∫bica (yd¬≥)</h2>';
                html += '<table>';
                html += '<thead><tr><th>Material</th><th>Peso (lb/yd¬≥)</th><th>Volumen (ft¬≥)</th></tr></thead>';
                html += '<tbody>';
                
                if (currentMixResults.cemento && currentMixResults.cemento.peso) {
                    html += '<tr><td><strong>Cemento</strong></td><td>' + currentMixResults.cemento.peso.toFixed(1) + '</td><td>' + currentMixResults.cemento.volumen.toFixed(3) + '</td></tr>';
                }
                
                if (currentMixResults.agua && currentMixResults.agua.peso) {
                    html += '<tr><td><strong>Agua</strong></td><td>' + currentMixResults.agua.peso.toFixed(1) + '</td><td>' + currentMixResults.agua.volumen.toFixed(3) + '</td></tr>';
                }
                
                if (currentMixResults.grueso && currentMixResults.grueso.peso > 0) {
                    html += '<tr><td><strong>Agregado Grueso</strong></td><td>' + currentMixResults.grueso.peso.toFixed(1) + '</td><td>' + currentMixResults.grueso.volumen.toFixed(3) + '</td></tr>';
                }
                
                if (currentMixResults.intermedio && currentMixResults.intermedio.peso > 0) {
                    html += '<tr><td><strong>Agregado Intermedio</strong></td><td>' + currentMixResults.intermedio.peso.toFixed(1) + '</td><td>' + currentMixResults.intermedio.volumen.toFixed(3) + '</td></tr>';
                }
                
                if (currentMixResults.arena1 && currentMixResults.arena1.peso > 0) {
                    html += '<tr><td><strong>Arena 1</strong></td><td>' + currentMixResults.arena1.peso.toFixed(1) + '</td><td>' + currentMixResults.arena1.volumen.toFixed(3) + '</td></tr>';
                }
                
                if (currentMixResults.arena2 && currentMixResults.arena2.peso > 0) {
                    html += '<tr><td><strong>Arena 2</strong></td><td>' + currentMixResults.arena2.peso.toFixed(1) + '</td><td>' + currentMixResults.arena2.volumen.toFixed(3) + '</td></tr>';
                }
                
                // Aditivos - Solo rangos
                if (currentMixResults.aditivo1 && currentMixResults.aditivo1.peso > 0 && currentMixResults.aditivo1.nombre) {
                    const dosisInput = document.getElementById('dosis-aditivo1');
                    const dosis = dosisInput ? parseFloat(dosisInput.value) || 0 : 0;
                    if (dosis > 0) {
                        html += '<tr><td><strong>' + currentMixResults.aditivo1.nombre + '</strong></td><td colspan="2">Rango: 0 to ' + dosis.toFixed(2) + ' oz/cwt</td></tr>';
                    }
                }
                
                if (currentMixResults.aditivo2 && currentMixResults.aditivo2.peso > 0 && currentMixResults.aditivo2.nombre) {
                    const dosisInput = document.getElementById('dosis-aditivo2');
                    const dosis = dosisInput ? parseFloat(dosisInput.value) || 0 : 0;
                    if (dosis > 0) {
                        html += '<tr><td><strong>' + currentMixResults.aditivo2.nombre + '</strong></td><td colspan="2">Rango: 0 to ' + dosis.toFixed(2) + ' oz/cwt</td></tr>';
                    }
                }
                
                if (currentMixResults.aditivo3 && currentMixResults.aditivo3.peso > 0 && currentMixResults.aditivo3.nombre) {
                    const dosisInput = document.getElementById('dosis-aditivo3');
                    const dosis = dosisInput ? parseFloat(dosisInput.value) || 0 : 0;
                    if (dosis > 0) {
                        html += '<tr><td><strong>' + currentMixResults.aditivo3.nombre + '</strong></td><td colspan="2">Rango: 0 to ' + dosis.toFixed(2) + ' oz/cwt</td></tr>';
                    }
                }
                
                html += '</tbody></table>';
                
                // Resumen actualizado
                html += '<h2>Resumen</h2>';
                html += '<div class="grid">';
                html += '<div class="item"><strong>Relaci√≥n W/C:</strong> ' + wc + '</div>';
                html += '<div class="item"><strong>Volumen Total Arenas:</strong> ' + (currentMixResults.volumenArenas ? currentMixResults.volumenArenas.toFixed(3) : '0.000') + ' ft¬≥</div>';
                html += '<div class="item"><strong>Peso Total:</strong> ' + (currentMixResults.pesoTotal ? currentMixResults.pesoTotal.toFixed(1) : '0') + ' lbs/yd¬≥</div>';
                html += '<div class="item"><strong>% Aire:</strong> ' + (currentMixResults.aire || '2.0') + ' %</div>';
                html += '<div class="item"><strong>Rendimiento:</strong> ' + (currentMixResults.rendimiento || 27) + ' ft¬≥</div>';
                html += '</div>';
                
                html += '<div class="signature-area">';
                html += '<div class="signature-box">';
                html += '<div class="signature-line" contenteditable="true"></div>';
                html += '<div class="signature-label">Firma / Nombre</div>';
                html += '</div>';
                html += '<div class="signature-box">';
                html += '<div class="signature-line" contenteditable="true"></div>';
                html += '<div class="signature-label">Fecha</div>';
                html += '</div>';
                html += '<div style="clear:both"></div>';
                html += '</div>';
                
                html += '<p style="margin-top:40px;text-align:center;color:#666;font-size:12px">Generado: ' + new Date().toLocaleString('es-ES') + '</p>';
                html += '</body></html>';
                
                console.log('Abriendo ventana...');
                
                const win = window.open('', '_blank');
                
                if (!win) {
                    alert('‚ùå Bloqueador de ventanas emergentes.');
                    return;
                }
                
                win.document.open();
                win.document.write(html);
                win.document.close();
                
                console.log('‚úÖ Reporte generado!');
                console.log('=== FIN DEBUG ===');
                
            } catch (error) {
                console.error('‚ùå ERROR:', error);
                alert('‚ùå Error: ' + error.message);
            }
        }

        // ============ FUNCI√ìN AUXILIAR: EXTRAER COLOR DOMINANTE DEL LOGO ============
        async function extraerColorDominanteDelLogo() {
            try {
                const logo = await obtenerLogo();
                if (!logo) return '#f59e0b'; // Color por defecto (naranja)
                
                return new Promise((resolve) => {
                    const img = new Image();
                    img.crossOrigin = 'Anonymous';
                    
                    img.onload = function() {
                        try {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            ctx.drawImage(img, 0, 0);
                            
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const data = imageData.data;
                            
                            let r = 0, g = 0, b = 0, count = 0;
                            
                            // Muestrear cada 10 p√≠xeles para optimizar
                            for (let i = 0; i < data.length; i += 40) {
                                const red = data[i];
                                const green = data[i + 1];
                                const blue = data[i + 2];
                                const alpha = data[i + 3];
                                
                                // Ignorar p√≠xeles muy claros (blancos) o transparentes
                                if (alpha > 100 && (red < 240 || green < 240 || blue < 240)) {
                                    r += red;
                                    g += green;
                                    b += blue;
                                    count++;
                                }
                            }
                            
                            if (count > 0) {
                                r = Math.round(r / count);
                                g = Math.round(g / count);
                                b = Math.round(b / count);
                                resolve(`rgb(${r}, ${g}, ${b})`);
                            } else {
                                resolve('#f59e0b');
                            }
                        } catch (e) {
                            console.error('Error extrayendo color:', e);
                            resolve('#f59e0b');
                        }
                    };
                    
                    img.onerror = () => resolve('#f59e0b');
                    img.src = logo;
                });
            } catch (e) {
                console.error('Error en extraerColorDominanteDelLogo:', e);
                return '#f59e0b';
            }
        }

        // ============ GENERAR REPORTE DE COSTOS (desde formulario actual) ============
        async function generarReporteCostosMix() {
            console.log('üîç Iniciando generarReporteCostosMix...');
            
            if (!currentMixResults) { 
                alert('‚ö†Ô∏è Debes calcular los vol√∫menes primero'); 
                return; 
            }

            try {
                const mix = {
                    nombre: document.getElementById('mix-nombre').value || 'Sin nombre',
                    fecha: document.getElementById('mix-fecha').value,
                    clienteId: parseInt(document.getElementById('mix-cliente').value) || null,
                    proyectoId: parseInt(document.getElementById('mix-proyecto').value) || null,
                    resistencia: parseFloat(document.getElementById('mix-resistencia').value),
                    slump: parseFloat(document.getElementById('mix-slump').value),
                    tipoCemento: document.getElementById('tipo-cemento').value,
                    resultados: currentMixResults,
                    dosisAditivo1: parseFloat(document.getElementById('dosis-aditivo1').value) || 0,
                    dosisAditivo2: parseFloat(document.getElementById('dosis-aditivo2').value) || 0,
                    dosisAditivo3: parseFloat(document.getElementById('dosis-aditivo3').value) || 0,
                    precioCemento: parseFloat(document.getElementById('precio-cemento').value) || 0,
                    precioAgua: parseFloat(document.getElementById('precio-agua').value) || 0,
                    precioGrueso: parseFloat(document.getElementById('precio-grueso').value) || 0,
                    precioIntermedio: parseFloat(document.getElementById('precio-intermedio').value) || 0,
                    precioArena1: parseFloat(document.getElementById('precio-arena1').value) || 0,
                    precioArena2: parseFloat(document.getElementById('precio-arena2').value) || 0,
                    precioAditivo1: parseFloat(document.getElementById('precio-aditivo1').value) || 0,
                    precioAditivo2: parseFloat(document.getElementById('precio-aditivo2').value) || 0,
                    precioAditivo3: parseFloat(document.getElementById('precio-aditivo3').value) || 0,
                };

                console.log('üì¶ Mix data:', mix);

                let clienteNombre = 'N/A';
                let proyectoNombre = 'N/A';
                if (mix.clienteId) { 
                    const c = await getRecord('clientes', mix.clienteId); 
                    if (c) clienteNombre = c.nombre; 
                }
                if (mix.proyectoId) { 
                    const p = await getRecord('proyectos', mix.proyectoId); 
                    if (p) proyectoNombre = p.nombre; 
                }

                console.log('üë• Cliente:', clienteNombre, 'Proyecto:', proyectoNombre);

                await generarHTMLReporteCostos(mix, clienteNombre, proyectoNombre);
                console.log('‚úÖ Reporte generado exitosamente');
            } catch (error) {
                console.error('‚ùå Error en generarReporteCostosMix:', error);
                alert('‚ùå Error al generar reporte: ' + error.message);
            }
        }

        // ============ GENERAR REPORTE DE COSTOS (desde mix guardado) ============
        async function generarReporteCostosGuardado(mixId) {
            console.log('üîç Iniciando generarReporteCostosGuardado con ID:', mixId);
            
            try {
                const mix = await getRecord('mixdesigns', mixId);
                if (!mix) {
                    alert('‚ùå No se encontr√≥ el mix design');
                    return;
                }

                console.log('üì¶ Mix cargado:', mix);

                let clienteNombre = 'N/A';
                let proyectoNombre = 'N/A';
                
                if (mix.clienteId) {
                    const c = await getRecord('clientes', mix.clienteId);
                    if (c) clienteNombre = c.nombre;
                }
                if (mix.proyectoId) {
                    const p = await getRecord('proyectos', mix.proyectoId);
                    if (p) proyectoNombre = p.nombre;
                }

                console.log('üë• Cliente:', clienteNombre, 'Proyecto:', proyectoNombre);

                await generarHTMLReporteCostos(mix, clienteNombre, proyectoNombre);
                console.log('‚úÖ Reporte generado exitosamente');
            } catch (error) {
                console.error('‚ùå Error en generarReporteCostosGuardado:', error);
                alert('‚ùå Error al generar reporte: ' + error.message);
            }
        }

        // ============ GENERAR REPORTES DE COSTOS M√öLTIPLES ============
        async function generarReportesCostosMultiple() {
            console.log('üîç Iniciando generaci√≥n de reportes m√∫ltiples...');
            
            const selectedIds = getSelectedMixDesignIds();
            console.log('üìã IDs seleccionados:', selectedIds);
            
            if (selectedIds.length === 0) {
                alert('‚ö†Ô∏è Selecciona al menos un mix design');
                return;
            }

            if (selectedIds.length > 10) {
                if (!confirm(`Has seleccionado ${selectedIds.length} mix designs.\n\n¬øDeseas continuar?`)) return;
            }

            try {
                const mixdesigns = await getAllRecords('mixdesigns');
                const clientes = await getAllRecords('clientes');
                const proyectos = await getAllRecords('proyectos');

                console.log(`üì¶ Total mix designs en DB: ${mixdesigns.length}`);

                const selectedMixes = selectedIds.map(id => mixdesigns.find(m => m.id === id)).filter(Boolean);
                console.log(`‚úÖ Mix designs encontrados: ${selectedMixes.length}`);
                
                if (selectedMixes.length === 0) {
                    alert('‚ùå No se encontraron los mix designs seleccionados');
                    return;
                }

                // Generar todos los reportes sin esperar entre ellos
                for (let i = 0; i < selectedMixes.length; i++) {
                    const mix = selectedMixes[i];
                    console.log(`üìÑ Generando reporte ${i + 1}/${selectedMixes.length} - Mix ID: ${mix.id}`);
                    
                    const clienteNombre = mix.clienteId ? (clientes.find(c => c.id == mix.clienteId)?.nombre || 'N/A') : 'N/A';
                    const proyectoNombre = mix.proyectoId ? (proyectos.find(p => p.id == mix.proyectoId)?.nombre || 'N/A') : 'N/A';
                    
                    // Usar setTimeout para abrir ventanas en secuencia sin bloquear
                    setTimeout(() => {
                        generarHTMLReporteCostos(mix, clienteNombre, proyectoNombre);
                    }, i * 500); // 500ms entre cada ventana
                }
                
                console.log(`‚úÖ Se abrir√°n ${selectedMixes.length} ventanas de reportes`);
                
            } catch (error) {
                console.error('‚ùå Error en generarReportesCostosMultiple:', error);
                alert('‚ùå Error al generar reportes: ' + error.message);
            }
        }

        // ============ FUNCIONES AUXILIARES PARA COLORES ============
        function hexToRgbHelper(color) {
            if (color.startsWith('rgb')) {
                return color.match(/\d+/g).join(', ');
            }
            const hex = color.replace('#', '');
            const r = parseInt(hex.substr(0, 2), 16);
            const g = parseInt(hex.substr(2, 2), 16);
            const b = parseInt(hex.substr(4, 2), 16);
            return r + ', ' + g + ', ' + b;
        }
        
        function rgbToHslHelper(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            
            if (max === min) {
                h = s = 0;
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                    case g: h = ((b - r) / d + 2) / 6; break;
                    case b: h = ((r - g) / d + 4) / 6; break;
                }
            }
            return [h * 360, s, l];
        }
        
        function adjustColorHelper(color, adjustment) {
            if (color.startsWith('rgb')) {
                const values = color.match(/\d+/g).map(Number);
                const h = rgbToHslHelper(values[0], values[1], values[2])[0];
                const newH = (h + adjustment) % 360;
                return `hsl(${newH}, 60%, 50%)`;
            }
            return color;
        }

        // ============ FUNCI√ìN PARA GENERAR SVG DEL GR√ÅFICO DE PIE ============
        function generatePieChartSVG(data) {
            let cumulativePercent = 0;
            let paths = '';
            
            data.forEach((item) => {
                if (item.value > 0) {
                    const startAngle = cumulativePercent * 2 * Math.PI;
                    cumulativePercent += item.value / 100;
                    const endAngle = cumulativePercent * 2 * Math.PI;
                    
                    const startX = 100 + 90 * Math.cos(startAngle - Math.PI / 2);
                    const startY = 100 + 90 * Math.sin(startAngle - Math.PI / 2);
                    const endX = 100 + 90 * Math.cos(endAngle - Math.PI / 2);
                    const endY = 100 + 90 * Math.sin(endAngle - Math.PI / 2);
                    
                    const largeArcFlag = item.value > 50 ? 1 : 0;
                    
                    const pathData = [
                        `M 100 100`,
                        `L ${startX} ${startY}`,
                        `A 90 90 0 ${largeArcFlag} 1 ${endX} ${endY}`,
                        'Z'
                    ].join(' ');
                    
                    paths += `<path d="${pathData}" fill="${item.color}" stroke="white" stroke-width="2"/>`;
                }
            });
            
            return paths;
        }

        // ============ FUNCI√ìN PRINCIPAL: GENERAR HTML REPORTE DE COSTOS ============
        async function generarHTMLReporteCostos(mix, clienteNombre, proyectoNombre) {
            console.log('üé® Generando HTML reporte de costos...');
            
            try {
                const logo = await obtenerLogo();
                console.log('üñºÔ∏è Logo obtenido');
                
                const colorPrincipal = await extraerColorDominanteDelLogo();
                console.log('üé® Color principal:', colorPrincipal);
                
                const r = mix.resultados;
                
                if (!r) {
                    throw new Error('No hay resultados en el mix design');
                }

                // Calcular costos totales por categor√≠a
                const costoAgregados = (r.grueso?.costo || 0) + (r.intermedio?.costo || 0) + 
                                       (r.arena1?.costo || 0) + (r.arena2?.costo || 0);
                const costoAditivos = (r.aditivo1?.costo || 0) + (r.aditivo2?.costo || 0) + 
                                      (r.aditivo3?.costo || 0);

                // Calcular porcentajes
                const pctCemento = ((r.cemento?.costo || 0) / r.costoTotal * 100);
                const pctAgua = ((r.agua?.costo || 0) / r.costoTotal * 100);
                const pctAgregados = (costoAgregados / r.costoTotal * 100);
                const pctAditivos = (costoAditivos / r.costoTotal * 100);

                console.log('üí∞ Costos calculados - Cemento:', pctCemento, 'Agregados:', pctAgregados);

                const logoHtml = logo 
                    ? `<img src="${logo}" alt="Logo" style="max-height:70px;max-width:200px;object-fit:contain;">` 
                    : `<div style="background:${colorPrincipal};color:white;font-weight:bold;padding:8px 20px;border-radius:6px;">MIXTEC PRO</div>`;

                // Calcular RGB para usar en el CSS
                const colorRgb = hexToRgbHelper(colorPrincipal);

                // Datos para el gr√°fico de pie
                const chartData = [
                    { label: 'Cemento', value: pctCemento, color: adjustColorHelper(colorPrincipal, 0) },
                    { label: 'Agregados', value: pctAgregados, color: adjustColorHelper(colorPrincipal, 30) },
                    { label: 'Agua', value: pctAgua, color: adjustColorHelper(colorPrincipal, 60) },
                    { label: 'Aditivos', value: pctAditivos, color: adjustColorHelper(colorPrincipal, 90) }
                ];

                console.log('üìä Chart data:', chartData);
                
                // Generar el SVG del gr√°fico de pie
                const pieChartSVG = generatePieChartSVG(chartData);
                console.log('üìä SVG generado');

            const html = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Reporte de Costos - ${mix.nombre}</title>
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
        font-family: Arial, Helvetica, sans-serif; 
        background: white; 
        padding: 0; 
        color: #222; 
        font-size: 11px;
    }
    .container { 
        max-width: 100%; 
        margin: 0 auto; 
        background: white; 
        padding: 18px 25px; 
    }
    .header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        border-bottom: 2px solid ${colorPrincipal}; 
        padding-bottom: 10px; 
        margin-bottom: 15px; 
    }
    .header h1 { 
        color: ${colorPrincipal}; 
        font-size: 24px; 
        font-weight: bold; 
    }
    .header-subtitle {
        font-size: 11px;
        color: #666;
        margin-top: 3px;
    }
    .header-info { 
        text-align: right; 
        font-size: 10px; 
        color: #666; 
    }
    .section { 
        margin-bottom: 14px; 
    }
    .section-title { 
        background: ${colorPrincipal}; 
        color: white; 
        padding: 6px 12px; 
        font-weight: bold; 
        font-size: 12px; 
        margin-bottom: 10px; 
        border-radius: 3px; 
    }
    .info-grid { 
        display: grid; 
        grid-template-columns: repeat(4, 1fr); 
        gap: 10px; 
        margin-bottom: 12px; 
    }
    .info-item { 
        border: 1px solid #e5e7eb; 
        padding: 8px 10px; 
        border-radius: 4px; 
        background: #fafafa; 
        min-height: 46px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .info-label { 
        font-size: 9px; 
        color: #666; 
        font-weight: bold; 
        text-transform: uppercase; 
        margin-bottom: 4px; 
    }
    .info-value { 
        font-size: 12px; 
        font-weight: bold; 
        color: #222; 
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        line-height: 1.2;
        word-wrap: break-word;
        hyphens: auto;
    }
    /* Auto-fit para textos largos en nombre, cliente y proyecto */
    .info-item:nth-child(1) .info-value,
    .info-item:nth-child(2) .info-value,
    .info-item:nth-child(3) .info-value {
        font-size: clamp(9px, 2.5vw, 12px);
    }
    table { 
        width: 100%; 
        border-collapse: collapse; 
        margin-bottom: 12px; 
        font-size: 10px;
    }
    thead { 
        background: ${colorPrincipal}; 
    }
    th { 
        color: white; 
        padding: 6px 8px; 
        text-align: left; 
        font-weight: bold; 
        font-size: 10px; 
    }
    td { 
        padding: 5px 8px; 
        border-bottom: 1px solid #e5e7eb; 
        font-size: 10px; 
        line-height: 1.4;
    }
    tbody tr:hover { 
        background: rgba(${colorRgb}, 0.05); 
    }
    .material-name { 
        font-weight: 600; 
        color: #374151; 
    }
    .cost-value { 
        font-weight: bold; 
        color: #059669; 
    }
    .pct-value { 
        color: #6b7280; 
        font-size: 9px; 
    }
    .total-row { 
        background: rgba(${colorRgb}, 0.1) !important; 
        font-weight: bold; 
        border-top: 2px solid ${colorPrincipal}; 
    }
    .total-row td { 
        padding: 7px 8px; 
        font-size: 11px; 
    }
    .cost-summary { 
        background: linear-gradient(135deg, rgba(${colorRgb}, 0.15) 0%, rgba(${colorRgb}, 0.25) 100%); 
        padding: 15px; 
        border-radius: 6px; 
        border: 2px solid ${colorPrincipal}; 
        margin: 14px 0; 
    }
    .cost-summary-inner {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 25px;
        align-items: start;
    }
    .cost-summary-left {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    .cost-summary-total {
        text-align: left;
        padding: 14px;
        background: white;
        border-radius: 6px;
        border-left: 3px solid ${colorPrincipal};
    }
    .cost-summary-title { 
        font-size: 10px; 
        color: ${colorPrincipal}; 
        font-weight: bold; 
        margin-bottom: 8px; 
        text-transform: uppercase; 
        letter-spacing: 0.5px; 
    }
    .cost-summary-value { 
        font-size: 32px; 
        font-weight: bold; 
        color: ${colorPrincipal}; 
        line-height: 1; 
    }
    .chart-container {
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .pie-chart {
        width: 220px;
        height: 220px;
    }
    .chart-legend {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        padding: 12px;
        background: white;
        border-radius: 6px;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 10px;
    }
    .legend-color {
        width: 14px;
        height: 14px;
        border-radius: 3px;
        flex-shrink: 0;
    }
    .legend-label {
        font-weight: 600;
        flex: 1;
    }
    .legend-value {
        color: #6b7280;
        font-weight: 600;
    }
    .category-header { 
        background: rgba(${colorRgb}, 0.1); 
        font-weight: bold; 
        color: ${colorPrincipal}; 
        border-left: 3px solid ${colorPrincipal}; 
    }
    .footer { 
        margin-top: 18px; 
        padding-top: 10px; 
        border-top: 1px solid #e5e7eb; 
        text-align: center; 
        font-size: 9px; 
        color: #9ca3af; 
    }
    @media print {
        body { 
            background: white; 
            padding: 0; 
            margin: 0;
        }
        .container { 
            padding: 12px 20px;
            max-width: 100%;
        }
        .section {
            page-break-inside: avoid;
            margin-bottom: 12px;
        }
        .cost-summary {
            page-break-inside: avoid;
        }
        table {
            page-break-inside: avoid;
        }
        @page {
            size: letter;
            margin: 0.35in 0.35in;
        }
    }
</style>
</head>
<body>
<div class="container">

    <!-- ENCABEZADO -->
    <div class="header">
        <div>
            <h1>üí∞ REPORTE DE COSTOS</h1>
            <div class="header-subtitle">An√°lisis Detallado de Costos de Mezcla</div>
        </div>
        <div>
            ${logoHtml.replace('max-height:45px;max-width:150px', 'max-height:65px;max-width:220px')}
            <div class="header-info" style="margin-top: 4px;">
                ${new Date().toLocaleDateString('es-ES', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                })}
            </div>
        </div>
    </div>

    <!-- INFORMACI√ìN DEL MIX -->
    <div class="section">
        <div class="section-title">üìã Informaci√≥n del Mix Design</div>
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Nombre</div>
                <div class="info-value">${mix.nombre}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Cliente</div>
                <div class="info-value">${clienteNombre}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Proyecto</div>
                <div class="info-value">${proyectoNombre}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Fecha</div>
                <div class="info-value">${new Date(mix.fecha || mix.fechaCreacion).toLocaleDateString('es-ES')}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Resistencia</div>
                <div class="info-value" style="color: #16a34a;">${mix.resistencia} PSI</div>
            </div>
            <div class="info-item">
                <div class="info-label">Slump</div>
                <div class="info-value">${mix.slump} in</div>
            </div>
            <div class="info-item">
                <div class="info-label">Relaci√≥n W/C</div>
                <div class="info-value">${r.wc.toFixed(3)}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Rendimiento</div>
                <div class="info-value">${r.rendimiento.toFixed(2)} ft¬≥</div>
            </div>
        </div>
    </div>

    <!-- RESUMEN DE COSTO TOTAL CON GR√ÅFICO -->
    <div class="cost-summary">
        <div class="cost-summary-inner">
            <div class="cost-summary-left">
                <!-- Costo Total arriba -->
                <div class="cost-summary-total">
                    <div class="cost-summary-title">Costo Total por Yarda C√∫bica</div>
                    <div class="cost-summary-value">$${r.costoTotal.toFixed(2)}</div>
                </div>
                
                <!-- Leyendas abajo -->
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: ${chartData[0].color}"></div>
                        <span class="legend-label">${chartData[0].label}</span>
                        <span class="legend-value">${chartData[0].value.toFixed(1)}%</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: ${chartData[1].color}"></div>
                        <span class="legend-label">${chartData[1].label}</span>
                        <span class="legend-value">${chartData[1].value.toFixed(1)}%</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: ${chartData[2].color}"></div>
                        <span class="legend-label">${chartData[2].label}</span>
                        <span class="legend-value">${chartData[2].value.toFixed(1)}%</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: ${chartData[3].color}"></div>
                        <span class="legend-label">${chartData[3].label}</span>
                        <span class="legend-value">${chartData[3].value.toFixed(1)}%</span>
                    </div>
                </div>
            </div>
            
            <!-- Gr√°fico de pie a la derecha -->
            <div class="chart-container">
                <svg class="pie-chart" viewBox="0 0 200 200">
                    ${pieChartSVG}
                </svg>
            </div>
        </div>
    </div>

    <!-- DESGLOSE DETALLADO -->
    <div class="section">
        <div class="section-title">üìä Desglose Detallado de Costos</div>
        <table>
            <thead>
                <tr>
                    <th>Material</th>
                    <th>Cantidad</th>
                    <th>Precio Unitario</th>
                    <th>Costo</th>
                    <th>% del Total</th>
                </tr>
            </thead>
            <tbody>
                <!-- CEMENTO -->
                <tr class="category-header">
                    <td colspan="5"><strong>üèóÔ∏è CEMENTO</strong></td>
                </tr>
                <tr>
                    <td class="material-name">${mix.tipoCemento || 'Tipo I'}</td>
                    <td>${r.cemento.peso.toFixed(1)} lb (${r.sacosCemento.toFixed(2)} sacos)</td>
                    <td>$${(mix.precioCemento || 0).toFixed(2)}/saco</td>
                    <td class="cost-value">$${r.cemento.costo.toFixed(2)}</td>
                    <td class="pct-value">${pctCemento.toFixed(1)}%</td>
                </tr>

                <!-- AGREGADOS -->
                <tr class="category-header">
                    <td colspan="5"><strong>ü™® AGREGADOS</strong></td>
                </tr>
                ${r.grueso.peso > 0 ? `
                <tr>
                    <td class="material-name">Agregado Grueso</td>
                    <td>${r.grueso.peso.toFixed(1)} lb</td>
                    <td>$${(mix.precioGrueso || 0).toFixed(2)}/ton</td>
                    <td class="cost-value">$${r.grueso.costo.toFixed(2)}</td>
                    <td class="pct-value">${((r.grueso.costo / r.costoTotal) * 100).toFixed(1)}%</td>
                </tr>` : ''}
                ${r.intermedio.peso > 0 ? `
                <tr>
                    <td class="material-name">Agregado Intermedio</td>
                    <td>${r.intermedio.peso.toFixed(1)} lb</td>
                    <td>$${(mix.precioIntermedio || 0).toFixed(2)}/ton</td>
                    <td class="cost-value">$${r.intermedio.costo.toFixed(2)}</td>
                    <td class="pct-value">${((r.intermedio.costo / r.costoTotal) * 100).toFixed(1)}%</td>
                </tr>` : ''}
                ${r.arena1.peso > 0 ? `
                <tr>
                    <td class="material-name">Arena 1</td>
                    <td>${r.arena1.peso.toFixed(1)} lb</td>
                    <td>$${(mix.precioArena1 || 0).toFixed(2)}/ton</td>
                    <td class="cost-value">$${r.arena1.costo.toFixed(2)}</td>
                    <td class="pct-value">${((r.arena1.costo / r.costoTotal) * 100).toFixed(1)}%</td>
                </tr>` : ''}
                ${r.arena2.peso > 0 ? `
                <tr>
                    <td class="material-name">Arena 2</td>
                    <td>${r.arena2.peso.toFixed(1)} lb</td>
                    <td>$${(mix.precioArena2 || 0).toFixed(2)}/ton</td>
                    <td class="cost-value">$${r.arena2.costo.toFixed(2)}</td>
                    <td class="pct-value">${((r.arena2.costo / r.costoTotal) * 100).toFixed(1)}%</td>
                </tr>` : ''}

                <!-- AGUA -->
                <tr class="category-header">
                    <td colspan="5"><strong>üíß AGUA</strong></td>
                </tr>
                <tr>
                    <td class="material-name">Agua Efectiva</td>
                    <td>${r.agua.peso.toFixed(1)} lb (${(r.agua.peso / 8.34).toFixed(1)} gal)</td>
                    <td>$${(mix.precioAgua || 0).toFixed(2)}/gal</td>
                    <td class="cost-value">$${r.agua.costo.toFixed(2)}</td>
                    <td class="pct-value">${pctAgua.toFixed(1)}%</td>
                </tr>

                ${(r.aditivo1.peso > 0 && r.aditivo1.nombre) || 
                  (r.aditivo2.peso > 0 && r.aditivo2.nombre) || 
                  (r.aditivo3.peso > 0 && r.aditivo3.nombre) ? `
                <!-- ADITIVOS -->
                <tr class="category-header">
                    <td colspan="5"><strong>üß™ ADITIVOS</strong></td>
                </tr>
                ${r.aditivo1.peso > 0 && r.aditivo1.nombre ? `
                <tr>
                    <td class="material-name">${r.aditivo1.nombre}</td>
                    <td>${(mix.dosisAditivo1 || 0).toFixed(2)} oz/cwt</td>
                    <td>$${(mix.precioAditivo1 || 0).toFixed(2)}/gal</td>
                    <td class="cost-value">$${r.aditivo1.costo.toFixed(2)}</td>
                    <td class="pct-value">${((r.aditivo1.costo / r.costoTotal) * 100).toFixed(1)}%</td>
                </tr>` : ''}
                ${r.aditivo2.peso > 0 && r.aditivo2.nombre ? `
                <tr>
                    <td class="material-name">${r.aditivo2.nombre}</td>
                    <td>${(mix.dosisAditivo2 || 0).toFixed(2)} oz/cwt</td>
                    <td>$${(mix.precioAditivo2 || 0).toFixed(2)}/gal</td>
                    <td class="cost-value">$${r.aditivo2.costo.toFixed(2)}</td>
                    <td class="pct-value">${((r.aditivo2.costo / r.costoTotal) * 100).toFixed(1)}%</td>
                </tr>` : ''}
                ${r.aditivo3.peso > 0 && r.aditivo3.nombre ? `
                <tr>
                    <td class="material-name">${r.aditivo3.nombre}</td>
                    <td>${(mix.dosisAditivo3 || 0).toFixed(2)} oz/cwt</td>
                    <td>$${(mix.precioAditivo3 || 0).toFixed(2)}/gal</td>
                    <td class="cost-value">$${r.aditivo3.costo.toFixed(2)}</td>
                    <td class="pct-value">${((r.aditivo3.costo / r.costoTotal) * 100).toFixed(1)}%</td>
                </tr>` : ''}
                ` : ''}

                <!-- TOTAL -->
                <tr class="total-row">
                    <td colspan="3"><strong>COSTO TOTAL</strong></td>
                    <td class="cost-value"><strong>$${r.costoTotal.toFixed(2)}</strong></td>
                    <td class="pct-value"><strong>100%</strong></td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- FOOTER -->
    <div class="footer">
        MIXTEC PRO - ${new Date().toLocaleDateString('es-ES')} ${new Date().toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'})}
    </div>

</div>

<scr` + `ipt>
    // Script simplificado - las funciones principales est√°n en el scope externo
    window.onload = function() {
        setTimeout(() => window.print(), 500);
    };
</scr` + `ipt>

</body>
</html>`;

                console.log('üìù HTML generado, abriendo ventana...');

                const win = window.open('', '_blank');
                if (!win) { 
                    alert('‚ùå Bloqueador de ventanas emergentes activo.'); 
                    return; 
                }
                
                console.log('‚úÖ Ventana abierta, escribiendo contenido...');
                win.document.write(html);
                win.document.close();
                console.log('‚úÖ Reporte completado');
                
            } catch (error) {
                console.error('‚ùå Error en generarHTMLReporteCostos:', error);
                alert('‚ùå Error al generar HTML del reporte: ' + error.message);
            }
        }














        document.getElementById('form-trial').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const editId = document.getElementById('edit-trial-id').value;
            const mixId = parseInt(document.getElementById('trial-mixdesign').value);
            const mix = await getRecord('mixdesigns', mixId);
            
            // Si estamos editando, usar el trialId existente, sino generar uno nuevo
            let trialId;
            if (editId) {
                const existingTrial = await getRecord('trials', parseInt(editId));
                trialId = existingTrial.trialId;
            } else {
                trialId = await generarTrialId();
            }
            
            let tamano = document.getElementById('trial-tamano').value;
            if (tamano === 'custom') {
                tamano = parseFloat(document.getElementById('trial-tamano-custom').value);
            } else {
                tamano = parseFloat(tamano);
            }

            // Recopilar datos de cilindros
            const numCilindros = parseInt(document.getElementById('trial-num-cilindros').value) || 0;
            const cilindros = [];
            for (let i = 1; i <= numCilindros; i++) {
                let dias = document.getElementById(`cilindro-${i}-dias`).value;
                if (dias === 'custom') {
                    dias = document.getElementById(`cilindro-${i}-dias-custom`).value;
                }
                
                cilindros.push({
                    numero: i,
                    diasCurado: dias,
                    fechaEnsayo: document.getElementById(`cilindro-${i}-fecha`).value,
                    resistencia: parseFloat(document.getElementById(`cilindro-${i}-resistencia`).value) || 0
                });
            }

            const trial = {
                trialId: trialId,
                mixDesignId: mixId,
                mixDesignNombre: mix.nombre,
                fecha: document.getElementById('trial-fecha').value,
                hora: document.getElementById('trial-hora').value,
                tamano: tamano,
                
                // Propiedades del concreto fresco
                slump: parseFloat(document.getElementById('trial-slump').value) || 0,
                temperatura: parseFloat(document.getElementById('trial-temperatura').value) || 0,
                aire: parseFloat(document.getElementById('trial-aire').value) || 0,
                pesoUnitario: parseFloat(document.getElementById('trial-peso-unitario').value) || 0,
                
                // Cilindros
                cilindros: cilindros,
                
                // Observaciones
                observaciones: document.getElementById('trial-observaciones').value,
                tecnico: document.getElementById('trial-tecnico').value,
                
                fechaCreacion: new Date().toISOString()
            };

            try {
                if (editId) {
                    trial.id = parseInt(editId);
                    await updateRecord('trials', trial);
                    alert('‚úÖ Trial Mix actualizado');
                } else {
                    await addRecord('trials', trial);
                    alert('‚úÖ Trial Mix guardado: ' + trialId);
                }
                
                // Guardar datos actuales para reportes y QR
                currentTrialData = trial;
                document.getElementById('btn-reporte-trial').disabled = false;
                document.getElementById('btn-qr-trial').disabled = false;
                
                loadTrials();
                updateDashboard();
            } catch (error) {
                alert('‚ùå Error: ' + error);
            }
        });

        async function loadTrials() {
            const trials = await getAllRecords('trials');
            const container = document.getElementById('lista-trials');
            
            if (trials.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay trial mixes registrados</div>';
                return;
            }
            
            let html = '<table><thead><tr><th>Trial ID</th><th>Mix Design</th><th>Tama√±o</th><th>Slump</th><th>Temp</th><th>Aire</th><th>Cilindros</th><th>Fecha</th><th>Acciones</th></tr></thead><tbody>';
            trials.forEach(t => {
                html += `<tr>
                    <td><span class="trial-badge">${t.trialId}</span></td>
                    <td><strong>${t.mixDesignNombre}</strong></td>
                    <td>${t.tamano} ft¬≥</td>
                    <td>${t.slump || '-'} in</td>
                    <td>${t.temperatura || '-'} ¬∞F</td>
                    <td>${t.aire || '-'} %</td>
                    <td>${t.cilindros.length}</td>
                    <td>${new Date(t.fecha).toLocaleDateString()}</td>
                    <td class="actions">
                        <button class="info" onclick="verTrial(${t.id})">Ver</button>
                        <button class="secondary" onclick="editTrial(${t.id})">Editar</button>
                        <button class="danger" onclick="deleteTrial(${t.id})">Eliminar</button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function verTrial(id) {
            const trial = await getRecord('trials', id);
            if (!trial) return;
            
            currentTrialData = trial;
            
            let resumenCilindros = '';
            trial.cilindros.forEach(cil => {
                resumenCilindros += `Cilindro ${cil.numero}: ${cil.diasCurado} d√≠as = ${cil.resistencia || 'Pendiente'} PSI\n`;
            });
            
            alert(`TRIAL MIX: ${trial.trialId}\n\n` +
                  `Mix Design: ${trial.mixDesignNombre}\n` +
                  `Tama√±o: ${trial.tamano} ft¬≥\n` +
                  `Fecha: ${new Date(trial.fecha).toLocaleDateString()}\n\n` +
                  `PROPIEDADES:\n` +
                  `Slump: ${trial.slump} in\n` +
                  `Temperatura: ${trial.temperatura} ¬∞F\n` +
                  `Aire: ${trial.aire}%\n` +
                  `Peso Unitario: ${trial.pesoUnitario} lb/ft¬≥\n\n` +
                  `CILINDROS (${trial.cilindros.length}):\n${resumenCilindros}\n` +
                  `Observaciones:\n${trial.observaciones || 'N/A'}\n\n` +
                  `T√©cnico: ${trial.tecnico || 'N/A'}`);
        }

        // ============ CALENDARIO DE ROTURAS ============
        async function cargarCalendario() {
            const trials = await getAllRecords('trials');
            const container = document.getElementById('calendario-container');
            const filtroMes = document.getElementById('filtro-mes-calendario').value;
            const filtroEstado = document.getElementById('filtro-estado-calendario').value;
            
            // Crear lista de todos los ensayos programados
            let ensayos = [];
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            
            trials.forEach(trial => {
                trial.cilindros.forEach(cilindro => {
                    const fechaTrial = new Date(trial.fecha);
                    const fechaEnsayo = new Date(fechaTrial);
                    fechaEnsayo.setDate(fechaEnsayo.getDate() + parseInt(cilindro.diasCurado));
                    fechaEnsayo.setHours(0, 0, 0, 0);
                    
                    const tieneResultado = cilindro.resistencia && cilindro.resistencia > 0;
                    const esVencido = fechaEnsayo < hoy && !tieneResultado;
                    const esHoy = fechaEnsayo.getTime() === hoy.getTime();
                    
                    let estado = 'pendiente';
                    if (tieneResultado) estado = 'completado';
                    else if (esVencido) estado = 'vencido';
                    
                    ensayos.push({
                        trialId: trial.trialId,
                        mixDesign: trial.mixDesignNombre,
                        cilindroNum: cilindro.numero,
                        diasCurado: cilindro.diasCurado,
                        fechaTrial: fechaTrial,
                        fechaEnsayo: fechaEnsayo,
                        fechaEnsayoReal: cilindro.fechaEnsayo ? new Date(cilindro.fechaEnsayo) : null,
                        resistencia: cilindro.resistencia,
                        estado: estado,
                        esHoy: esHoy,
                        tecnico: trial.tecnico || 'N/A'
                    });
                });
            });
            
            // Filtrar por mes si est√° seleccionado
            if (filtroMes) {
                const [year, month] = filtroMes.split('-');
                ensayos = ensayos.filter(e => {
                    const fecha = e.fechaEnsayo;
                    return fecha.getFullYear() == year && (fecha.getMonth() + 1) == month;
                });
            }
            
            // Filtrar por estado
            if (filtroEstado !== 'todos') {
                if (filtroEstado === 'pendientes') {
                    ensayos = ensayos.filter(e => e.estado === 'pendiente');
                } else if (filtroEstado === 'completados') {
                    ensayos = ensayos.filter(e => e.estado === 'completado');
                } else if (filtroEstado === 'vencidos') {
                    ensayos = ensayos.filter(e => e.estado === 'vencido');
                }
            }
            
            // Ordenar por fecha de ensayo
            ensayos.sort((a, b) => a.fechaEnsayo - b.fechaEnsayo);
            
            if (ensayos.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay ensayos programados para los filtros seleccionados</div>';
                return;
            }
            
            let html = '';
            ensayos.forEach(ensayo => {
                const claseEstado = ensayo.esHoy ? 'hoy' : ensayo.estado;
                const labelEstado = ensayo.esHoy ? 'HOY' : ensayo.estado.toUpperCase();
                const diasDesdeColado = Math.floor((ensayo.fechaEnsayo - ensayo.fechaTrial) / (1000 * 60 * 60 * 24));
                
                html += `
                    <div class="calendario-item ${claseEstado}">
                        <div class="calendario-header">
                            <div class="calendario-fecha">
                                üìÖ ${ensayo.fechaEnsayo.toLocaleDateString('es-ES', { 
                                    weekday: 'long', 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric' 
                                })}
                            </div>
                            <span class="calendario-status ${ensayo.estado}">${labelEstado}</span>
                        </div>
                        <div class="calendario-content">
                            <div class="calendario-detail">
                                <strong>Trial ID:</strong><br>
                                <span class="trial-badge" style="font-size: 14px; padding: 4px 8px;">${ensayo.trialId}</span>
                            </div>
                            <div class="calendario-detail">
                                <strong>Mix Design:</strong><br>
                                ${ensayo.mixDesign}
                            </div>
                            <div class="calendario-detail">
                                <strong>Cilindro:</strong><br>
                                #${ensayo.cilindroNum} - ${ensayo.diasCurado} d√≠as
                            </div>
                            <div class="calendario-detail">
                                <strong>Fecha Colado:</strong><br>
                                ${ensayo.fechaTrial.toLocaleDateString()}
                            </div>
                            <div class="calendario-detail">
                                <strong>T√©cnico:</strong><br>
                                ${ensayo.tecnico}
                            </div>
                            <div class="calendario-detail">
                                <strong>Resistencia:</strong><br>
                                ${ensayo.resistencia ? ensayo.resistencia + ' PSI' : '‚è≥ Pendiente'}
                            </div>
                        </div>
                        ${ensayo.fechaEnsayoReal ? `
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); font-size: 12px; color: var(--text-light);">
                            ‚úÖ Ensayado el: ${ensayo.fechaEnsayoReal.toLocaleDateString()}
                        </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }


        async function editTrial(id) {
            const trial = await getRecord('trials', id);
            if (!trial) return;
            
            // Cargar el select de mix designs primero
            await loadMixDesignsSelect();
            
            currentTrialData = trial;
            document.getElementById('btn-reporte-trial').disabled = false;
            document.getElementById('btn-qr-trial').disabled = false;
            
            document.getElementById('edit-trial-id').value = trial.id;
            document.getElementById('trial-id-display').value = trial.trialId;
            document.getElementById('trial-mixdesign').value = trial.mixDesignId;
            document.getElementById('trial-fecha').value = trial.fecha;
            document.getElementById('trial-hora').value = trial.hora || '';
            
            if ([1, 2, 3, 4, 5, 6.75, 13.5, 27].includes(trial.tamano)) {
                document.getElementById('trial-tamano').value = trial.tamano;
            } else {
                document.getElementById('trial-tamano').value = 'custom';
                document.getElementById('trial-tamano-custom').value = trial.tamano;
                document.getElementById('trial-tamano-custom-group').style.display = 'block';
            }
            
            document.getElementById('trial-slump').value = trial.slump;
            document.getElementById('trial-temperatura').value = trial.temperatura;
            document.getElementById('trial-aire').value = trial.aire;
            document.getElementById('trial-peso-unitario').value = trial.pesoUnitario;
            
            document.getElementById('trial-num-cilindros').value = trial.cilindros.length;
            generarCamposCilindros();
            
            trial.cilindros.forEach((cil, index) => {
                const i = index + 1;
                const diasSelect = document.getElementById(`cilindro-${i}-dias`);
                if ([7, 14, 28, 56].includes(parseInt(cil.diasCurado))) {
                    diasSelect.value = cil.diasCurado;
                } else {
                    diasSelect.value = 'custom';
                    document.getElementById(`cilindro-${i}-dias-custom`).value = cil.diasCurado;
                    document.getElementById(`cilindro-${i}-dias-custom-group`).style.display = 'block';
                }
                document.getElementById(`cilindro-${i}-fecha`).value = cil.fechaEnsayo || '';
                document.getElementById(`cilindro-${i}-resistencia`).value = cil.resistencia;
            });
            
            document.getElementById('trial-observaciones').value = trial.observaciones || '';
            document.getElementById('trial-tecnico').value = trial.tecnico || '';
            
            await cargarInfoMixDesign();
            
            switchTab('trials');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function deleteTrial(id) {
            if (confirm('¬øEliminar este trial mix?')) {
                await deleteRecord('trials', id);
                loadTrials();
                updateDashboard();
            }
        }

        function filterTrials() {
            const search = document.getElementById('search-trials').value.toLowerCase();
            document.querySelectorAll('#lista-trials table tbody tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        let currentTrialData = null;

                        async function generarReporteTrial() {
            var trialId = document.getElementById('trial-id-display').value;
            
            if (!trialId) {
                alert('‚ö†Ô∏è Primero guarda el trial mix');
                return;
            }

            var trials = await getAllRecords('trials');
            var trial = null;
            
            for (var i = 0; i < trials.length; i++) {
                if (trials[i].trialId === trialId) {
                    trial = trials[i];
                    break;
                }
            }
            
            if (!trial) {
                alert('‚ö†Ô∏è Guarda el trial primero');
                return;
            }

            var mix = await getRecord('mixdesigns', parseInt(trial.mixDesignId));
            
            var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Trial Mix Report - ' + trialId + '</title>';
            html += '<style>';
            html += 'body{font-family:Arial,sans-serif;margin:40px;background:white;color:#333}';
            html += '.header{display:flex;justify-content:space-between;align-items:center;border-bottom:3px solid #16a34a;padding-bottom:20px;margin-bottom:30px}';
            html += '.header-left h1{color:#16a34a;font-size:2em;margin:0 0 10px 0}';
            html += '.header-right img{max-width:300px;max-height:120px;height:auto}';
            html += '.info-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin:20px 0;background:#f8f9fa;padding:20px;border-radius:8px}';
            html += '.info-item{padding:10px}';
            html += '.info-item strong{color:#16a34a;display:block;margin-bottom:5px}';
            html += 'h2{color:#16a34a;margin-top:30px;font-size:1.5em;border-bottom:2px solid #16a34a;padding-bottom:10px}';
            html += 'table{width:100%;border-collapse:collapse;margin:20px 0}';
            html += 'th,td{border:1px solid #ddd;padding:12px;text-align:left}';
            html += 'th{background:#16a34a;color:white;font-weight:bold}';
            html += 'tr:nth-child(even){background:#f8f9fa}';
            html += '.chart-container{margin:30px 0;text-align:center}';
            html += 'canvas{border:1px solid #e0e0e0;border-radius:8px;background:white}';
            html += '@media print{body{margin:20px}.header{page-break-after:avoid}}';
            html += '</style></head><body>';
            
            // Header con logo
            html += '<div class="header">';
            html += '<div class="header-left">';
            html += '<h1>TRIAL MIX REPORT</h1>';
            html += '<p style="font-size:14px;color:#666;margin:0">Trial ID: <strong>' + trialId + '</strong></p>';
            html += '</div>';
            html += '<div class="header-right">';
            if (logoEmpresa) {
                html += '<img src="' + logoEmpresa + '" alt="Logo Empresa">';
            } else {
                html += '<div style="width:300px;height:100px;background:#16a34a;border-radius:8px;display:flex;align-items:center;justify-content:center;color:white;font-size:24px;font-weight:bold">MIXTEC PRO</div>';
            }
            html += '</div>';
            html += '</div>';
            
            // Informaci√≥n General
            html += '<h2>Informaci√≥n General</h2>';
            html += '<div class="info-grid">';
            html += '<div class="info-item"><strong>Mix Design Base:</strong> ' + (mix ? mix.nombre : 'N/A') + '</div>';
            html += '<div class="info-item"><strong>Fecha del Trial:</strong> ' + new Date(trial.fecha).toLocaleDateString('es-ES') + '</div>';
            html += '<div class="info-item"><strong>Hora:</strong> ' + (trial.hora || 'N/A') + '</div>';
            html += '<div class="info-item"><strong>Tama√±o del Batch:</strong> ' + trial.tamano + ' ft¬≥</div>';
            html += '<div class="info-item"><strong>T√©cnico:</strong> ' + (trial.tecnico || 'N/A') + '</div>';
            html += '<div class="info-item"><strong>Resistencia Objetivo:</strong> ' + (mix ? mix.resistencia + ' psi' : 'N/A') + '</div>';
            html += '</div>';
            
            // Propiedades del Concreto Fresco
            html += '<h2>Propiedades del Concreto Fresco</h2>';
            html += '<table>';
            html += '<thead><tr><th>Propiedad</th><th>Valor Medido</th><th>Especificaci√≥n</th></tr></thead>';
            html += '<tbody>';
            html += '<tr><td>Slump</td><td>' + (trial.slump || '-') + ' in</td><td>' + (mix ? mix.slump + ' in' : '-') + '</td></tr>';
            html += '<tr><td>Temperatura</td><td>' + (trial.temperatura || '-') + ' ¬∞F</td><td>50-90 ¬∞F</td></tr>';
            html += '<tr><td>Contenido de Aire</td><td>' + (trial.aire || '-') + ' %</td><td>' + (mix ? mix.contenidoAire + ' %' : '-') + '</td></tr>';
            html += '<tr><td>Peso Unitario</td><td>' + (trial.pesoUnitario || '-') + ' lb/ft¬≥</td><td>-</td></tr>';
            html += '</tbody></table>';
            
            // Resultados de Cilindros
            html += '<h2>Resultados de Ensayos de Compresi√≥n</h2>';
            html += '<table>';
            html += '<thead><tr><th>Cilindro</th><th>Edad (d√≠as)</th><th>Fecha de Ensayo</th><th>Resistencia (psi)</th><th>% de f\'c</th></tr></thead>';
            html += '<tbody>';

            var resistenciaObjetivo = mix ? mix.resistencia : 0;
            for (var i = 0; i < trial.cilindros.length; i++) {
                var c = trial.cilindros[i];
                var porcentaje = resistenciaObjetivo > 0 && c.resistencia ? ((c.resistencia / resistenciaObjetivo) * 100).toFixed(1) : '-';
                html += '<tr>';
                html += '<td>' + c.numero + '</td>';
                html += '<td>' + c.diasCurado + '</td>';
                html += '<td>' + (c.fechaEnsayo ? new Date(c.fechaEnsayo).toLocaleDateString('es-ES') : '-') + '</td>';
                html += '<td><strong>' + (c.resistencia || '-') + '</strong></td>';
                html += '<td>' + (porcentaje !== '-' ? porcentaje + '%' : '-') + '</td>';
                html += '</tr>';
            }

            html += '</tbody></table>';
            
            // Observaciones
            if (trial.observaciones) {
                html += '<h2>Observaciones</h2>';
                html += '<div style="background:#f8f9fa;padding:15px;border-radius:8px;border-left:4px solid #16a34a">';
                html += '<p style="margin:0;white-space:pre-wrap">' + trial.observaciones + '</p>';
                html += '</div>';
            }
            
            // Gr√°fica de Resistencia
            html += '<h2>Curva de Desarrollo de Resistencia</h2>';
            html += '<div class="chart-container">';
            html += '<canvas id="chart-resistencia" width="900" height="500"></canvas>';
            html += '</div>';
            
            html += '<p style="margin-top:40px;text-align:center;color:#666;font-size:12px">';
            html += 'Reporte generado: ' + new Date().toLocaleString('es-ES') + '</p>';
            html += '</body></html>';

            var win = window.open('', '_blank');
            if (!win) {
                alert('‚ùå Bloqueador de ventanas emergentes activado. Por favor permite ventanas emergentes para este sitio.');
                return;
            }
            
            win.document.write(html);
            win.document.close();
            
            // Dibujar gr√°fica despu√©s de que el documento est√© listo
            setTimeout(function() {
                try {
                    var canvas = win.document.getElementById('chart-resistencia');
                    if (!canvas) {
                        console.error('Canvas no encontrado');
                        return;
                    }
                    
                    var ctx = canvas.getContext('2d');
                    var padding = 80;
                    var chartWidth = canvas.width - 2 * padding;
                    var chartHeight = canvas.height - 2 * padding;
                    
                    // Preparar datos - agrupar por d√≠as de curado y calcular promedio
                    var dataByAge = {};
                    for (var i = 0; i < trial.cilindros.length; i++) {
                        var c = trial.cilindros[i];
                        if (c.resistencia && c.resistencia > 0) {
                            var age = parseInt(c.diasCurado) || 0;
                            if (!dataByAge[age]) {
                                dataByAge[age] = {
                                    sum: 0,
                                    count: 0
                                };
                            }
                            dataByAge[age].sum += parseFloat(c.resistencia);
                            dataByAge[age].count += 1;
                        }
                    }
                    
                    // Calcular promedios
                    var chartData = [];
                    for (var age in dataByAge) {
                        chartData.push({
                            age: parseInt(age),
                            strength: dataByAge[age].sum / dataByAge[age].count,
                            count: dataByAge[age].count
                        });
                    }
                    
                    if (chartData.length === 0) {
                        ctx.fillStyle = '#666';
                        ctx.font = '16px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText('No hay datos de resistencia para graficar', canvas.width / 2, canvas.height / 2);
                        return;
                    }
                    
                    // Ordenar por edad
                    chartData.sort(function(a, b) { return a.age - b.age; });
                    
                    // Calcular escalas
                    var maxAge = Math.max.apply(null, chartData.map(function(d) { return d.age; }));
                    maxAge = Math.ceil(maxAge * 1.2 / 10) * 10; // Redondear al m√∫ltiplo de 10 m√°s cercano
                    
                    var targetStrength = resistenciaObjetivo;
                    var maxDataStrength = Math.max.apply(null, chartData.map(function(d) { return d.strength; }));
                    var maxStrength = Math.max(maxDataStrength, targetStrength) * 1.2;
                    maxStrength = Math.ceil(maxStrength / 500) * 500; // Redondear al m√∫ltiplo de 500
                    
                    // Fondo blanco
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Cuadr√≠cula
                    ctx.strokeStyle = '#e0e0e0';
                    ctx.lineWidth = 1;
                    
                    // L√≠neas horizontales
                    for(var i = 0; i <= 5; i++) {
                        var y = canvas.height - padding - (i / 5) * chartHeight;
                        ctx.beginPath();
                        ctx.moveTo(padding, y);
                        ctx.lineTo(canvas.width - padding, y);
                        ctx.stroke();
                    }
                    
                    // L√≠neas verticales
                    var numVerticalLines = Math.min(10, maxAge);
                    for(var i = 0; i <= numVerticalLines; i++) {
                        var x = padding + (i / numVerticalLines) * chartWidth;
                        ctx.beginPath();
                        ctx.moveTo(x, padding);
                        ctx.lineTo(x, canvas.height - padding);
                        ctx.stroke();
                    }
                    
                    // Ejes
                    ctx.strokeStyle = '#333';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(padding, padding);
                    ctx.lineTo(padding, canvas.height - padding);
                    ctx.lineTo(canvas.width - padding, canvas.height - padding);
                    ctx.stroke();
                    
                    // Etiquetas de los ejes
                    ctx.fillStyle = '#333';
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('Edad (d√≠as)', canvas.width / 2, canvas.height - 30);
                    
                    ctx.save();
                    ctx.translate(25, canvas.height / 2);
                    ctx.rotate(-Math.PI / 2);
                    ctx.fillText('Resistencia Promedio a la Compresi√≥n (psi)', 0, 0);
                    ctx.restore();
                    
                    // L√≠nea de resistencia objetivo (f'c)
                    if (targetStrength > 0) {
                        var targetY = canvas.height - padding - (targetStrength / maxStrength) * chartHeight;
                        ctx.strokeStyle = '#ef4444';
                        ctx.lineWidth = 2;
                        ctx.setLineDash([10, 5]);
                        ctx.beginPath();
                        ctx.moveTo(padding, targetY);
                        ctx.lineTo(canvas.width - padding, targetY);
                        ctx.stroke();
                        ctx.setLineDash([]);
                        
                        ctx.fillStyle = '#ef4444';
                        ctx.font = 'bold 14px Arial';
                        ctx.textAlign = 'left';
                        ctx.fillText("f'c = " + targetStrength + " psi", padding + 10, targetY - 8);
                    }
                    
                    // Dibujar l√≠nea de datos
                    ctx.strokeStyle = '#16a34a';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    
                    for(var i = 0; i < chartData.length; i++) {
                        var point = chartData[i];
                        var x = padding + (point.age / maxAge) * chartWidth;
                        var y = canvas.height - padding - (point.strength / maxStrength) * chartHeight;
                        
                        if(i === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    }
                    ctx.stroke();
                    
                    // Dibujar puntos de datos
                    for(var i = 0; i < chartData.length; i++) {
                        var point = chartData[i];
                        var x = padding + (point.age / maxAge) * chartWidth;
                        var y = canvas.height - padding - (point.strength / maxStrength) * chartHeight;
                        
                        // Punto
                        ctx.fillStyle = '#16a34a';
                        ctx.beginPath();
                        ctx.arc(x, y, 7, 0, 2 * Math.PI);
                        ctx.fill();
                        
                        ctx.strokeStyle = 'white';
                        ctx.lineWidth = 3;
                        ctx.stroke();
                        
                        // Etiqueta del valor con indicador de promedio
                        ctx.fillStyle = '#333';
                        ctx.font = 'bold 13px Arial';
                        ctx.textAlign = 'center';
                        var label = point.strength.toFixed(0) + ' psi';
                        if (point.count > 1) {
                            label += ' (Prom.)';
                        }
                        ctx.fillText(label, x, y - 18);
                        
                        // Etiqueta de edad con contador de muestras
                        ctx.fillStyle = '#666';
                        ctx.font = '12px Arial';
                        var ageLabel = point.age + ' d√≠as';
                        if (point.count > 1) {
                            ageLabel += ' (n=' + point.count + ')';
                        }
                        ctx.fillText(ageLabel, x, canvas.height - padding + 25);
                    }
                    
                    // Escala del eje Y
                    ctx.fillStyle = '#666';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'right';
                    for(var i = 0; i <= 5; i++) {
                        var value = (maxStrength / 5) * i;
                        var y = canvas.height - padding - (i / 5) * chartHeight;
                        ctx.fillText(value.toFixed(0), padding - 15, y + 5);
                    }
                    
                } catch(error) {
                    console.error('Error dibujando gr√°fica:', error);
                }
            }, 800);
        }



                async function generarQRTrial() {
            console.log('üîç Iniciando generaci√≥n de QR Code...');
            
            const trialId = document.getElementById('trial-id-display').value;
            const mixId = document.getElementById('trial-mixdesign').value;
            
            console.log('Trial ID:', trialId);
            console.log('Mix ID:', mixId);
            
            if (!trialId) {
                alert('‚ö†Ô∏è Primero guarda el trial mix');
                return;
            }
            
            if (!mixId) {
                alert('‚ö†Ô∏è Selecciona un mix design');
                return;
            }

            try {
                // Verificar si QRCode est√° disponible
                if (typeof QRCode === 'undefined') {
                    throw new Error('Librer√≠a QRCode no est√° cargada. Recarga la p√°gina.');
                }

                // Obtener todos los datos del trial actual
                const trials = await getAllRecords('trials');
                console.log('üì¶ Trials encontrados:', trials.length);
                
                let trial = null;
                for (let i = 0; i < trials.length; i++) {
                    if (trials[i].trialId === trialId) {
                        trial = trials[i];
                        break;
                    }
                }
                
                if (!trial) {
                    alert('‚ö†Ô∏è No se encontr√≥ el trial. Aseg√∫rate de guardar el trial primero.');
                    console.error('Trial no encontrado con ID:', trialId);
                    return;
                }

                console.log('‚úÖ Trial encontrado:', trial);

                const mix = await getRecord('mixdesigns', parseInt(mixId));
                console.log('‚úÖ Mix design:', mix);
                
                // Versi√≥n COMPACTA para QR (optimizada para escaneo)
                let qrText = '=== TRIAL MIX ===\n';
                qrText += 'ID: ' + trialId + '\n';
                qrText += 'Mix: ' + (mix ? mix.nombre : 'N/A') + '\n';
                qrText += 'Fecha: ' + new Date(trial.fecha).toLocaleDateString('es-ES') + '\n';
                if (trial.hora) qrText += 'Hora: ' + trial.hora + '\n';
                if (trial.tecnico) qrText += 'Tec: ' + trial.tecnico + '\n';
                
                qrText += '\nESPECIFICACIONES:\n';
                if (mix && mix.resistencia) qrText += "f'c: " + mix.resistencia + ' psi\n';
                qrText += 'Batch: ' + trial.tamano + ' ft3\n';
                
                qrText += '\nFRESCO:\n';
                if (trial.slump) qrText += 'Slump: ' + trial.slump + ' in\n';
                if (trial.temperatura) qrText += 'Temp: ' + trial.temperatura + ' F\n';
                if (trial.aire) qrText += 'Aire: ' + trial.aire + '%\n';
                if (trial.pesoUnitario) qrText += 'PU: ' + trial.pesoUnitario + ' pcf\n';
                
                qrText += '\nRESISTENCIAS:\n';
                if (trial.cilindros && trial.cilindros.length > 0) {
                    // Agrupar por edad y calcular promedio
                    const byAge = {};
                    trial.cilindros.forEach(c => {
                        if (c.resistencia && c.resistencia > 0) {
                            const age = c.diasCurado;
                            if (!byAge[age]) {
                                byAge[age] = { sum: 0, count: 0 };
                            }
                            byAge[age].sum += parseFloat(c.resistencia);
                            byAge[age].count++;
                        }
                    });
                    
                    // Ordenar por edad
                    const ages = Object.keys(byAge).map(a => parseInt(a)).sort((a, b) => a - b);
                    ages.forEach(age => {
                        const avg = byAge[age].sum / byAge[age].count;
                        const count = byAge[age].count;
                        qrText += age + 'd: ' + avg.toFixed(0) + ' psi';
                        if (count > 1) qrText += ' (n=' + count + ')';
                        
                        // Calcular % de f'c
                        if (mix && mix.resistencia) {
                            const percent = (avg / mix.resistencia * 100).toFixed(0);
                            qrText += ' (' + percent + '%)';
                        }
                        qrText += '\n';
                    });
                } else {
                    qrText += 'Sin datos\n';
                }
                
                if (trial.observaciones && trial.observaciones.length > 0) {
                    qrText += '\nOBS: ';
                    qrText += trial.observaciones.substring(0, 80);
                    if (trial.observaciones.length > 80) qrText += '...';
                    qrText += '\n';
                }

                console.log('üìù Texto del QR generado, longitud:', qrText.length);

                const qrContainer = document.getElementById('qr-code-container');
                if (!qrContainer) {
                    throw new Error('No se encontr√≥ el contenedor del QR');
                }
                
                qrContainer.innerHTML = '';
                
                console.log('üé® Generando QR Code...');
                
                new QRCode(qrContainer, {
                    text: qrText,
                    width: 256,
                    height: 256,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.L  // L=Low for more data capacity
                });
                
                console.log('‚úÖ QR Code generado, mostrando modal...');
                
                const modal = document.getElementById('qr-modal');
                if (!modal) {
                    throw new Error('No se encontr√≥ el modal del QR');
                }
                
                modal.style.display = 'flex';
                console.log('‚úÖ Modal mostrado correctamente');
                
            } catch (error) {
                console.error('‚ùå Error generando QR:', error);
                alert('‚ùå Error al generar QR Code: ' + error.message + '\n\nAbre la consola (F12) para m√°s detalles.');
            }
        }
        
        function cerrarModalQR() {
            document.getElementById('qr-modal').style.display = 'none';
        }


        
        function createStrengthChart(canvasId, data, targetStrength) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const padding = 80;
            const chartWidth = canvas.width - 2 * padding;
            const chartHeight = canvas.height - 2 * padding;
            
            // Ordenar por edad
            data.sort((a, b) => a.age - b.age);
            
            const maxAge = Math.max(...data.map(d => d.age)) * 1.2;
            const maxStrength = Math.max(...data.map(d => d.strength), targetStrength) * 1.2;
            
            // Fondo blanco
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Ejes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.stroke();
            
            // Etiquetas
            ctx.fillStyle = '#333';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Edad (d√≠as)', canvas.width / 2, canvas.height - 20);
            
            ctx.save();
            ctx.translate(20, canvas.height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Resistencia Promedio (psi)', 0, 0);
            ctx.restore();
            
            // Cuadr√≠cula
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for(let i = 0; i <= 5; i++) {
                const y = canvas.height - padding - (i / 5) * chartHeight;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();
            }
            
            // L√≠nea de resistencia objetivo
            if (targetStrength) {
                const targetY = canvas.height - padding - (targetStrength / maxStrength) * chartHeight;
                ctx.strokeStyle = '#ef4444';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(padding, targetY);
                ctx.lineTo(canvas.width - padding, targetY);
                ctx.stroke();
                ctx.setLineDash([]);
                
                ctx.fillStyle = '#ef4444';
                ctx.font = '12px Arial';
                ctx.textAlign = 'right';
                ctx.fillText("f'c = " + targetStrength + " psi", canvas.width - padding - 10, targetY - 5);
            }
            
            // L√≠nea de datos
            if(data.length > 0) {
                ctx.strokeStyle = '#16a34a';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                data.forEach((point, index) => {
                    const x = padding + (point.age / maxAge) * chartWidth;
                    const y = canvas.height - padding - (point.strength / maxStrength) * chartHeight;
                    
                    if(index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();
                
                // Puntos
                data.forEach(point => {
                    const x = padding + (point.age / maxAge) * chartWidth;
                    const y = canvas.height - padding - (point.strength / maxStrength) * chartHeight;
                    
                    ctx.fillStyle = '#16a34a';
                    ctx.beginPath();
                    ctx.arc(x, y, 6, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    ctx.fillStyle = '#333';
                    ctx.font = 'bold 12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(point.strength.toFixed(0) + ' psi', x, y - 15);
                });
            }
            
            // Marcas eje X
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            data.forEach(point => {
                const x = padding + (point.age / maxAge) * chartWidth;
                ctx.fillText(point.age + ' d√≠as', x, canvas.height - padding + 20);
            });
            
            // Marcas eje Y
            ctx.textAlign = 'right';
            for(let i = 0; i <= 5; i++) {
                const value = (maxStrength / 5) * i;
                const y = canvas.height - padding - (i / 5) * chartHeight;
                ctx.fillText(value.toFixed(0), padding - 10, y + 5);
            }
        }

        // ============ DASHBOARD ============
        async function updateDashboard() {
            const clientes = await getAllRecords('clientes');
            const proyectos = await getAllRecords('proyectos');
            const materiales = await getAllRecords('materiales');
            const cotizaciones = await getAllRecords('cotizaciones');
            const mixdesigns = await getAllRecords('mixdesigns');
            const trials = await getAllRecords('trials');

            document.getElementById('stat-clientes').textContent = clientes.length;
            document.getElementById('stat-proyectos').textContent = proyectos.filter(p => p.estado === 'active').length;
            document.getElementById('stat-cotizaciones').textContent = cotizaciones.length;
            document.getElementById('stat-mixdesigns').textContent = mixdesigns.length;
            document.getElementById('stat-trials').textContent = trials.length;

            // Resumen de Cotizaciones por Status
            const cotizacionesPorStatus = {
                'Pendiente': 0,
                'Aprobada': 0,
                'Rechazada': 0,
                'En Revisi√≥n': 0,
                'Cancelada': 0
            };
            
            let totalYdCotizaciones = 0;
            
            cotizaciones.forEach(c => {
                const status = c.status || 'Pendiente';
                cotizacionesPorStatus[status] = (cotizacionesPorStatus[status] || 0) + 1;
                totalYdCotizaciones += (c.totalYd || 0);
            });

            const containerCotSummary = document.getElementById('dashboard-cotizaciones-summary');
            if (cotizaciones.length === 0) {
                containerCotSummary.innerHTML = '<div class="empty-state">No hay cotizaciones registradas</div>';
            } else {
                let htmlCotSummary = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <div style="font-size: 12px; color: #92400e; font-weight: bold; margin-bottom: 5px;">‚è≥ PENDIENTES</div>
                            <div style="font-size: 28px; font-weight: bold; color: #f59e0b;">${cotizacionesPorStatus['Pendiente']}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #16a34a;">
                            <div style="font-size: 12px; color: #166534; font-weight: bold; margin-bottom: 5px;">‚úÖ APROBADAS</div>
                            <div style="font-size: 28px; font-weight: bold; color: #16a34a;">${cotizacionesPorStatus['Aprobada']}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #0369a1;">
                            <div style="font-size: 12px; color: #075985; font-weight: bold; margin-bottom: 5px;">üëÅÔ∏è EN REVISI√ìN</div>
                            <div style="font-size: 28px; font-weight: bold; color: #0369a1;">${cotizacionesPorStatus['En Revisi√≥n']}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #dc2626;">
                            <div style="font-size: 12px; color: #991b1b; font-weight: bold; margin-bottom: 5px;">‚ùå RECHAZADAS</div>
                            <div style="font-size: 28px; font-weight: bold; color: #dc2626;">${cotizacionesPorStatus['Rechazada']}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #0369a1;">
                            <div style="font-size: 12px; color: #1e3a8a; font-weight: bold; margin-bottom: 5px;">üìä TOTAL YD¬≥</div>
                            <div style="font-size: 24px; font-weight: bold; color: #0369a1;">${totalYdCotizaciones.toFixed(2)} yd¬≥</div>
                        </div>
                    </div>
                `;
                
                // Cotizaciones recientes
                const recentCotizaciones = cotizaciones.slice(-5).reverse();
                htmlCotSummary += '<h3 style="margin: 20px 0 10px 0;">Cotizaciones Recientes</h3>';
                htmlCotSummary += '<table><thead><tr><th>N√∫mero</th><th>Status</th><th>Cliente</th><th>Proyecto</th><th>Total YD¬≥</th></tr></thead><tbody>';
                recentCotizaciones.forEach(c => {
                    const statusColor = {
                        'Pendiente': '#f59e0b',
                        'Aprobada': '#16a34a',
                        'Rechazada': '#dc2626',
                        'En Revisi√≥n': '#0369a1',
                        'Cancelada': '#6b7280'
                    }[c.status || 'Pendiente'];
                    htmlCotSummary += `<tr>
                        <td><strong>${c.numero}</strong></td>
                        <td><span style="background: ${statusColor}; color: white; padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: bold;">${c.status || 'Pendiente'}</span></td>
                        <td>${c.clienteNombre}</td>
                        <td>${c.proyecto}</td>
                        <td style="color: #0369a1; font-weight: bold;">${(c.totalYd || 0).toFixed(2)} yd¬≥</td>
                    </tr>`;
                });
                htmlCotSummary += '</tbody></table>';
                containerCotSummary.innerHTML = htmlCotSummary;
            }

            // Mix Designs recientes
            const recentMix = mixdesigns.slice(-5).reverse();
            const containerMix = document.getElementById('recent-mixdesigns');
            if (recentMix.length === 0) {
                containerMix.innerHTML = '<div class="empty-state">No hay mix designs</div>';
            } else {
                let htmlMix = '<table><thead><tr><th>Nombre</th><th>Resistencia</th><th>W/C</th><th>Costo</th></tr></thead><tbody>';
                recentMix.forEach(m => {
                    htmlMix += `<tr><td>${m.nombre}</td><td>${m.resistencia} PSI</td><td>${m.resultados.wc.toFixed(2)}</td><td>$${m.resultados.costoTotal.toFixed(2)}</td></tr>`;
                });
                htmlMix += '</tbody></table>';
                containerMix.innerHTML = htmlMix;
            }

            // Trials recientes
            const recentTrials = trials.slice(-5).reverse();
            const containerTrials = document.getElementById('recent-trials');
            if (recentTrials.length === 0) {
                containerTrials.innerHTML = '<div class="empty-state">No hay trial mixes</div>';
            } else {
                let htmlTrials = '<table><thead><tr><th>Trial ID</th><th>Mix Design</th><th>Tama√±o</th><th>Slump</th><th>Fecha</th></tr></thead><tbody>';
                recentTrials.forEach(t => {
                    htmlTrials += `<tr><td><span class="trial-badge">${t.trialId}</span></td><td>${t.mixDesignNombre}</td><td>${t.tamano} ft¬≥</td><td>${t.slump || '-'} in</td><td>${new Date(t.fecha).toLocaleDateString()}</td></tr>`;
                });
                htmlTrials += '</tbody></table>';
                containerTrials.innerHTML = htmlTrials;
            }
        }

        // ============ UTILIDADES ============
        
        function nuevoTrialMix() {
            clearForm('trial');
            document.getElementById('form-trial').reset();
            generarTrialId().then(id => {
                document.getElementById('trial-id-display').value = id;
            });
            document.getElementById('edit-trial-id').value = '';
            alert('‚úÖ Formulario listo para nuevo trial mix');
        }

        function clearForm(tipo) {
            const form = document.getElementById(`form-${tipo}`);
            if (form) form.reset();
            
            const editId = document.getElementById(`edit-${tipo}-id`);
            if (editId) editId.value = '';
            
            if (tipo === 'mixdesign') {
                document.getElementById('mix-results').style.display = 'none';
                currentMixResults = null;
                document.getElementById('btn-reporte').disabled = true;
                document.getElementById('btn-reporte-costos').disabled = true;
                document.getElementById('btn-mixdesign').disabled = true;
                document.getElementById('pct-arena1').value = 60;
                document.getElementById('pct-arena2').value = 40;
                calcularVolumenes();
            }
            
            if (tipo === 'trial') {
                document.getElementById('mix-design-preview').style.display = 'none';
                document.getElementById('trial-cantidades').style.display = 'none';
                document.getElementById('trial-tamano-custom-group').style.display = 'none';
                document.getElementById('cilindros-container').innerHTML = '';
                currentTrialData = null;
                document.getElementById('btn-reporte-trial').disabled = true;
                document.getElementById('btn-qr-trial').disabled = true;
                generarTrialId().then(id => {
                    document.getElementById('trial-id-display').value = id;
                });
            }
        }

        // ============ CARGAR ADITIVOS EN SELECTS ============
        async function cargarAditivosEnSelects() {
            const materiales = await getAllRecords('materiales');
            const aditivos = materiales.filter(m => m.categoria === 'aditivos');
            
            const selects = ['nombre-aditivo1', 'nombre-aditivo2', 'nombre-aditivo3'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const valorActual = select.value;
                select.innerHTML = '<option value="">Ninguno</option>';
                aditivos.forEach(aditivo => {
                    select.innerHTML += `<option value="${aditivo.nombre}" data-precio="${aditivo.precio || 0}">${aditivo.nombre}</option>`;
                });
                if (valorActual && aditivos.find(a => a.nombre === valorActual)) {
                    select.value = valorActual;
                }
            });
            
            // Agregar event listeners para actualizar precios cuando se selecciona un aditivo
            document.getElementById('nombre-aditivo1').addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const precio = selectedOption.getAttribute('data-precio') || 0;
                document.getElementById('precio-aditivo1').value = precio;
            });
            
            document.getElementById('nombre-aditivo2').addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const precio = selectedOption.getAttribute('data-precio') || 0;
                document.getElementById('precio-aditivo2').value = precio;
            });
            
            document.getElementById('nombre-aditivo3').addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const precio = selectedOption.getAttribute('data-precio') || 0;
                document.getElementById('precio-aditivo3').value = precio;
            });
        }

        // ============ INICIALIZACI√ìN ============
        document.getElementById('mix-fecha').valueAsDate = new Date();
        document.getElementById('trial-fecha').valueAsDate = new Date();
        
        // Listener para recalcular fechas de rotura cuando cambia la fecha del trial
        document.getElementById('trial-fecha').addEventListener('change', function() {
            const numCilindros = parseInt(document.getElementById('trial-num-cilindros').value) || 0;
            for (let i = 1; i <= numCilindros; i++) {
                calcularFechaRotura(i);
            }
        });
        
        // Inicializar filtro de calendario con mes actual
        const hoy = new Date();
        const mesActual = hoy.toISOString().slice(0, 7);
        document.getElementById('filtro-mes-calendario').value = mesActual;
        
        // ============ AN√ÅLISIS DE DATA ============
        
        let analisisChart = null;
        let selectedAnalisisMixes = [];

        async function loadAnalisisData() {
            const trials = await getAllRecords('trials');
            const mixdesigns = await getAllRecords('mixdesigns');
            
            const analisisData = [];
            
            for (const trial of trials) {
                if (!trial.cilindros || trial.cilindros.length === 0) continue;
                
                const mixDesign = mixdesigns.find(m => m.id === trial.mixDesignId);
                const resistenciaObjetivo = mixDesign ? mixDesign.resistencia : 3000;
                
                // Obtener contenido de cemento en lb desde el mix design
                const cementoPeso = mixDesign && mixDesign.resultados && mixDesign.resultados.cemento 
                    ? parseFloat(mixDesign.resultados.cemento.peso) 
                    : (mixDesign && mixDesign.pesoCemento ? parseFloat(mixDesign.pesoCemento) : 0);

                trial.cilindros.forEach(cilindro => {
                    if (cilindro.resistencia && cilindro.resistencia > 0) {
                        analisisData.push({
                            trialId: trial.id,
                            trialName: trial.trialId || `Trial-${trial.id}`,
                            mixName: mixDesign ? mixDesign.nombre : 'N/A',
                            diasCurado: parseInt(cilindro.diasCurado) || 0,
                            resistencia: parseFloat(cilindro.resistencia),
                            resistenciaObjetivo: resistenciaObjetivo,
                            eficiencia: (parseFloat(cilindro.resistencia) / resistenciaObjetivo * 100).toFixed(1),
                            fechaRotura: cilindro.fechaRotura,
                            fechaColado: trial.fecha,
                            cementoPeso: cementoPeso
                        });
                    }
                });
            }
            
            return analisisData;
        }

        async function updateAnalisisMixFilter() {
            const trials = await getAllRecords('trials');
            const mixdesigns = await getAllRecords('mixdesigns');
            const container = document.getElementById('analisis-mix-checkboxes');
            
            if (!container) return;
            
            container.innerHTML = '';
            
            trials.forEach(trial => {
                if (!trial.cilindros || trial.cilindros.length === 0) return;
                
                const mixDesign = mixdesigns.find(m => m.id === trial.mixDesignId);
                const isChecked = selectedAnalisisMixes.length === 0 || selectedAnalisisMixes.includes(trial.id);
                
                const label = document.createElement('label');
                label.style.cssText = 'display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 5px; border-radius: 4px;';
                label.innerHTML = `
                    <input type="checkbox" value="${trial.id}" ${isChecked ? 'checked' : ''} onchange="handleAnalisisMixFilterChange(this)">
                    <span>${trial.trialId || `Trial-${trial.id}`} - ${mixDesign ? mixDesign.nombre : 'N/A'}</span>
                `;
                
                label.onmouseover = () => label.style.background = '#f0f0f0';
                label.onmouseout = () => label.style.background = 'transparent';
                
                container.appendChild(label);
            });
            
            updateAnalisisMixFilterLabel();
        }

        function toggleAnalisisMixFilter() {
            const dropdown = document.getElementById('analisis-mix-dropdown');
            if (dropdown) dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }

        function handleAnalisisMixFilterChange(checkbox) {
            const value = checkbox.value;
            const allCheckbox = document.querySelector('#analisis-mix-dropdown input[value="all"]');
            
            if (value === 'all') {
                const checkboxes = document.querySelectorAll('#analisis-mix-checkboxes input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = checkbox.checked);
                selectedAnalisisMixes = checkbox.checked ? [] : ['none'];
            } else {
                if (checkbox.checked) {
                    if (selectedAnalisisMixes.includes('none')) selectedAnalisisMixes = [];
                    if (!selectedAnalisisMixes.includes(parseInt(value))) {
                        selectedAnalisisMixes.push(parseInt(value));
                    }
                } else {
                    selectedAnalisisMixes = selectedAnalisisMixes.filter(id => id !== parseInt(value));
                    if (allCheckbox) allCheckbox.checked = false;
                }
                
                const checkboxes = document.querySelectorAll('#analisis-mix-checkboxes input[type="checkbox"]');
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                if (allCheckbox) allCheckbox.checked = allChecked;
                
                if (selectedAnalisisMixes.length === 0) {
                    selectedAnalisisMixes = [];
                    if (allCheckbox) allCheckbox.checked = true;
                }
            }
            
            updateAnalisisMixFilterLabel();
        }

        function updateAnalisisMixFilterLabel() {
            const label = document.getElementById('analisis-filter-label');
            if (!label) return;
            
            const checkboxes = document.querySelectorAll('#analisis-mix-checkboxes input[type="checkbox"]:checked');
            const totalCheckboxes = document.querySelectorAll('#analisis-mix-checkboxes input[type="checkbox"]');
            
            if (selectedAnalisisMixes.length === 0 || checkboxes.length === totalCheckboxes.length) {
                label.textContent = 'Todas las mezclas';
            } else {
                label.textContent = `${checkboxes.length} mezcla(s) seleccionada(s)`;
            }
        }

        async function updateAnalisisCharts() {
            const allData = await loadAnalisisData();
            const viewType = document.getElementById('analisis-view-type').value;
            
            let filteredData = allData;
            if (selectedAnalisisMixes.length > 0 && !selectedAnalisisMixes.includes('none')) {
                filteredData = allData.filter(d => selectedAnalisisMixes.includes(d.trialId));
            }
            
            if (filteredData.length === 0) {
                alert('‚ö†Ô∏è No hay datos para mostrar. Aseg√∫rate de tener Trial Mixes con cilindros rotos.');
                return;
            }
            
            updateAnalisisStats(filteredData);
            
            if (viewType === 'evolution') {
                renderEvolutionChart(filteredData);
            } else if (viewType === 'efficiency') {
                renderEfficiencyChart(filteredData);
            } else if (viewType === 'comparison') {
                renderComparisonChart(filteredData);
            }
            
            renderAnalisisTable(filteredData);
        }

        function calcStdDev(values) {
            if (values.length < 2) return 0;
            const avg = values.reduce((s, v) => s + v, 0) / values.length;
            const variance = values.reduce((s, v) => s + Math.pow(v - avg, 2), 0) / (values.length - 1);
            return Math.sqrt(variance);
        }

        function updateAnalisisStats(data) {
            const container = document.getElementById('analisis-stats');
            if (!container) return;
            
            const totalTests = data.length;
            const maxResistencia = Math.max(...data.map(d => d.resistencia));
            const uniqueTrials = [...new Set(data.map(d => d.trialId))].length;
            
            // Agrupar por edad (d√≠as de curado)
            const byAge = {};
            data.forEach(d => {
                if (!byAge[d.diasCurado]) byAge[d.diasCurado] = [];
                byAge[d.diasCurado].push(d);
            });

            // Construir tarjetas de promedio + desviaci√≥n por edad
            const ages = Object.keys(byAge).map(Number).sort((a, b) => a - b);
            const ageCardsHtml = ages.map(age => {
                const resistencias = byAge[age].map(d => d.resistencia);
                const avg = resistencias.reduce((s, v) => s + v, 0) / resistencias.length;
                const std = calcStdDev(resistencias);
                const eficiencias = byAge[age].map(d => parseFloat(d.eficiencia));
                const avgEf = eficiencias.reduce((s, v) => s + v, 0) / eficiencias.length;
                return `
                <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <div style="font-size: 12px; color: #92400e; font-weight: bold; margin-bottom: 5px;">üí™ PROMEDIO ${age} D√çAS</div>
                    <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">${avg.toFixed(0)} PSI</div>
                    <div style="font-size: 11px; color: #92400e;">œÉ = ${std.toFixed(0)} PSI | Efic: ${avgEf.toFixed(1)}% | n=${resistencias.length}</div>
                </div>`;
            }).join('');

            // Tarjeta de eficiencia de cemento (PSI por lb de cemento)
            const cementDataAll = data.filter(d => d.cementoPeso && d.cementoPeso > 0);
            let cementCardHtml = '';
            if (cementDataAll.length > 0) {
                // Agrupar por trial y edad, usar promedio resistencia a 28 d√≠as preferentemente
                const byTrialCement = {};
                cementDataAll.forEach(d => {
                    if (!byTrialCement[d.trialName]) byTrialCement[d.trialName] = { resistencias: [], cemento: d.cementoPeso };
                    byTrialCement[d.trialName].resistencias.push(d.resistencia);
                });
                const cementEffValues = Object.values(byTrialCement).map(t => {
                    const avgR = t.resistencias.reduce((s, v) => s + v, 0) / t.resistencias.length;
                    return avgR / t.cemento;
                });
                const avgCementEff = cementEffValues.reduce((s, v) => s + v, 0) / cementEffValues.length;
                const bestCementEff = Math.max(...cementEffValues);
                cementCardHtml = `
                <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #059669; grid-column: span 1;">
                    <div style="font-size: 12px; color: #065f46; font-weight: bold; margin-bottom: 5px;">‚öóÔ∏è EFICIENCIA DE CEMENTO</div>
                    <div style="font-size: 24px; font-weight: bold; color: #059669;">${avgCementEff.toFixed(2)} PSI/lb</div>
                    <div style="font-size: 11px; color: #065f46; margin-top: 4px;">Mejor mezcla: ${bestCementEff.toFixed(2)} PSI/lb</div>
                    <div style="font-size: 10px; color: #6b7280; margin-top: 2px;">Resistencia promedio √∑ Cemento (lb/yd¬≥)</div>
                </div>`;
            } else {
                cementCardHtml = `
                <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #059669;">
                    <div style="font-size: 12px; color: #065f46; font-weight: bold; margin-bottom: 5px;">‚öóÔ∏è EFICIENCIA DE CEMENTO</div>
                    <div style="font-size: 18px; font-weight: bold; color: #059669;">N/D</div>
                    <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">Requiere contenido de cemento en el Mix Design</div>
                </div>`;
            }

            container.innerHTML = `
                <div style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #16a34a;">
                    <div style="font-size: 12px; color: #166534; font-weight: bold; margin-bottom: 5px;">üß™ TOTAL ENSAYOS</div>
                    <div style="font-size: 28px; font-weight: bold; color: #16a34a;">${totalTests}</div>
                </div>
                <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #0369a1;">
                    <div style="font-size: 12px; color: #075985; font-weight: bold; margin-bottom: 5px;">üìä TRIAL MIXES</div>
                    <div style="font-size: 28px; font-weight: bold; color: #0369a1;">${uniqueTrials}</div>
                </div>
                ${ageCardsHtml}
                ${cementCardHtml}
                <div style="background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #ec4899;">
                    <div style="font-size: 12px; color: #9f1239; font-weight: bold; margin-bottom: 5px;">üèÜ M√ÅXIMA RESISTENCIA</div>
                    <div style="font-size: 28px; font-weight: bold; color: #ec4899;">${maxResistencia.toFixed(0)} PSI</div>
                </div>
            `;
        }

        function renderEvolutionChart(data) {
            const groupedData = {};
            
            data.forEach(d => {
                if (!groupedData[d.trialName]) groupedData[d.trialName] = {};
                if (!groupedData[d.trialName][d.diasCurado]) groupedData[d.trialName][d.diasCurado] = [];
                groupedData[d.trialName][d.diasCurado].push(d.resistencia);
            });
            
            const datasets = [];
            const colors = ['#16a34a', '#0369a1', '#f59e0b', '#ec4899', '#8b5cf6', '#14b8a6'];
            let colorIndex = 0;
            
            Object.keys(groupedData).forEach(trialName => {
                const points = [];
                Object.keys(groupedData[trialName]).sort((a, b) => a - b).forEach(dias => {
                    const resistencias = groupedData[trialName][dias];
                    const avg = resistencias.reduce((sum, r) => sum + r, 0) / resistencias.length;
                    points.push({ x: parseInt(dias), y: avg });
                });
                
                datasets.push({
                    label: trialName,
                    data: points,
                    borderColor: colors[colorIndex % colors.length],
                    backgroundColor: colors[colorIndex % colors.length] + '33',
                    tension: 0.4,
                    pointRadius: 6,
                    pointHoverRadius: 8
                });
                colorIndex++;
            });
            
            renderChart({
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Evoluci√≥n de Resistencia (PSI) vs D√≠as de Curado', font: { size: 16, weight: 'bold' } },
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        x: { type: 'linear', title: { display: true, text: 'D√≠as de Curado' }, ticks: { stepSize: 7 } },
                        y: { title: { display: true, text: 'Resistencia (PSI)' }, beginAtZero: true }
                    }
                }
            });
        }

        function renderEfficiencyChart(data) {
            const groupedData = {};
            
            data.forEach(d => {
                if (!groupedData[d.trialName]) groupedData[d.trialName] = {};
                if (!groupedData[d.trialName][d.diasCurado]) groupedData[d.trialName][d.diasCurado] = [];
                groupedData[d.trialName][d.diasCurado].push(parseFloat(d.eficiencia));
            });
            
            const datasets = [];
            const colors = ['#16a34a', '#0369a1', '#f59e0b', '#ec4899', '#8b5cf6', '#14b8a6'];
            let colorIndex = 0;
            
            Object.keys(groupedData).forEach(trialName => {
                const points = [];
                Object.keys(groupedData[trialName]).sort((a, b) => a - b).forEach(dias => {
                    const eficiencias = groupedData[trialName][dias];
                    const avg = eficiencias.reduce((sum, e) => sum + e, 0) / eficiencias.length;
                    points.push({ x: parseInt(dias), y: avg });
                });
                
                datasets.push({
                    label: trialName,
                    data: points,
                    borderColor: colors[colorIndex % colors.length],
                    backgroundColor: colors[colorIndex % colors.length] + '33',
                    tension: 0.4,
                    pointRadius: 6,
                    pointHoverRadius: 8
                });
                colorIndex++;
            });
            
            datasets.push({
                label: '100% f\'c',
                data: [{ x: 0, y: 100 }, { x: 28, y: 100 }],
                borderColor: '#dc2626',
                borderDash: [5, 5],
                pointRadius: 0,
                borderWidth: 2
            });
            
            renderChart({
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: '% de Resistencia Alcanzada (f\'c) vs D√≠as de Curado', font: { size: 16, weight: 'bold' } },
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        x: { type: 'linear', title: { display: true, text: 'D√≠as de Curado' }, ticks: { stepSize: 7 } },
                        y: { title: { display: true, text: '% de f\'c' }, beginAtZero: true }
                    }
                }
            });
        }

        function renderComparisonChart(data) {
            // Agrupar por trial y luego por edad
            const byTrial = {};
            data.forEach(d => {
                if (!byTrial[d.trialName]) byTrial[d.trialName] = {};
                if (!byTrial[d.trialName][d.diasCurado]) byTrial[d.trialName][d.diasCurado] = [];
                byTrial[d.trialName][d.diasCurado].push(d.resistencia);
            });

            // Obtener todas las edades √∫nicas ordenadas
            const allAges = [...new Set(data.map(d => d.diasCurado))].sort((a, b) => a - b);
            // Labels = nombres de trial mixes
            const trialNames = Object.keys(byTrial);

            // Colores por edad
            const ageColors = ['#0369a1', '#16a34a', '#f59e0b', '#ec4899', '#8b5cf6', '#14b8a6'];

            // Un dataset por cada edad
            const datasets = allAges.map((age, i) => {
                return {
                    label: `${age} d√≠as`,
                    data: trialNames.map(name => {
                        const vals = byTrial[name][age];
                        if (!vals || vals.length === 0) return null;
                        return vals.reduce((s, v) => s + v, 0) / vals.length;
                    }),
                    backgroundColor: ageColors[i % ageColors.length] + 'cc',
                    borderColor: ageColors[i % ageColors.length],
                    borderWidth: 2
                };
            });

            renderChart({
                type: 'bar',
                data: {
                    labels: trialNames,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Comparaci√≥n de Resistencia Promedio por Edad entre Trial Mixes', font: { size: 16, weight: 'bold' } },
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Trial Mix' } },
                        y: { title: { display: true, text: 'Resistencia Promedio (PSI)' }, beginAtZero: true }
                    }
                }
            });
        }

        function renderChart(config) {
            const canvas = document.getElementById('analisis-chart-main');
            if (!canvas) return;
            
            if (analisisChart) {
                analisisChart.destroy();
            }
            
            analisisChart = new Chart(canvas, config);
        }

        function renderAnalisisTable(data) {
            const container = document.getElementById('analisis-table-container');
            if (!container) return;
            
            const groupedByTrial = {};
            data.forEach(d => {
                if (!groupedByTrial[d.trialName]) groupedByTrial[d.trialName] = [];
                groupedByTrial[d.trialName].push(d);
            });
            
            let html = '';
            
            Object.keys(groupedByTrial).forEach(trialName => {
                const trialData = groupedByTrial[trialName].slice().sort((a, b) => a.diasCurado - b.diasCurado);
                
                // Agrupar por edad
                const byAge = {};
                trialData.forEach(d => {
                    if (!byAge[d.diasCurado]) byAge[d.diasCurado] = [];
                    byAge[d.diasCurado].push(d);
                });

                // Calcular eficiencia de cemento si hay datos
                const cementData = trialData.filter(d => d.cemento && parseFloat(d.cemento) > 0);
                const hasCement = cementData.length > 0;
                
                html += `
                    <h4 style="margin: 20px 0 10px 0; color: #16a34a;">${trialName} - Mix: ${trialData[0].mixName}</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>D√≠as Curado</th>
                                <th>Resistencia (PSI)</th>
                                <th>f'c Objetivo</th>
                                <th>% Eficiencia</th>
                                <th>Desv. Est√°ndar (PSI)</th>
                                ${hasCement ? '<th>Efic. Cemento (PSI/kg)</th>' : ''}
                                <th>Fecha Rotura</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                trialData.forEach(d => {
                    const colorEficiencia = parseFloat(d.eficiencia) >= 100 ? '#16a34a' : parseFloat(d.eficiencia) >= 80 ? '#f59e0b' : '#dc2626';
                    const cementEff = (hasCement && d.cemento && parseFloat(d.cemento) > 0) 
                        ? (d.resistencia / parseFloat(d.cemento)).toFixed(2) + ' PSI/kg' : '-';
                    html += `
                        <tr>
                            <td style="text-align: center;"><strong>${d.diasCurado} d√≠as</strong></td>
                            <td style="text-align: center; font-weight: bold;">${d.resistencia.toFixed(0)} PSI</td>
                            <td style="text-align: center;">${d.resistenciaObjetivo} PSI</td>
                            <td style="text-align: center; color: ${colorEficiencia}; font-weight: bold;">${d.eficiencia}%</td>
                            <td style="text-align: center; color: #7c3aed;">-</td>
                            ${hasCement ? `<td style="text-align: center; color: #16a34a;">${cementEff}</td>` : ''}
                            <td style="text-align: center;">${d.fechaRotura || 'N/A'}</td>
                        </tr>
                    `;
                });
                
                html += `</tbody><tbody style="border-top: 2px solid #d1d5db;">`;

                // Filas de resumen por edad
                const ages = Object.keys(byAge).map(Number).sort((a, b) => a - b);
                ages.forEach(age => {
                    const group = byAge[age];
                    const resistencias = group.map(d => d.resistencia);
                    const avgR = resistencias.reduce((s, v) => s + v, 0) / resistencias.length;
                    const stdR = calcStdDev(resistencias);
                    const eficiencias = group.map(d => parseFloat(d.eficiencia));
                    const avgEf = eficiencias.reduce((s, v) => s + v, 0) / eficiencias.length;
                    const colorEf = avgEf >= 100 ? '#16a34a' : avgEf >= 80 ? '#f59e0b' : '#dc2626';
                    
                    // Efic cemento por edad
                    const cementGroup = group.filter(d => d.cemento && parseFloat(d.cemento) > 0);
                    const cementEffStr = cementGroup.length > 0
                        ? (cementGroup.reduce((s, d) => s + d.resistencia / parseFloat(d.cemento), 0) / cementGroup.length).toFixed(2) + ' PSI/kg'
                        : '-';
                    
                    html += `
                        <tr style="background: #f0fdf4; font-weight: bold;">
                            <td style="text-align: center; color: #065f46;">PROMEDIO ${age} d√≠as</td>
                            <td style="text-align: center; color: #16a34a;">${avgR.toFixed(0)} PSI</td>
                            <td></td>
                            <td style="text-align: center; color: ${colorEf};">${avgEf.toFixed(1)}%</td>
                            <td style="text-align: center; color: #7c3aed;">œÉ = ${stdR.toFixed(0)} PSI</td>
                            ${hasCement ? `<td style="text-align: center; color: #16a34a;">${cementEffStr}</td>` : ''}
                            <td></td>
                        </tr>
                    `;
                });

                html += `</tbody></table>`;
            });
            
            container.innerHTML = html || '<div class="empty-state">No hay datos para mostrar</div>';
        }

        async function exportarAnalisisPDF() {
            alert('üìÑ Exportando an√°lisis a PDF...\n\nPor ahora puedes usar Ctrl+P para imprimir esta secci√≥n.');
            window.print();
        }
        
        // ============ FIN AN√ÅLISIS DE DATA ============
        
        initDB().then(async () => {
            console.log('‚úÖ Base de datos inicializada');
            cargarLogoGuardado();
            cargarAplicaciones();
            updateDashboard();
            calcularVolumenes();
            cargarAditivosEnSelects();
            setTimeout(async function() {
                const mixId = await generarMixId();
                const elem = document.getElementById('mix-id-display');
                if (elem) elem.value = mixId;
            }, 500);
            
            // Generar Trial ID inicial
            const trialId = await generarTrialId();
            document.getElementById('trial-id-display').value = trialId;
            
            // Generar campos de cilindros inicial
            generarCamposCilindros();
            
            // Inicializar cotizaciones
            const cotNumero = await generarNumeroCotizacion();
            document.getElementById('cotizacion-numero').value = cotNumero;
            document.getElementById('cotizacion-fecha').valueAsDate = new Date();
            const validaHasta = new Date();
            validaHasta.setDate(validaHasta.getDate() + 30);
            document.getElementById('cotizacion-valida-hasta').valueAsDate = validaHasta;
            
        }).catch(error => {
            console.error('‚ùå Error:', error);
        });
    </script>

    <!-- Modal para Nuevo Cliente R√°pido -->
    <div id="modal-cliente-rapido" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center">
        <div style="background:white;padding:30px;border-radius:12px;max-width:500px;width:90%;box-shadow:0 10px 40px rgba(0,0,0,0.3)">
            <h2 style="color:#16a34a;margin-bottom:20px">Nuevo Cliente</h2>
            <div class="form-group">
                <label>Nombre del Cliente *</label>
                <input type="text" id="nuevo-cliente-nombre" placeholder="Ej: Constructora ABC">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="nuevo-cliente-email" placeholder="contacto@empresa.com">
            </div>
            <div class="form-group">
                <label>Tel√©fono</label>
                <input type="tel" id="nuevo-cliente-telefono" placeholder="787-123-4567">
            </div>
            <div style="display:flex;gap:10px;margin-top:20px">
                <button class="btn success" onclick="guardarClienteRapido()">üíæ Guardar</button>
                <button class="btn secondary" onclick="cerrarModalCliente()">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <div id="modal-proyecto-rapido" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center">
        <div style="background:white;padding:30px;border-radius:12px;max-width:500px;width:90%;box-shadow:0 10px 40px rgba(0,0,0,0.3)">
            <h2 style="color:#16a34a;margin-bottom:20px">Nuevo Proyecto</h2>
            <div class="form-group">
                <label>Cliente *</label>
                <select id="nuevo-proyecto-cliente">
                    <option value="">Seleccionar cliente...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Nombre del Proyecto *</label>
                <input type="text" id="nuevo-proyecto-nombre" placeholder="Ej: Torre Residencial XYZ">
            </div>
            <div class="form-group">
                <label>Ubicaci√≥n</label>
                <input type="text" id="nuevo-proyecto-ubicacion" placeholder="Ej: San Juan, PR">
            </div>
            <div style="display:flex;gap:10px;margin-top:20px">
                <button class="btn success" onclick="guardarProyectoRapido()">üíæ Guardar</button>
                <button class="btn secondary" onclick="cerrarModalProyecto()">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <div id="qr-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center">
        <div style="background:white;padding:30px;border-radius:12px;max-width:400px;width:90%;box-shadow:0 10px 40px rgba(0,0,0,0.3);text-align:center">
            <h2 style="color:#16a34a;margin-bottom:20px">üì± QR Code - Trial Mix</h2>
            <div id="qr-code-container" style="display:flex;justify-content:center;margin:20px 0"></div>
            <p style="font-size:14px;color:#666;margin-bottom:20px">Escanea este c√≥digo para ver los detalles del trial mix</p>
            <button class="btn secondary" onclick="cerrarModalQR()">Cerrar</button>
        </div>
    </div>

    <!-- Modal An√°lisis con IA -->
    <div id="modal-analisis-ia" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:9999;justify-content:center;align-items:center;padding:20px;">
        <div style="background:white;border-radius:16px;max-width:800px;width:100%;max-height:90vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.4);display:flex;flex-direction:column;">
            <div style="background:linear-gradient(135deg,#7c3aed 0%,#4f46e5 100%);padding:20px 25px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0;">
                <div>
                    <h2 style="color:white;margin:0;font-size:1.3rem;">ü§ñ An√°lisis de Data con Inteligencia Artificial</h2>
                    <p style="color:rgba(255,255,255,0.8);margin:4px 0 0 0;font-size:13px;">Claude AI analiza tus resultados de laboratorio</p>
                </div>
                <button onclick="cerrarModalIA()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:36px;height:36px;border-radius:50%;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;">‚úï</button>
            </div>
            <div style="padding:25px;overflow-y:auto;flex:1;">
                <div id="ia-loading" style="display:none;text-align:center;padding:40px;">
                    <div style="font-size:48px;margin-bottom:15px;">üß†</div>
                    <div style="font-size:16px;color:#7c3aed;font-weight:600;">Claude est√° analizando tus datos...</div>
                    <div style="margin-top:15px;display:flex;justify-content:center;gap:6px;">
                        <div style="width:10px;height:10px;border-radius:50%;background:#7c3aed;animation:ia-bounce 1.2s infinite;"></div>
                        <div style="width:10px;height:10px;border-radius:50%;background:#4f46e5;animation:ia-bounce 1.2s infinite 0.2s;"></div>
                        <div style="width:10px;height:10px;border-radius:50%;background:#7c3aed;animation:ia-bounce 1.2s infinite 0.4s;"></div>
                    </div>
                </div>
                <div id="ia-prompt-section">
                    <div style="background:#f5f3ff;border-radius:8px;padding:15px;margin-bottom:20px;border-left:4px solid #7c3aed;">
                        <p style="margin:0;font-size:13px;color:#4c1d95;">üí° Claude analizar√° todos los datos actuales de resistencia, eficiencia por edad, desviaci√≥n est√°ndar y eficiencia de cemento de tus Trial Mixes.</p>
                    </div>
                    <div class="form-group" style="margin-bottom:18px;">
                        <label style="font-weight:600;color:#4c1d95;font-size:14px;">¬øQu√© deseas que analice? <small style="color:#9ca3af;font-weight:400;">(opcional)</small></label>
                        <textarea id="ia-pregunta-extra" placeholder="Ej: ¬øCu√°l mezcla es la m√°s eficiente? ¬øQu√© mezcla recomiendas para una estructura de alta resistencia? ¬øQu√© ajustes sugiere para mejorar la resistencia a 28 d√≠as?" style="width:100%;margin-top:6px;border:2px solid #ddd8fe;border-radius:8px;padding:12px;font-size:14px;resize:vertical;min-height:90px;font-family:inherit;"></textarea>
                    </div>
                    <button onclick="ejecutarAnalisisIA()" style="width:100%;padding:14px;background:linear-gradient(135deg,#7c3aed 0%,#4f46e5 100%);color:white;border:none;border-radius:8px;font-size:15px;font-weight:700;cursor:pointer;box-shadow:0 4px 12px rgba(124,58,237,0.4);letter-spacing:0.3px;">
                        üöÄ Generar An√°lisis con IA
                    </button>
                </div>
                <div id="ia-resultado" style="display:none;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;flex-wrap:wrap;gap:10px;">
                        <h3 style="color:#4c1d95;margin:0;">üìã Resultado del An√°lisis</h3>
                        <button onclick="reiniciarAnalisisIA()" style="padding:8px 16px;background:#f3f4f6;border:1px solid #d1d5db;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;">üîÑ Nuevo An√°lisis</button>
                    </div>
                    <div id="ia-resultado-texto" style="background:#fafafa;border:1px solid #e5e7eb;border-radius:10px;padding:22px;font-size:14px;line-height:1.9;white-space:pre-wrap;color:#1e293b;font-family:inherit;"></div>
                </div>
            </div>
        </div>
    </div>
    <style>@keyframes ia-bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}</style>
    <script>
        async function abrirAnalisisIA() {
            const allData = await loadAnalisisData();
            if (allData.length === 0) {
                alert('‚ö†Ô∏è No hay datos de ensayos para analizar. Ingresa resultados de cilindros primero.');
                return;
            }
            reiniciarAnalisisIA();
            document.getElementById('modal-analisis-ia').style.display = 'flex';
        }
        function cerrarModalIA() {
            document.getElementById('modal-analisis-ia').style.display = 'none';
        }
        function reiniciarAnalisisIA() {
            document.getElementById('ia-prompt-section').style.display = 'block';
            document.getElementById('ia-resultado').style.display = 'none';
            document.getElementById('ia-loading').style.display = 'none';
            document.getElementById('ia-pregunta-extra').value = '';
        }
        async function ejecutarAnalisisIA() {
            const allData = await loadAnalisisData();
            if (allData.length === 0) return;
            const preguntaExtra = document.getElementById('ia-pregunta-extra').value.trim();

            // Construir resumen de datos agrupado por trial
            const byTrial = {};
            allData.forEach(d => {
                if (!byTrial[d.trialName]) byTrial[d.trialName] = { mixName: d.mixName, ensayos: [], cementoPeso: d.cementoPeso || 0, objetivo: d.resistenciaObjetivo };
                byTrial[d.trialName].ensayos.push({ edad: d.diasCurado, resistencia: d.resistencia });
            });

            const resumenTrials = Object.keys(byTrial).map(name => {
                const t = byTrial[name];
                const byAge = {};
                t.ensayos.forEach(e => {
                    if (!byAge[e.edad]) byAge[e.edad] = [];
                    byAge[e.edad].push(e.resistencia);
                });
                const promediosPorEdad = Object.keys(byAge).sort((a,b)=>a-b).map(edad => {
                    const vals = byAge[edad];
                    const avg = vals.reduce((s,v)=>s+v,0)/vals.length;
                    const std = calcStdDev(vals);
                    const ef = (avg / t.objetivo * 100).toFixed(1);
                    return `  ¬∑ ${edad} d√≠as: ${avg.toFixed(0)} PSI | Efic: ${ef}% | œÉ=${std.toFixed(0)} | n=${vals.length}`;
                }).join('\n');
                const cementLine = t.cementoPeso > 0
                    ? `Cemento: ${t.cementoPeso} lb/yd¬≥ | Efic. cemento global: ${(t.ensayos.reduce((s,e)=>s+e.resistencia,0)/t.ensayos.length/t.cementoPeso).toFixed(3)} PSI/lb`
                    : 'Cemento: no disponible en Mix Design';
                return `‚ñ∂ Trial: ${name} | Mix: ${t.mixName} | f'c objetivo: ${t.objetivo} PSI\n${promediosPorEdad}\n  ${cementLine}`;
            }).join('\n\n');

            const prompt = `Eres un experto en tecnolog√≠a del concreto y control de calidad. Analiza los siguientes resultados de laboratorio de trial mixes de concreto y proporciona un an√°lisis t√©cnico profesional en espa√±ol.

DATOS DE ENSAYOS:
${resumenTrials}

AN√ÅLISIS REQUERIDO:
1. RESUMEN EJECUTIVO ‚Äî conclusi√≥n principal en 2-3 l√≠neas
2. AN√ÅLISIS POR MEZCLA ‚Äî desempe√±o vs f'c objetivo, tendencia de desarrollo de resistencia
3. EFICIENCIA DE CEMENTO ‚Äî comparaci√≥n PSI/lb entre mezclas, identificar la m√°s eficiente
4. VARIABILIDAD Y CALIDAD ‚Äî evaluaci√≥n de la desviaci√≥n est√°ndar y coeficiente de variaci√≥n
5. RECOMENDACIONES ‚Äî acciones concretas para optimizar las mezclas${preguntaExtra ? `\n6. RESPUESTA ESPEC√çFICA ‚Äî ${preguntaExtra}` : ''}

S√© t√©cnico pero comprensible para ingenieros de materiales y laboratoristas.`;

            document.getElementById('ia-prompt-section').style.display = 'none';
            document.getElementById('ia-loading').style.display = 'block';

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{ role: 'user', content: prompt }]
                    })
                });
                const result = await response.json();
                const texto = result.content && result.content[0] ? result.content[0].text : 'No se pudo obtener respuesta del servicio de IA.';
                document.getElementById('ia-loading').style.display = 'none';
                document.getElementById('ia-resultado').style.display = 'block';
                document.getElementById('ia-resultado-texto').textContent = texto;
            } catch(err) {
                document.getElementById('ia-loading').style.display = 'none';
                document.getElementById('ia-prompt-section').style.display = 'block';
                alert('‚ùå Error al conectar con el servicio de IA.\n\nDetalle: ' + err.message);
            }
        }
    </script>

</body>
</html>
