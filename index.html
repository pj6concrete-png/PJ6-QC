<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n + Mix Design + Trial Mixes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #06b6d4;
            --purple: #16a34a;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-content h1 {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .header-content p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .header-logo {
            max-width: 150px;
            max-height: 80px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-logo img {
            max-width: 100%;
            max-height: 60px;
        }

        .header-logo.empty {
            border: 2px dashed rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 12px;
            text-align: center;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .tab:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .card h2 {
            margin-bottom: 20px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h3 {
            margin-top: 25px;
            margin-bottom: 15px;
            color: var(--text);
            font-size: 1.2rem;
            border-bottom: 2px solid var(--border);
            padding-bottom: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-grid.cols-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .form-grid.cols-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .form-grid.cols-4 {
            grid-template-columns: repeat(4, 1fr);
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 500;
            margin-bottom: 5px;
            color: var(--text);
            font-size: 14px;
        }

        label small {
            color: var(--text-light);
            font-weight: 400;
            margin-left: 5px;
        }

        input, select, textarea {
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        input[readonly] {
            background: #f1f5f9;
            color: var(--text-light);
            cursor: not-allowed;
        }

        input.calculated {
            background: #fef3c7;
            font-weight: 600;
            color: #92400e;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        button {
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            font-size: 14px;
        }

        button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        button:disabled {
            background: var(--text-light);
            cursor: not-allowed;
            transform: none;
        }

        button.secondary {
            background: var(--secondary);
        }

        button.secondary:hover {
            background: #059669;
        }

        button.danger {
            background: var(--danger);
        }

        button.danger:hover {
            background: #dc2626;
        }

        button.warning {
            background: var(--warning);
        }

        button.info {
            background: var(--info);
        }

        button.purple {
            background: var(--purple);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th {
            background: var(--primary);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 500;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        tr:hover {
            background: var(--bg);
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        .actions button {
            padding: 6px 12px;
            font-size: 13px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin: 0 0 10px 0;
            border: none;
            padding: 0;
            color: white;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px;
            font-size: 15px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge.active {
            background: #dcfce7;
            color: #166534;
        }

        .badge.inactive {
            background: #fee2e2;
            color: #991b1b;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert.info {
            background: #dbeafe;
            color: #1e40af;
        }

        .alert.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .alert.success {
            background: #dcfce7;
            color: #166534;
        }

        .mix-design-preview {
            background: var(--bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .mix-design-preview h4 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .mix-design-preview .detail {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .mix-design-preview .detail:last-child {
            border-bottom: none;
        }

        .cylinders-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .cylinder-item {
            background: var(--bg);
            padding: 15px;
            border-radius: 8px;
            border: 2px solid var(--border);
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 15px;
            align-items: center;
        }

        .cylinder-item .number {
            background: var(--primary);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .cylinder-item .fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .cylinder-item button {
            padding: 8px 12px;
        }

        .trial-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 16px;
            background: linear-gradient(135deg, var(--purple) 0%, #16a34a 100%);
            color: white;
            margin-bottom: 10px;
        }

        .calendario-item {
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .calendario-item:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .calendario-item.vencido {
            border-color: var(--danger);
            background: #fef2f2;
        }

        .calendario-item.completado {
            border-color: var(--secondary);
            background: #f0fdf4;
        }

        .calendario-item.hoy {
            border-color: var(--warning);
            background: #fffbeb;
        }

        .calendario-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        .calendario-fecha {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary);
        }

        .calendario-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .calendario-status.pendiente {
            background: #fef3c7;
            color: #92400e;
        }

        .calendario-status.vencido {
            background: #fee2e2;
            color: #991b1b;
        }

        .calendario-status.completado {
            background: #dcfce7;
            color: #166534;
        }

        .calendario-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .calendario-detail {
            font-size: 14px;
        }

        .calendario-detail strong {
            color: var(--text);
        }

        @media print {
            .no-print {
                display: none !important;
            }
            
            .card {
                page-break-inside: avoid;
            }
        }

        @media (max-width: 768px) {
            .form-grid.cols-2,
            .form-grid.cols-3,
            .form-grid.cols-4 {
                grid-template-columns: 1fr;
            }

            .tabs {
                overflow-x: auto;
            }

            .cylinder-item {
                grid-template-columns: 1fr;
            }

            .cylinder-item .fields {
                grid-template-columns: 1fr;
            }
        }
    
        /* ===== AI OPTIMIZER STYLES ===== */
        .ai-score-card {
            background: #f8fafc;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 2px solid #e2e8f0;
            transition: transform 0.2s;
        }
        .ai-score-card:hover { transform: translateY(-2px); }
        .sieve-input {
            width: 70px; padding: 4px 6px; border: 1px solid #ddd;
            border-radius: 4px; font-size: 13px; text-align: center;
        }
        .sieve-input:focus { outline: none; border-color: #2563eb; }
        .ai-param-card {
            background: #f8fafc; border-radius: 8px; padding: 15px;
            border-left: 4px solid #6d28d9;
        }
        .ai-rec-card {
            background: #fff; border: 1px solid #e2e8f0; border-radius: 8px;
            padding: 18px; margin-bottom: 12px;
        }
        .ai-loading-spinner {
            display: inline-block; width: 40px; height: 40px;
            border: 4px solid #e2e8f0; border-top-color: #6d28d9;
            border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .grade-table th { background: #1e40af; }
        .better-val { color: #10b981; font-weight: 700; }
        .worse-val { color: #ef4444; font-weight: 700; }
        .neutral-val { color: #64748b; font-weight: 600; }

        </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1>üèóÔ∏è Sistema de Gesti√≥n de Concreto</h1>
                <p>Mix Design Profesional + Trial Mixes</p>
            </div>
            <div class="header-logo empty" id="logo-container" onclick="document.getElementById('logo-upload').click()">
                <span>Click para subir logo</span>
            </div>
            <input type="file" id="logo-upload" accept="image/*" style="display: none;">
        </header>

        <!-- Tabs Navigation -->
        <div class="tabs no-print">
            <div class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</div>
            <div class="tab" onclick="switchTab('clientes')">üë• Clientes</div>
            <div class="tab" onclick="switchTab('proyectos')">üìÅ Proyectos</div>
            <div class="tab" onclick="switchTab('materiales')">üì¶ Materiales</div>
            <div class="tab" onclick="switchTab('cotizaciones')">üí∞ Cotizaciones</div>
            <div class="tab" onclick="switchTab('mixdesign')">üß™ Mix Design</div>
            <div class="tab" onclick="switchTab('trials')">üî¨ Trial Mixes</div>
            <div class="tab" onclick="switchTab('analisis')">üìà An√°lisis de Data</div>
            <div class="tab" onclick="switchTab('calendario')">üìÖ Calendario Roturas</div>
            <div class="tab" onclick="switchTab('ai-optimizer')">ü§ñ AI Optimizer</div>
        </div>

        <!-- DASHBOARD -->
        <div id="tab-dashboard" class="tab-content active">
            <div class="stats">
                <div class="stat-card">
                    <h3>Clientes</h3>
                    <div class="number" id="stat-clientes">0</div>
                </div>
                <div class="stat-card">
                    <h3>Proyectos Activos</h3>
                    <div class="number" id="stat-proyectos">0</div>
                </div>
                <div class="stat-card">
                    <h3>Cotizaciones</h3>
                    <div class="number" id="stat-cotizaciones">0</div>
                </div>
                <div class="stat-card">
                    <h3>Mix Designs</h3>
                    <div class="number" id="stat-mixdesigns">0</div>
                </div>
                <div class="stat-card">
                    <h3>Trial Mixes</h3>
                    <div class="number" id="stat-trials">0</div>
                </div>
            </div>

            <div class="card">
                <h2>üí∞ Resumen de Cotizaciones</h2>
                <div id="dashboard-cotizaciones-summary"></div>
            </div>

            <div class="card">
                <h2>üíæ Gesti√≥n de Datos</h2>
                <div class="button-group">
                    <button type="button" class="success" onclick="exportarTodaLaData()">üì• Exportar Toda la Data</button>
                    <button type="button" class="info" onclick="document.getElementById('import-file').click()">üì§ Importar Data</button>
                    <input type="file" id="import-file" accept=".json" style="display:none" onchange="importarData(event)">
                </div>
                <p style="margin-top:15px;color:#666;font-size:14px">
                    <strong>Exportar:</strong> Descarga todos tus datos (clientes, proyectos, materiales, mix designs, trials) en formato JSON.<br>
                    <strong>Importar:</strong> Restaura datos desde un archivo JSON exportado previamente.
                </p>
            </div>

            <div class="card">
                <h2>üìã Mix Designs Recientes</h2>
                <div id="recent-mixdesigns"></div>
            </div>

            <div class="card">
                <h2>üî¨ Trial Mixes Recientes</h2>
                <div id="recent-trials"></div>
            </div>
        </div>

        <!-- CLIENTES -->
        <div id="tab-clientes" class="tab-content">
            <div class="card">
                <h2>‚ûï Nuevo Cliente</h2>
                <form id="form-cliente">
                    <input type="hidden" id="edit-cliente-id">
                    <div class="form-grid cols-2">
                        <div class="form-group">
                            <label>Nombre *</label>
                            <input type="text" id="cliente-nombre" required>
                        </div>
                        <div class="form-group">
                            <label>Empresa</label>
                            <input type="text" id="cliente-empresa">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="cliente-email">
                        </div>
                        <div class="form-group">
                            <label>Tel√©fono</label>
                            <input type="tel" id="cliente-telefono">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notas</label>
                        <textarea id="cliente-notas"></textarea>
                    </div>
                    <div class="button-group">
                        <button type="submit">üíæ Guardar Cliente</button>
                        <button type="button" class="secondary" onclick="clearForm('cliente')">üîÑ Limpiar</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h2>üìã Lista de Clientes</h2>
                <div class="search-box">
                    <input type="text" id="search-clientes" placeholder="üîç Buscar cliente..." onkeyup="filterClientes()">
                </div>
                <div id="lista-clientes"></div>
            </div>
        </div>

        <!-- PROYECTOS -->
        <div id="tab-proyectos" class="tab-content">
            <div class="card">
                <h2>‚ûï Nuevo Proyecto</h2>
                <form id="form-proyecto">
                    <input type="hidden" id="edit-proyecto-id">
                    <div class="form-grid cols-2">
                        <div class="form-group">
                            <label>Nombre del Proyecto *</label>
                            <input type="text" id="proyecto-nombre" required>
                        </div>
                        <div class="form-group">
                            <label>Cliente</label>
                            <select id="proyecto-cliente">
                                <option value="">Seleccionar...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ubicaci√≥n</label>
                            <input type="text" id="proyecto-ubicacion">
                        </div>
                        <div class="form-group">
                            <label>Estado</label>
                            <select id="proyecto-estado">
                                <option value="active">Activo</option>
                                <option value="completed">Completado</option>
                                <option value="on-hold">En Espera</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Descripci√≥n</label>
                        <textarea id="proyecto-descripcion"></textarea>
                    </div>
                    <div class="button-group">
                        <button type="submit">üíæ Guardar Proyecto</button>
                        <button type="button" class="secondary" onclick="clearForm('proyecto')">üîÑ Limpiar</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h2>üìã Lista de Proyectos</h2>
                <div class="search-box">
                    <input type="text" id="search-proyectos" placeholder="üîç Buscar proyecto..." onkeyup="filterProyectos()">
                </div>
                <div id="lista-proyectos"></div>
            </div>
        </div>

        <!-- MATERIALES -->
        <div id="tab-materiales" class="tab-content">
            <div class="card">
                <h2>‚ûï Nuevo Material</h2>
                <form id="form-material">
                    <input type="hidden" id="edit-material-id">
                    <div class="form-grid cols-3">
                        <div class="form-group">
                            <label>Nombre *</label>
                            <input type="text" id="material-nombre" required>
                        </div>
                        <div class="form-group">
                            <label>Categor√≠a *</label>
                            <select id="material-categoria" required>
                                <option value="">Seleccionar...</option>
                                <option value="cemento">Cemento</option>
                                <option value="agregados">Agregados</option>
                                <option value="aditivos">Aditivos</option>
                                <option value="agua">Agua</option>
                                <option value="otros">Otros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Unidad</label>
                            <select id="material-unidad">
                                <option value="kg">Kilogramos (kg)</option>
                                <option value="lb">Libras (lb)</option>
                                <option value="ton">Toneladas</option>
                                <option value="gal">Galones</option>
                                <option value="L">Litros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Cantidad en Inventario</label>
                            <input type="number" id="material-cantidad" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label>Precio Unitario ($)</label>
                            <input type="number" id="material-precio" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label>Proveedor</label>
                            <input type="text" id="material-proveedor">
                        </div>
                    </div>
                    <div class="button-group">
                        <button type="submit">üíæ Guardar Material</button>
                        <button type="button" class="secondary" onclick="clearForm('material')">üîÑ Limpiar</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h2>üìã Inventario de Materiales</h2>
                <div class="search-box">
                    <input type="text" id="search-materiales" placeholder="üîç Buscar material..." onkeyup="filterMateriales()">
                </div>
                <div id="lista-materiales"></div>
            </div>
        </div>

        <!-- SECCI√ìN: COTIZACIONES -->
        <div id="tab-cotizaciones" class="tab-content">
            <div class="card">
                <h2>üí∞ Nueva Cotizaci√≥n</h2>
                <form id="form-cotizacion">
                    <input type="hidden" id="edit-cotizacion-id">
                    
                    <div class="alert info">
                        <span>‚ÑπÔ∏è</span>
                        <span>Complete la informaci√≥n del cliente y agregue las l√≠neas de cotizaci√≥n</span>
                    </div>

                    <h3>üìã Informaci√≥n del Cliente</h3>
                    <div class="form-grid cols-3">
                        <div class="form-group">
                            <label>N√∫mero de Cotizaci√≥n</label>
                            <input type="text" id="cotizacion-numero" readonly class="calculated">
                        </div>
                        <div class="form-group">
                            <label>Fecha *</label>
                            <input type="date" id="cotizacion-fecha" required>
                        </div>
                        <div class="form-group">
                            <label>V√°lida hasta</label>
                            <input type="date" id="cotizacion-valida-hasta">
                        </div>
                    </div>

                    <div class="form-grid cols-4">
                        <div class="form-group">
                            <label>Status *</label>
                            <select id="cotizacion-status" required>
                                <option value="Pendiente">‚è≥ Pendiente</option>
                                <option value="Aprobada">‚úÖ Aprobada</option>
                                <option value="Rechazada">‚ùå Rechazada</option>
                                <option value="En Revisi√≥n">üëÅÔ∏è En Revisi√≥n</option>
                                <option value="Cancelada">üö´ Cancelada</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Nombre del Cliente *</label>
                            <input type="text" id="cotizacion-cliente-nombre" required placeholder="Ej: Juan P√©rez">
                        </div>
                        <div class="form-group">
                            <label>Tel√©fono</label>
                            <input type="tel" id="cotizacion-cliente-tel" placeholder="787-123-4567">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="cotizacion-cliente-email" placeholder="cliente@email.com">
                        </div>
                    </div>

                    <div class="form-grid cols-2">
                        <div class="form-group">
                            <label>Nombre del Proyecto *</label>
                            <input type="text" id="cotizacion-proyecto" required placeholder="Ej: Construcci√≥n Edificio XYZ">
                        </div>
                        <div class="form-group">
                            <label>Ubicaci√≥n del Proyecto</label>
                            <input type="text" id="cotizacion-ubicacion" placeholder="Ej: San Juan, PR">
                        </div>
                    </div>

                    <h3>üìù L√≠neas de Cotizaci√≥n</h3>
                    <div style="margin-bottom: 15px;">
                        <button type="button" class="btn success" onclick="agregarLineaCotizacion()">‚ûï Agregar L√≠nea</button>
                    </div>

                    <table id="tabla-cotizacion-lineas">
                        <thead>
                            <tr>
                                <th style="width: 50%">Descripci√≥n</th>
                                <th style="width: 15%">Cantidad (yd¬≥)</th>
                                <th style="width: 20%">Precio Unitario</th>
                                <th style="width: 15%">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="cotizacion-lineas-body">
                            <!-- Las l√≠neas se agregan din√°micamente -->
                        </tbody>
                        <tfoot>
                            <tr style="background: #e0f2fe; font-weight: bold;">
                                <td style="text-align: right; padding: 12px;">TOTAL YD¬≥:</td>
                                <td id="cotizacion-total-yd" style="font-size: 18px; color: #0369a1;">0.00 yd¬≥</td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>

                    <h3>üìÑ Notas y Condiciones</h3>
                    <div class="form-group">
                        <label>Notas Adicionales</label>
                        <textarea id="cotizacion-notas" rows="3" placeholder="Informaci√≥n adicional, t√©rminos, condiciones de pago, tiempo de entrega, etc."></textarea>
                    </div>

                    <div class="button-group">
                        <button type="button" class="secondary" onclick="nuevaCotizacion()">‚ûï Nueva Cotizaci√≥n</button>
                        <button type="submit" class="primary">üíæ Guardar Cotizaci√≥n</button>
                        <button type="button" class="success" id="btn-imprimir-cotizacion" onclick="imprimirCotizacion()" disabled>üñ®Ô∏è Imprimir</button>
                        <button type="button" class="secondary" onclick="limpiarFormularioCotizacion()">üîÑ Limpiar</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h2>üìã Cotizaciones Guardadas</h2>
                <div class="search-box">
                    <input type="text" id="search-cotizaciones" placeholder="üîç Buscar cotizaci√≥n..." onkeyup="filterCotizaciones()">
                </div>
                <div id="lista-cotizaciones"></div>
            </div>
        </div>

        <!-- MIX DESIGN (contenido original mantenido) -->
        <div id="tab-mixdesign" class="tab-content">
            <div class="card">
                <h2>üß™ Nuevo Mix Design</h2>
                <form id="form-mixdesign">
                    <input type="hidden" id="edit-mixdesign-id">
                    
                    <h3>üìã Informaci√≥n General</h3>
                    <div class="form-grid cols-3">
                        <div class="form-group">
                        <label>Logo de la Empresa (opcional)</label>
                        <input type="file" id="mix-logo" accept="image/*" onchange="cargarLogo()">
                        <small style="color:#666;display:block;margin-top:5px">Sube tu logo para que aparezca en el reporte</small>
                        <img id="logo-preview" style="max-width:200px;max-height:80px;margin-top:10px;display:none;border:1px solid #ddd;padding:5px;border-radius:4px">
                    </div>
                    
                    <div class="form-group">
                            <label>Mix ID</label>
                            <input type="text" id="mix-id-display" readonly class="calculated">
                        </div>
                        <div class="form-group">
                            <label>Nombre del Mix *</label>
                            <input type="text" id="mix-nombre" required>
                        </div>
                        <div class="form-group">
                            <label>Fecha</label>
                            <input type="date" id="mix-fecha" required>
                        </div>
                        <div class="form-group">
                        <label>Cliente</label>
                        <div style="display:flex;gap:10px">
                            <select id="mix-cliente" onchange="filtrarProyectosPorCliente()" style="flex:1">
                                <option value="">Seleccione cliente...</option>
                            </select>
                            <button type="button" class="btn success" onclick="nuevoClienteRapido()" style="padding:8px 15px;margin:0" title="Nuevo Cliente">‚ûï</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Proyecto Asociado</label>
                        <div style="display:flex;gap:10px">
                            <select id="mix-proyecto" style="flex:1">
                                <option value="">Sin proyecto</option>
                            </select>
                            <button type="button" class="btn success" onclick="nuevoProyectoRapido()" style="padding:8px 15px;margin:0" title="Nuevo Proyecto">‚ûï</button>
                        </div>
                    </div>
                    </div>

                    <h3>üéØ Especificaciones de Dise√±o</h3>
                    <div class="form-grid cols-4">
                        <div class="form-group">
                            <label>Resistencia (PSI) *</label>
                            <input type="number" id="mix-resistencia" required value="3000">
                        </div>
                        <div class="form-group">
                            <label>Slump (in) *</label>
                            <input type="number" id="mix-slump" step="0.5" required value="4">
                        </div>
                        <div class="form-group">
                            <label>Tama√±o M√°x. Agregado (in)</label>
                            <input type="number" id="mix-tma" step="0.25" value="0.75">
                        </div>
                        <div class="form-group">
                            <label>% Aire *</label>
                            <input type="number" id="mix-aire" step="0.1" required value="2.0">
                        </div>
                        <div class="form-group">
                            <label>Aplicaci√≥n</label>
                            <input type="text" id="mix-aplicacion" list="aplicaciones-list" placeholder="Seleccionar o escribir...">
                            <datalist id="aplicaciones-list">
                                <option value="Pavimento">
                                <option value="Columnas">
                                <option value="Vigas">
                                <option value="Losas">
                                <option value="Muros">
                                <option value="Cimentaci√≥n">
                                <option value="Prefabricados">
                                <option value="Arquitect√≥nico">
                                <option value="Estructural">
                            </datalist>
                        </div>
                    </div>

                    <h3>üèóÔ∏è Cemento - Propiedades y Peso</h3>
                    <div class="form-grid cols-4">
                        <div class="form-group">
                            <label>Tipo de Cemento</label>
                            <select id="tipo-cemento">
                                <option value="Tipo I">Tipo I - Normal</option>
                                <option value="Tipo II">Tipo II - Moderado</option>
                                <option value="Tipo III">Tipo III - Alta Resistencia</option>
                                <option value="Tipo IV">Tipo IV - Bajo Calor</option>
                                <option value="Tipo V">Tipo V - Sulfato Resistente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Peso de Cemento (lb/yd¬≥) *</label>
                            <input type="number" id="peso-cemento" step="0.1" value="564" required oninput="calcularTotalCementicio()">
                        </div>
                        <div class="form-group">
                            <label>Gravedad Espec√≠fica</label>
                            <input type="number" id="ge-cemento" step="0.01" value="3.15">
                        </div>
                        <div class="form-group">
                            <label>Precio ($/saco 94lb)</label>
                            <input type="number" id="precio-cemento" step="0.01" value="8.50">
                        </div>
                    </div>

                    <!-- SCM SECTION -->
                    <div style="background:linear-gradient(135deg,#faf5ff,#ede9fe);border:2px solid #c4b5fd;border-radius:10px;padding:18px;margin-bottom:18px">
                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px">
                            <h3 style="margin:0;color:#5b21b6">üß™ Materiales Cementicios Suplementarios (SCM)</h3>
                            <div style="background:#ede9fe;border:1px solid #c4b5fd;border-radius:20px;padding:5px 14px;font-size:13px;font-weight:700;color:#5b21b6">
                                Total Cementicio: <span id="total-cementicio-display" style="color:#7c3aed">564 lb/yd¬≥</span>
                                &nbsp;|&nbsp; W/CM: <span id="wcm-display" style="color:#7c3aed">‚Äî</span>
                            </div>
                        </div>
                        <div class="alert info" style="margin-bottom:14px;padding:10px 14px">
                            <span>‚ÑπÔ∏è</span>
                            <div style="font-size:12px">SCMs reemplazan parcialmente el cemento. El <strong>volumen total cementicio</strong> (cemento + SCM) se usa en el c√°lculo de vol√∫menes. La relaci√≥n <strong>W/CM</strong> se calcula sobre todos los materiales cementicios. Dejar peso = 0 para desactivar.</div>
                        </div>

                        <!-- SCM 1 -->
                        <div style="background:white;border:1px solid #ddd6fe;border-radius:8px;padding:14px;margin-bottom:10px">
                            <div style="font-weight:700;color:#5b21b6;margin-bottom:10px;font-size:13px">SCM 1</div>
                            <div class="form-grid cols-5">
                                <div class="form-group" style="margin-bottom:0">
                                    <label style="font-size:11px">Tipo de SCM</label>
                                    <select id="tipo-scm1" onchange="actualizarGeSCM(1)">
                                        <option value="">‚Äî Ninguno ‚Äî</option>
                                        <option value="Fly Ash Clase F">Fly Ash Clase F</option>
                                        <option value="Fly Ash Clase C">Fly Ash Clase C</option>
                                        <option value="GGBS / Slag">GGBS / Slag</option>
                                        <option value="Microsilica">Microsilica (Silica Fume)</option>
                                        <option value="Metakaolin">Metakaolin</option>
                                        <option value="Natural Pozzolan">Puzolana Natural</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom:0">
                                    <label style="font-size:11px">Peso (lb/yd¬≥)</label>
                                    <input type="number" id="peso-scm1" step="0.1" value="0" min="0" oninput="calcularTotalCementicio()">
                                </div>
                                <div class="form-group" style="margin-bottom:0">
                                    <label style="font-size:11px">Gravedad Esp.</label>
                                    <input type="number" id="ge-scm1" step="0.01" value="2.20">
                                </div>
                                <div class="form-group" style="margin-bottom:0">
                                    <label style="font-size:11px">% Reemplazo</label>
                                    <input type="number" id="pct-reemplazo-scm1" step="0.1" value="0" min="0" max="100" readonly class="calculated">
                                </div>
                                <div class="form-group" style="margin-bottom:0">
                                    <label style="font-size:11px">Precio ($/saco 94lb)</label>
                                    <input type="number" id="precio-scm1" step="0.01" value="4.00">
                                </div>
                            </div>
                        </div>

                        <!-- SCM 2 -->
                        <div style="background:white;border:1px solid #ddd6fe;border-radius:8px;padding:14px;margin-bottom:10px">
                            <div style="font-weight:700;color:#5b21b6;margin-bottom:10px;font-size:13px">SCM 2</div>
                            <div class="form-grid cols-5">
                                <div class="form-group" style="margin-bottom:0">
                                    <label style="font-size:11px">Tipo de SCM</label>
                                    <select id="tipo-scm2" onchange="actualizarGeSCM(2)">
                                        <option value="">‚Äî Ninguno ‚Äî</option>
                                        <option value="Fly Ash Clase F">Fly Ash Clase F</option>
                                        <option value="Fly Ash Clase C">Fly Ash Clase C</option>
                                        <option value="GGBS / Slag">GGBS / Slag</option>
                                        <option value="Microsilica">Microsilica (Silica Fume)</option>
                                        <option value="Metakaolin">Metakaolin</option>
                                        <option value="Natural Pozzolan">Puzolana Natural</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom:0">
                                    <label style="font-size:11px">Peso (lb/yd¬≥)</label>
                                    <input type="number" id="peso-scm2" step="0.1" value="0" min="0" oninput="calcularTotalCementicio()">
                                </div>
                                <div class="form-group" style="margin-bottom:0">
                                    <label style="font-size:11px">Gravedad Esp.</label>
                                    <input type="number" id="ge-scm2" step="0.01" value="2.90">
                                </div>
                                <div class="form-group" style="margin-bottom:0">
                                    <label style="font-size:11px">% Reemplazo</label>
                                    <input type="number" id="pct-reemplazo-scm2" step="0.1" value="0" min="0" max="100" readonly class="calculated">
                                </div>
                                <div class="form-group" style="margin-bottom:0">
                                    <label style="font-size:11px">Precio ($/saco 94lb)</label>
                                    <input type="number" id="precio-scm2" step="0.01" value="3.50">
                                </div>
                            </div>
                        </div>

                        <!-- SCM 3 -->
                        <div style="background:white;border:1px solid #ddd6fe;border-radius:8px;padding:14px">
                            <div style="font-weight:700;color:#5b21b6;margin-bottom:10px;font-size:13px">SCM 3</div>
                            <div class="form-grid cols-5">
                                <div class="form-group" style="margin-bottom:0">
                                    <label style="font-size:11px">Tipo de SCM</label>
                                    <select id="tipo-scm3" onchange="actualizarGeSCM(3)">
                                        <option value="">‚Äî Ninguno ‚Äî</option>
                                        <option value="Fly Ash Clase F">Fly Ash Clase F</option>
                                        <option value="Fly Ash Clase C">Fly Ash Clase C</option>
                                        <option value="GGBS / Slag">GGBS / Slag</option>
                                        <option value="Microsilica">Microsilica (Silica Fume)</option>
                                        <option value="Metakaolin">Metakaolin</option>
                                        <option value="Natural Pozzolan">Puzolana Natural</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom:0">
                                    <label style="font-size:11px">Peso (lb/yd¬≥)</label>
                                    <input type="number" id="peso-scm3" step="0.1" value="0" min="0" oninput="calcularTotalCementicio()">
                                </div>
                                <div class="form-group" style="margin-bottom:0">
                                    <label style="font-size:11px">Gravedad Esp.</label>
                                    <input type="number" id="ge-scm3" step="0.01" value="2.50">
                                </div>
                                <div class="form-group" style="margin-bottom:0">
                                    <label style="font-size:11px">% Reemplazo</label>
                                    <input type="number" id="pct-reemplazo-scm3" step="0.1" value="0" min="0" max="100" readonly class="calculated">
                                </div>
                                <div class="form-group" style="margin-bottom:0">
                                    <label style="font-size:11px">Precio ($/saco 94lb)</label>
                                    <input type="number" id="precio-scm3" step="0.01" value="3.00">
                                </div>
                            </div>
                        </div>
                    </div>

                    <h3>üíß Agua</h3>
                    <div class="form-grid cols-3">
                        <div class="form-group">
                            <label>Peso de Agua (lb/yd¬≥) *</label>
                            <input type="number" id="peso-agua" step="0.1" value="310" required oninput="calcularTotalCementicio()">
                        </div>
                        <div class="form-group">
                            <label>Relaci√≥n W/C <small>(sobre cemento solo)</small></label>
                            <input type="number" id="wc-ratio" step="0.01" readonly class="calculated">
                        </div>
                        <div class="form-group">
                            <label>Relaci√≥n W/CM <small>(sobre total cementicio)</small></label>
                            <input type="number" id="wcm-ratio" step="0.01" readonly class="calculated" style="border-color:#7c3aed;background:#faf5ff">
                        </div>
                    </div>
                    <div class="form-grid cols-1">
                        <div class="form-group">
                            <label>Precio Agua ($/gal)</label>
                            <input type="number" id="precio-agua" step="0.01" value="0.05" style="max-width:200px">
                        </div>
                    </div>

                    <h3>ü™® Agregado Grueso - Propiedades y Peso</h3>
                    <div class="form-grid cols-4">
                        <div class="form-group">
                            <label>Peso Agregado Grueso (lb/yd¬≥) *</label>
                            <input type="number" id="peso-grueso" step="0.1" value="1800" required>
                        </div>
                        <div class="form-group">
                            <label>Gravedad Espec√≠fica (Bulk SSD)</label>
                            <input type="number" id="ge-grueso" step="0.01" value="2.65">
                        </div>
                        <div class="form-group">
                            <label>Absorci√≥n (%)</label>
                            <input type="number" id="abs-grueso" step="0.01" value="1.5">
                        </div>
                        <div class="form-group">
                            <label>Humedad (%)</label>
                            <input type="number" id="hum-grueso" step="0.01" value="0.5">
                        </div>
                    </div>
                    <div class="form-grid cols-2">
                        <div class="form-group">
                            <label>Precio ($/ton)</label>
                            <input type="number" id="precio-grueso" step="0.01" value="15.00">
                        </div>
                        <div class="form-group">
                            <label>Peso Unitario Compactado (lb/ft¬≥)</label>
                            <input type="number" id="puc-grueso" step="0.1" value="105">
                        </div>
                    </div>

                    <h3>üî∑ Agregado Intermedio - Propiedades y Peso</h3>
                    <div class="form-grid cols-4">
                        <div class="form-group">
                            <label>Peso Agregado Intermedio (lb/yd¬≥) *</label>
                            <input type="number" id="peso-intermedio" step="0.1" value="0" required>
                        </div>
                        <div class="form-group">
                            <label>Gravedad Espec√≠fica (Bulk SSD)</label>
                            <input type="number" id="ge-intermedio" step="0.01" value="2.62">
                        </div>
                        <div class="form-group">
                            <label>Absorci√≥n (%)</label>
                            <input type="number" id="abs-intermedio" step="0.01" value="1.8">
                        </div>
                        <div class="form-group">
                            <label>Humedad (%)</label>
                            <input type="number" id="hum-intermedio" step="0.01" value="1.0">
                        </div>
                    </div>
                    <div class="form-grid cols-2">
                        <div class="form-group">
                            <label>Precio ($/ton)</label>
                            <input type="number" id="precio-intermedio" step="0.01" value="12.00">
                        </div>
                        <div class="form-group">
                            <label>Peso Unitario Compactado (lb/ft¬≥)</label>
                            <input type="number" id="puc-intermedio" step="0.1" value="100">
                        </div>
                    </div>

                    <h3>üèñÔ∏è Agregado Fino (Arenas) - Calculadas por Diferencia de Volumen</h3>
                    
                    <div class="alert info">
                        <span>‚ÑπÔ∏è</span>
                        <div>
                            <strong>Las arenas se calculan autom√°ticamente</strong> como la diferencia entre el volumen total (27 ft¬≥) 
                            menos los vol√∫menes de: cemento, agua, aire, agregado grueso, agregado intermedio y aditivos.
                        </div>
                    </div>
                    
                    <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <strong>Arena 1:</strong>
                    </div>
                    <div class="form-grid cols-4">
                        <div class="form-group">
                            <label>Gravedad Espec√≠fica (Bulk SSD)</label>
                            <input type="number" id="ge-arena1" step="0.01" value="2.60">
                        </div>
                        <div class="form-group">
                            <label>Absorci√≥n (%)</label>
                            <input type="number" id="abs-arena1" step="0.01" value="2.0">
                        </div>
                        <div class="form-group">
                            <label>Humedad (%)</label>
                            <input type="number" id="hum-arena1" step="0.01" value="3.0">
                        </div>
                        <div class="form-group">
                            <label>M√≥dulo de Finura</label>
                            <input type="number" id="mf-arena1" step="0.01" value="2.80">
                        </div>
                    </div>
                    <div class="form-grid cols-2">
                        <div class="form-group">
                            <label>Precio ($/ton)</label>
                            <input type="number" id="precio-arena1" step="0.01" value="12.00">
                        </div>
                        <div class="form-group">
                            <label>% en Mezcla de Arenas</label>
                            <input type="number" id="pct-arena1" step="1" value="60" min="0" max="100" oninput="ajustarPorcentajesArenas(1)">
                        </div>
                    </div>

                    <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 15px; margin-top: 20px;">
                        <strong>Arena 2:</strong>
                    </div>
                    <div class="form-grid cols-4">
                        <div class="form-group">
                            <label>Gravedad Espec√≠fica (Bulk SSD)</label>
                            <input type="number" id="ge-arena2" step="0.01" value="2.58">
                        </div>
                        <div class="form-group">
                            <label>Absorci√≥n (%)</label>
                            <input type="number" id="abs-arena2" step="0.01" value="2.5">
                        </div>
                        <div class="form-group">
                            <label>Humedad (%)</label>
                            <input type="number" id="hum-arena2" step="0.01" value="4.0">
                        </div>
                        <div class="form-group">
                            <label>M√≥dulo de Finura</label>
                            <input type="number" id="mf-arena2" step="0.01" value="3.20">
                        </div>
                    </div>
                    <div class="form-grid cols-2">
                        <div class="form-group">
                            <label>Precio ($/ton)</label>
                            <input type="number" id="precio-arena2" step="0.01" value="10.00">
                        </div>
                        <div class="form-group">
                            <label>% en Mezcla de Arenas</label>
                            <input type="number" id="pct-arena2" step="1" value="40" min="0" max="100" oninput="ajustarPorcentajesArenas(2)">
                        </div>
                    </div>

                    <div class="alert info">
                        <span>‚ÑπÔ∏è</span>
                        <div>
                            <strong>M√≥dulo de Finura Combinado:</strong> <span id="mf-combinado">3.04</span><br>
                            <small>Se calcula autom√°ticamente seg√∫n los porcentajes de cada arena</small>
                        </div>
                    </div>

                    <h3>üå¨Ô∏è Contenido de Aire</h3>
                    <div class="form-grid cols-2">
                        <div class="form-group">
                            <label>Contenido de Aire (%)</label>
                            <input type="number" id="contenido-aire" step="0.1" value="2.0">
                        </div>
                        <div class="form-group">
                            <label>Volumen de Aire <small>(calculado)</small></label>
                            <input type="number" id="volumen-aire" step="0.01" readonly class="calculated">
                        </div>
                    </div>

                    <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <strong>Aditivo 1:</strong>
                    </div>
                    <div class="form-grid cols-4">
                        <div class="form-group">
                            <label>Nombre Aditivo</label>
                            <select id="nombre-aditivo1">
                                <option value="">Ninguno</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Dosis (oz/cwt)</label>
                            <input type="number" id="dosis-aditivo1" step="0.1" value="0">
                        </div>
                        <div class="form-group">
                            <label>Gravedad Espec√≠fica</label>
                            <input type="number" id="ge-aditivo1" step="0.01" value="1.0">
                        </div>
                        <div class="form-group">
                            <label>Precio ($/gal)</label>
                            <input type="number" id="precio-aditivo1" step="0.01" value="0">
                        </div>
                    </div>

                    <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <strong>Aditivo 2:</strong>
                    </div>
                    <div class="form-grid cols-4">
                        <div class="form-group">
                            <label>Nombre Aditivo</label>
                            <select id="nombre-aditivo2">
                                <option value="">Ninguno</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Dosis (oz/cwt)</label>
                            <input type="number" id="dosis-aditivo2" step="0.1" value="0">
                        </div>
                        <div class="form-group">
                            <label>Gravedad Espec√≠fica</label>
                            <input type="number" id="ge-aditivo2" step="0.01" value="1.0">
                        </div>
                        <div class="form-group">
                            <label>Precio ($/gal)</label>
                            <input type="number" id="precio-aditivo2" step="0.01" value="0">
                        </div>
                    </div>

                    <div style="background: #f3e8ff; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <strong>Aditivo 3:</strong>
                    </div>
                    <div class="form-grid cols-4">
                        <div class="form-group">
                            <label>Nombre Aditivo</label>
                            <select id="nombre-aditivo3">
                                <option value="">Ninguno</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Dosis (oz/cwt)</label>
                            <input type="number" id="dosis-aditivo3" step="0.1" value="0">
                        </div>
                        <div class="form-group">
                            <label>Gravedad Espec√≠fica</label>
                            <input type="number" id="ge-aditivo3" step="0.01" value="1.0">
                        </div>
                        <div class="form-group">
                            <label>Precio ($/gal)</label>
                            <input type="number" id="precio-aditivo3" step="0.01" value="0">
                        </div>
                    </div>

                    <div class="button-group">
                        <button type="button" class="secondary" onclick="nuevoMixDesign()">‚ûï Nuevo Mix Design</button>
                        <button type="button" class="warning" onclick="calcularVolumenes()">üßÆ Calcular Vol√∫menes</button>
                        <button type="submit" id="btn-mixdesign" disabled>üíæ Guardar Mix Design</button>
                        <button type="button" class="info" id="btn-reporte" onclick="generarReporteMixDesign()" disabled>üìÑ Generar Reporte (Ventana)</button>
                        <button type="button" class="success" id="btn-reporte-download" onclick="descargarReporteMixDesign()" disabled>üíæ Descargar Reporte</button>
                        <button type="button" class="warning" id="btn-reporte-costos" onclick="generarReporteCostosMix()" disabled>üí∞ Reporte de Costos</button>
                        <button type="button" class="success" onclick="generarReportePrueba()">üß™ Probar Reporte</button>
                        <button type="button" class="secondary" onclick="clearForm('mixdesign')">üîÑ Limpiar</button>
                    </div>
                </form>
            </div>

            <!-- Resultados del C√°lculo -->
            <div class="card" id="mix-results" style="display: none;">
                <h2>üìä Resultados del Mix Design</h2>
                
                <div class="alert success">
                    <span>‚úÖ</span>
                    <span>C√°lculo completado exitosamente</span>
                </div>

                <h3>üéØ Cantidades por Yarda C√∫bica</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Material</th>
                            <th>Peso (lb/yd¬≥)</th>
                            <th>Volumen (ft¬≥)</th>
                            <th>Costo ($/yd¬≥)</th>
                        </tr>
                    </thead>
                    <tbody id="resultados-cantidades"></tbody>
                </table>

                <h3>üìà Resumen del Mix Design</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Par√°metro</th>
                            <th>Valor</th>
                        </tr>
                    </thead>
                    <tbody id="resultados-resumen"></tbody>
                </table>

                <h3>üí∞ An√°lisis de Costos</h3>
                <div id="resultados-costos"></div>
            </div>

            <div class="card">
                <h2>üìã Mix Designs Guardados</h2>
                <div class="search-box">
                    <input type="text" id="search-mixdesigns" placeholder="üîç Buscar mix design..." onkeyup="filterMixDesigns()">
                </div>
                <div class="button-group" style="margin-bottom:15px">
                    <button type="button" class="info" onclick="seleccionarTodosMixDesigns()">‚òëÔ∏è Seleccionar Todos</button>
                    <button type="button" class="secondary" onclick="deseleccionarTodosMixDesigns()">‚òê Deseleccionar Todos</button>
                    <button type="button" class="success" id="btn-generar-pdf-multiple" onclick="generarPDFMultiple()" disabled>üìÑ Generar PDF con Seleccionados (<span id="count-selected">0</span>)</button>
                    <button type="button" class="warning" id="btn-generar-costos-multiple" onclick="generarReportesCostosMultiple()" disabled>üí∞ Reportes de Costos (<span id="count-selected-costos">0</span>)</button>
                </div>
                <div id="lista-mixdesigns"></div>
            </div>
        </div>

        <!-- NUEVA SECCI√ìN: TRIAL MIXES -->
        <div id="tab-trials" class="tab-content">
            <div class="card">
                <h2>üî¨ Nuevo Trial Mix</h2>
                <form id="form-trial" novalidate>
                    <input type="hidden" id="edit-trial-id">
                    
                    <div class="alert info">
                        <span>‚ÑπÔ∏è</span>
                        <span>Selecciona un Mix Design base y registra los resultados del trial batch</span>
                    </div>

                    <h3>üìã Informaci√≥n del Trial</h3>
                    <div class="form-grid cols-3">
                        <div class="form-group">
                            <label>Trial Mix ID</label>
                            <input type="text" id="trial-id-display" readonly class="calculated">
                        </div>
                        <div class="form-group">
                            <label>Fecha del Trial *</label>
                            <input type="date" id="trial-fecha" required>
                        </div>
                        <div class="form-group">
                            <label>Hora del Trial</label>
                            <input type="time" id="trial-hora">
                        </div>
                    </div>

                    <div class="form-grid cols-2">
                        <div class="form-group">
                            <label>Seleccionar Mix Design Base *</label>
                            <select id="trial-mixdesign" required onchange="cargarInfoMixDesign()">
                                <option value="">Seleccionar...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tama√±o del Trial Batch (ft¬≥) *</label>
                            <select id="trial-tamano" required onchange="calcularCantidadesTrial()">
                                <option value="">Seleccionar...</option>
                                <option value="1">1 ft¬≥</option>
                                <option value="2">2 ft¬≥</option>
                                <option value="3">3 ft¬≥</option>
                                <option value="4">4 ft¬≥</option>
                                <option value="5">5 ft¬≥</option>
                                <option value="6.75">1/4 yd¬≥ (6.75 ft¬≥)</option>
                                <option value="13.5">1/2 yd¬≥ (13.5 ft¬≥)</option>
                                <option value="27">1 yd¬≥ (27 ft¬≥)</option>
                                <option value="custom">Tama√±o personalizado</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" id="trial-tamano-custom-group" style="display: none;">
                        <label>Tama√±o Personalizado (ft¬≥)</label>
                        <input type="number" id="trial-tamano-custom" step="0.01" min="0.1" onchange="calcularCantidadesTrial()">
                    </div>

                    <!-- Preview del Mix Design seleccionado -->
                    <div id="mix-design-preview" class="mix-design-preview" style="display: none;">
                        <h4>üìä Mix Design Seleccionado</h4>
                        <div class="detail">
                            <span><strong>Nombre:</strong></span>
                            <span id="preview-nombre">-</span>
                        </div>
                        <div class="detail">
                            <span><strong>Resistencia:</strong></span>
                            <span id="preview-resistencia">-</span>
                        </div>
                        <div class="detail">
                            <span><strong>W/C Ratio:</strong></span>
                            <span id="preview-wc">-</span>
                        </div>
                        <div class="detail">
                            <span><strong>Slump Objetivo:</strong></span>
                            <span id="preview-slump">-</span>
                        </div>
                    </div>

                    <!-- Cantidades calculadas para el trial -->
                    <div id="trial-cantidades" style="display: none;">
                        <h3>‚öñÔ∏è Cantidades para el Trial Batch</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Material</th>
                                    <th style="text-align:right">Cantidad (lb)</th>
                                    <th style="text-align:right">Unidad Ref.</th>
                                </tr>
                            </thead>
                            <tbody id="trial-cantidades-tabla"></tbody>
                        </table>
                    </div>

                    <h3>üß™ Resultados del Trial - Propiedades del Concreto Fresco</h3>
                    <div class="form-grid cols-4">
                        <div class="form-group">
                            <label>Slump Obtenido (in)</label>
                            <input type="number" id="trial-slump" step="0.25" placeholder="ej: 4.5">
                        </div>
                        <div class="form-group">
                            <label>Temperatura (¬∞F)</label>
                            <input type="number" id="trial-temperatura" step="0.1" placeholder="ej: 72.5">
                        </div>
                        <div class="form-group">
                            <label>Contenido de Aire (%)</label>
                            <input type="number" id="trial-aire" step="0.1" placeholder="ej: 2.5">
                        </div>
                        <div class="form-group">
                            <label>Peso Unitario (lb/ft¬≥)</label>
                            <input type="number" id="trial-peso-unitario" step="0.1" placeholder="ej: 145.2">
                        </div>
                    </div>

                    <h3>üèóÔ∏è Informaci√≥n de Cilindros</h3>
                    <div class="form-group">
                        <label>N√∫mero de Cilindros</label>
                        <input type="number" id="trial-num-cilindros" min="0" max="20" value="6" onchange="generarCamposCilindros()">
                    </div>

                    <div id="cilindros-container" class="cylinders-list"></div>

                    <h3>üìù Observaciones y Notas</h3>
                    <div class="form-group">
                        <label>Observaciones del Trial</label>
                        <textarea id="trial-observaciones" rows="4" placeholder="Ej: Buena trabajabilidad, sin segregaci√≥n, tiempo de mezclado 3 minutos..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>T√©cnico Responsable</label>
                        <input type="text" id="trial-tecnico" placeholder="Nombre del t√©cnico">
                    </div>

                    <div class="button-group">
                        <button type="button" onclick="guardarTrialMix()">üíæ Guardar Trial Mix</button>
                        <button type="button" class="success" onclick="nuevoTrialMix()">‚ûï Nuevo Trial Mix</button>
                        <button type="button" class="info" id="btn-reporte-trial" onclick="generarReporteTrial()" disabled>üìÑ Generar Reporte</button>
                        <button type="button" class="purple" id="btn-qr-trial" onclick="generarQRTrial()" disabled>üì± Generar QR Code</button>
                        <button type="button" class="secondary" onclick="clearForm('trial')">üîÑ Limpiar</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h2>üìã Trial Mixes Registrados</h2>
                <div class="search-box">
                    <input type="text" id="search-trials" placeholder="üîç Buscar trial mix..." onkeyup="filterTrials()">
                </div>
                <div id="lista-trials"></div>
            </div>
        </div>

        <!-- SECCI√ìN: AN√ÅLISIS DE DATA -->
        <div id="tab-analisis" class="tab-content">
            <div class="card">
                <h2>üìà An√°lisis de Resistencia de Concreto</h2>
                
                <div class="alert info">
                    <span>‚ÑπÔ∏è</span>
                    <span>An√°lisis estad√≠stico de los resultados de Trial Mixes. Los gr√°ficos se generan autom√°ticamente con los datos de cilindros rotos.</span>
                </div>

                <!-- Controles y Filtros -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <div class="form-grid cols-3">
                        <div class="form-group">
                            <label>Seleccionar Trial Mixes</label>
                            <div style="position: relative;">
                                <button type="button" class="secondary" onclick="toggleAnalisisMixFilter()" style="width: 100%; text-align: left; display: flex; justify-content: space-between; align-items: center;">
                                    <span id="analisis-filter-label">Todas las mezclas</span>
                                    <span>‚ñº</span>
                                </button>
                                <div id="analisis-mix-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; margin-top: 5px; max-height: 300px; overflow-y: auto; z-index: 10; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                    <div style="padding: 10px; border-bottom: 1px solid #eee;">
                                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 5px;">
                                            <input type="checkbox" value="all" checked onchange="handleAnalisisMixFilterChange(this)">
                                            <strong>Seleccionar Todas</strong>
                                        </label>
                                    </div>
                                    <div id="analisis-mix-checkboxes" style="padding: 10px;"></div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Tipo de Vista</label>
                            <select id="analisis-view-type" onchange="updateAnalisisCharts()">
                                <option value="evolution">Evoluci√≥n de Resistencia</option>
                                <option value="efficiency">% de Resistencia (f'c)</option>
                                <option value="comparison">Comparaci√≥n entre Mezclas</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Acciones</label>
                            <div style="display: flex; gap: 10px;">
                                <button type="button" class="success" onclick="updateAnalisisCharts()" style="flex: 1;">üîÑ Actualizar</button>
                                <button type="button" class="info" onclick="exportarAnalisisPDF()" style="flex: 1;">üìÑ Exportar PDF</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Estad√≠sticas Resumen -->
                <div id="analisis-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;"></div>

                <!-- Gr√°fico Principal -->
                <div style="background: white; padding: 25px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 20px; color: #16a34a;">üìä Gr√°fico de An√°lisis</h3>
                    <div style="position: relative; height: 500px;">
                        <canvas id="analisis-chart-main"></canvas>
                    </div>
                </div>

                <!-- Tabla de Datos Detallados -->
                <div class="card">
                    <h3>üìã Datos Detallados por Trial Mix</h3>
                    <div id="analisis-table-container"></div>
                </div>
            </div>
        </div>

        <!-- CALENDARIO DE ROTURAS -->
        <div id="tab-calendario" class="tab-content">
            <div class="card">
                <h2>üìÖ Calendario de Roturas de Cilindros</h2>
                
                <div class="alert info">
                    <span>‚ÑπÔ∏è</span>
                    <div>
                        <strong>Calendario de Ensayos Programados</strong><br>
                        Vista de todos los cilindros pendientes y programados para ensayo. Los ensayos vencidos aparecen en rojo.
                    </div>
                </div>

                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <div class="form-group" style="flex: 1;">
                        <label>Filtrar por mes</label>
                        <input type="month" id="filtro-mes-calendario" onchange="cargarCalendario()">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Filtrar por estado</label>
                        <select id="filtro-estado-calendario" onchange="cargarCalendario()">
                            <option value="todos">Todos</option>
                            <option value="pendientes">Solo Pendientes</option>
                            <option value="completados">Solo Completados</option>
                            <option value="vencidos">Solo Vencidos</option>
                        </select>
                    </div>
                </div>

                <div id="calendario-container"></div>
            </div>
        </div>
    </div>

    <script>

        // MIX ID
        async function generarMixId() {
            try {
                const mixdesigns = await getAllRecords('mixdesigns');
                const year = new Date().getFullYear();
                const numero = (mixdesigns ? mixdesigns.length : 0) + 1;
                return 'MX-' + year + '-' + String(numero).padStart(4, '0');
            } catch(e) {
                return 'MX-2026-0001';
            }
        }

        // FUNCIONES PARA BOTONES NUEVO
        function nuevoMixDesign() {
            clearForm('mixdesign');
            generarMixId().then(id => {
                const elem = document.getElementById('mix-id-display');
                if (elem) elem.value = id;
            });
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function nuevoTrial() {
            clearForm('trial');
            const trialId = await generarTrialId();
            document.getElementById('trial-id-display').value = trialId;
            document.getElementById('trial-fecha').valueAsDate = new Date();
            generarCamposCilindros();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }


        // ============ BASE DE DATOS ============
        let db;
        let currentMixResults = null;

        // Variable global para guardar el logo
        let logoEmpresa = null;
        
        // Funci√≥n para cargar el logo
        function cargarLogo() {
            const input = document.getElementById('mix-logo');
            const preview = document.getElementById('logo-preview');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    logoEmpresa = e.target.result;
                    preview.src = logoEmpresa;
                    preview.style.display = 'block';
                    console.log('Logo cargado exitosamente');
                };
                
                reader.readAsDataURL(input.files[0]);
            }
        }
        


        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('ConcretoManagementDB', 4); // Incrementar versi√≥n
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    
                    if (!db.objectStoreNames.contains('clientes')) {
                        db.createObjectStore('clientes', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('proyectos')) {
                        db.createObjectStore('proyectos', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('materiales')) {
                        db.createObjectStore('materiales', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('cotizaciones')) {
                        db.createObjectStore('cotizaciones', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('mixdesigns')) {
                        db.createObjectStore('mixdesigns', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('trials')) {
                        db.createObjectStore('trials', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings', { keyPath: 'key' });
                    }
                };
            });
        }

        function addRecord(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(data);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function updateRecord(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function deleteRecord(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function getRecord(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(id);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function getAllRecords(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // ============ EXPORTAR / IMPORTAR DATA ============
        async function exportarTodaLaData() {
            try {
                const data = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    clientes: await getAllRecords('clientes'),
                    proyectos: await getAllRecords('proyectos'),
                    materiales: await getAllRecords('materiales'),
                    mixdesigns: await getAllRecords('mixdesigns'),
                    trials: await getAllRecords('trials')
                };
                
                // Incluir logo si existe
                try {
                    const transaction = db.transaction(['settings'], 'readonly');
                    const store = transaction.objectStore('settings');
                    const request = store.get('logo');
                    
                    await new Promise((resolve) => {
                        request.onsuccess = () => {
                            if (request.result && request.result.value) {
                                data.logo = request.result.value;
                            }
                            resolve();
                        };
                        request.onerror = () => resolve();
                    });
                } catch (error) {
                    console.log('No logo to export');
                }
                
                // Crear archivo JSON
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // Crear nombre de archivo con fecha
                const fecha = new Date().toISOString().split('T')[0];
                const nombreArchivo = `mixtec-backup-${fecha}.json`;
                
                // Descargar
                const a = document.createElement('a');
                a.href = url;
                a.download = nombreArchivo;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert(`‚úÖ Data exportada exitosamente!\n\nArchivo: ${nombreArchivo}\n\n` +
                      `Clientes: ${data.clientes.length}\n` +
                      `Proyectos: ${data.proyectos.length}\n` +
                      `Materiales: ${data.materiales.length}\n` +
                      `Mix Designs: ${data.mixdesigns.length}\n` +
                      `Trial Mixes: ${data.trials.length}`);
                
            } catch (error) {
                console.error('Error exportando:', error);
                alert('‚ùå Error al exportar datos: ' + error.message);
            }
        }

        async function importarData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Confirmaci√≥n
            if (!confirm('‚ö†Ô∏è ADVERTENCIA: Al importar datos se REEMPLAZAR√Å toda la informaci√≥n actual.\n\n' +
                        '¬øEst√°s seguro de que deseas continuar?\n\n' +
                        'Recomendaci√≥n: Exporta tus datos actuales primero como respaldo.')) {
                event.target.value = ''; // Reset file input
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validar estructura
                    if (!data.version || !data.clientes || !data.proyectos || !data.materiales || !data.mixdesigns || !data.trials) {
                        throw new Error('Archivo JSON inv√°lido o incompleto');
                    }
                    
                    // Limpiar todas las tablas primero
                    const stores = ['clientes', 'proyectos', 'materiales', 'mixdesigns', 'trials'];
                    
                    for (const storeName of stores) {
                        const transaction = db.transaction([storeName], 'readwrite');
                        const store = transaction.objectStore(storeName);
                        await store.clear();
                    }
                    
                    // Importar datos
                    let importados = {
                        clientes: 0,
                        proyectos: 0,
                        materiales: 0,
                        mixdesigns: 0,
                        trials: 0
                    };
                    
                    // Importar cada categor√≠a
                    for (const cliente of data.clientes) {
                        await addRecord('clientes', cliente);
                        importados.clientes++;
                    }
                    
                    for (const proyecto of data.proyectos) {
                        await addRecord('proyectos', proyecto);
                        importados.proyectos++;
                    }
                    
                    for (const material of data.materiales) {
                        await addRecord('materiales', material);
                        importados.materiales++;
                    }
                    
                    for (const mix of data.mixdesigns) {
                        await addRecord('mixdesigns', mix);
                        importados.mixdesigns++;
                    }
                    
                    for (const trial of data.trials) {
                        await addRecord('trials', trial);
                        importados.trials++;
                    }
                    
                    // Importar logo si existe
                    if (data.logo) {
                        await guardarLogo(data.logo);
                        mostrarLogo(data.logo);
                    }
                    
                    alert(`‚úÖ Importaci√≥n exitosa!\n\n` +
                          `Clientes: ${importados.clientes}\n` +
                          `Proyectos: ${importados.proyectos}\n` +
                          `Materiales: ${importados.materiales}\n` +
                          `Mix Designs: ${importados.mixdesigns}\n` +
                          `Trial Mixes: ${importados.trials}\n\n` +
                          `Fecha de exportaci√≥n original: ${new Date(data.exportDate).toLocaleString('es-ES')}`);
                    
                    // Recargar dashboard
                    updateDashboard();
                    
                } catch (error) {
                    console.error('Error importando:', error);
                    alert('‚ùå Error al importar datos: ' + error.message + '\n\nAseg√∫rate de que el archivo sea un backup v√°lido.');
                }
                
                // Reset file input
                event.target.value = '';
            };
            
            reader.onerror = function() {
                alert('‚ùå Error al leer el archivo');
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }


        // ============ NAVEGACI√ìN ============
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Cargar datos cuando se cambia de tab
            if (tabName === 'clientes') loadClientes();
            if (tabName === 'proyectos') {
                loadProyectos();
                loadClientesSelect();
            }
            if (tabName === 'materiales') loadMateriales();
            if (tabName === 'cotizaciones') loadCotizaciones();
            if (tabName === 'mixdesign') {
                loadMixDesigns();
                loadClientesSelect();
                loadProyectosSelect();
            }
            if (tabName === 'trials') {
                loadTrials();
                loadMixDesignsSelect();
            }
            if (tabName === 'analisis') {
                updateAnalisisMixFilter();
                updateAnalisisCharts();
            }
            if (tabName === 'calendario') {
                cargarCalendario();
            }
            if (tabName === 'ai-optimizer') {
                cargarMixDesignsEnAIOptimizer();
                setTimeout(aiAttachSieveLiveListeners, 100);
            }
            if (tabName === 'dashboard') updateDashboard();
        }

        // ============ LOGO ============
        document.getElementById('logo-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const logoData = event.target.result;
                    guardarLogo(logoData);
                    mostrarLogo(logoData);
                };
                reader.readAsDataURL(file);
            }
        });

        async function guardarLogo(logoData) {
            const transaction = db.transaction(['settings'], 'readwrite');
            const store = transaction.objectStore('settings');
            await store.put({ key: 'logo', value: logoData });
        }

        async function cargarLogoGuardado() {
            try {
                const transaction = db.transaction(['settings'], 'readonly');
                const store = transaction.objectStore('settings');
                const request = store.get('logo');
                
                request.onsuccess = () => {
                    if (request.result && request.result.value) {
                        mostrarLogo(request.result.value);
                    }
                };
            } catch (error) {
                console.log('No hay logo guardado');
            }
        }

        function mostrarLogo(logoData) {
            const container = document.getElementById('logo-container');
            container.innerHTML = `<img src="${logoData}" alt="Logo">`;
            container.classList.remove('empty');
        }

        // ============ APLICACIONES ============
        async function cargarAplicaciones() {
            const aplicaciones = [
                'Losas', 'Columnas', 'Vigas', 'Muros', 'Cimientos',
                'Pavimento', 'Aceras', 'Estructural', 'Arquitect√≥nico', 'Otro'
            ];
            
            const select = document.getElementById('mix-aplicacion');
            aplicaciones.forEach(app => {
                select.innerHTML += `<option value="${app}">${app}</option>`;
            });
        }

        // ============ CLIENTES ============
        document.getElementById('form-cliente').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const cliente = {
                nombre: document.getElementById('cliente-nombre').value,
                empresa: document.getElementById('cliente-empresa').value,
                email: document.getElementById('cliente-email').value,
                telefono: document.getElementById('cliente-telefono').value,
                notas: document.getElementById('cliente-notas').value,
                fechaCreacion: new Date().toISOString()
            };

            const editId = document.getElementById('edit-cliente-id').value;

            try {
                if (editId) {
                    cliente.id = parseInt(editId);
                    await updateRecord('clientes', cliente);
                    alert('‚úÖ Cliente actualizado');
                } else {
                    await addRecord('clientes', cliente);
                    alert('‚úÖ Cliente guardado');
                }
                clearForm('cliente');
                loadClientes();
                updateDashboard();
            } catch (error) {
                alert('‚ùå Error: ' + error);
            }
        });

        async function loadClientes() {
            const clientes = await getAllRecords('clientes');
            const container = document.getElementById('lista-clientes');
            
            if (clientes.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay clientes registrados</div>';
                return;
            }
            
            let html = '<table><thead><tr><th>Nombre</th><th>Empresa</th><th>Email</th><th>Tel√©fono</th><th>Acciones</th></tr></thead><tbody>';
            clientes.forEach(c => {
                html += `<tr>
                    <td><strong>${c.nombre}</strong></td>
                    <td>${c.empresa || '-'}</td>
                    <td>${c.email || '-'}</td>
                    <td>${c.telefono || '-'}</td>
                    <td class="actions">
                        <button class="secondary" onclick="editCliente(${c.id})">Editar</button>
                        <button class="danger" onclick="deleteCliente(${c.id})">Eliminar</button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function editCliente(id) {
            const cliente = await getRecord('clientes', id);
            if (!cliente) return;
            
            document.getElementById('edit-cliente-id').value = cliente.id;
            document.getElementById('cliente-nombre').value = cliente.nombre;
            document.getElementById('cliente-empresa').value = cliente.empresa || '';
            document.getElementById('cliente-email').value = cliente.email || '';
            document.getElementById('cliente-telefono').value = cliente.telefono || '';
            document.getElementById('cliente-notas').value = cliente.notas || '';
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function deleteCliente(id) {
            if (confirm('¬øEliminar este cliente?')) {
                await deleteRecord('clientes', id);
                loadClientes();
                updateDashboard();
            }
        }

        function filterClientes() {
            const search = document.getElementById('search-clientes').value.toLowerCase();
            document.querySelectorAll('#lista-clientes table tbody tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        // ============ PROYECTOS ============
        document.getElementById('form-proyecto').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const proyecto = {
                nombre: document.getElementById('proyecto-nombre').value,
                cliente: document.getElementById('proyecto-cliente').value,
                ubicacion: document.getElementById('proyecto-ubicacion').value,
                descripcion: document.getElementById('proyecto-descripcion').value,
                estado: document.getElementById('proyecto-estado').value,
                fechaCreacion: new Date().toISOString()
            };

            const editId = document.getElementById('edit-proyecto-id').value;

            try {
                if (editId) {
                    proyecto.id = parseInt(editId);
                    await updateRecord('proyectos', proyecto);
                    alert('‚úÖ Proyecto actualizado');
                } else {
                    await addRecord('proyectos', proyecto);
                    alert('‚úÖ Proyecto guardado');
                }
                clearForm('proyecto');
                loadProyectos();
                updateDashboard();
            } catch (error) {
                alert('‚ùå Error: ' + error);
            }
        });

        async function loadProyectos() {
            const proyectos = await getAllRecords('proyectos');
            const clientes = await getAllRecords('clientes');
            const container = document.getElementById('lista-proyectos');
            
            if (proyectos.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay proyectos</div>';
                return;
            }
            
            let html = '<table><thead><tr><th>Proyecto</th><th>Cliente</th><th>Ubicaci√≥n</th><th>Estado</th><th>Acciones</th></tr></thead><tbody>';
            proyectos.forEach(p => {
                const cliente = clientes.find(c => c.id == p.cliente);
                const estadoBadge = p.estado === 'active' ? 'active' : 'inactive';
                const estadoTexto = p.estado === 'active' ? 'Activo' : p.estado === 'completed' ? 'Completado' : 'En Espera';
                
                html += `<tr>
                    <td><strong>${p.nombre}</strong></td>
                    <td>${cliente ? cliente.nombre : '-'}</td>
                    <td>${p.ubicacion || '-'}</td>
                    <td><span class="badge ${estadoBadge}">${estadoTexto}</span></td>
                    <td class="actions">
                        <button class="secondary" onclick="editProyecto(${p.id})">Editar</button>
                        <button class="danger" onclick="deleteProyecto(${p.id})">Eliminar</button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function editProyecto(id) {
            const proyecto = await getRecord('proyectos', id);
            if (!proyecto) return;
            
            document.getElementById('edit-proyecto-id').value = proyecto.id;
            document.getElementById('proyecto-nombre').value = proyecto.nombre;
            document.getElementById('proyecto-cliente').value = proyecto.cliente || '';
            document.getElementById('proyecto-ubicacion').value = proyecto.ubicacion || '';
            document.getElementById('proyecto-descripcion').value = proyecto.descripcion || '';
            document.getElementById('proyecto-estado').value = proyecto.estado;
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function deleteProyecto(id) {
            if (confirm('¬øEliminar este proyecto?')) {
                await deleteRecord('proyectos', id);
                loadProyectos();
                updateDashboard();
            }
        }

        function filterProyectos() {
            const search = document.getElementById('search-proyectos').value.toLowerCase();
            document.querySelectorAll('#lista-proyectos table tbody tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        
        // Abrir modal de nuevo cliente
        function nuevoClienteRapido() {
            document.getElementById('modal-cliente-rapido').style.display = 'flex';
            document.getElementById('nuevo-cliente-nombre').value = '';
            document.getElementById('nuevo-cliente-email').value = '';
            document.getElementById('nuevo-cliente-telefono').value = '';
            document.getElementById('nuevo-cliente-nombre').focus();
        }
        
        // Cerrar modal
        function cerrarModalCliente() {
            document.getElementById('modal-cliente-rapido').style.display = 'none';
        }
        
        // Nuevo Proyecto R√°pido
        function nuevoProyectoRapido() {
            // Cargar clientes primero en el select del modal
            loadClientesSelectModal();
            document.getElementById('modal-proyecto-rapido').style.display = 'flex';
            document.getElementById('nuevo-proyecto-nombre').value = '';
            document.getElementById('nuevo-proyecto-ubicacion').value = '';
            document.getElementById('nuevo-proyecto-nombre').focus();
        }
        
        // Cerrar modal proyecto
        function cerrarModalProyecto() {
            document.getElementById('modal-proyecto-rapido').style.display = 'none';
        }
        
        // Cargar clientes en el select del modal
        async function loadClientesSelectModal() {
            const clientes = await getAllRecords('clientes');
            const select = document.getElementById('nuevo-proyecto-cliente');
            if (select) {
                select.innerHTML = '<option value="">Seleccionar cliente...</option>';
                clientes.forEach(c => {
                    select.innerHTML += `<option value="${c.id}">${c.nombre}</option>`;
                });
            }
        }
        
        // Guardar proyecto r√°pido
        async function guardarProyectoRapido() {
            const nombre = document.getElementById('nuevo-proyecto-nombre').value.trim();
            const clienteId = document.getElementById('nuevo-proyecto-cliente').value;
            
            if (!nombre) {
                alert('‚ö†Ô∏è El nombre del proyecto es obligatorio');
                return;
            }
            
            if (!clienteId) {
                alert('‚ö†Ô∏è Debes seleccionar un cliente');
                return;
            }
            
            const proyecto = {
                nombre: nombre,
                clienteId: parseInt(clienteId),
                ubicacion: document.getElementById('nuevo-proyecto-ubicacion').value.trim(),
                estado: 'Activo',
                fechaCreacion: new Date().toISOString()
            };
            
            try {
                const id = await addRecord('proyectos', proyecto);
                
                // Cargar el cliente en el select de mix design
                document.getElementById('mix-cliente').value = clienteId;
                await filtrarProyectosPorCliente();
                
                // Esperar un momento para que se cargue el select
                setTimeout(() => {
                    document.getElementById('mix-proyecto').value = id;
                }, 100);
                
                cerrarModalProyecto();
                alert('‚úÖ Proyecto creado exitosamente');
            } catch (error) {
                alert('‚ùå Error al crear proyecto: ' + error.message);
            }
        }
        
        // Guardar cliente r√°pido
        async function guardarClienteRapido() {
            const nombre = document.getElementById('nuevo-cliente-nombre').value.trim();
            
            if (!nombre) {
                alert('‚ö†Ô∏è El nombre del cliente es obligatorio');
                return;
            }
            
            const cliente = {
                nombre: nombre,
                email: document.getElementById('nuevo-cliente-email').value.trim(),
                telefono: document.getElementById('nuevo-cliente-telefono').value.trim(),
                fechaCreacion: new Date().toISOString()
            };
            
            try {
                const id = await addRecord('clientes', cliente);
                await loadClientesSelect();
                
                // Esperar un momento para que se cargue el select
                setTimeout(() => {
                    document.getElementById('mix-cliente').value = id;
                    // Trigger del filtrado de proyectos
                    filtrarProyectosPorCliente();
                }, 100);
                await filtrarProyectosPorCliente();
                
                cerrarModalCliente();
                alert('‚úÖ Cliente creado exitosamente');
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error al crear cliente: ' + error.message);
            }
        }
        

        async function loadClientesSelect() {
            const clientes = await getAllRecords('clientes');
            
            // Cargar en select de proyectos
            const selectProyecto = document.getElementById('proyecto-cliente');
            if (selectProyecto) {
                selectProyecto.innerHTML = '<option value="">Seleccionar...</option>';
                clientes.forEach(c => {
                    selectProyecto.innerHTML += `<option value="${c.id}">${c.nombre}</option>`;
                });
            }
            
            // Cargar en select de mix design
            const selectMix = document.getElementById('mix-cliente');
            if (selectMix) {
                selectMix.innerHTML = '<option value="">Seleccione cliente...</option>';
                clientes.forEach(c => {
                    selectMix.innerHTML += `<option value="${c.id}">${c.nombre}</option>`;
                });
            }
        }

        async function loadProyectosSelect() {
            const proyectos = await getAllRecords('proyectos');
            const select = document.getElementById('mix-proyecto');
            select.innerHTML = '<option value="">Sin proyecto</option>';
            proyectos.forEach(p => {
                select.innerHTML += `<option value="${p.id}">${p.nombre}</option>`;
            });
        }
        
        // Filtrar proyectos por cliente seleccionado
        async function filtrarProyectosPorCliente() {
            const clienteSelect = document.getElementById('mix-cliente');
            const proyectoSelect = document.getElementById('mix-proyecto');
            
            if (!clienteSelect || !proyectoSelect) return;
            
            const clienteId = clienteSelect.value;
            
            if (!clienteId) {
                // Si no hay cliente seleccionado, mostrar todos los proyectos
                await loadProyectosSelect();
                return;
            }
            
            // Filtrar proyectos del cliente seleccionado
            const proyectos = await getAllRecords('proyectos');
            const proyectosFiltrados = proyectos.filter(p => p.clienteId == clienteId);
            
            proyectoSelect.innerHTML = '<option value="">Seleccione proyecto...</option>';
            
            if (proyectosFiltrados.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No hay proyectos para este cliente';
                option.disabled = true;
                proyectoSelect.appendChild(option);
            } else {
                proyectosFiltrados.forEach(proyecto => {
                    const option = document.createElement('option');
                    option.value = proyecto.id;
                    option.textContent = proyecto.nombre;
                    proyectoSelect.appendChild(option);
                });
            }
        }


        // ============ MATERIALES ============
        document.getElementById('form-material').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const material = {
                nombre: document.getElementById('material-nombre').value,
                categoria: document.getElementById('material-categoria').value,
                cantidad: parseFloat(document.getElementById('material-cantidad').value) || 0,
                unidad: document.getElementById('material-unidad').value,
                precio: parseFloat(document.getElementById('material-precio').value) || 0,
                proveedor: document.getElementById('material-proveedor').value,
                fechaCreacion: new Date().toISOString()
            };

            const editId = document.getElementById('edit-material-id').value;

            try {
                if (editId) {
                    material.id = parseInt(editId);
                    await updateRecord('materiales', material);
                    alert('‚úÖ Material actualizado');
                } else {
                    await addRecord('materiales', material);
                    alert('‚úÖ Material guardado');
                }
                clearForm('material');
                loadMateriales();
                cargarAditivosEnSelects();
            setTimeout(async function() {
                const mixId = await generarMixId();
                const elem = document.getElementById('mix-id-display');
                if (elem) elem.value = mixId;
            }, 500);
                updateDashboard();
            } catch (error) {
                alert('‚ùå Error: ' + error);
            }
        });

        async function loadMateriales() {
            const materiales = await getAllRecords('materiales');
            const container = document.getElementById('lista-materiales');
            
            if (materiales.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay materiales</div>';
                return;
            }
            
            let html = '<table><thead><tr><th>Nombre</th><th>Categor√≠a</th><th>Cantidad</th><th>Precio</th><th>Total</th><th>Acciones</th></tr></thead><tbody>';
            materiales.forEach(m => {
                const total = m.cantidad * m.precio;
                html += `<tr>
                    <td><strong>${m.nombre}</strong></td>
                    <td>${m.categoria}</td>
                    <td>${m.cantidad} ${m.unidad || ''}</td>
                    <td>$${m.precio.toFixed(2)}</td>
                    <td>$${total.toFixed(2)}</td>
                    <td class="actions">
                        <button class="secondary" onclick="editMaterial(${m.id})">Editar</button>
                        <button class="danger" onclick="deleteMaterial(${m.id})">Eliminar</button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function editMaterial(id) {
            const material = await getRecord('materiales', id);
            if (!material) return;
            
            document.getElementById('edit-material-id').value = material.id;
            document.getElementById('material-nombre').value = material.nombre;
            document.getElementById('material-categoria').value = material.categoria;
            document.getElementById('material-cantidad').value = material.cantidad;
            document.getElementById('material-unidad').value = material.unidad || '';
            document.getElementById('material-precio').value = material.precio;
            document.getElementById('material-proveedor').value = material.proveedor || '';
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function deleteMaterial(id) {
            if (confirm('¬øEliminar este material?')) {
                await deleteRecord('materiales', id);
                loadMateriales();
                updateDashboard();
            }
        }

        function filterMateriales() {
            const search = document.getElementById('search-materiales').value.toLowerCase();
            document.querySelectorAll('#lista-materiales table tbody tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        // ============ COTIZACIONES ============
        
        let lineaCotizacionCounter = 0;

        async function generarNumeroCotizacion() {
            const cotizaciones = await getAllRecords('cotizaciones');
            const year = new Date().getFullYear();
            const numero = (cotizaciones ? cotizaciones.length : 0) + 1;
            return 'COT-' + year + '-' + String(numero).padStart(4, '0');
        }

        function nuevaCotizacion() {
            limpiarFormularioCotizacion();
            generarNumeroCotizacion().then(numero => {
                document.getElementById('cotizacion-numero').value = numero;
            });
            // Agregar una l√≠nea inicial
            agregarLineaCotizacion();
        }

        function agregarLineaCotizacion() {
            lineaCotizacionCounter++;
            const tbody = document.getElementById('cotizacion-lineas-body');
            const row = document.createElement('tr');
            row.id = `linea-${lineaCotizacionCounter}`;
            
            row.innerHTML = `
                <td><input type="text" class="linea-descripcion" placeholder="Ej: Concreto 3000 PSI" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></td>
                <td><input type="number" class="linea-cantidad" step="0.01" min="0" value="0" onchange="calcularTotalGeneral()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></td>
                <td><input type="number" class="linea-precio" step="0.01" min="0" value="0" onchange="calcularTotalGeneral()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></td>
                <td style="text-align: center;">
                    <button type="button" class="danger" onclick="eliminarLineaCotizacion(${lineaCotizacionCounter})" style="padding: 6px 12px;">üóëÔ∏è</button>
                </td>
            `;
            
            tbody.appendChild(row);
        }

        function calcularTotalGeneral() {
            const tbody = document.getElementById('cotizacion-lineas-body');
            let totalDinero = 0;
            let totalYd = 0;
            
            tbody.querySelectorAll('tr').forEach(row => {
                const cantidad = parseFloat(row.querySelector('.linea-cantidad').value) || 0;
                const precio = parseFloat(row.querySelector('.linea-precio').value) || 0;
                totalDinero += cantidad * precio;
                totalYd += cantidad;
            });
            
            document.getElementById('cotizacion-total-yd').textContent = totalYd.toFixed(2) + ' yd¬≥';
        }

        function eliminarLineaCotizacion(lineaId) {
            const row = document.getElementById(`linea-${lineaId}`);
            if (row) {
                row.remove();
                calcularTotalGeneral();
            }
        }

        function limpiarFormularioCotizacion() {
            document.getElementById('form-cotizacion').reset();
            document.getElementById('edit-cotizacion-id').value = '';
            document.getElementById('cotizacion-lineas-body').innerHTML = '';
            document.getElementById('cotizacion-total-yd').textContent = '0.00 yd¬≥';
            document.getElementById('cotizacion-status').value = 'Pendiente';
            document.getElementById('btn-imprimir-cotizacion').disabled = true;
            lineaCotizacionCounter = 0;
            
            // Generar nuevo n√∫mero
            generarNumeroCotizacion().then(numero => {
                document.getElementById('cotizacion-numero').value = numero;
            });
            
            // Fecha de hoy
            document.getElementById('cotizacion-fecha').valueAsDate = new Date();
            
            // Fecha v√°lida hasta (30 d√≠as)
            const validaHasta = new Date();
            validaHasta.setDate(validaHasta.getDate() + 30);
            document.getElementById('cotizacion-valida-hasta').valueAsDate = validaHasta;
        }

        document.getElementById('form-cotizacion').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Recopilar l√≠neas
            const tbody = document.getElementById('cotizacion-lineas-body');
            const lineas = [];
            
            tbody.querySelectorAll('tr').forEach(row => {
                const descripcion = row.querySelector('.linea-descripcion').value;
                const cantidad = parseFloat(row.querySelector('.linea-cantidad').value) || 0;
                const precio = parseFloat(row.querySelector('.linea-precio').value) || 0;
                const total = cantidad * precio;
                
                if (descripcion && cantidad > 0) {
                    lineas.push({ descripcion, cantidad, precio, total });
                }
            });
            
            if (lineas.length === 0) {
                alert('‚ö†Ô∏è Agrega al menos una l√≠nea de cotizaci√≥n');
                return;
            }
            
            const totalGeneral = lineas.reduce((sum, linea) => sum + linea.total, 0);
            const totalYd = lineas.reduce((sum, linea) => sum + linea.cantidad, 0);
            
            const cotizacion = {
                numero: document.getElementById('cotizacion-numero').value,
                fecha: document.getElementById('cotizacion-fecha').value,
                validaHasta: document.getElementById('cotizacion-valida-hasta').value,
                status: document.getElementById('cotizacion-status').value,
                clienteNombre: document.getElementById('cotizacion-cliente-nombre').value,
                clienteTel: document.getElementById('cotizacion-cliente-tel').value,
                clienteEmail: document.getElementById('cotizacion-cliente-email').value,
                proyecto: document.getElementById('cotizacion-proyecto').value,
                ubicacion: document.getElementById('cotizacion-ubicacion').value,
                lineas: lineas,
                total: totalGeneral,
                totalYd: totalYd,
                notas: document.getElementById('cotizacion-notas').value,
                fechaCreacion: new Date().toISOString()
            };
            
            const editId = document.getElementById('edit-cotizacion-id').value;
            
            try {
                if (editId) {
                    cotizacion.id = parseInt(editId);
                    await updateRecord('cotizaciones', cotizacion);
                    alert('‚úÖ Cotizaci√≥n actualizada');
                } else {
                    await addRecord('cotizaciones', cotizacion);
                    alert('‚úÖ Cotizaci√≥n guardada exitosamente');
                }
                
                document.getElementById('btn-imprimir-cotizacion').disabled = false;
                await loadCotizaciones();
                
            } catch (error) {
                console.error('Error al guardar cotizaci√≥n:', error);
                alert('‚ùå Error al guardar: ' + error.message);
            }
        });

        async function loadCotizaciones() {
            const cotizaciones = await getAllRecords('cotizaciones');
            const container = document.getElementById('lista-cotizaciones');
            
            if (cotizaciones.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay cotizaciones</div>';
                return;
            }
            
            cotizaciones.sort((a, b) => new Date(b.fechaCreacion) - new Date(a.fechaCreacion));
            
            // Funci√≥n para obtener emoji del status
            const getStatusEmoji = (status) => {
                const emojis = {
                    'Pendiente': '‚è≥',
                    'Aprobada': '‚úÖ',
                    'Rechazada': '‚ùå',
                    'En Revisi√≥n': 'üëÅÔ∏è',
                    'Cancelada': 'üö´'
                };
                return emojis[status] || 'üìÑ';
            };
            
            // Funci√≥n para obtener color del status
            const getStatusColor = (status) => {
                const colors = {
                    'Pendiente': '#f59e0b',
                    'Aprobada': '#16a34a',
                    'Rechazada': '#dc2626',
                    'En Revisi√≥n': '#0369a1',
                    'Cancelada': '#6b7280'
                };
                return colors[status] || '#6b7280';
            };
            
            let html = '<table><thead><tr><th>N√∫mero</th><th>Status</th><th>Cliente</th><th>Proyecto</th><th>Fecha</th><th>Total YD¬≥</th><th>Acciones</th></tr></thead><tbody>';
            cotizaciones.forEach(c => {
                const statusColor = getStatusColor(c.status || 'Pendiente');
                const statusEmoji = getStatusEmoji(c.status || 'Pendiente');
                html += `<tr>
                    <td><strong>${c.numero}</strong></td>
                    <td><span style="background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: bold; white-space: nowrap;">${statusEmoji} ${c.status || 'Pendiente'}</span></td>
                    <td>${c.clienteNombre}</td>
                    <td>${c.proyecto}</td>
                    <td>${new Date(c.fecha).toLocaleDateString('es-ES')}</td>
                    <td style="color: #0369a1; font-weight: bold;">${(c.totalYd || 0).toFixed(2)} yd¬≥</td>
                    <td class="actions">
                        <button class="info" onclick="verCotizacion(${c.id})">Ver</button>
                        <button class="secondary" onclick="editCotizacion(${c.id})">Editar</button>
                        <button class="success" onclick="imprimirCotizacionGuardada(${c.id})">üñ®Ô∏è</button>
                        <button class="danger" onclick="deleteCotizacion(${c.id})">Eliminar</button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function verCotizacion(id) {
            const cotizacion = await getRecord('cotizaciones', id);
            if (!cotizacion) return;
            
            let detalles = `
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
   COTIZACI√ìN ${cotizacion.numero}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìÖ Fecha: ${new Date(cotizacion.fecha).toLocaleDateString('es-ES')}
üìÖ V√°lida hasta: ${new Date(cotizacion.validaHasta).toLocaleDateString('es-ES')}

üë§ CLIENTE
Nombre: ${cotizacion.clienteNombre}
Tel: ${cotizacion.clienteTel || 'N/A'}
Email: ${cotizacion.clienteEmail || 'N/A'}

üìÅ PROYECTO
Nombre: ${cotizacion.proyecto}
Ubicaci√≥n: ${cotizacion.ubicacion || 'N/A'}

üìù L√çNEAS DE COTIZACI√ìN
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
`;
            
            cotizacion.lineas.forEach((linea, index) => {
                detalles += `
${index + 1}. ${linea.descripcion}
   Cantidad: ${linea.cantidad} yd¬≥
   Precio: $${linea.precio.toFixed(2)}/yd¬≥
   Total: $${linea.total.toFixed(2)}
`;
            });
            
            detalles += `
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
TOTAL GENERAL: $${cotizacion.total.toFixed(2)}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
`;
            
            if (cotizacion.notas) {
                detalles += `\nüìÑ NOTAS:\n${cotizacion.notas}`;
            }
            
            alert(detalles);
        }

        async function editCotizacion(id) {
            const cotizacion = await getRecord('cotizaciones', id);
            if (!cotizacion) return;
            
            document.getElementById('edit-cotizacion-id').value = id;
            document.getElementById('cotizacion-numero').value = cotizacion.numero;
            document.getElementById('cotizacion-fecha').value = cotizacion.fecha;
            document.getElementById('cotizacion-valida-hasta').value = cotizacion.validaHasta;
            document.getElementById('cotizacion-status').value = cotizacion.status || 'Pendiente';
            document.getElementById('cotizacion-cliente-nombre').value = cotizacion.clienteNombre;
            document.getElementById('cotizacion-cliente-tel').value = cotizacion.clienteTel || '';
            document.getElementById('cotizacion-cliente-email').value = cotizacion.clienteEmail || '';
            document.getElementById('cotizacion-proyecto').value = cotizacion.proyecto;
            document.getElementById('cotizacion-ubicacion').value = cotizacion.ubicacion || '';
            document.getElementById('cotizacion-notas').value = cotizacion.notas || '';
            
            // Limpiar l√≠neas existentes
            document.getElementById('cotizacion-lineas-body').innerHTML = '';
            lineaCotizacionCounter = 0;
            
            // Agregar l√≠neas guardadas
            cotizacion.lineas.forEach(linea => {
                lineaCotizacionCounter++;
                const tbody = document.getElementById('cotizacion-lineas-body');
                const row = document.createElement('tr');
                row.id = `linea-${lineaCotizacionCounter}`;
                
                row.innerHTML = `
                    <td><input type="text" class="linea-descripcion" value="${linea.descripcion}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></td>
                    <td><input type="number" class="linea-cantidad" step="0.01" min="0" value="${linea.cantidad}" onchange="calcularTotalGeneral()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></td>
                    <td><input type="number" class="linea-precio" step="0.01" min="0" value="${linea.precio}" onchange="calcularTotalGeneral()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></td>
                    <td style="text-align: center;">
                        <button type="button" class="danger" onclick="eliminarLineaCotizacion(${lineaCotizacionCounter})" style="padding: 6px 12px;">üóëÔ∏è</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            calcularTotalGeneral();
            document.getElementById('btn-imprimir-cotizacion').disabled = false;
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function deleteCotizacion(id) {
            if (!confirm('¬øEliminar esta cotizaci√≥n?')) return;
            
            await deleteRecord('cotizaciones', id);
            await loadCotizaciones();
            alert('‚úÖ Cotizaci√≥n eliminada');
        }

        function filterCotizaciones() {
            const searchTerm = document.getElementById('search-cotizaciones').value.toLowerCase();
            const rows = document.querySelectorAll('#lista-cotizaciones table tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        async function imprimirCotizacion() {
            // Recopilar datos del formulario actual
            const tbody = document.getElementById('cotizacion-lineas-body');
            const lineas = [];
            
            tbody.querySelectorAll('tr').forEach(row => {
                const descripcion = row.querySelector('.linea-descripcion').value;
                const cantidad = parseFloat(row.querySelector('.linea-cantidad').value) || 0;
                const precio = parseFloat(row.querySelector('.linea-precio').value) || 0;
                const total = cantidad * precio;
                
                if (descripcion && cantidad > 0) {
                    lineas.push({ descripcion, cantidad, precio, total });
                }
            });
            
            const cotizacion = {
                numero: document.getElementById('cotizacion-numero').value,
                fecha: document.getElementById('cotizacion-fecha').value,
                validaHasta: document.getElementById('cotizacion-valida-hasta').value,
                clienteNombre: document.getElementById('cotizacion-cliente-nombre').value,
                clienteTel: document.getElementById('cotizacion-cliente-tel').value,
                clienteEmail: document.getElementById('cotizacion-cliente-email').value,
                proyecto: document.getElementById('cotizacion-proyecto').value,
                ubicacion: document.getElementById('cotizacion-ubicacion').value,
                lineas: lineas,
                total: lineas.reduce((sum, linea) => sum + linea.total, 0),
                notas: document.getElementById('cotizacion-notas').value
            };
            
            generarPDFCotizacion(cotizacion);
        }

        async function imprimirCotizacionGuardada(id) {
            const cotizacion = await getRecord('cotizaciones', id);
            if (!cotizacion) return;
            
            generarPDFCotizacion(cotizacion);
        }

        async function generarPDFCotizacion(cotizacion) {
            const logo = await obtenerLogo();
            const logoHtml = logo 
                ? `<img src="${logo}" style="max-height: 120px; max-width: 350px;">` 
                : `<div style="background: #16a34a; color: white; padding: 10px 20px; border-radius: 6px; font-weight: bold; font-size: 18px;">MIXTEC PRO</div>`;
            
            const html = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Cotizaci√≥n ${cotizacion.numero}</title>
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; padding: 40px; color: #333; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 3px solid #16a34a; padding-bottom: 20px; }
    .header h1 { color: #16a34a; font-size: 28px; }
    .info-section { margin-bottom: 25px; }
    .info-section h3 { color: #16a34a; margin-bottom: 10px; font-size: 16px; text-transform: uppercase; }
    .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
    .info-item { padding: 10px; background: #f8f9fa; border-radius: 4px; }
    .info-label { font-size: 11px; color: #666; font-weight: bold; text-transform: uppercase; }
    .info-value { font-size: 14px; color: #222; font-weight: 500; margin-top: 3px; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    thead { background: #16a34a; color: white; }
    th { padding: 12px; text-align: left; font-weight: bold; }
    td { padding: 12px; border-bottom: 1px solid #ddd; }
    .total-row { background: #f0fdf4; font-weight: bold; font-size: 18px; }
    .notas { background: #fffbeb; padding: 15px; border-left: 4px solid #f59e0b; margin-top: 20px; }
    .footer { margin-top: 40px; text-align: center; font-size: 12px; color: #666; border-top: 2px solid #ddd; padding-top: 20px; }
    @media print {
        body { padding: 20px; }
        @page { size: letter; margin: 0.5in; }
    }
</style>
</head>
<body>
    <div class="header">
        <div>${logoHtml}</div>
        <div style="text-align: right;">
            <h1>COTIZACI√ìN</h1>
            <p style="font-size: 18px; color: #666; margin-top: 5px;">${cotizacion.numero}</p>
        </div>
    </div>

    <div class="info-section">
        <h3>üìÖ Informaci√≥n de la Cotizaci√≥n</h3>
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Fecha de Emisi√≥n</div>
                <div class="info-value">${new Date(cotizacion.fecha).toLocaleDateString('es-ES', {year: 'numeric', month: 'long', day: 'numeric'})}</div>
            </div>
            <div class="info-item">
                <div class="info-label">V√°lida Hasta</div>
                <div class="info-value">${new Date(cotizacion.validaHasta).toLocaleDateString('es-ES', {year: 'numeric', month: 'long', day: 'numeric'})}</div>
            </div>
        </div>
    </div>

    <div class="info-section">
        <h3>üë§ Informaci√≥n del Cliente</h3>
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Nombre</div>
                <div class="info-value">${cotizacion.clienteNombre}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Tel√©fono</div>
                <div class="info-value">${cotizacion.clienteTel || 'N/A'}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Email</div>
                <div class="info-value">${cotizacion.clienteEmail || 'N/A'}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Proyecto</div>
                <div class="info-value">${cotizacion.proyecto}</div>
            </div>
        </div>
        ${cotizacion.ubicacion ? `<div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
            <div class="info-label">Ubicaci√≥n</div>
            <div class="info-value">${cotizacion.ubicacion}</div>
        </div>` : ''}
    </div>

    <h3 style="color: #16a34a; margin: 25px 0 15px 0;">üìù Detalle de la Cotizaci√≥n</h3>
    <table>
        <thead>
            <tr>
                <th style="width: 60%">Descripci√≥n</th>
                <th style="width: 20%; text-align: center;">Cantidad (yd¬≥)</th>
                <th style="width: 20%; text-align: right;">Precio Unit.</th>
            </tr>
        </thead>
        <tbody>
            ${cotizacion.lineas.map(linea => `
                <tr>
                    <td>${linea.descripcion}</td>
                    <td style="text-align: center;">${linea.cantidad.toFixed(2)}</td>
                    <td style="text-align: right;">$${linea.precio.toFixed(2)}</td>
                </tr>
            `).join('')}
        </tbody>
        <tfoot>
            <tr style="background: #f3f4f6; font-weight: bold;">
                <td style="text-align: right; padding: 15px;">TOTAL YD¬≥:</td>
                <td style="text-align: center; color: #374151; padding: 15px; font-size: 18px;">${cotizacion.lineas.reduce((sum, l) => sum + l.cantidad, 0).toFixed(2)} yd¬≥</td>
                <td></td>
            </tr>
        </tfoot>
    </table>

    ${cotizacion.notas ? `
        <div class="notas">
            <h4 style="color: #92400e; margin-bottom: 8px;">üìÑ Notas y Condiciones</h4>
            <p style="line-height: 1.6; white-space: pre-wrap;">${cotizacion.notas}</p>
        </div>
    ` : ''}

    <div class="footer">
        <p><strong>Gracias por su preferencia</strong></p>
        <p>Documento generado el ${new Date().toLocaleDateString('es-ES')} a las ${new Date().toLocaleTimeString('es-ES')}</p>
    </div>

<scr` + `ipt>
    window.onload = function() {
        setTimeout(() => window.print(), 500);
    };
</scr` + `ipt>
</body>
</html>`;

            const win = window.open('', '_blank');
            if (!win) {
                alert('‚ùå Bloqueador de ventanas emergentes activo');
                return;
            }
            win.document.write(html);
            win.document.close();
        }

        // ============ SCM ‚Äî Materiales Cementicios Suplementarios ============
        // Default GE values by SCM type (ASTM C618, C989, C1240)
        const SCM_GE_DEFAULTS = {
            'Fly Ash Clase F':  2.20,
            'Fly Ash Clase C':  2.65,
            'GGBS / Slag':      2.90,
            'Microsilica':      2.20,
            'Metakaolin':       2.55,
            'Natural Pozzolan': 2.50,
            'Otro':             2.50,
        };

        function actualizarGeSCM(n) {
            const tipo = document.getElementById(`tipo-scm${n}`)?.value;
            const geEl = document.getElementById(`ge-scm${n}`);
            if (tipo && SCM_GE_DEFAULTS[tipo] && geEl) {
                geEl.value = SCM_GE_DEFAULTS[tipo];
            }
            calcularTotalCementicio();
        }

        function calcularTotalCementicio() {
            const pc  = parseFloat(document.getElementById('peso-cemento')?.value) || 0;
            const ps1 = parseFloat(document.getElementById('peso-scm1')?.value)    || 0;
            const ps2 = parseFloat(document.getElementById('peso-scm2')?.value)    || 0;
            const ps3 = parseFloat(document.getElementById('peso-scm3')?.value)    || 0;
            const total = pc + ps1 + ps2 + ps3;
            const agua  = parseFloat(document.getElementById('peso-agua')?.value)  || 0;

            // Update total display
            const dispEl = document.getElementById('total-cementicio-display');
            if (dispEl) dispEl.textContent = total.toFixed(0) + ' lb/yd¬≥';

            // W/C (cement only)
            const wcEl = document.getElementById('wc-ratio');
            if (wcEl) wcEl.value = (pc > 0 ? (agua / pc) : 0).toFixed(3);

            // W/CM (total cementitious)
            const wcmEl = document.getElementById('wcm-ratio');
            if (wcmEl) wcmEl.value = (total > 0 ? (agua / total) : 0).toFixed(3);

            const wcmDisp = document.getElementById('wcm-display');
            if (wcmDisp) wcmDisp.textContent = (total > 0 ? (agua / total) : 0).toFixed(3);

            // % reemplazo
            [1,2,3].forEach(i => {
                const pEl = document.getElementById(`pct-reemplazo-scm${i}`);
                const ps  = parseFloat(document.getElementById(`peso-scm${i}`)?.value) || 0;
                if (pEl) pEl.value = total > 0 ? ((ps / total) * 100).toFixed(1) : '0.0';
            });
        }
        // ============ FIN SCM ============

        function ajustarPorcentajesArenas(cambio) {
            const pct1 = parseFloat(document.getElementById('pct-arena1').value) || 0;
            const pct2 = parseFloat(document.getElementById('pct-arena2').value) || 0;
            
            if (cambio === 1) {
                document.getElementById('pct-arena2').value = Math.max(0, 100 - pct1);
            } else {
                document.getElementById('pct-arena1').value = Math.max(0, 100 - pct2);
            }
            
            calcularModuloFinuraCombinado();
        }

        function calcularModuloFinuraCombinado() {
            const mf1 = parseFloat(document.getElementById('mf-arena1').value) || 0;
            const mf2 = parseFloat(document.getElementById('mf-arena2').value) || 0;
            const pct1 = parseFloat(document.getElementById('pct-arena1').value) || 0;
            const pct2 = parseFloat(document.getElementById('pct-arena2').value) || 0;
            
            const mfCombinado = (mf1 * pct1 + mf2 * pct2) / 100;
            document.getElementById('mf-combinado').textContent = mfCombinado.toFixed(2);
        }

        function calcularVolumenes() {
            try {
                // ============ OBTENER TODOS LOS VALORES ============
                const resistencia = parseFloat(document.getElementById('mix-resistencia').value);
                const slump = parseFloat(document.getElementById('mix-slump').value);
                const tma = parseFloat(document.getElementById('mix-tma').value);
                const contenidoAire = parseFloat(document.getElementById('contenido-aire').value);

                // Cemento
                const pesoCemento = parseFloat(document.getElementById('peso-cemento').value);
                const geCemento = parseFloat(document.getElementById('ge-cemento').value);
                const precioCemento = parseFloat(document.getElementById('precio-cemento').value);

                // SCMs
                const scms = [1,2,3].map(i => ({
                    tipo:   document.getElementById(`tipo-scm${i}`)?.value || '',
                    peso:   parseFloat(document.getElementById(`peso-scm${i}`)?.value)  || 0,
                    ge:     parseFloat(document.getElementById(`ge-scm${i}`)?.value)    || 2.20,
                    precio: parseFloat(document.getElementById(`precio-scm${i}`)?.value) || 0,
                }));

                // Total cementitious
                const totalCementicio = pesoCemento + scms.reduce((s,m) => s + m.peso, 0);

                // Agua
                const pesoAgua = parseFloat(document.getElementById('peso-agua').value);
                const precioAgua = parseFloat(document.getElementById('precio-agua').value);

                // Agregado grueso
                const pesoGrueso = parseFloat(document.getElementById('peso-grueso').value);
                const geGrueso = parseFloat(document.getElementById('ge-grueso').value);
                const absGrueso = parseFloat(document.getElementById('abs-grueso').value) / 100;
                const humGrueso = parseFloat(document.getElementById('hum-grueso').value) / 100;
                const precioGrueso = parseFloat(document.getElementById('precio-grueso').value);

                // Agregado intermedio
                const pesoIntermedio = parseFloat(document.getElementById('peso-intermedio').value);
                const geIntermedio = parseFloat(document.getElementById('ge-intermedio').value);
                const absIntermedio = parseFloat(document.getElementById('abs-intermedio').value) / 100;
                const humIntermedio = parseFloat(document.getElementById('hum-intermedio').value) / 100;
                const precioIntermedio = parseFloat(document.getElementById('precio-intermedio').value);

                // Arena 1
                const geArena1 = parseFloat(document.getElementById('ge-arena1').value);
                const absArena1 = parseFloat(document.getElementById('abs-arena1').value) / 100;
                const humArena1 = parseFloat(document.getElementById('hum-arena1').value) / 100;
                const precioArena1 = parseFloat(document.getElementById('precio-arena1').value);
                const pctArena1 = parseFloat(document.getElementById('pct-arena1').value) / 100;

                // Arena 2
                const geArena2 = parseFloat(document.getElementById('ge-arena2').value);
                const absArena2 = parseFloat(document.getElementById('abs-arena2').value) / 100;
                const humArena2 = parseFloat(document.getElementById('hum-arena2').value) / 100;
                const precioArena2 = parseFloat(document.getElementById('precio-arena2').value);
                const pctArena2 = parseFloat(document.getElementById('pct-arena2').value) / 100;

                // Aditivos
                const dosisAd1 = parseFloat(document.getElementById('dosis-aditivo1').value) || 0;
                const geAd1 = parseFloat(document.getElementById('ge-aditivo1').value);
                const precioAd1 = parseFloat(document.getElementById('precio-aditivo1').value);

                const dosisAd2 = parseFloat(document.getElementById('dosis-aditivo2').value) || 0;
                const geAd2 = parseFloat(document.getElementById('ge-aditivo2').value);
                const precioAd2 = parseFloat(document.getElementById('precio-aditivo2').value);

                const dosisAd3 = parseFloat(document.getElementById('dosis-aditivo3').value) || 0;
                const geAd3 = parseFloat(document.getElementById('ge-aditivo3').value);
                const precioAd3 = parseFloat(document.getElementById('precio-aditivo3').value);

                // ============ C√ÅLCULOS PRINCIPALES ============

                // 1. W/C y W/CM
                const wcRatio  = pesoAgua / pesoCemento;
                const wcmRatio = totalCementicio > 0 ? pesoAgua / totalCementicio : wcRatio;
                document.getElementById('wc-ratio').value  = wcRatio.toFixed(3);
                document.getElementById('wcm-ratio').value = wcmRatio.toFixed(3);

                // 2. Vol√∫menes absolutos
                const volCemento    = pesoCemento / (geCemento * 62.4);
                const volSCMs       = scms.reduce((s, m) => s + (m.peso > 0 ? m.peso / (m.ge * 62.4) : 0), 0);
                const volAgua       = pesoAgua / 62.4;
                const volAire       = (contenidoAire / 100) * 27;
                const volGrueso     = pesoGrueso / (geGrueso * 62.4);
                const volIntermedio = pesoIntermedio / (geIntermedio * 62.4);

                document.getElementById('volumen-aire').value = volAire.toFixed(2);

                // 3. Aditivos
                const pesoAd1 = (dosisAd1 / 16) * (pesoCemento / 100);
                const pesoAd2 = (dosisAd2 / 16) * (pesoCemento / 100);
                const pesoAd3 = (dosisAd3 / 16) * (pesoCemento / 100);
                const volAd1  = pesoAd1 / (geAd1 * 62.4);
                const volAd2  = pesoAd2 / (geAd2 * 62.4);
                const volAd3  = pesoAd3 / (geAd3 * 62.4);

                // 4. Arenas por diferencia de volumen (incluye SCMs)
                const volumenOcupado = volCemento + volSCMs + volAgua + volAire + volGrueso + volIntermedio + volAd1 + volAd2 + volAd3;
                const volArenaTotal  = 27 - volumenOcupado;

                if (volArenaTotal < 0) {
                    throw new Error('El volumen de materiales ingresados excede 27 ft¬≥. Reduce las cantidades.');
                }

                // 5. Pesos de arenas
                const geCombinado  = (geArena1 * pctArena1 + geArena2 * pctArena2);
                const absCombinado = (absArena1 * pctArena1 + absArena2 * pctArena2);
                const humCombinado = (humArena1 * pctArena1 + humArena2 * pctArena2);
                const pesoArenaTotal = volArenaTotal * geCombinado * 62.4;

                const pesoArena1SSD = pesoArenaTotal * pctArena1;
                const pesoArena2SSD = pesoArenaTotal * pctArena2;

                // 6. Ajuste por humedad
                const pesoArena1Humedo    = pesoArena1SSD * (1 + humArena1);
                const pesoArena2Humedo    = pesoArena2SSD * (1 + humArena2);
                const pesoGruesoHumedo    = pesoGrueso * (1 + humGrueso) / (1 + absGrueso);
                const pesoIntermedioHumedo= pesoIntermedio * (1 + humIntermedio) / (1 + absIntermedio);

                // 7. Agua efectiva
                const aguaAbsGrueso     = (pesoGrueso / (1 + absGrueso)) * absGrueso;
                const aguaLibreGrueso   = pesoGrueso * (humGrueso - absGrueso) / (1 + absGrueso);
                const aguaAbsInter      = (pesoIntermedio / (1 + absIntermedio)) * absIntermedio;
                const aguaLibreInter    = pesoIntermedio * (humIntermedio - absIntermedio) / (1 + absIntermedio);
                const aguaAbsArena      = pesoArenaTotal * absCombinado;
                const aguaLibreArena    = (humCombinado - absCombinado) * pesoArenaTotal;
                const aguaEfectiva      = pesoAgua - aguaAbsGrueso - aguaAbsInter - aguaAbsArena + aguaLibreGrueso + aguaLibreInter + aguaLibreArena;

                // ============ COSTOS ============
                const costoCemento    = (pesoCemento / 94) * precioCemento;
                const costoSCMs       = scms.map(m => m.peso > 0 ? (m.peso / 94) * m.precio : 0);
                const costoTotalSCMs  = costoSCMs.reduce((s,c) => s+c, 0);
                const costoAgua       = (aguaEfectiva / 8.34) * precioAgua;
                const costoGrueso     = (pesoGruesoHumedo / 2000) * precioGrueso;
                const costoIntermedio = (pesoIntermedioHumedo / 2000) * precioIntermedio;
                const costoArena1     = (pesoArena1Humedo / 2000) * precioArena1;
                const costoArena2     = (pesoArena2Humedo / 2000) * precioArena2;
                const costoAd1        = (pesoAd1 / 8.34 / geAd1) * precioAd1;
                const costoAd2        = (pesoAd2 / 8.34 / geAd2) * precioAd2;
                const costoAd3        = (pesoAd3 / 8.34 / geAd3) * precioAd3;
                const costoTotal      = costoCemento + costoTotalSCMs + costoAgua + costoGrueso + costoIntermedio + costoArena1 + costoArena2 + costoAd1 + costoAd2 + costoAd3;

                const pesoTotal = pesoCemento + scms.reduce((s,m)=>s+m.peso,0) + aguaEfectiva + pesoGruesoHumedo + pesoIntermedioHumedo + pesoArena1Humedo + pesoArena2Humedo + pesoAd1 + pesoAd2 + pesoAd3;

                // ============ GUARDAR RESULTADOS ============
                currentMixResults = {
                    cemento:     { peso: pesoCemento,          volumen: volCemento,                  costo: costoCemento },
                    scm1:        { peso: scms[0].peso, tipo: scms[0].tipo, volumen: scms[0].peso>0?scms[0].peso/(scms[0].ge*62.4):0, costo: costoSCMs[0] },
                    scm2:        { peso: scms[1].peso, tipo: scms[1].tipo, volumen: scms[1].peso>0?scms[1].peso/(scms[1].ge*62.4):0, costo: costoSCMs[1] },
                    scm3:        { peso: scms[2].peso, tipo: scms[2].tipo, volumen: scms[2].peso>0?scms[2].peso/(scms[2].ge*62.4):0, costo: costoSCMs[2] },
                    totalCementicio,
                    agua:        { peso: aguaEfectiva,         volumen: volAgua,                     costo: costoAgua },
                    grueso:      { peso: pesoGruesoHumedo,     volumen: volGrueso,                   costo: costoGrueso },
                    intermedio:  { peso: pesoIntermedioHumedo, volumen: volIntermedio,               costo: costoIntermedio },
                    arena1:      { peso: pesoArena1Humedo,     volumen: volArenaTotal * pctArena1,   costo: costoArena1 },
                    arena2:      { peso: pesoArena2Humedo,     volumen: volArenaTotal * pctArena2,   costo: costoArena2 },
                    aditivo1:    { peso: pesoAd1, volumen: volAd1, costo: costoAd1, nombre: document.getElementById('nombre-aditivo1').value },
                    aditivo2:    { peso: pesoAd2, volumen: volAd2, costo: costoAd2, nombre: document.getElementById('nombre-aditivo2').value },
                    aditivo3:    { peso: pesoAd3, volumen: volAd3, costo: costoAd3, nombre: document.getElementById('nombre-aditivo3').value },
                    wc:          wcRatio,
                    wcm:         wcmRatio,
                    aire:        contenidoAire,
                    costoTotal,
                    pesoTotal,
                    rendimiento: 27,
                    sacosCemento: pesoCemento / 94,
                    sacosTotalCementicio: totalCementicio / 94,
                    volumenArenas: volArenaTotal
                };

                // Update live SCM display
                calcularTotalCementicio();

                mostrarResultados();
                document.getElementById('btn-mixdesign').disabled = false;
                document.getElementById('btn-reporte').disabled = false;
                document.getElementById('btn-reporte-download').disabled = false;
                document.getElementById('btn-reporte-costos').disabled = false;

            } catch (error) {
                alert('‚ùå Error en el c√°lculo: ' + error.message);
                console.error(error);
            }
        }

        function mostrarResultados() {
            document.getElementById('mix-results').style.display = 'block';
            
            let htmlCantidades = '';

            // Cemento
            htmlCantidades += `<tr style="background:#eff6ff">
                <td><strong>Cemento (${document.getElementById('tipo-cemento')?.value||''})</strong></td>
                <td>${currentMixResults.cemento.peso.toFixed(1)} lb</td>
                <td>${currentMixResults.cemento.volumen.toFixed(3)} ft¬≥</td>
                <td>$${currentMixResults.cemento.costo.toFixed(2)}</td>
            </tr>`;

            // SCMs ‚Äî only if peso > 0
            const scmColors = ['#f5f3ff','#faf5ff','#ede9fe'];
            const scmIcons  = ['üî¨','üè≠','üåæ'];
            [1,2,3].forEach((i,idx) => {
                const s = currentMixResults[`scm${i}`];
                if (s && s.peso > 0 && s.tipo) {
                    const pct = currentMixResults.totalCementicio > 0
                        ? ((s.peso / currentMixResults.totalCementicio)*100).toFixed(1) : '0';
                    htmlCantidades += `<tr style="background:${scmColors[idx]}">
                        <td><strong>${scmIcons[idx]} ${s.tipo}</strong> <span style="font-size:11px;color:#7c3aed;font-weight:600">(SCM ${i} ‚Äî ${pct}% reemplazo)</span></td>
                        <td>${s.peso.toFixed(1)} lb</td>
                        <td>${s.volumen.toFixed(3)} ft¬≥</td>
                        <td>$${s.costo.toFixed(2)}</td>
                    </tr>`;
                }
            });

            // Total cementicio banner (only if any SCM used)
            const hasSCM = [1,2,3].some(i => (currentMixResults[`scm${i}`]?.peso||0) > 0);
            if (hasSCM) {
                const costoSCMs = [1,2,3].reduce((s,i) => s+(currentMixResults[`scm${i}`]?.costo||0), 0);
                htmlCantidades += `<tr style="background:#ddd6fe;font-weight:700">
                    <td style="color:#5b21b6">üìä Total Cementicio (Cemento + SCMs)</td>
                    <td style="color:#5b21b6">${currentMixResults.totalCementicio.toFixed(1)} lb</td>
                    <td style="color:#5b21b6">${(currentMixResults.cemento.volumen + [1,2,3].reduce((s,i)=>s+(currentMixResults[`scm${i}`]?.volumen||0),0)).toFixed(3)} ft¬≥</td>
                    <td style="color:#5b21b6">$${(currentMixResults.cemento.costo + costoSCMs).toFixed(2)}</td>
                </tr>`;
            }

            // Agua
            htmlCantidades += `<tr>
                <td><strong>Agua Efectiva</strong></td>
                <td>${currentMixResults.agua.peso.toFixed(1)} lb</td>
                <td>${currentMixResults.agua.volumen.toFixed(3)} ft¬≥</td>
                <td>$${currentMixResults.agua.costo.toFixed(2)}</td>
            </tr>`;

            // Agregados
            htmlCantidades += `<tr>
                <td><strong>Agregado Grueso</strong></td>
                <td>${currentMixResults.grueso.peso.toFixed(1)} lb</td>
                <td>${currentMixResults.grueso.volumen.toFixed(3)} ft¬≥</td>
                <td>$${currentMixResults.grueso.costo.toFixed(2)}</td>
            </tr>`;

            if (currentMixResults.intermedio.peso > 0) {
                htmlCantidades += `<tr>
                    <td><strong>Agregado Intermedio</strong></td>
                    <td>${currentMixResults.intermedio.peso.toFixed(1)} lb</td>
                    <td>${currentMixResults.intermedio.volumen.toFixed(3)} ft¬≥</td>
                    <td>$${currentMixResults.intermedio.costo.toFixed(2)}</td>
                </tr>`;
            }

            htmlCantidades += `<tr>
                <td><strong>Arena 1</strong></td>
                <td>${currentMixResults.arena1.peso.toFixed(1)} lb</td>
                <td>${currentMixResults.arena1.volumen.toFixed(3)} ft¬≥</td>
                <td>$${currentMixResults.arena1.costo.toFixed(2)}</td>
            </tr>`;

            htmlCantidades += `<tr>
                <td><strong>Arena 2</strong></td>
                <td>${currentMixResults.arena2.peso.toFixed(1)} lb</td>
                <td>${currentMixResults.arena2.volumen.toFixed(3)} ft¬≥</td>
                <td>$${currentMixResults.arena2.costo.toFixed(2)}</td>
            </tr>`;

            // Aditivos
            [1,2,3].forEach(i => {
                const ad = currentMixResults[`aditivo${i}`];
                if (ad?.peso > 0 && ad?.nombre) {
                    const dosis = parseFloat(document.getElementById(`dosis-aditivo${i}`)?.value) || 0;
                    htmlCantidades += `<tr style="background:#fffbeb">
                        <td><strong>${ad.nombre}</strong></td>
                        <td colspan="2" style="color:#92400e;font-style:italic">Rango: 0 to ${dosis.toFixed(2)} oz/cwt</td>
                        <td>$${ad.costo.toFixed(2)}</td>
                    </tr>`;
                }
            });

            document.getElementById('resultados-cantidades').innerHTML = htmlCantidades;

            // Resumen ‚Äî show W/CM when SCM present
            let htmlResumen = `
                <tr><td><strong>Relaci√≥n W/C</strong> <small style="color:#64748b">(solo cemento)</small></td><td>${currentMixResults.wc.toFixed(3)}</td></tr>`;
            if (hasSCM) {
                htmlResumen += `<tr style="background:#f5f3ff"><td><strong style="color:#5b21b6">Relaci√≥n W/CM</strong> <small style="color:#7c3aed">(total cementicio)</small></td><td style="color:#5b21b6;font-weight:700">${(currentMixResults.wcm||currentMixResults.wc).toFixed(3)}</td></tr>`;
                htmlResumen += `<tr style="background:#f5f3ff"><td><strong style="color:#5b21b6">Sacos Totales Cementicio</strong></td><td style="color:#5b21b6">${(currentMixResults.sacosTotalCementicio||currentMixResults.sacosCemento).toFixed(2)}</td></tr>`;
            }
            htmlResumen += `
                <tr><td><strong>Volumen Total Arenas</strong></td><td>${currentMixResults.volumenArenas.toFixed(3)} ft¬≥</td></tr>
                <tr><td><strong>Peso Total</strong></td><td>${currentMixResults.pesoTotal.toFixed(1)} lb/yd¬≥</td></tr>
                <tr><td><strong>Rendimiento</strong></td><td>${currentMixResults.rendimiento.toFixed(2)} ft¬≥</td></tr>
                <tr><td><strong>Sacos de Cemento</strong></td><td>${currentMixResults.sacosCemento.toFixed(2)}</td></tr>
                <tr><td><strong>Costo Total</strong></td><td>$${currentMixResults.costoTotal.toFixed(2)}/yd¬≥</td></tr>
            `;
            document.getElementById('resultados-resumen').innerHTML = htmlResumen;

            // Costos
            const costoAgregados = currentMixResults.grueso.costo + currentMixResults.intermedio.costo + currentMixResults.arena1.costo + currentMixResults.arena2.costo;
            const costoAditivos  = [1,2,3].reduce((s,i) => s+(currentMixResults[`aditivo${i}`]?.costo||0), 0);
            const costoSCMsTotal = [1,2,3].reduce((s,i) => s+(currentMixResults[`scm${i}`]?.costo||0), 0);

            let htmlCostos = `<div class="alert success">
                <div>
                    <strong>üí∞ Costo Total por Yarda C√∫bica: $${currentMixResults.costoTotal.toFixed(2)}</strong><br>
                    <small>Cemento $${currentMixResults.cemento.costo.toFixed(2)}${hasSCM?` | SCMs $${costoSCMsTotal.toFixed(2)}`:''} | Agregados $${costoAgregados.toFixed(2)} | Agua $${currentMixResults.agua.costo.toFixed(2)} | Aditivos $${costoAditivos.toFixed(2)}</small>
                </div>
            </div>`;
            document.getElementById('resultados-costos').innerHTML = htmlCostos;

            window.scrollTo({ top: document.getElementById('mix-results').offsetTop - 20, behavior: 'smooth' });
        }

        document.getElementById('form-mixdesign').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentMixResults) {
                alert('‚ö†Ô∏è Primero debes calcular los vol√∫menes');
                return;
            }

            const mixDesign = {
                nombre: document.getElementById('mix-nombre').value,
                fecha: document.getElementById('mix-fecha').value,
                clienteId: document.getElementById('mix-cliente').value || null,
                proyectoId: document.getElementById('mix-proyecto').value || null,
                proyecto: document.getElementById('mix-proyecto').value,
                resistencia: parseFloat(document.getElementById('mix-resistencia').value),
                slump: parseFloat(document.getElementById('mix-slump').value),
                tma: parseFloat(document.getElementById('mix-tma').value),
                aplicacion: document.getElementById('mix-aplicacion').value,
                
                // Cemento - con peso directo
                tipoCemento: document.getElementById('tipo-cemento').value,
                pesoCemento: parseFloat(document.getElementById('peso-cemento').value),
                geCemento: parseFloat(document.getElementById('ge-cemento').value),
                precioCemento: parseFloat(document.getElementById('precio-cemento').value),

                // SCMs
                tipoSCM1: document.getElementById('tipo-scm1').value,
                pesoSCM1: parseFloat(document.getElementById('peso-scm1').value) || 0,
                geSCM1: parseFloat(document.getElementById('ge-scm1').value),
                precioSCM1: parseFloat(document.getElementById('precio-scm1').value),
                tipoSCM2: document.getElementById('tipo-scm2').value,
                pesoSCM2: parseFloat(document.getElementById('peso-scm2').value) || 0,
                geSCM2: parseFloat(document.getElementById('ge-scm2').value),
                precioSCM2: parseFloat(document.getElementById('precio-scm2').value),
                tipoSCM3: document.getElementById('tipo-scm3').value,
                pesoSCM3: parseFloat(document.getElementById('peso-scm3').value) || 0,
                geSCM3: parseFloat(document.getElementById('ge-scm3').value),
                precioSCM3: parseFloat(document.getElementById('precio-scm3').value),
                
                // Agua - con peso directo
                pesoAgua: parseFloat(document.getElementById('peso-agua').value),
                precioAgua: parseFloat(document.getElementById('precio-agua').value),
                
                // Agregado grueso - con peso directo
                pesoGrueso: parseFloat(document.getElementById('peso-grueso').value),
                geGrueso: parseFloat(document.getElementById('ge-grueso').value),
                absGrueso: parseFloat(document.getElementById('abs-grueso').value),
                humGrueso: parseFloat(document.getElementById('hum-grueso').value),
                precioGrueso: parseFloat(document.getElementById('precio-grueso').value),
                pucGrueso: parseFloat(document.getElementById('puc-grueso').value),
                
                // Agregado intermedio - con peso directo
                pesoIntermedio: parseFloat(document.getElementById('peso-intermedio').value),
                geIntermedio: parseFloat(document.getElementById('ge-intermedio').value),
                absIntermedio: parseFloat(document.getElementById('abs-intermedio').value),
                humIntermedio: parseFloat(document.getElementById('hum-intermedio').value),
                precioIntermedio: parseFloat(document.getElementById('precio-intermedio').value),
                pucIntermedio: parseFloat(document.getElementById('puc-intermedio').value),
                
                // Arenas - calculadas por diferencia
                geArena1: parseFloat(document.getElementById('ge-arena1').value),
                absArena1: parseFloat(document.getElementById('abs-arena1').value),
                humArena1: parseFloat(document.getElementById('hum-arena1').value),
                mfArena1: parseFloat(document.getElementById('mf-arena1').value),
                precioArena1: parseFloat(document.getElementById('precio-arena1').value),
                pctArena1: parseFloat(document.getElementById('pct-arena1').value),
                
                geArena2: parseFloat(document.getElementById('ge-arena2').value),
                absArena2: parseFloat(document.getElementById('abs-arena2').value),
                humArena2: parseFloat(document.getElementById('hum-arena2').value),
                mfArena2: parseFloat(document.getElementById('mf-arena2').value),
                precioArena2: parseFloat(document.getElementById('precio-arena2').value),
                pctArena2: parseFloat(document.getElementById('pct-arena2').value),
                
                mfCombinado: parseFloat(document.getElementById('mf-combinado').textContent),
                
                // Aire
                contenidoAire: parseFloat(document.getElementById('contenido-aire').value),
                
                // Aditivos
                nombreAditivo1: document.getElementById('nombre-aditivo1').value,
                dosisAditivo1: parseFloat(document.getElementById('dosis-aditivo1').value) || 0,
                geAditivo1: parseFloat(document.getElementById('ge-aditivo1').value),
                precioAditivo1: parseFloat(document.getElementById('precio-aditivo1').value),
                
                nombreAditivo2: document.getElementById('nombre-aditivo2').value,
                dosisAditivo2: parseFloat(document.getElementById('dosis-aditivo2').value) || 0,
                geAditivo2: parseFloat(document.getElementById('ge-aditivo2').value),
                precioAditivo2: parseFloat(document.getElementById('precio-aditivo2').value),
                
                nombreAditivo3: document.getElementById('nombre-aditivo3').value,
                dosisAditivo3: parseFloat(document.getElementById('dosis-aditivo3').value) || 0,
                geAditivo3: parseFloat(document.getElementById('ge-aditivo3').value),
                precioAditivo3: parseFloat(document.getElementById('precio-aditivo3').value),
                
                resultados: currentMixResults,
                fechaCreacion: new Date().toISOString()
            };
            
            // Agregar resultados del c√°lculo
            mixDesign.resultados = currentMixResults;
            
            const editId = document.getElementById('edit-mixdesign-id');
            
            try {
                if (editId && editId.value) {
                    // Actualizar existente
                    mixDesign.id = parseInt(editId.value);
                    await updateRecord('mixdesigns', mixDesign);
                    alert('‚úÖ Mix Design actualizado exitosamente');
                } else {
                    // Crear nuevo
                    await addRecord('mixdesigns', mixDesign);
                    alert('‚úÖ Mix Design guardado exitosamente con ID: ' + mixDesign.mixId);
                }
                
                // Limpiar formulario y recargar lista
                clearForm('mixdesign');
                await loadMixDesigns();
                updateDashboard();
                
            } catch (error) {
                console.error('Error al guardar:', error);
                alert('‚ùå Error al guardar: ' + error.message);
            }


            // editId ya declarado arriba

            try {
                if (editId) {
                    mixDesign.id = parseInt(editId);
                    await updateRecord('mixdesigns', mixDesign);
                    alert('‚úÖ Mix Design actualizado');
                } else {
                    await addRecord('mixdesigns', mixDesign);
                document.getElementById('btn-reporte').disabled = false;
                document.getElementById('btn-reporte-download').disabled = false;
                    alert('‚úÖ Mix Design guardado');
                    document.getElementById('btn-reporte').disabled = false;
                document.getElementById('btn-reporte-download').disabled = false;
                }
                clearForm('mixdesign');
                loadMixDesigns();
                updateDashboard();
            } catch (error) {
                alert('‚ùå Error: ' + error);
            }
        });

        async function loadMixDesigns() {
            const mixdesigns = await getAllRecords('mixdesigns');
            const proyectos = await getAllRecords('proyectos');
            const container = document.getElementById('lista-mixdesigns');
            
            if (mixdesigns.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay mix designs</div>';
                return;
            }
            
            let html = '<table><thead><tr><th><input type="checkbox" id="select-all-mixdesigns" onchange="toggleAllMixDesigns(this)"></th><th>Nombre</th><th>Resistencia</th><th>W/C</th><th>Proyecto</th><th>Costo</th><th>Fecha</th><th>Acciones</th></tr></thead><tbody>';
            mixdesigns.forEach(m => {
                const proyecto = proyectos.find(p => p.id == m.proyecto);
                html += `<tr>
                    <td><input type="checkbox" class="mix-checkbox" data-id="${m.id}" onchange="updateSelectedCount()"></td>
                    <td><strong>${m.nombre}</strong></td>
                    <td>${m.resistencia} PSI</td>
                    <td>${m.resultados.wc.toFixed(2)}</td>
                    <td>${proyecto ? proyecto.nombre : '-'}</td>
                    <td>$${m.resultados.costoTotal.toFixed(2)}</td>
                    <td>${new Date(m.fechaCreacion).toLocaleDateString()}</td>
                    <td class="actions">
                        <button class="info" onclick="verMixDesign(${m.id})">Ver</button>
                        <button class="secondary" onclick="editMixDesign(${m.id})">Editar</button>
                        <button class="success" onclick="imprimirMixDesign(${m.id})" title="Imprimir Reporte">üñ®Ô∏è</button>
                        <button class="warning" onclick="generarReporteCostosGuardado(${m.id})" title="Reporte de Costos">üí∞</button>
                        <button class="danger" onclick="deleteMixDesign(${m.id})">Eliminar</button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
            updateSelectedCount();
        }

        // ============ FUNCI√ìN CENTRAL DE REPORTE HTML ============
        // Genera el mismo HTML que el bot√≥n "Reporte" pero recibiendo datos del mix guardado
        async function construirHTMLReporte(mix, clienteNombre, proyectoNombre, logoSrc) {
            const r = mix.resultados;
            const mixId = 'MIX-' + mix.id.toString().padStart(4, '0');
            const wc = r.wc ? r.wc.toFixed(3) : '0.000';
            const aplicacion = mix.aplicacion || '-';

            var html = '<!DOCTYPE html><html><head><meta charset="UTF-8">';
            html += '<title>MIX DESIGN SUBMITTAL - ' + mixId + '</title>';
            html += '<style>';
            html += 'body{font-family:Arial,sans-serif;margin:40px;background:white;color:#333}';
            html += '.logo{width:100%;height:auto;display:flex;align-items:center;justify-content:flex-start;margin:0 0 30px 0;padding:0}';
            html += '.header{text-align:center;border-bottom:3px solid #16a34a;padding-bottom:20px;margin-bottom:30px}';
            html += 'h1{color:#16a34a;font-size:2em;margin:0 0 10px 0}';
            html += 'h2{color:#16a34a;margin-top:30px;font-size:1.5em}';
            html += 'table{width:100%;border-collapse:collapse;margin:20px 0}';
            html += 'th,td{border:1px solid #ddd;padding:12px;text-align:left}';
            html += 'th{background:#16a34a;color:white;font-weight:bold}';
            html += '.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:20px 0}';
            html += '.item{background:#f8f9fa;padding:12px;border-radius:5px;border:1px solid #e0e0e0}';
            html += '.item strong{color:#16a34a}';
            html += '.signature-area{margin-top:50px;padding-top:20px;border-top:2px solid #333}';
            html += '.signature-box{display:inline-block;width:45%;margin:10px 2%}';
            html += '.signature-line{border-bottom:2px solid #333;min-height:60px;margin-bottom:5px;margin-top:30px}';
            html += '.signature-label{text-align:center;color:#666;font-size:14px;font-weight:600}';
            html += '@media print{body{margin:20px}}';
            html += '</style></head><body>';

            // Logo
            html += '<div class="logo">';
            if (logoSrc) {
                html += '<img src="' + logoSrc + '" alt="Logo Empresa" style="max-width:450px;max-height:180px;height:auto">';
            } else {
                html += '<img src="data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'450\' height=\'180\' viewBox=\'0 0 450 180\'%3E%3Crect width=\'450\' height=\'180\' fill=\'%2316a34a\' rx=\'8\'/%3E%3Ctext x=\'90\' y=\'35\' font-family=\'Arial,sans-serif\' font-size=\'20\' font-weight=\'bold\' fill=\'white\' text-anchor=\'middle\'%3EMIXTEC PRO%3C/text%3E%3C/svg%3E" alt="Logo" style="max-width:100%;height:auto">';
            }
            html += '</div>';

            // Header
            html += '<div class="header">';
            html += '<h1>MIX DESIGN SUBMITTAL</h1>';
            html += '<p style="font-size:14px;color:#666;margin:10px 0">Fecha: ' + new Date().toLocaleDateString('es-ES') + '</p>';
            html += '</div>';

            // Info General
            html += '<h2>Informaci√≥n General</h2>';
            html += '<div class="grid">';
            html += '<div class="item"><strong>Mix ID:</strong> ' + mixId + '</div>';
            html += '<div class="item"><strong>Nombre:</strong> ' + mix.nombre + '</div>';
            html += '<div class="item"><strong>Cliente:</strong> ' + clienteNombre + '</div>';
            html += '<div class="item"><strong>Proyecto:</strong> ' + proyectoNombre + '</div>';
            html += '<div class="item"><strong>Resistencia:</strong> ' + mix.resistencia + ' psi</div>';
            html += '<div class="item"><strong>Slump:</strong> ' + mix.slump + ' in</div>';
            html += '<div class="item"><strong>Relaci√≥n a/c:</strong> ' + wc + '</div>';
            html += '<div class="item"><strong>TMA:</strong> ' + mix.tma + ' in</div>';
            html += '<div class="item"><strong>Aplicaci√≥n:</strong> ' + aplicacion + '</div>';
            html += '</div>';

            // Cantidades
            html += '<h2>Cantidades por Yarda C√∫bica (yd¬≥)</h2>';
            html += '<table><thead><tr>';
            html += '<th>Material</th>';
            html += '<th style="text-align:right">Peso (lb/yd¬≥)</th>';
            html += '<th style="text-align:right">Volumen (ft¬≥)</th>';
            html += '<th style="text-align:right">Costo ($/yd¬≥)</th>';
            html += '</tr></thead><tbody>';

            // Cemento
            if (r.cemento && r.cemento.peso) {
                const tipoCem = mix.tipoCemento || '';
                html += '<tr style="background:#eff6ff">';
                html += '<td><strong>Cemento' + (tipoCem ? ' (' + tipoCem + ')' : '') + '</strong></td>';
                html += '<td style="text-align:right">' + r.cemento.peso.toFixed(1) + '</td>';
                html += '<td style="text-align:right">' + r.cemento.volumen.toFixed(3) + '</td>';
                html += '<td style="text-align:right">$' + (r.cemento.costo||0).toFixed(2) + '</td>';
                html += '</tr>';
            }

            // SCMs
            const scmColors1 = ['#f5f3ff','#faf5ff','#ede9fe'];
            const scmIcons1  = ['üî¨','üè≠','üåæ'];
            let hasSCM1 = false;
            [1,2,3].forEach((i,ix) => {
                const s = r['scm'+i];
                if (s && s.peso > 0 && s.tipo) {
                    hasSCM1 = true;
                    const pct = r.totalCementicio > 0 ? ((s.peso/r.totalCementicio)*100).toFixed(1) : '0';
                    html += '<tr style="background:' + scmColors1[ix] + '">';
                    html += '<td><strong>' + scmIcons1[ix] + ' ' + s.tipo + '</strong> <span style="font-size:11px;color:#7c3aed">(SCM '+i+' ‚Äî '+pct+'% reemplazo)</span></td>';
                    html += '<td style="text-align:right">' + s.peso.toFixed(1) + '</td>';
                    html += '<td style="text-align:right">' + s.volumen.toFixed(3) + '</td>';
                    html += '<td style="text-align:right">$' + (s.costo||0).toFixed(2) + '</td>';
                    html += '</tr>';
                }
            });

            // Total cementicio banner
            if (hasSCM1 && r.totalCementicio > 0) {
                const volSCMs1   = [1,2,3].reduce((s,i)=>s+(r['scm'+i]?.volumen||0),0);
                const costoSCMs1 = [1,2,3].reduce((s,i)=>s+(r['scm'+i]?.costo||0),0);
                html += '<tr style="background:#ddd6fe;font-weight:700">';
                html += '<td style="color:#5b21b6">üìä Total Cementicio (Cemento + SCMs)</td>';
                html += '<td style="text-align:right;color:#5b21b6">' + r.totalCementicio.toFixed(1) + '</td>';
                html += '<td style="text-align:right;color:#5b21b6">' + ((r.cemento?.volumen||0)+volSCMs1).toFixed(3) + '</td>';
                html += '<td style="text-align:right;color:#5b21b6">$' + ((r.cemento?.costo||0)+costoSCMs1).toFixed(2) + '</td>';
                html += '</tr>';
            }

            // Agua
            if (r.agua && r.agua.peso) {
                html += '<tr>';
                html += '<td><strong>Agua Efectiva</strong></td>';
                html += '<td style="text-align:right">' + r.agua.peso.toFixed(1) + '</td>';
                html += '<td style="text-align:right">' + r.agua.volumen.toFixed(3) + '</td>';
                html += '<td style="text-align:right">$' + (r.agua.costo||0).toFixed(2) + '</td>';
                html += '</tr>';
            }

            // Agregado Grueso
            if (r.grueso && r.grueso.peso >= 0) {
                html += '<tr>';
                html += '<td><strong>Agregado Grueso</strong></td>';
                html += '<td style="text-align:right">' + r.grueso.peso.toFixed(1) + '</td>';
                html += '<td style="text-align:right">' + r.grueso.volumen.toFixed(3) + '</td>';
                html += '<td style="text-align:right">$' + (r.grueso.costo||0).toFixed(2) + '</td>';
                html += '</tr>';
            }

            // Agregado Intermedio
            if (r.intermedio && r.intermedio.peso > 0) {
                html += '<tr>';
                html += '<td><strong>Agregado Intermedio</strong></td>';
                html += '<td style="text-align:right">' + r.intermedio.peso.toFixed(1) + '</td>';
                html += '<td style="text-align:right">' + r.intermedio.volumen.toFixed(3) + '</td>';
                html += '<td style="text-align:right">$' + (r.intermedio.costo||0).toFixed(2) + '</td>';
                html += '</tr>';
            }

            // Arena 1
            if (r.arena1 && r.arena1.peso > 0) {
                html += '<tr>';
                html += '<td><strong>Arena 1</strong></td>';
                html += '<td style="text-align:right">' + r.arena1.peso.toFixed(1) + '</td>';
                html += '<td style="text-align:right">' + r.arena1.volumen.toFixed(3) + '</td>';
                html += '<td style="text-align:right">$' + (r.arena1.costo||0).toFixed(2) + '</td>';
                html += '</tr>';
            }

            // Arena 2
            if (r.arena2 && r.arena2.peso > 0) {
                html += '<tr>';
                html += '<td><strong>Arena 2</strong></td>';
                html += '<td style="text-align:right">' + r.arena2.peso.toFixed(1) + '</td>';
                html += '<td style="text-align:right">' + r.arena2.volumen.toFixed(3) + '</td>';
                html += '<td style="text-align:right">$' + (r.arena2.costo||0).toFixed(2) + '</td>';
                html += '</tr>';
            }

            // Aditivos
            if (r.aditivo1 && r.aditivo1.peso > 0 && r.aditivo1.nombre && mix.dosisAditivo1 > 0) {
                html += '<tr style="background:#fffbeb">';
                html += '<td><strong>' + r.aditivo1.nombre + '</strong></td>';
                html += '<td colspan="2" style="color:#92400e;font-style:italic">Rango: 0 to ' + mix.dosisAditivo1.toFixed(2) + ' oz/cwt</td>';
                html += '<td style="text-align:right">$' + (r.aditivo1.costo||0).toFixed(2) + '</td>';
                html += '</tr>';
            }
            if (r.aditivo2 && r.aditivo2.peso > 0 && r.aditivo2.nombre && mix.dosisAditivo2 > 0) {
                html += '<tr style="background:#fffbeb">';
                html += '<td><strong>' + r.aditivo2.nombre + '</strong></td>';
                html += '<td colspan="2" style="color:#92400e;font-style:italic">Rango: 0 to ' + mix.dosisAditivo2.toFixed(2) + ' oz/cwt</td>';
                html += '<td style="text-align:right">$' + (r.aditivo2.costo||0).toFixed(2) + '</td>';
                html += '</tr>';
            }
            if (r.aditivo3 && r.aditivo3.peso > 0 && r.aditivo3.nombre && mix.dosisAditivo3 > 0) {
                html += '<tr style="background:#fffbeb">';
                html += '<td><strong>' + r.aditivo3.nombre + '</strong></td>';
                html += '<td colspan="2" style="color:#92400e;font-style:italic">Rango: 0 to ' + mix.dosisAditivo3.toFixed(2) + ' oz/cwt</td>';
                html += '<td style="text-align:right">$' + (r.aditivo3.costo||0).toFixed(2) + '</td>';
                html += '</tr>';
            }

            // Aire
            const aireVol1 = r.volumenAire || ((parseFloat(r.aire||2)/100)*27);
            html += '<tr style="background:#f0fdf4">';
            html += '<td><strong>Aire</strong></td>';
            html += '<td style="text-align:right">‚Äî</td>';
            html += '<td style="text-align:right">' + aireVol1.toFixed(3) + '</td>';
            html += '<td style="text-align:right">‚Äî</td>';
            html += '</tr>';

            // TOTAL
            html += '<tr style="background:#16a34a;color:white;font-weight:700">';
            html += '<td><strong>TOTAL</strong></td>';
            html += '<td style="text-align:right"><strong>' + (r.pesoTotal||0).toFixed(1) + ' lb</strong></td>';
            html += '<td style="text-align:right"><strong>' + (r.rendimiento||27).toFixed(3) + ' ft¬≥</strong></td>';
            html += '<td style="text-align:right"><strong>$' + (r.costoTotal||0).toFixed(2) + '</strong></td>';
            html += '</tr>';

            html += '</tbody></table>';

            // Resumen
            html += '<h2>Resumen</h2>';
            html += '<div class="grid">';
            html += '<div class="item"><strong>Relaci√≥n W/C:</strong> ' + wc + '</div>';
            html += '<div class="item"><strong>Volumen Total Arenas:</strong> ' + (r.volumenArenas ? r.volumenArenas.toFixed(3) : '0.000') + ' ft¬≥</div>';
            html += '<div class="item"><strong>Peso Total:</strong> ' + (r.pesoTotal ? r.pesoTotal.toFixed(1) : '0') + ' lbs/yd¬≥</div>';
            html += '<div class="item"><strong>% Aire:</strong> ' + (r.aire || mix.contenidoAire || '0') + ' %</div>';
            html += '<div class="item"><strong>Rendimiento:</strong> ' + (r.rendimiento || 27) + ' ft¬≥</div>';
            html += '</div>';

            // Firmas
            html += '<div class="signature-area">';
            html += '<div class="signature-box">';
            html += '<div class="signature-line"></div>';
            html += '<div class="signature-label">Firma / Nombre</div>';
            html += '</div>';
            html += '<div class="signature-box">';
            html += '<div class="signature-line"></div>';
            html += '<div class="signature-label">Fecha</div>';
            html += '</div>';
            html += '<div style="clear:both"></div>';
            html += '</div>';

            html += '<p style="margin-top:40px;text-align:center;color:#666;font-size:12px">Generado: ' + new Date().toLocaleString('es-ES') + '</p>';
            html += '</body></html>';

            return html;
        }

        // Obtiene el logo guardado como promesa
        function obtenerLogo() {
            return new Promise((resolve) => {
                try {
                    const transaction = db.transaction(['settings'], 'readonly');
                    const store = transaction.objectStore('settings');
                    const request = store.get('logo');
                    request.onsuccess = () => resolve(request.result ? request.result.value : null);
                    request.onerror = () => resolve(null);
                } catch (e) {
                    resolve(logoEmpresa || null);
                }
            });
        }

        // ============ IMPRIMIR MIX DESIGN INDIVIDUAL ============
        async function imprimirMixDesign(id) {
            const mix = await getRecord('mixdesigns', id);
            if (!mix) { alert('‚ùå No se encontr√≥ el mix design'); return; }

            let clienteNombre = 'N/A';
            let proyectoNombre = 'N/A';

            if (mix.clienteId) {
                const clientes = await getAllRecords('clientes');
                const cliente = clientes.find(c => c.id == mix.clienteId);
                if (cliente) clienteNombre = cliente.nombre;
            }

            if (mix.proyectoId) {
                const proyectos = await getAllRecords('proyectos');
                const proyecto = proyectos.find(p => p.id == mix.proyectoId);
                if (proyecto) proyectoNombre = proyecto.nombre;
            }

            const logo = await obtenerLogo();
            const html = await construirHTMLReporte(mix, clienteNombre, proyectoNombre, logo);

            const win = window.open('', '_blank');
            if (!win) { alert('‚ùå Bloqueador de ventanas emergentes activo.'); return; }
            win.document.write(html);
            win.document.close();
            setTimeout(() => win.print(), 600);
        }

        // ============ GENERAR PDF CON M√öLTIPLES MIX DESIGNS ============
        async function generarPDFMultiple() {
            const selectedIds = getSelectedMixDesignIds();
            if (selectedIds.length === 0) { alert('‚ö†Ô∏è Selecciona al menos un mix design'); return; }

            if (selectedIds.length > 10) {
                if (!confirm(`Has seleccionado ${selectedIds.length} mix designs.\n\n¬øDeseas continuar?`)) return;
            }

            const mixdesigns = await getAllRecords('mixdesigns');
            const clientes   = await getAllRecords('clientes');
            const proyectos  = await getAllRecords('proyectos');
            const logo       = await obtenerLogo();

            const selectedMixes = selectedIds.map(id => mixdesigns.find(m => m.id === id)).filter(Boolean);
            if (selectedMixes.length === 0) { alert('‚ùå No se encontraron los mix designs seleccionados'); return; }

            const logoHtml = logo
                ? `<img src="${logo}" alt="Logo" style="max-height:70px;max-width:260px;width:auto;height:auto;object-fit:contain;">`
                : `<div style="background:#16a34a;color:white;font-weight:bold;font-size:18px;padding:10px 24px;border-radius:6px;">MIXTEC PRO</div>`;

            let pagesHtml = '';

            for (let index = 0; index < selectedMixes.length; index++) {
                const mix = selectedMixes[index];
                const r   = mix.resultados;
                const mixId      = 'MIX-' + mix.id.toString().padStart(4, '0');
                const wc         = r.wc ? r.wc.toFixed(3) : '0.000';
                const aplicacion = mix.aplicacion || '-';
                const clienteNombre  = mix.clienteId  ? (clientes.find(c => c.id == mix.clienteId)?.nombre  || 'N/A') : 'N/A';
                const proyectoNombre = mix.proyectoId ? (proyectos.find(p => p.id == mix.proyectoId)?.nombre || 'N/A') : 'N/A';

                // Materiales rows
                let matsRows = '';
                if (r.cemento   && r.cemento.peso   > 0) matsRows += `<tr><td>Cemento (${mix.tipoCemento || 'I'})</td><td>${r.cemento.peso.toFixed(1)}</td><td>${r.cemento.volumen.toFixed(3)}</td></tr>`;
                if (r.agua      && r.agua.peso       > 0) matsRows += `<tr><td>Agua Efectiva</td><td>${r.agua.peso.toFixed(1)}</td><td>${r.agua.volumen.toFixed(3)}</td></tr>`;
                if (r.grueso    && r.grueso.peso     > 0) matsRows += `<tr><td>Agregado Grueso</td><td>${r.grueso.peso.toFixed(1)}</td><td>${r.grueso.volumen.toFixed(3)}</td></tr>`;
                if (r.intermedio && r.intermedio.peso > 0) matsRows += `<tr><td>Agregado Intermedio</td><td>${r.intermedio.peso.toFixed(1)}</td><td>${r.intermedio.volumen.toFixed(3)}</td></tr>`;
                if (r.arena1    && r.arena1.peso     > 0) matsRows += `<tr><td>Arena 1</td><td>${r.arena1.peso.toFixed(1)}</td><td>${r.arena1.volumen.toFixed(3)}</td></tr>`;
                if (r.arena2    && r.arena2.peso     > 0) matsRows += `<tr><td>Arena 2</td><td>${r.arena2.peso.toFixed(1)}</td><td>${r.arena2.volumen.toFixed(3)}</td></tr>`;
                // Aditivos en formato RANGO
                if (r.aditivo1 && r.aditivo1.nombre && mix.dosisAditivo1 > 0) matsRows += `<tr class="aditivo-row"><td><strong>${r.aditivo1.nombre}</strong></td><td colspan="2">Rango: 0 to ${parseFloat(mix.dosisAditivo1).toFixed(2)} oz/cwt</td></tr>`;
                if (r.aditivo2 && r.aditivo2.nombre && mix.dosisAditivo2 > 0) matsRows += `<tr class="aditivo-row"><td><strong>${r.aditivo2.nombre}</strong></td><td colspan="2">Rango: 0 to ${parseFloat(mix.dosisAditivo2).toFixed(2)} oz/cwt</td></tr>`;
                if (r.aditivo3 && r.aditivo3.nombre && mix.dosisAditivo3 > 0) matsRows += `<tr class="aditivo-row"><td><strong>${r.aditivo3.nombre}</strong></td><td colspan="2">Rango: 0 to ${parseFloat(mix.dosisAditivo3).toFixed(2)} oz/cwt</td></tr>`;

                pagesHtml += `
                <div class="page">

                    <!-- ENCABEZADO con logo en cada p√°gina -->
                    <div class="page-header">
                        <div class="header-left">
                            <div class="doc-title">MIX DESIGN SUBMITTAL</div>
                            <div class="doc-sub">${index + 1} de ${selectedMixes.length} &nbsp;¬∑&nbsp; Generado: ${new Date().toLocaleDateString('es-ES')}</div>
                        </div>
                        <div class="header-right">${logoHtml}</div>
                    </div>

                    <!-- INFO GENERAL -->
                    <div class="section-title">Informaci√≥n General</div>
                    <div class="info-grid">
                        <div class="info-cell"><span class="lbl">Mix ID</span><span class="val">${mixId}</span></div>
                        <div class="info-cell"><span class="lbl">Nombre</span><span class="val">${mix.nombre}</span></div>
                        <div class="info-cell"><span class="lbl">Cliente</span><span class="val">${clienteNombre}</span></div>
                        <div class="info-cell"><span class="lbl">Proyecto</span><span class="val">${proyectoNombre}</span></div>
                        <div class="info-cell"><span class="lbl">Resistencia</span><span class="val green">${mix.resistencia} psi</span></div>
                        <div class="info-cell"><span class="lbl">Slump</span><span class="val">${mix.slump} in</span></div>
                        <div class="info-cell"><span class="lbl">Relaci√≥n a/c</span><span class="val">${wc}</span></div>
                        <div class="info-cell"><span class="lbl">TMA</span><span class="val">${mix.tma} in</span></div>
                        <div class="info-cell"><span class="lbl">% Aire</span><span class="val">${mix.contenidoAire || r.aire || '0'} %</span></div>
                        <div class="info-cell"><span class="lbl">Aplicaci√≥n</span><span class="val">${aplicacion}</span></div>
                    </div>

                    <!-- CANTIDADES -->
                    <div class="section-title">Cantidades por Yarda C√∫bica (yd¬≥)</div>
                    <table>
                        <thead><tr><th>Material</th><th>Peso (lb/yd¬≥)</th><th>Volumen (ft¬≥)</th></tr></thead>
                        <tbody>${matsRows}</tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td><strong>TOTAL</strong></td>
                                <td><strong>${r.pesoTotal ? r.pesoTotal.toFixed(1) : '-'}</strong></td>
                                <td><strong>27.000</strong></td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- FIRMAS -->
                    <div class="signatures">
                        <div class="sig-box"><div class="sig-line"></div><div class="sig-lbl">Preparado por / Fecha</div></div>
                        <div class="sig-box"><div class="sig-line"></div><div class="sig-lbl">Aprobado por / Fecha</div></div>
                    </div>

                </div>`;  // end .page
            }

            const fullHtml = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Mix Designs - Reporte M√∫ltiple</title>
<style>
    /* Reset y base */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, Helvetica, sans-serif; background: #e0e0e0; color: #222; font-size: 11px; }

    /* Cada p√°gina = una hoja */
    .page {
        width: 8.5in;
        min-height: 11in;
        max-height: 11in;
        overflow: hidden;
        background: white;
        margin: 0 auto 20px auto;
        padding: 0.45in 0.5in 0.35in 0.5in;
        display: flex;
        flex-direction: column;
        box-shadow: 0 2px 12px rgba(0,0,0,0.18);
        page-break-after: always;
        page-break-inside: avoid;
        break-after: page;
        break-inside: avoid;
    }
    .page:last-child { page-break-after: avoid; break-after: avoid; margin-bottom: 0; }

    /* Encabezado de cada p√°gina */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 3px solid #16a34a;
        padding-bottom: 10px;
        margin-bottom: 12px;
        flex-shrink: 0;
    }
    .doc-title { font-size: 20px; font-weight: bold; color: #16a34a; letter-spacing: 1px; }
    .doc-sub   { font-size: 10px; color: #666; margin-top: 3px; }
    .header-right { text-align: right; }

    /* T√≠tulos de secci√≥n */
    .section-title {
        background: #16a34a;
        color: white;
        font-weight: bold;
        font-size: 11px;
        padding: 5px 10px;
        margin: 10px 0 6px 0;
        letter-spacing: 0.5px;
        flex-shrink: 0;
    }

    /* Grid de info general */
    .info-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 5px;
        margin-bottom: 4px;
        flex-shrink: 0;
    }
    .info-cell {
        border: 1px solid #ddd;
        border-radius: 3px;
        padding: 5px 7px;
        display: flex;
        flex-direction: column;
    }
    .lbl { font-size: 9px; color: #888; font-weight: bold; text-transform: uppercase; }
    .val { font-size: 12px; font-weight: bold; color: #222; margin-top: 2px; }
    .val.green { color: #16a34a; font-size: 14px; }

    /* Tabla de materiales */
    table {
        width: 100%;
        border-collapse: collapse;
        flex-shrink: 0;
    }
    thead tr { background: #16a34a; }
    th { color: white; font-weight: bold; padding: 7px 10px; text-align: left; font-size: 11px; }
    td { padding: 6px 10px; border-bottom: 1px solid #eee; font-size: 11px; }
    tbody tr:nth-child(even) td { background: #f8fffe; }
    tfoot .total-row td { background: #f0fdf4; border-top: 2px solid #16a34a; padding: 7px 10px; }
    .aditivo-row td { background: #fffbeb; font-style: italic; color: #92400e; border-left: 3px solid #f59e0b; }

    /* Firmas */
    .signatures {
        display: flex;
        gap: 40px;
        margin-top: auto;
        padding-top: 14px;
        border-top: 1px solid #ccc;
        flex-shrink: 0;
    }
    .sig-box { flex: 1; }
    .sig-line { border-bottom: 1.5px solid #333; height: 38px; margin-bottom: 4px; }
    .sig-lbl  { text-align: center; font-size: 10px; color: #555; }

    /* PRINT: ocultar sombras, forzar colores */
    @media print {
        body { background: white !important; }
        .page {
            box-shadow: none !important;
            margin: 0 !important;
            width: 100% !important;
            min-height: 100vh !important;
            max-height: none !important;
            padding: 0.4in 0.45in 0.3in 0.45in !important;
        }
        thead tr { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .section-title { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
</style>
</head>
<body>${pagesHtml}</body>
</html>`;

            const win = window.open('', '_blank');
            if (!win) { alert('‚ùå Bloqueador de ventanas emergentes activo.'); return; }
            win.document.write(fullHtml);
            win.document.close();
            setTimeout(() => win.print(), 800);
        }

        function toggleAllMixDesigns(checkbox) {
            const checkboxes = document.querySelectorAll('.mix-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateSelectedCount();
        }

        function seleccionarTodosMixDesigns() {
            const checkboxes = document.querySelectorAll('.mix-checkbox');
            checkboxes.forEach(cb => cb.checked = true);
            document.getElementById('select-all-mixdesigns').checked = true;
            updateSelectedCount();
        }

        function deseleccionarTodosMixDesigns() {
            const checkboxes = document.querySelectorAll('.mix-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            document.getElementById('select-all-mixdesigns').checked = false;
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const selected = document.querySelectorAll('.mix-checkbox:checked');
            const count = selected.length;
            document.getElementById('count-selected').textContent = count;
            document.getElementById('count-selected-costos').textContent = count;
            document.getElementById('btn-generar-pdf-multiple').disabled = count === 0;
            document.getElementById('btn-generar-costos-multiple').disabled = count === 0;
        }

        function getSelectedMixDesignIds() {
            const selected = document.querySelectorAll('.mix-checkbox:checked');
            return Array.from(selected).map(cb => parseInt(cb.dataset.id));
        }

        // ============ IMPRIMIR MIX DESIGN INDIVIDUAL ============
        async function verMixDesign_PLACEHOLDER() {} // placeholder to maintain structure

        function buildMixPageHTML(mix, clienteNombre, proyectoNombre) {
            const mixId   = 'MIX-' + mix.id.toString().padStart(4, '0');
            const r       = mix.resultados;
            const wc      = r.wc ? r.wc.toFixed(3) : '0.000';
            const aplicacion = mix.aplicacion || '-';

            var h = '';

            // Logo
            h += '<div class="logo">';
            if (logoEmpresa) {
                h += '<img src="' + logoEmpresa + '" alt="Logo Empresa" style="max-width:450px;max-height:180px;height:auto">';
            } else {
                h += '<img src="data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'450\' height=\'180\' viewBox=\'0 0 450 180\'%3E%3Crect width=\'450\' height=\'180\' fill=\'%2316a34a\' rx=\'8\'/%3E%3Ctext x=\'225\' y=\'105\' font-family=\'Arial,sans-serif\' font-size=\'40\' font-weight=\'bold\' fill=\'white\' text-anchor=\'middle\'%3EMIXTEC PRO%3C/text%3E%3C/svg%3E" alt="Logo" style="max-width:450px;max-height:180px">';
            }
            h += '</div>';

            // Header
            h += '<div class="header">';
            h += '<h1>MIX DESIGN SUBMITTAL</h1>';
            h += '<p style="font-size:14px;color:#666;margin:10px 0">Fecha: ' + new Date().toLocaleDateString('es-ES') + '</p>';
            h += '</div>';

            // Informaci√≥n General
            h += '<h2>Informaci√≥n General</h2>';
            h += '<div class="grid">';
            h += '<div class="item"><strong>Mix ID:</strong> ' + mixId + '</div>';
            h += '<div class="item"><strong>Nombre:</strong> ' + mix.nombre + '</div>';
            h += '<div class="item"><strong>Cliente:</strong> ' + clienteNombre + '</div>';
            h += '<div class="item"><strong>Proyecto:</strong> ' + proyectoNombre + '</div>';
            h += '<div class="item"><strong>Resistencia:</strong> ' + mix.resistencia + ' psi</div>';
            h += '<div class="item"><strong>Slump:</strong> ' + mix.slump + ' in</div>';
            h += '<div class="item"><strong>Relaci√≥n a/c:</strong> ' + wc + '</div>';
            h += '<div class="item"><strong>TMA:</strong> ' + mix.tma + ' in</div>';
            h += '<div class="item"><strong>Aplicaci√≥n:</strong> ' + aplicacion + '</div>';
            h += '</div>';

            // Cantidades
            h += '<h2>Cantidades por Yarda C√∫bica (yd¬≥)</h2>';
            h += '<table><thead><tr><th>Material</th><th>Peso (lb/yd¬≥)</th><th>Volumen (ft¬≥)</th></tr></thead><tbody>';

            if (r.cemento && r.cemento.peso)
                h += '<tr><td><strong>Cemento</strong></td><td>' + r.cemento.peso.toFixed(1) + '</td><td>' + r.cemento.volumen.toFixed(3) + '</td></tr>';
            if (r.agua && r.agua.peso)
                h += '<tr><td><strong>Agua</strong></td><td>' + r.agua.peso.toFixed(1) + '</td><td>' + r.agua.volumen.toFixed(3) + '</td></tr>';
            if (r.grueso && r.grueso.peso > 0)
                h += '<tr><td><strong>Agregado Grueso</strong></td><td>' + r.grueso.peso.toFixed(1) + '</td><td>' + r.grueso.volumen.toFixed(3) + '</td></tr>';
            if (r.intermedio && r.intermedio.peso > 0)
                h += '<tr><td><strong>Agregado Intermedio</strong></td><td>' + r.intermedio.peso.toFixed(1) + '</td><td>' + r.intermedio.volumen.toFixed(3) + '</td></tr>';
            if (r.arena1 && r.arena1.peso > 0)
                h += '<tr><td><strong>Arena 1</strong></td><td>' + r.arena1.peso.toFixed(1) + '</td><td>' + r.arena1.volumen.toFixed(3) + '</td></tr>';
            if (r.arena2 && r.arena2.peso > 0)
                h += '<tr><td><strong>Arena 2</strong></td><td>' + r.arena2.peso.toFixed(1) + '</td><td>' + r.arena2.volumen.toFixed(3) + '</td></tr>';

            // Aditivos ‚Äî formato "Rango: 0 to X oz/cwt"
            [1, 2, 3].forEach(n => {
                const ad = r['aditivo' + n];
                const nombre = ad ? ad.nombre : (mix['nombreAditivo' + n] || '');
                const dosis  = parseFloat(mix['dosisAditivo' + n]) || 0;
                if (nombre && dosis > 0) {
                    h += '<tr style="background:#fffbeb"><td><strong>' + nombre + '</strong></td><td colspan="2" style="color:#92400e;font-style:italic">Rango: 0 to ' + dosis.toFixed(2) + ' oz/cwt</td></tr>';
                }
            });

            h += '</tbody></table>';

            // Resumen
            h += '<h2>Resumen</h2>';
            h += '<div class="grid">';
            h += '<div class="item"><strong>Relaci√≥n W/C:</strong> ' + wc + '</div>';
            h += '<div class="item"><strong>Volumen Total Arenas:</strong> ' + (r.volumenArenas ? r.volumenArenas.toFixed(3) : '0.000') + ' ft¬≥</div>';
            h += '<div class="item"><strong>Peso Total:</strong> ' + (r.pesoTotal ? r.pesoTotal.toFixed(1) : '0') + ' lbs/yd¬≥</div>';
            h += '<div class="item"><strong>% Aire:</strong> ' + (r.aire || mix.contenidoAire || '0') + ' %</div>';
            h += '<div class="item"><strong>Rendimiento:</strong> ' + (r.rendimiento || 27) + ' ft¬≥</div>';
            h += '</div>';

            // Firma
            h += '<div class="signature-area">';
            h += '<div class="signature-box"><div class="signature-line"></div><div class="signature-label">Firma / Nombre</div></div>';
            h += '<div class="signature-box"><div class="signature-line"></div><div class="signature-label">Fecha</div></div>';
            h += '<div style="clear:both"></div>';
            h += '</div>';

            h += '<p style="margin-top:40px;text-align:center;color:#666;font-size:12px">Generado: ' + new Date().toLocaleString('es-ES') + '</p>';

            return h;
        }

        async function verMixDesign(id) {
            const mix = await getRecord('mixdesigns', id);
            if (!mix) return;
            
            // Cargar listas primero
            await loadClientesSelect();
            await loadProyectosSelect();
            
            // Cargar valores b√°sicos en el formulario
            document.getElementById('mix-nombre').value = mix.nombre;
            document.getElementById('mix-fecha').value = mix.fecha;
            document.getElementById('mix-resistencia').value = mix.resistencia;
            document.getElementById('mix-slump').value = mix.slump;
            document.getElementById('mix-tma').value = mix.tma;
            document.getElementById('mix-aplicacion').value = mix.aplicacion || '';
            
            // Cargar cliente y proyecto con la secuencia correcta
            if (mix.clienteId) {
                // Si hay cliente, cargar cliente y filtrar proyectos
                document.getElementById('mix-cliente').value = mix.clienteId;
                await filtrarProyectosPorCliente();
                
                // Luego cargar el proyecto (ya filtrado)
                if (mix.proyectoId) {
                    document.getElementById('mix-proyecto').value = mix.proyectoId;
                }
            } else {
                // Si no hay cliente, solo cargar el proyecto de la lista completa
                if (mix.proyectoId) {
                    document.getElementById('mix-proyecto').value = mix.proyectoId;
                }
            }
            
            // Cemento - con peso directo
            document.getElementById('tipo-cemento').value = mix.tipoCemento;
            document.getElementById('peso-cemento').value = mix.pesoCemento || 564;
            document.getElementById('ge-cemento').value = mix.geCemento;
            document.getElementById('precio-cemento').value = mix.precioCemento;

            // SCMs
            [1,2,3].forEach(i => {
                const t = document.getElementById(`tipo-scm${i}`);
                const p = document.getElementById(`peso-scm${i}`);
                const g = document.getElementById(`ge-scm${i}`);
                const pr= document.getElementById(`precio-scm${i}`);
                if (t) t.value   = mix[`tipoSCM${i}`]  || '';
                if (p) p.value   = mix[`pesoSCM${i}`]  || 0;
                if (g) g.value   = mix[`geSCM${i}`]    || SCM_GE_DEFAULTS[mix[`tipoSCM${i}`]] || 2.20;
                if (pr) pr.value = mix[`precioSCM${i}`] || 4.00;
            });
            calcularTotalCementicio();
            
            // Agua - con peso directo
            document.getElementById('peso-agua').value = mix.pesoAgua || 310;
            document.getElementById('precio-agua').value = mix.precioAgua;
            
            // Agregado grueso - con peso directo
            document.getElementById('peso-grueso').value = mix.pesoGrueso || 1800;
            document.getElementById('ge-grueso').value = mix.geGrueso;
            document.getElementById('abs-grueso').value = mix.absGrueso;
            document.getElementById('hum-grueso').value = mix.humGrueso;
            document.getElementById('precio-grueso').value = mix.precioGrueso;
            document.getElementById('puc-grueso').value = mix.pucGrueso;
            
            // Agregado intermedio - con peso directo
            document.getElementById('peso-intermedio').value = mix.pesoIntermedio || 0;
            document.getElementById('ge-intermedio').value = mix.geIntermedio || 2.62;
            document.getElementById('abs-intermedio').value = mix.absIntermedio || 1.8;
            document.getElementById('hum-intermedio').value = mix.humIntermedio || 1.0;
            document.getElementById('precio-intermedio').value = mix.precioIntermedio || 12.00;
            document.getElementById('puc-intermedio').value = mix.pucIntermedio || 100;
            
            // Arenas
            document.getElementById('ge-arena1').value = mix.geArena1;
            document.getElementById('abs-arena1').value = mix.absArena1;
            document.getElementById('hum-arena1').value = mix.humArena1;
            document.getElementById('mf-arena1').value = mix.mfArena1;
            document.getElementById('precio-arena1').value = mix.precioArena1;
            document.getElementById('pct-arena1').value = mix.pctArena1;
            
            document.getElementById('ge-arena2').value = mix.geArena2;
            document.getElementById('abs-arena2').value = mix.absArena2;
            document.getElementById('hum-arena2').value = mix.humArena2;
            document.getElementById('mf-arena2').value = mix.mfArena2;
            document.getElementById('precio-arena2').value = mix.precioArena2;
            document.getElementById('pct-arena2').value = mix.pctArena2;
            
            calcularModuloFinuraCombinado();
            
            // Aire
            document.getElementById('contenido-aire').value = mix.contenidoAire;
            
            // Aditivos
            document.getElementById('nombre-aditivo1').value = mix.nombreAditivo1 || '';
            document.getElementById('dosis-aditivo1').value = mix.dosisAditivo1 || 0;
            document.getElementById('ge-aditivo1').value = mix.geAditivo1;
            document.getElementById('precio-aditivo1').value = mix.precioAditivo1;
            
            document.getElementById('nombre-aditivo2').value = mix.nombreAditivo2 || '';
            document.getElementById('dosis-aditivo2').value = mix.dosisAditivo2 || 0;
            document.getElementById('ge-aditivo2').value = mix.geAditivo2;
            document.getElementById('precio-aditivo2').value = mix.precioAditivo2;
            
            document.getElementById('nombre-aditivo3').value = mix.nombreAditivo3 || '';
            document.getElementById('dosis-aditivo3').value = mix.dosisAditivo3 || 0;
            document.getElementById('ge-aditivo3').value = mix.geAditivo3;
            document.getElementById('precio-aditivo3').value = mix.precioAditivo3;
            
            // Recalcular el mix design con los valores cargados
            calcularMixDesign();
            
            switchTab('mixdesign');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function editMixDesign(id) {
            const mix = await getRecord('mixdesigns', id);
            if (!mix) return;
            
            document.getElementById('edit-mixdesign-id').value = mix.id;
            await verMixDesign(id);
        }

        async function deleteMixDesign(id) {
            if (confirm('¬øEliminar este mix design?')) {
                await deleteRecord('mixdesigns', id);
                loadMixDesigns();
                updateDashboard();
            }
        }

        function filterMixDesigns() {
            const search = document.getElementById('search-mixdesigns').value.toLowerCase();
            document.querySelectorAll('#lista-mixdesigns table tbody tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

                        



        // ============ TRIAL MIXES ============
        
        async function loadMixDesignsSelect() {
            const mixdesigns = await getAllRecords('mixdesigns');
            const select = document.getElementById('trial-mixdesign');
            select.innerHTML = '<option value="">Seleccionar...</option>';
            mixdesigns.forEach(m => {
                select.innerHTML += `<option value="${m.id}">${m.nombre} - ${m.resistencia} PSI</option>`;
            });
        }

        async function generarTrialId() {
            const trials = await getAllRecords('trials');
            const fecha = new Date();
            const a√±o = fecha.getFullYear().toString().substr(-2);
            const mes = String(fecha.getMonth() + 1).padStart(2, '0');
            const numero = String(trials.length + 1).padStart(4, '0');
            return `TM-${a√±o}${mes}-${numero}`;
        }

        async function cargarInfoMixDesign() {
            const mixId = document.getElementById('trial-mixdesign').value;
            if (!mixId) {
                document.getElementById('mix-design-preview').style.display = 'none';
                document.getElementById('trial-cantidades').style.display = 'none';
                return;
            }

            const mix = await getRecord('mixdesigns', parseInt(mixId));
            if (!mix) return;

            document.getElementById('preview-nombre').textContent = mix.nombre;
            document.getElementById('preview-resistencia').textContent = `${mix.resistencia} PSI`;
            document.getElementById('preview-wc').textContent = mix.resultados.wc.toFixed(2);
            document.getElementById('preview-slump').textContent = `${mix.slump} in`;
            
            document.getElementById('mix-design-preview').style.display = 'block';
            
            if (document.getElementById('trial-tamano').value) {
                calcularCantidadesTrial();
            }
        }

        async function calcularCantidadesTrial() {
            const mixId = document.getElementById('trial-mixdesign').value;
            let tamano = document.getElementById('trial-tamano').value;
            
            if (!mixId || !tamano) {
                document.getElementById('trial-cantidades').style.display = 'none';
                return;
            }

            // Mostrar/ocultar campo personalizado
            if (tamano === 'custom') {
                document.getElementById('trial-tamano-custom-group').style.display = 'block';
                tamano = parseFloat(document.getElementById('trial-tamano-custom').value);
                if (!tamano || tamano <= 0) {
                    document.getElementById('trial-cantidades').style.display = 'none';
                    return;
                }
            } else {
                document.getElementById('trial-tamano-custom-group').style.display = 'none';
                tamano = parseFloat(tamano);
            }

            const mix = await getRecord('mixdesigns', parseInt(mixId));
            if (!mix || !mix.resultados) return;

            // Factor de conversi√≥n: tamano est√° en ft¬≥, resultados est√°n por yd¬≥ (27 ft¬≥)
            const factor = tamano / 27;
            
            const r = mix.resultados;
            const hasSCMTrial = [1,2,3].some(i => (r[`scm${i}`]?.peso || 0) > 0 && r[`scm${i}`]?.tipo);

            let html = '';

            // ‚îÄ‚îÄ Cemento Portland ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const tipoCem = mix.tipoCemento || '';
            const sacosT  = (r.cemento.peso * factor) / 94;
            html += `<tr style="background:#eff6ff">
                <td><strong>Cemento${tipoCem ? ' (' + tipoCem + ')' : ''}${hasSCMTrial ? ' (Portland)' : ''}</strong></td>
                <td style="text-align:right">${(r.cemento.peso * factor).toFixed(2)} lb</td>
                <td style="text-align:right;color:#64748b">${sacosT.toFixed(3)} sacos</td>
            </tr>`;

            // ‚îÄ‚îÄ SCMs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const scmBgColors = ['#f5f3ff', '#faf5ff', '#ede9fe'];
            let totalCementicioTrial = r.cemento.peso * factor;
            const scmRows = [];
            [1,2,3].forEach((i, ix) => {
                const s = r[`scm${i}`];
                if (s && s.peso > 0 && s.tipo) {
                    const scmLb   = (s.peso * factor).toFixed(2);
                    const scmSacs = (s.peso * factor / 94).toFixed(3);
                    totalCementicioTrial += s.peso * factor;
                    scmRows.push(`<tr style="background:${scmBgColors[ix]}">
                        <td><strong>${s.tipo}</strong> <span style="font-size:11px;color:#7c3aed">(SCM ${i})</span></td>
                        <td style="text-align:right">${scmLb} lb</td>
                        <td style="text-align:right;color:#64748b">${scmSacs} sacos</td>
                    </tr>`);
                }
            });
            html += scmRows.join('');

            // ‚îÄ‚îÄ Total Cementicio banner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (hasSCMTrial) {
                html += `<tr style="background:#ddd6fe;font-weight:700">
                    <td style="color:#5b21b6">üìä Total Cementicio</td>
                    <td style="text-align:right;color:#5b21b6">${totalCementicioTrial.toFixed(2)} lb</td>
                    <td style="text-align:right;color:#5b21b6">${(totalCementicioTrial/94).toFixed(3)} sacos</td>
                </tr>`;
            }

            // ‚îÄ‚îÄ Agua ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            html += `<tr>
                <td><strong>Agua Efectiva</strong></td>
                <td style="text-align:right">${(r.agua.peso * factor).toFixed(2)} lb</td>
                <td style="text-align:right;color:#64748b">${((r.agua.peso * factor) / 8.34).toFixed(3)} gal</td>
            </tr>`;

            // ‚îÄ‚îÄ Agregado Grueso ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            html += `<tr>
                <td><strong>Agregado Grueso</strong></td>
                <td style="text-align:right">${(r.grueso.peso * factor).toFixed(2)} lb</td>
                <td></td>
            </tr>`;

            // ‚îÄ‚îÄ Agregado Intermedio ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (r.intermedio && r.intermedio.peso > 0) {
                html += `<tr>
                    <td><strong>Agregado Intermedio</strong></td>
                    <td style="text-align:right">${(r.intermedio.peso * factor).toFixed(2)} lb</td>
                    <td></td>
                </tr>`;
            }

            // ‚îÄ‚îÄ Arenas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (r.arena1 && r.arena1.peso > 0) {
                html += `<tr>
                    <td><strong>Arena 1</strong></td>
                    <td style="text-align:right">${(r.arena1.peso * factor).toFixed(2)} lb</td>
                    <td></td>
                </tr>`;
            }
            if (r.arena2 && r.arena2.peso > 0) {
                html += `<tr>
                    <td><strong>Arena 2</strong></td>
                    <td style="text-align:right">${(r.arena2.peso * factor).toFixed(2)} lb</td>
                    <td></td>
                </tr>`;
            }

            // ‚îÄ‚îÄ Aditivos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            [1,2,3].forEach(i => {
                const ad = r[`aditivo${i}`];
                if (ad && ad.peso > 0 && ad.nombre) {
                    const ozVal = (ad.peso * factor * 16).toFixed(2); // lb ‚Üí oz
                    html += `<tr style="background:#fffbeb">
                        <td><strong>${ad.nombre}</strong></td>
                        <td style="text-align:right">${(ad.peso * factor).toFixed(3)} lb</td>
                        <td style="text-align:right;color:#92400e">${ozVal} oz</td>
                    </tr>`;
                }
            });

            // ‚îÄ‚îÄ TOTAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const pesoTotalT = r.pesoTotal ? (r.pesoTotal * factor).toFixed(2) : '‚Äî';
            html += `<tr style="background:#16a34a;color:white;font-weight:700">
                <td><strong>TOTAL BATCH</strong></td>
                <td style="text-align:right"><strong>${pesoTotalT} lb</strong></td>
                <td style="text-align:right;font-size:11px">${tamano} ft¬≥ batch</td>
            </tr>`;
            
            document.getElementById('trial-cantidades-tabla').innerHTML = html;
            document.getElementById('trial-cantidades').style.display = 'block';
        }

        function generarCamposCilindros() {
            const numCilindros = parseInt(document.getElementById('trial-num-cilindros').value) || 0;
            const container = document.getElementById('cilindros-container');
            
            if (numCilindros === 0) {
                container.innerHTML = '';
                return;
            }

            let html = '';
            for (let i = 1; i <= numCilindros; i++) {
                html += `
                    <div class="cylinder-item">
                        <div class="number">${i}</div>
                        <div class="fields">
                            <div class="form-group">
                                <label>D√≠as de Curado</label>
                                <select id="cilindro-${i}-dias" onchange="calcularFechaRotura(${i})">
                                    <option value="7">7 d√≠as</option>
                                    <option value="14">14 d√≠as</option>
                                    <option value="28" selected>28 d√≠as</option>
                                    <option value="56">56 d√≠as</option>
                                    <option value="custom">Personalizado</option>
                                </select>
                            </div>
                            <div class="form-group" id="cilindro-${i}-dias-custom-group" style="display: none;">
                                <label>D√≠as Personalizados</label>
                                <input type="number" id="cilindro-${i}-dias-custom" min="1" onchange="calcularFechaRotura(${i})">
                            </div>
                            <div class="form-group">
                                <label>Fecha de Ensayo <small>(auto-calculada)</small></label>
                                <input type="date" id="cilindro-${i}-fecha" readonly class="calculated">
                            </div>
                            <div class="form-group">
                                <label>Resistencia (PSI)</label>
                                <input type="number" id="cilindro-${i}-resistencia" step="1" placeholder="ej: 3250">
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;

            // Agregar listeners para d√≠as personalizados
            for (let i = 1; i <= numCilindros; i++) {
                document.getElementById(`cilindro-${i}-dias`).addEventListener('change', function() {
                    const customGroup = document.getElementById(`cilindro-${i}-dias-custom-group`);
                    customGroup.style.display = this.value === 'custom' ? 'block' : 'none';
                });
                
                // Calcular fecha inicial
                calcularFechaRotura(i);
            }
        }

        function calcularFechaRotura(cilindroNum) {
            const fechaTrial = document.getElementById('trial-fecha').value;
            if (!fechaTrial) return;
            
            let diasCurado = document.getElementById(`cilindro-${cilindroNum}-dias`).value;
            
            if (diasCurado === 'custom') {
                diasCurado = parseInt(document.getElementById(`cilindro-${cilindroNum}-dias-custom`).value) || 0;
            } else {
                diasCurado = parseInt(diasCurado);
            }
            
            if (diasCurado > 0) {
                const fechaBase = new Date(fechaTrial);
                fechaBase.setDate(fechaBase.getDate() + diasCurado);
                
                // Formatear fecha para input type="date" (YYYY-MM-DD)
                const fechaFormateada = fechaBase.toISOString().split('T')[0];
                document.getElementById(`cilindro-${cilindroNum}-fecha`).value = fechaFormateada;
            }
        }

        
        // ============ REPORTE MIX DESIGN ============
        
        // FUNCI√ìN DE PRUEBA - Reporte simple
        function generarReportePrueba() {
            const html = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Prueba Reporte</title>
    <style>
        body { font-family: Arial; margin: 40px; }
        h1 { color: #16a34a; }
    </style>
</head>
<body>
    <h1>Reporte de Prueba</h1>
    <p>Si ves esto, la funci√≥n de reporte est√° funcionando correctamente.</p>
    <p>Fecha: ${new Date().toLocaleString()}</p>
</body>
</html>`;
            
            const win = window.open('', '_blank');
            if (win) {
                win.document.write(html);
                win.document.close();
                alert('‚úÖ La funci√≥n de reporte funciona correctamente!');
            } else {
                alert('‚ùå Bloqueador de ventanas emergentes activado. Por favor permite ventanas emergentes para este sitio.');
            }
        }

        
        // Funci√≥n para DESCARGAR el reporte como HTML
        async function descargarReporteMixDesign() {
            console.log('Descargando reporte...');
            
            if (!currentMixResults) {
                alert('‚ö†Ô∏è Primero calcula el mix design');
                return;
            }

            try {
                const nombre = document.getElementById('mix-nombre') ? document.getElementById('mix-nombre').value : 'Sin nombre';
                
                
                // Obtener Cliente y Proyecto directamente de los selects
                let clienteNombre = 'N/A';
                let proyectoNombre = 'N/A';
                
                const clienteSelect = document.getElementById('mix-cliente');
                const proyectoSelect = document.getElementById('mix-proyecto');
                
                console.log('Cliente Select:', clienteSelect ? clienteSelect.value : 'no existe');
                console.log('Proyecto Select:', proyectoSelect ? proyectoSelect.value : 'no existe');
                
                // Obtener Cliente
                if (clienteSelect && clienteSelect.value) {
                    const clienteId = parseInt(clienteSelect.value);
                    console.log('Buscando cliente ID:', clienteId);
                    try {
                        const clientes = await getAllRecords('clientes');
                        console.log('Clientes disponibles:', clientes.length);
                        const cliente = clientes.find(c => c.id === clienteId);
                        if (cliente) {
                            clienteNombre = cliente.nombre || 'N/A';
                            console.log('Cliente encontrado:', clienteNombre);
                        } else {
                            console.log('Cliente no encontrado en la lista');
                        }
                    } catch (e) {
                        console.log('Error al obtener cliente:', e);
                    }
                }
                
                console.log('Cliente final:', clienteNombre);
                
                // Obtener Proyecto
                if (proyectoSelect && proyectoSelect.value) {
                    const proyectoId = parseInt(proyectoSelect.value);
                    try {
                        const proyectos = await getAllRecords('proyectos');
                        const proyecto = proyectos.find(p => p.id === proyectoId);
                        if (proyecto) {
                            proyectoNombre = proyecto.nombre || 'N/A';
                        }
                    } catch (e) {
                        console.log('No se pudo obtener proyecto:', e);
                    }
                }
                
                
                
                // Obtener Cliente y Proyecto
                const resistencia = document.getElementById('mix-resistencia') ? document.getElementById('mix-resistencia').value : '0';
                const slump = document.getElementById('mix-slump') ? document.getElementById('mix-slump').value : '0';
                const tma = document.getElementById('mix-tma') ? document.getElementById('mix-tma').value : '0';
                const aplicacion = document.getElementById('mix-aplicacion') ? document.getElementById('mix-aplicacion').value : '-';
                const wc = currentMixResults.wc ? currentMixResults.wc.toFixed(3) : '0.000';
                
                let mixId = 'MIX-0001';
                const mixIdDisplay = document.getElementById('mix-id-display');
                if (mixIdDisplay && mixIdDisplay.value) {
                    mixId = mixIdDisplay.value;
                } else {
                    const timestamp = Date.now().toString().slice(-4);
                    mixId = 'MIX-' + timestamp;
                }
                
                var html = '<!DOCTYPE html><html><head><meta charset="UTF-8">';
                html += '<title>MIX DESIGN SUBMITTAL - ' + mixId + '</title>';
                html += '<style>';
                html += 'body{font-family:Arial,sans-serif;margin:40px;background:white;color:#333}';
                html += '.logo{width:100%;height:auto;display:flex;align-items:center;justify-content:flex-start;margin:0 0 30px 0;padding:0}';
                html += '.header{text-align:center;border-bottom:3px solid #16a34a;padding-bottom:20px;margin-bottom:30px}';
                html += 'h1{color:#16a34a;font-size:2em;margin:0 0 10px 0}';
                html += 'h2{color:#16a34a;margin-top:30px;font-size:1.5em}';
                html += 'table{width:100%;border-collapse:collapse;margin:20px 0}';
                html += 'th,td{border:1px solid #ddd;padding:12px;text-align:left}';
                html += 'th{background:#16a34a;color:white;font-weight:bold}';
                html += '.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:20px 0}';
                html += '.item{background:#f8f9fa;padding:12px;border-radius:5px;border:1px solid #e0e0e0}';
                html += '.item strong{color:#16a34a}';
                html += '.signature-area{margin-top:50px;padding-top:20px;border-top:2px solid #333}';
                html += '.signature-box{display:inline-block;width:45%;margin:10px 2%}';
                html += '.signature-line{border-bottom:2px solid #333;min-height:60px;margin-bottom:5px;margin-top:30px}';
                html += '.signature-label{text-align:center;color:#666;font-size:14px;font-weight:600}';
                html += '@media print{body{margin:20px}}';
                html += '</style></head><body>';
                
                html += '<div class="logo">';
                if (logoEmpresa) {
                    html += '<img src="' + logoEmpresa + '" alt="Logo Empresa" style="max-width:450px;max-height:180px;height:auto">';
                } else {
                    html += '<img src="data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'450\' height=\'180\' viewBox=\'0 0 450 180\'%3E%3Crect width=\'450\' height=\'180\' fill=\'%2316a34a\' rx=\'8\'/%3E%3Ctext x=\'90\' y=\'35\' font-family=\'Arial,sans-serif\' font-size=\'20\' font-weight=\'bold\' fill=\'white\' text-anchor=\'middle\'%3EMIXTEC PRO%3C/text%3E%3C/svg%3E" alt="Logo" style="max-width:100%;height:auto">';
                }
                html += '</div>';
                html += '<div class="header">';
                html += '<h1>MIX DESIGN SUBMITTAL</h1>';
                html += '<p style="font-size:14px;color:#666;margin:10px 0">Fecha: ' + new Date().toLocaleDateString('es-ES') + '</p>';
                html += '</div>';
                
                html += '<h2>Informaci√≥n General</h2>';
                html += '<div class="grid">';
                html += '<div class="item"><strong>Mix ID:</strong> ' + mixId + '</div>';
                html += '<div class="item"><strong>Nombre:</strong> ' + nombre + '</div>';
                html += '<div class="item"><strong>Cliente:</strong> ' + clienteNombre + '</div>';
                html += '<div class="item"><strong>Proyecto:</strong> ' + proyectoNombre + '</div>';
                html += '<div class="item"><strong>Resistencia:</strong> ' + resistencia + ' psi</div>';
                html += '<div class="item"><strong>Slump:</strong> ' + slump + ' in</div>';
                html += '<div class="item"><strong>Relaci√≥n a/c:</strong> ' + wc + '</div>';
                html += '<div class="item"><strong>TMA:</strong> ' + tma + ' in</div>';
                html += '<div class="item"><strong>Aplicaci√≥n:</strong> ' + aplicacion + '</div>';
                html += '</div>';
                
                html += '<h2>Cantidades por Yarda C√∫bica (yd¬≥)</h2>';
                html += '<table><thead><tr>';
                html += '<th>Material</th>';
                html += '<th style="text-align:right">Peso (lb/yd¬≥)</th>';
                html += '<th style="text-align:right">Volumen (ft¬≥)</th>';
                html += '</tr></thead><tbody>';

                // Cemento
                if (currentMixResults.cemento && currentMixResults.cemento.peso) {
                    const tipoCemR = document.getElementById('tipo-cemento')?.value || '';
                    html += '<tr style="background:#eff6ff">';
                    html += '<td><strong>Cemento' + (tipoCemR ? ' (' + tipoCemR + ')' : '') + '</strong></td>';
                    html += '<td style="text-align:right">' + currentMixResults.cemento.peso.toFixed(1) + '</td>';
                    html += '<td style="text-align:right">' + currentMixResults.cemento.volumen.toFixed(3) + '</td>';
                    html += '</tr>';
                }

                // SCMs
                const scmColorsD = ['#f5f3ff','#faf5ff','#ede9fe'];
                let hasSCMD = false;
                [1,2,3].forEach((i,ix) => {
                    const s = currentMixResults['scm'+i];
                    if (s && s.peso > 0 && s.tipo) {
                        hasSCMD = true;
                        const pct = currentMixResults.totalCementicio > 0 ? ((s.peso/currentMixResults.totalCementicio)*100).toFixed(1) : '0';
                        html += '<tr style="background:' + scmColorsD[ix] + '">';
                        html += '<td><strong>' + s.tipo + '</strong> <span style="font-size:11px;color:#7c3aed">(SCM '+i+' ‚Äî '+pct+'% reemplazo)</span></td>';
                        html += '<td style="text-align:right">' + s.peso.toFixed(1) + '</td>';
                        html += '<td style="text-align:right">' + s.volumen.toFixed(3) + '</td>';
                        html += '</tr>';
                    }
                });

                // Total cementicio banner
                if (hasSCMD && currentMixResults.totalCementicio > 0) {
                    const volSCMsD = [1,2,3].reduce((s,i)=>s+(currentMixResults['scm'+i]?.volumen||0),0);
                    html += '<tr style="background:#ddd6fe;font-weight:700">';
                    html += '<td style="color:#5b21b6">Total Cementicio (Cemento + SCMs)</td>';
                    html += '<td style="text-align:right;color:#5b21b6">' + currentMixResults.totalCementicio.toFixed(1) + '</td>';
                    html += '<td style="text-align:right;color:#5b21b6">' + ((currentMixResults.cemento?.volumen||0)+volSCMsD).toFixed(3) + '</td>';
                    html += '</tr>';
                }

                // Agua
                if (currentMixResults.agua && currentMixResults.agua.peso) {
                    html += '<tr>';
                    html += '<td><strong>Agua Efectiva</strong></td>';
                    html += '<td style="text-align:right">' + currentMixResults.agua.peso.toFixed(1) + '</td>';
                    html += '<td style="text-align:right">' + currentMixResults.agua.volumen.toFixed(3) + '</td>';
                    html += '</tr>';
                }

                // Agregado Grueso
                if (currentMixResults.grueso && currentMixResults.grueso.peso >= 0) {
                    html += '<tr>';
                    html += '<td><strong>Agregado Grueso</strong></td>';
                    html += '<td style="text-align:right">' + currentMixResults.grueso.peso.toFixed(1) + '</td>';
                    html += '<td style="text-align:right">' + currentMixResults.grueso.volumen.toFixed(3) + '</td>';
                    html += '</tr>';
                }

                // Agregado Intermedio
                if (currentMixResults.intermedio && currentMixResults.intermedio.peso > 0) {
                    html += '<tr>';
                    html += '<td><strong>Agregado Intermedio</strong></td>';
                    html += '<td style="text-align:right">' + currentMixResults.intermedio.peso.toFixed(1) + '</td>';
                    html += '<td style="text-align:right">' + currentMixResults.intermedio.volumen.toFixed(3) + '</td>';
                    html += '</tr>';
                }

                // Arena 1
                if (currentMixResults.arena1 && currentMixResults.arena1.peso > 0) {
                    html += '<tr>';
                    html += '<td><strong>Arena 1</strong></td>';
                    html += '<td style="text-align:right">' + currentMixResults.arena1.peso.toFixed(1) + '</td>';
                    html += '<td style="text-align:right">' + currentMixResults.arena1.volumen.toFixed(3) + '</td>';
                    html += '</tr>';
                }

                // Arena 2
                if (currentMixResults.arena2 && currentMixResults.arena2.peso > 0) {
                    html += '<tr>';
                    html += '<td><strong>Arena 2</strong></td>';
                    html += '<td style="text-align:right">' + currentMixResults.arena2.peso.toFixed(1) + '</td>';
                    html += '<td style="text-align:right">' + currentMixResults.arena2.volumen.toFixed(3) + '</td>';
                    html += '</tr>';
                }

                // Aditivos
                [1,2,3].forEach(n => {
                    const ad = currentMixResults['aditivo'+n];
                    const dosisEl = document.getElementById('dosis-aditivo'+n);
                    const dosis   = dosisEl ? parseFloat(dosisEl.value)||0 : 0;
                    if (ad && ad.nombre && dosis > 0) {
                        html += '<tr style="background:#fffbeb">';
                        html += '<td><strong>' + ad.nombre + '</strong></td>';
                        html += '<td colspan="2" style="color:#92400e;font-style:italic">Rango: 0 to ' + dosis.toFixed(2) + ' oz/cwt</td>';
                        html += '</tr>';
                    }
                });

                // Aire
                const aireVolD = currentMixResults.volumenAire || ((parseFloat(currentMixResults.aire||2)/100)*27);
                html += '<tr style="background:#f0fdf4">';
                html += '<td><strong>Aire</strong></td>';
                html += '<td style="text-align:right">‚Äî</td>';
                html += '<td style="text-align:right">' + aireVolD.toFixed(3) + '</td>';
                html += '</tr>';

                // TOTAL
                html += '<tr style="background:#16a34a;color:white;font-weight:700">';
                html += '<td><strong>TOTAL</strong></td>';
                html += '<td style="text-align:right"><strong>' + (currentMixResults.pesoTotal||0).toFixed(1) + ' lb</strong></td>';
                html += '<td style="text-align:right"><strong>' + (currentMixResults.rendimiento||27).toFixed(3) + ' ft¬≥</strong></td>';
                html += '</tr>';

                html += '</tbody></table>';
                
                html += '<h2>Resumen</h2>';
                html += '<div class="grid">';
                html += '<div class="item"><strong>Relaci√≥n W/C:</strong> ' + wc + '</div>';
                html += '<div class="item"><strong>Volumen Total Arenas:</strong> ' + (currentMixResults.volumenArenas ? currentMixResults.volumenArenas.toFixed(3) : '0.000') + ' ft¬≥</div>';
                html += '<div class="item"><strong>Peso Total:</strong> ' + (currentMixResults.pesoTotal ? currentMixResults.pesoTotal.toFixed(1) : '0') + ' lbs/yd¬≥</div>';
                html += '<div class="item"><strong>% Aire:</strong> ' + (currentMixResults.aire || '0') + ' %</div>';
                html += '<div class="item"><strong>Rendimiento:</strong> ' + (currentMixResults.rendimiento || 27) + ' ft¬≥</div>';
                html += '</div>';
                
                html += '<div class="signature-area">';
                html += '<div class="signature-box">';
                html += '<div class="signature-line" contenteditable="true"></div>';
                html += '<div class="signature-label">Firma / Nombre</div>';
                html += '</div>';
                html += '<div class="signature-box">';
                html += '<div class="signature-line" contenteditable="true"></div>';
                html += '<div class="signature-label">Fecha</div>';
                html += '</div>';
                html += '<div style="clear:both"></div>';
                html += '</div>';
                
                html += '<p style="margin-top:40px;text-align:center;color:#666;font-size:12px">Generado: ' + new Date().toLocaleString('es-ES') + '</p>';
                html += '</body></html>';
                
                // Crear blob y descargar
                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'MixDesign_' + mixId + '_' + new Date().toISOString().slice(0,10) + '.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('‚úÖ Reporte descargado! Abre el archivo para verlo e imprimirlo.');
                
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error: ' + error.message);
            }
        }

        async function generarReporteMixDesign() {
            console.log('=== INICIO DEBUG ===');
            console.log('currentMixResults:', currentMixResults);
            
            if (!currentMixResults) {
                const debugHtml = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>DEBUG</title></head><body>
                <h1 style="color:red">‚ö†Ô∏è currentMixResults est√° NULL</h1>
                <p>Debes hacer click en "Calcular Vol√∫menes" primero.</p>
                </body></html>`;
                const win = window.open('', '_blank');
                win.document.write(debugHtml);
                win.document.close();
                return;
            }

            try {
                const nombre = document.getElementById('mix-nombre') ? document.getElementById('mix-nombre').value : 'Sin nombre';
                const resistencia = document.getElementById('mix-resistencia') ? document.getElementById('mix-resistencia').value : '0';
                const slump = document.getElementById('mix-slump') ? document.getElementById('mix-slump').value : '0';
                const tma = document.getElementById('mix-tma') ? document.getElementById('mix-tma').value : '0';
                const aplicacion = document.getElementById('mix-aplicacion') ? document.getElementById('mix-aplicacion').value : '-';
                const wc = currentMixResults.wc ? currentMixResults.wc.toFixed(3) : '0.000';
                
                let mixId = 'MIX-0001';
                const mixIdDisplay = document.getElementById('mix-id-display');
                if (mixIdDisplay && mixIdDisplay.value) {
                    mixId = mixIdDisplay.value;
                } else {
                    const timestamp = Date.now().toString().slice(-4);
                    mixId = 'MIX-' + timestamp;
                }
                
                console.log('Generando reporte...');
                
                var html = '<!DOCTYPE html><html><head><meta charset="UTF-8">';
                html += '<title>MIX DESIGN SUBMITTAL</title>';
                html += '<style>';
                html += 'body{font-family:Arial,sans-serif;margin:40px;background:white;color:#333}';
                html += '.logo{width:100%;height:auto;display:flex;align-items:center;justify-content:flex-start;margin:0 0 30px 0;padding:0}';
                html += '.header{text-align:center;border-bottom:3px solid #16a34a;padding-bottom:20px;margin-bottom:30px}';
                html += 'h1{color:#16a34a;font-size:2em;margin:0 0 10px 0}';
                html += 'h2{color:#16a34a;margin-top:30px;font-size:1.5em}';
                html += 'table{width:100%;border-collapse:collapse;margin:20px 0}';
                html += 'th,td{border:1px solid #ddd;padding:12px;text-align:left}';
                html += 'th{background:#16a34a;color:white;font-weight:bold}';
                html += '.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:20px 0}';
                html += '.item{background:#f8f9fa;padding:12px;border-radius:5px;border:1px solid #e0e0e0}';
                html += '.item strong{color:#16a34a}';
                html += '.signature-area{margin-top:50px;padding-top:20px;border-top:2px solid #333}';
                html += '.signature-box{display:inline-block;width:45%;margin:10px 2%}';
                html += '.signature-line{border-bottom:2px solid #333;min-height:60px;margin-bottom:5px;margin-top:30px}';
                html += '.signature-label{text-align:center;color:#666;font-size:14px;font-weight:600}';
                html += '@media print{body{margin:20px}}';
                html += '</style></head><body>';
                
                html += '<div class="logo">';
                if (logoEmpresa) {
                    html += '<img src="' + logoEmpresa + '" alt="Logo Empresa" style="max-width:450px;max-height:180px;height:auto">';
                } else {
                    html += '<img src="data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'450\' height=\'180\' viewBox=\'0 0 450 180\'%3E%3Crect width=\'450\' height=\'180\' fill=\'%2316a34a\' rx=\'8\'/%3E%3Ctext x=\'90\' y=\'35\' font-family=\'Arial,sans-serif\' font-size=\'20\' font-weight=\'bold\' fill=\'white\' text-anchor=\'middle\'%3EMIXTEC PRO%3C/text%3E%3C/svg%3E" alt="Logo" style="max-width:100%;height:auto">';
                }
                html += '</div>';
                html += '<div class="header">';
                html += '<h1>MIX DESIGN SUBMITTAL</h1>';
                html += '<p style="font-size:14px;color:#666;margin:10px 0">Fecha: ' + new Date().toLocaleDateString('es-ES') + '</p>';
                html += '</div>';
                
                html += '<h2>Informaci√≥n General</h2>';
                html += '<div class="grid">';
                html += '<div class="item"><strong>Mix ID:</strong> ' + mixId + '</div>';
                html += '<div class="item"><strong>Nombre:</strong> ' + nombre + '</div>';
                html += '<div class="item"><strong>Cliente:</strong> ' + clienteNombre + '</div>';
                html += '<div class="item"><strong>Proyecto:</strong> ' + proyectoNombre + '</div>';
                html += '<div class="item"><strong>Resistencia:</strong> ' + resistencia + ' psi</div>';
                html += '<div class="item"><strong>Slump:</strong> ' + slump + ' in</div>';
                html += '<div class="item"><strong>Relaci√≥n a/c:</strong> ' + wc + '</div>';
                html += '<div class="item"><strong>TMA:</strong> ' + tma + ' in</div>';
                html += '<div class="item"><strong>Aplicaci√≥n:</strong> ' + aplicacion + '</div>';
                html += '</div>';
                
                html += '<h2>Cantidades por Yarda C√∫bica (yd¬≥)</h2>';
                html += '<table><thead><tr>';
                html += '<th>Material</th>';
                html += '<th style="text-align:right">Peso (lb/yd¬≥)</th>';
                html += '<th style="text-align:right">Volumen (ft¬≥)</th>';
                html += '<th style="text-align:right">Costo ($/yd¬≥)</th>';
                html += '</tr></thead><tbody>';

                // Cemento
                if (currentMixResults.cemento && currentMixResults.cemento.peso) {
                    const tipoCemR = document.getElementById('tipo-cemento')?.value || '';
                    html += '<tr style="background:#eff6ff">';
                    html += '<td><strong>Cemento' + (tipoCemR ? ' (' + tipoCemR + ')' : '') + '</strong></td>';
                    html += '<td style="text-align:right">' + currentMixResults.cemento.peso.toFixed(1) + '</td>';
                    html += '<td style="text-align:right">' + currentMixResults.cemento.volumen.toFixed(3) + '</td>';
                    html += '<td style="text-align:right">$' + (currentMixResults.cemento.costo||0).toFixed(2) + '</td>';
                    html += '</tr>';
                }

                // SCMs
                const scmColorsR = ['#f5f3ff','#faf5ff','#ede9fe'];
                const scmIconsR  = ['\u{1F52C}','\u{1F3ED}','\u{1F33E}'];
                let hasSCMR = false;
                [1,2,3].forEach((i,ix) => {
                    const s = currentMixResults['scm'+i];
                    if (s && s.peso > 0 && s.tipo) {
                        hasSCMR = true;
                        const pct = currentMixResults.totalCementicio > 0 ? ((s.peso/currentMixResults.totalCementicio)*100).toFixed(1) : '0';
                        html += '<tr style="background:' + scmColorsR[ix] + '">';
                        html += '<td><strong>' + s.tipo + '</strong> <span style="font-size:11px;color:#7c3aed">(SCM '+i+' ‚Äî '+pct+'% reemplazo)</span></td>';
                        html += '<td style="text-align:right">' + s.peso.toFixed(1) + '</td>';
                        html += '<td style="text-align:right">' + s.volumen.toFixed(3) + '</td>';
                        html += '<td style="text-align:right">$' + (s.costo||0).toFixed(2) + '</td>';
                        html += '</tr>';
                    }
                });

                // Total cementicio banner
                if (hasSCMR && currentMixResults.totalCementicio > 0) {
                    const volSCMsR   = [1,2,3].reduce((s,i)=>s+(currentMixResults['scm'+i]?.volumen||0),0);
                    const costoSCMsR = [1,2,3].reduce((s,i)=>s+(currentMixResults['scm'+i]?.costo||0),0);
                    html += '<tr style="background:#ddd6fe;font-weight:700">';
                    html += '<td style="color:#5b21b6">Total Cementicio (Cemento + SCMs)</td>';
                    html += '<td style="text-align:right;color:#5b21b6">' + currentMixResults.totalCementicio.toFixed(1) + '</td>';
                    html += '<td style="text-align:right;color:#5b21b6">' + ((currentMixResults.cemento?.volumen||0)+volSCMsR).toFixed(3) + '</td>';
                    html += '<td style="text-align:right;color:#5b21b6">$' + ((currentMixResults.cemento?.costo||0)+costoSCMsR).toFixed(2) + '</td>';
                    html += '</tr>';
                }

                // Agua
                if (currentMixResults.agua && currentMixResults.agua.peso) {
                    html += '<tr>';
                    html += '<td><strong>Agua Efectiva</strong></td>';
                    html += '<td style="text-align:right">' + currentMixResults.agua.peso.toFixed(1) + '</td>';
                    html += '<td style="text-align:right">' + currentMixResults.agua.volumen.toFixed(3) + '</td>';
                    html += '<td style="text-align:right">$' + (currentMixResults.agua.costo||0).toFixed(2) + '</td>';
                    html += '</tr>';
                }

                // Agregado Grueso
                if (currentMixResults.grueso && currentMixResults.grueso.peso >= 0) {
                    html += '<tr>';
                    html += '<td><strong>Agregado Grueso</strong></td>';
                    html += '<td style="text-align:right">' + currentMixResults.grueso.peso.toFixed(1) + '</td>';
                    html += '<td style="text-align:right">' + currentMixResults.grueso.volumen.toFixed(3) + '</td>';
                    html += '<td style="text-align:right">$' + (currentMixResults.grueso.costo||0).toFixed(2) + '</td>';
                    html += '</tr>';
                }

                // Agregado Intermedio
                if (currentMixResults.intermedio && currentMixResults.intermedio.peso > 0) {
                    html += '<tr>';
                    html += '<td><strong>Agregado Intermedio</strong></td>';
                    html += '<td style="text-align:right">' + currentMixResults.intermedio.peso.toFixed(1) + '</td>';
                    html += '<td style="text-align:right">' + currentMixResults.intermedio.volumen.toFixed(3) + '</td>';
                    html += '<td style="text-align:right">$' + (currentMixResults.intermedio.costo||0).toFixed(2) + '</td>';
                    html += '</tr>';
                }

                // Arena 1
                if (currentMixResults.arena1 && currentMixResults.arena1.peso > 0) {
                    html += '<tr>';
                    html += '<td><strong>Arena 1</strong></td>';
                    html += '<td style="text-align:right">' + currentMixResults.arena1.peso.toFixed(1) + '</td>';
                    html += '<td style="text-align:right">' + currentMixResults.arena1.volumen.toFixed(3) + '</td>';
                    html += '<td style="text-align:right">$' + (currentMixResults.arena1.costo||0).toFixed(2) + '</td>';
                    html += '</tr>';
                }

                // Arena 2
                if (currentMixResults.arena2 && currentMixResults.arena2.peso > 0) {
                    html += '<tr>';
                    html += '<td><strong>Arena 2</strong></td>';
                    html += '<td style="text-align:right">' + currentMixResults.arena2.peso.toFixed(1) + '</td>';
                    html += '<td style="text-align:right">' + currentMixResults.arena2.volumen.toFixed(3) + '</td>';
                    html += '<td style="text-align:right">$' + (currentMixResults.arena2.costo||0).toFixed(2) + '</td>';
                    html += '</tr>';
                }

                // Aditivos
                [1,2,3].forEach(n => {
                    const ad = currentMixResults['aditivo'+n];
                    const dosisEl = document.getElementById('dosis-aditivo'+n);
                    const dosis   = dosisEl ? parseFloat(dosisEl.value)||0 : 0;
                    if (ad && ad.nombre && dosis > 0) {
                        html += '<tr style="background:#fffbeb">';
                        html += '<td><strong>' + ad.nombre + '</strong></td>';
                        html += '<td colspan="2" style="color:#92400e;font-style:italic">Rango: 0 to ' + dosis.toFixed(2) + ' oz/cwt</td>';
                        html += '<td style="text-align:right">$' + (ad.costo||0).toFixed(2) + '</td>';
                        html += '</tr>';
                    }
                });

                // Aire
                const aireVolR = currentMixResults.volumenAire || ((parseFloat(currentMixResults.aire||2)/100)*27);
                html += '<tr style="background:#f0fdf4">';
                html += '<td><strong>Aire</strong></td>';
                html += '<td style="text-align:right">‚Äî</td>';
                html += '<td style="text-align:right">' + aireVolR.toFixed(3) + '</td>';
                html += '<td style="text-align:right">‚Äî</td>';
                html += '</tr>';

                // TOTAL
                html += '<tr style="background:#16a34a;color:white;font-weight:700">';
                html += '<td><strong>TOTAL</strong></td>';
                html += '<td style="text-align:right"><strong>' + (currentMixResults.pesoTotal||0).toFixed(1) + ' lb</strong></td>';
                html += '<td style="text-align:right"><strong>' + (currentMixResults.rendimiento||27).toFixed(3) + ' ft¬≥</strong></td>';
                html += '<td style="text-align:right"><strong>$' + (currentMixResults.costoTotal||0).toFixed(2) + '</strong></td>';
                html += '</tr>';

                html += '</tbody></table>';
                
                // Resumen actualizado
                html += '<h2>Resumen</h2>';
                html += '<div class="grid">';
                html += '<div class="item"><strong>Relaci√≥n W/C:</strong> ' + wc + '</div>';
                html += '<div class="item"><strong>Volumen Total Arenas:</strong> ' + (currentMixResults.volumenArenas ? currentMixResults.volumenArenas.toFixed(3) : '0.000') + ' ft¬≥</div>';
                html += '<div class="item"><strong>Peso Total:</strong> ' + (currentMixResults.pesoTotal ? currentMixResults.pesoTotal.toFixed(1) : '0') + ' lbs/yd¬≥</div>';
                html += '<div class="item"><strong>% Aire:</strong> ' + (currentMixResults.aire || '2.0') + ' %</div>';
                html += '<div class="item"><strong>Rendimiento:</strong> ' + (currentMixResults.rendimiento || 27) + ' ft¬≥</div>';
                html += '</div>';
                
                html += '<div class="signature-area">';
                html += '<div class="signature-box">';
                html += '<div class="signature-line" contenteditable="true"></div>';
                html += '<div class="signature-label">Firma / Nombre</div>';
                html += '</div>';
                html += '<div class="signature-box">';
                html += '<div class="signature-line" contenteditable="true"></div>';
                html += '<div class="signature-label">Fecha</div>';
                html += '</div>';
                html += '<div style="clear:both"></div>';
                html += '</div>';
                
                html += '<p style="margin-top:40px;text-align:center;color:#666;font-size:12px">Generado: ' + new Date().toLocaleString('es-ES') + '</p>';
                html += '</body></html>';
                
                console.log('Abriendo ventana...');
                
                const win = window.open('', '_blank');
                
                if (!win) {
                    alert('‚ùå Bloqueador de ventanas emergentes.');
                    return;
                }
                
                win.document.open();
                win.document.write(html);
                win.document.close();
                
                console.log('‚úÖ Reporte generado!');
                console.log('=== FIN DEBUG ===');
                
            } catch (error) {
                console.error('‚ùå ERROR:', error);
                alert('‚ùå Error: ' + error.message);
            }
        }

        // ============ FUNCI√ìN AUXILIAR: EXTRAER COLOR DOMINANTE DEL LOGO ============
        async function extraerColorDominanteDelLogo() {
            try {
                const logo = await obtenerLogo();
                if (!logo) return '#f59e0b'; // Color por defecto (naranja)
                
                return new Promise((resolve) => {
                    const img = new Image();
                    img.crossOrigin = 'Anonymous';
                    
                    img.onload = function() {
                        try {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            ctx.drawImage(img, 0, 0);
                            
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const data = imageData.data;
                            
                            let r = 0, g = 0, b = 0, count = 0;
                            
                            // Muestrear cada 10 p√≠xeles para optimizar
                            for (let i = 0; i < data.length; i += 40) {
                                const red = data[i];
                                const green = data[i + 1];
                                const blue = data[i + 2];
                                const alpha = data[i + 3];
                                
                                // Ignorar p√≠xeles muy claros (blancos) o transparentes
                                if (alpha > 100 && (red < 240 || green < 240 || blue < 240)) {
                                    r += red;
                                    g += green;
                                    b += blue;
                                    count++;
                                }
                            }
                            
                            if (count > 0) {
                                r = Math.round(r / count);
                                g = Math.round(g / count);
                                b = Math.round(b / count);
                                resolve(`rgb(${r}, ${g}, ${b})`);
                            } else {
                                resolve('#f59e0b');
                            }
                        } catch (e) {
                            console.error('Error extrayendo color:', e);
                            resolve('#f59e0b');
                        }
                    };
                    
                    img.onerror = () => resolve('#f59e0b');
                    img.src = logo;
                });
            } catch (e) {
                console.error('Error en extraerColorDominanteDelLogo:', e);
                return '#f59e0b';
            }
        }

        // ============ GENERAR REPORTE DE COSTOS (desde formulario actual) ============
        async function generarReporteCostosMix() {
            console.log('üîç Iniciando generarReporteCostosMix...');
            
            if (!currentMixResults) { 
                alert('‚ö†Ô∏è Debes calcular los vol√∫menes primero'); 
                return; 
            }

            try {
                const mix = {
                    nombre: document.getElementById('mix-nombre').value || 'Sin nombre',
                    fecha: document.getElementById('mix-fecha').value,
                    clienteId: parseInt(document.getElementById('mix-cliente').value) || null,
                    proyectoId: parseInt(document.getElementById('mix-proyecto').value) || null,
                    resistencia: parseFloat(document.getElementById('mix-resistencia').value),
                    slump: parseFloat(document.getElementById('mix-slump').value),
                    tipoCemento: document.getElementById('tipo-cemento').value,
                    resultados: currentMixResults,
                    dosisAditivo1: parseFloat(document.getElementById('dosis-aditivo1').value) || 0,
                    dosisAditivo2: parseFloat(document.getElementById('dosis-aditivo2').value) || 0,
                    dosisAditivo3: parseFloat(document.getElementById('dosis-aditivo3').value) || 0,
                    precioCemento: parseFloat(document.getElementById('precio-cemento').value) || 0,
                    precioAgua: parseFloat(document.getElementById('precio-agua').value) || 0,
                    precioGrueso: parseFloat(document.getElementById('precio-grueso').value) || 0,
                    precioIntermedio: parseFloat(document.getElementById('precio-intermedio').value) || 0,
                    precioArena1: parseFloat(document.getElementById('precio-arena1').value) || 0,
                    precioArena2: parseFloat(document.getElementById('precio-arena2').value) || 0,
                    precioAditivo1: parseFloat(document.getElementById('precio-aditivo1').value) || 0,
                    precioAditivo2: parseFloat(document.getElementById('precio-aditivo2').value) || 0,
                    precioAditivo3: parseFloat(document.getElementById('precio-aditivo3').value) || 0,
                };

                console.log('üì¶ Mix data:', mix);

                let clienteNombre = 'N/A';
                let proyectoNombre = 'N/A';
                if (mix.clienteId) { 
                    const c = await getRecord('clientes', mix.clienteId); 
                    if (c) clienteNombre = c.nombre; 
                }
                if (mix.proyectoId) { 
                    const p = await getRecord('proyectos', mix.proyectoId); 
                    if (p) proyectoNombre = p.nombre; 
                }

                console.log('üë• Cliente:', clienteNombre, 'Proyecto:', proyectoNombre);

                await generarHTMLReporteCostos(mix, clienteNombre, proyectoNombre);
                console.log('‚úÖ Reporte generado exitosamente');
            } catch (error) {
                console.error('‚ùå Error en generarReporteCostosMix:', error);
                alert('‚ùå Error al generar reporte: ' + error.message);
            }
        }

        // ============ GENERAR REPORTE DE COSTOS (desde mix guardado) ============
        async function generarReporteCostosGuardado(mixId) {
            console.log('üîç Iniciando generarReporteCostosGuardado con ID:', mixId);
            
            try {
                const mix = await getRecord('mixdesigns', mixId);
                if (!mix) {
                    alert('‚ùå No se encontr√≥ el mix design');
                    return;
                }

                console.log('üì¶ Mix cargado:', mix);

                let clienteNombre = 'N/A';
                let proyectoNombre = 'N/A';
                
                if (mix.clienteId) {
                    const c = await getRecord('clientes', mix.clienteId);
                    if (c) clienteNombre = c.nombre;
                }
                if (mix.proyectoId) {
                    const p = await getRecord('proyectos', mix.proyectoId);
                    if (p) proyectoNombre = p.nombre;
                }

                console.log('üë• Cliente:', clienteNombre, 'Proyecto:', proyectoNombre);

                await generarHTMLReporteCostos(mix, clienteNombre, proyectoNombre);
                console.log('‚úÖ Reporte generado exitosamente');
            } catch (error) {
                console.error('‚ùå Error en generarReporteCostosGuardado:', error);
                alert('‚ùå Error al generar reporte: ' + error.message);
            }
        }

        // ============ GENERAR REPORTES DE COSTOS M√öLTIPLES ============
        async function generarReportesCostosMultiple() {
            console.log('üîç Iniciando generaci√≥n de reportes m√∫ltiples...');
            
            const selectedIds = getSelectedMixDesignIds();
            console.log('üìã IDs seleccionados:', selectedIds);
            
            if (selectedIds.length === 0) {
                alert('‚ö†Ô∏è Selecciona al menos un mix design');
                return;
            }

            if (selectedIds.length > 10) {
                if (!confirm(`Has seleccionado ${selectedIds.length} mix designs.\n\n¬øDeseas continuar?`)) return;
            }

            try {
                const mixdesigns = await getAllRecords('mixdesigns');
                const clientes = await getAllRecords('clientes');
                const proyectos = await getAllRecords('proyectos');

                console.log(`üì¶ Total mix designs en DB: ${mixdesigns.length}`);

                const selectedMixes = selectedIds.map(id => mixdesigns.find(m => m.id === id)).filter(Boolean);
                console.log(`‚úÖ Mix designs encontrados: ${selectedMixes.length}`);
                
                if (selectedMixes.length === 0) {
                    alert('‚ùå No se encontraron los mix designs seleccionados');
                    return;
                }

                // Generar todos los reportes sin esperar entre ellos
                for (let i = 0; i < selectedMixes.length; i++) {
                    const mix = selectedMixes[i];
                    console.log(`üìÑ Generando reporte ${i + 1}/${selectedMixes.length} - Mix ID: ${mix.id}`);
                    
                    const clienteNombre = mix.clienteId ? (clientes.find(c => c.id == mix.clienteId)?.nombre || 'N/A') : 'N/A';
                    const proyectoNombre = mix.proyectoId ? (proyectos.find(p => p.id == mix.proyectoId)?.nombre || 'N/A') : 'N/A';
                    
                    // Usar setTimeout para abrir ventanas en secuencia sin bloquear
                    setTimeout(() => {
                        generarHTMLReporteCostos(mix, clienteNombre, proyectoNombre);
                    }, i * 500); // 500ms entre cada ventana
                }
                
                console.log(`‚úÖ Se abrir√°n ${selectedMixes.length} ventanas de reportes`);
                
            } catch (error) {
                console.error('‚ùå Error en generarReportesCostosMultiple:', error);
                alert('‚ùå Error al generar reportes: ' + error.message);
            }
        }

        // ============ FUNCIONES AUXILIARES PARA COLORES ============
        function hexToRgbHelper(color) {
            if (color.startsWith('rgb')) {
                return color.match(/\d+/g).join(', ');
            }
            const hex = color.replace('#', '');
            const r = parseInt(hex.substr(0, 2), 16);
            const g = parseInt(hex.substr(2, 2), 16);
            const b = parseInt(hex.substr(4, 2), 16);
            return r + ', ' + g + ', ' + b;
        }
        
        function rgbToHslHelper(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            
            if (max === min) {
                h = s = 0;
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                    case g: h = ((b - r) / d + 2) / 6; break;
                    case b: h = ((r - g) / d + 4) / 6; break;
                }
            }
            return [h * 360, s, l];
        }
        
        function adjustColorHelper(color, adjustment) {
            if (color.startsWith('rgb')) {
                const values = color.match(/\d+/g).map(Number);
                const h = rgbToHslHelper(values[0], values[1], values[2])[0];
                const newH = (h + adjustment) % 360;
                return `hsl(${newH}, 60%, 50%)`;
            }
            return color;
        }

        // ============ FUNCI√ìN PARA GENERAR SVG DEL GR√ÅFICO DE PIE ============
        function generatePieChartSVG(data) {
            let cumulativePercent = 0;
            let paths = '';
            
            data.forEach((item) => {
                if (item.value > 0) {
                    const startAngle = cumulativePercent * 2 * Math.PI;
                    cumulativePercent += item.value / 100;
                    const endAngle = cumulativePercent * 2 * Math.PI;
                    
                    const startX = 100 + 90 * Math.cos(startAngle - Math.PI / 2);
                    const startY = 100 + 90 * Math.sin(startAngle - Math.PI / 2);
                    const endX = 100 + 90 * Math.cos(endAngle - Math.PI / 2);
                    const endY = 100 + 90 * Math.sin(endAngle - Math.PI / 2);
                    
                    const largeArcFlag = item.value > 50 ? 1 : 0;
                    
                    const pathData = [
                        `M 100 100`,
                        `L ${startX} ${startY}`,
                        `A 90 90 0 ${largeArcFlag} 1 ${endX} ${endY}`,
                        'Z'
                    ].join(' ');
                    
                    paths += `<path d="${pathData}" fill="${item.color}" stroke="white" stroke-width="2"/>`;
                }
            });
            
            return paths;
        }

        // ============ FUNCI√ìN PRINCIPAL: GENERAR HTML REPORTE DE COSTOS ============
        async function generarHTMLReporteCostos(mix, clienteNombre, proyectoNombre) {
            console.log('üé® Generando HTML reporte de costos...');
            
            try {
                const logo = await obtenerLogo();
                console.log('üñºÔ∏è Logo obtenido');
                
                const colorPrincipal = await extraerColorDominanteDelLogo();
                console.log('üé® Color principal:', colorPrincipal);
                
                const r = mix.resultados;
                
                if (!r) {
                    throw new Error('No hay resultados en el mix design');
                }

                // Calcular costos totales por categor√≠a
                const costoAgregados = (r.grueso?.costo || 0) + (r.intermedio?.costo || 0) + 
                                       (r.arena1?.costo || 0) + (r.arena2?.costo || 0);
                const costoAditivos = (r.aditivo1?.costo || 0) + (r.aditivo2?.costo || 0) + 
                                      (r.aditivo3?.costo || 0);
                const costoSCMs = (r.scm1?.costo || 0) + (r.scm2?.costo || 0) + (r.scm3?.costo || 0);

                // Calcular porcentajes
                const pctCemento = ((r.cemento?.costo || 0) / r.costoTotal * 100);
                const pctAgua = ((r.agua?.costo || 0) / r.costoTotal * 100);
                const pctAgregados = (costoAgregados / r.costoTotal * 100);
                const pctAditivos = (costoAditivos / r.costoTotal * 100);
                const pctSCMs = (costoSCMs / r.costoTotal * 100);

                console.log('üí∞ Costos calculados - Cemento:', pctCemento, 'Agregados:', pctAgregados, 'SCMs:', pctSCMs);

                const logoHtml = logo 
                    ? `<img src="${logo}" alt="Logo" style="max-height:70px;max-width:200px;object-fit:contain;">` 
                    : `<div style="background:${colorPrincipal};color:white;font-weight:bold;padding:8px 20px;border-radius:6px;">MIXTEC PRO</div>`;

                // Calcular RGB para usar en el CSS
                const colorRgb = hexToRgbHelper(colorPrincipal);

                // Datos para el gr√°fico de pie ‚Äî includes individual SCMs
                const hasSCMCosto = (r.scm1?.peso > 0 && r.scm1?.tipo) || 
                                    (r.scm2?.peso > 0 && r.scm2?.tipo) || 
                                    (r.scm3?.peso > 0 && r.scm3?.tipo);

                const chartData = [];
                // Cemento (portland only, labeled accordingly)
                if ((r.cemento?.costo || 0) > 0) {
                    chartData.push({ 
                        label: hasSCMCosto ? 'Cemento Portland' : 'Cemento', 
                        value: pctCemento, 
                        color: adjustColorHelper(colorPrincipal, 0),
                        costo: r.cemento?.costo || 0
                    });
                }
                // SCMs individually
                const scmPieColors = [adjustColorHelper(colorPrincipal, 20), adjustColorHelper(colorPrincipal, 35), adjustColorHelper(colorPrincipal, 50)];
                [1,2,3].forEach((i,ix) => {
                    const s = r['scm'+i];
                    if (s && s.peso > 0 && s.tipo && (s.costo || 0) > 0) {
                        chartData.push({ 
                            label: s.tipo, 
                            value: ((s.costo||0) / r.costoTotal * 100), 
                            color: scmPieColors[ix],
                            costo: s.costo || 0
                        });
                    }
                });
                // Agregados
                if (costoAgregados > 0) {
                    chartData.push({ label: 'Agregados', value: pctAgregados, color: adjustColorHelper(colorPrincipal, 65), costo: costoAgregados });
                }
                // Agua
                if ((r.agua?.costo || 0) > 0) {
                    chartData.push({ label: 'Agua', value: pctAgua, color: adjustColorHelper(colorPrincipal, 80), costo: r.agua?.costo || 0 });
                }
                // Aditivos
                if (costoAditivos > 0) {
                    chartData.push({ label: 'Aditivos', value: pctAditivos, color: adjustColorHelper(colorPrincipal, 95), costo: costoAditivos });
                }

                console.log('üìä Chart data:', chartData);
                
                // Generar el SVG del gr√°fico de pie
                const pieChartSVG = generatePieChartSVG(chartData);
                console.log('üìä SVG generado');

            const html = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Reporte de Costos - ${mix.nombre}</title>
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
        font-family: Arial, Helvetica, sans-serif; 
        background: white; 
        padding: 0; 
        color: #222; 
        font-size: 11px;
    }
    .container { 
        max-width: 100%; 
        margin: 0 auto; 
        background: white; 
        padding: 18px 25px; 
    }
    .header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        border-bottom: 2px solid ${colorPrincipal}; 
        padding-bottom: 10px; 
        margin-bottom: 15px; 
    }
    .header h1 { 
        color: ${colorPrincipal}; 
        font-size: 24px; 
        font-weight: bold; 
    }
    .header-subtitle {
        font-size: 11px;
        color: #666;
        margin-top: 3px;
    }
    .header-info { 
        text-align: right; 
        font-size: 10px; 
        color: #666; 
    }
    .section { 
        margin-bottom: 14px; 
    }
    .section-title { 
        background: ${colorPrincipal}; 
        color: white; 
        padding: 6px 12px; 
        font-weight: bold; 
        font-size: 12px; 
        margin-bottom: 10px; 
        border-radius: 3px; 
    }
    .info-grid { 
        display: grid; 
        grid-template-columns: repeat(4, 1fr); 
        gap: 10px; 
        margin-bottom: 12px; 
    }
    .info-item { 
        border: 1px solid #e5e7eb; 
        padding: 8px 10px; 
        border-radius: 4px; 
        background: #fafafa; 
        min-height: 46px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .info-label { 
        font-size: 9px; 
        color: #666; 
        font-weight: bold; 
        text-transform: uppercase; 
        margin-bottom: 4px; 
    }
    .info-value { 
        font-size: 12px; 
        font-weight: bold; 
        color: #222; 
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        line-height: 1.2;
        word-wrap: break-word;
        hyphens: auto;
    }
    /* Auto-fit para textos largos en nombre, cliente y proyecto */
    .info-item:nth-child(1) .info-value,
    .info-item:nth-child(2) .info-value,
    .info-item:nth-child(3) .info-value {
        font-size: clamp(9px, 2.5vw, 12px);
    }
    table { 
        width: 100%; 
        border-collapse: collapse; 
        margin-bottom: 12px; 
        font-size: 10px;
    }
    thead { 
        background: ${colorPrincipal}; 
    }
    th { 
        color: white; 
        padding: 6px 8px; 
        text-align: left; 
        font-weight: bold; 
        font-size: 10px; 
    }
    td { 
        padding: 5px 8px; 
        border-bottom: 1px solid #e5e7eb; 
        font-size: 10px; 
        line-height: 1.4;
    }
    tbody tr:hover { 
        background: rgba(${colorRgb}, 0.05); 
    }
    .material-name { 
        font-weight: 600; 
        color: #374151; 
    }
    .cost-value { 
        font-weight: bold; 
        color: #059669; 
    }
    .pct-value { 
        color: #6b7280; 
        font-size: 9px; 
    }
    .total-row { 
        background: rgba(${colorRgb}, 0.1) !important; 
        font-weight: bold; 
        border-top: 2px solid ${colorPrincipal}; 
    }
    .total-row td { 
        padding: 7px 8px; 
        font-size: 11px; 
    }
    .cost-summary { 
        background: linear-gradient(135deg, rgba(${colorRgb}, 0.15) 0%, rgba(${colorRgb}, 0.25) 100%); 
        padding: 15px; 
        border-radius: 6px; 
        border: 2px solid ${colorPrincipal}; 
        margin: 14px 0; 
    }
    .cost-summary-inner {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 25px;
        align-items: start;
    }
    .cost-summary-left {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    .cost-summary-total {
        text-align: left;
        padding: 14px;
        background: white;
        border-radius: 6px;
        border-left: 3px solid ${colorPrincipal};
    }
    .cost-summary-title { 
        font-size: 10px; 
        color: ${colorPrincipal}; 
        font-weight: bold; 
        margin-bottom: 8px; 
        text-transform: uppercase; 
        letter-spacing: 0.5px; 
    }
    .cost-summary-value { 
        font-size: 32px; 
        font-weight: bold; 
        color: ${colorPrincipal}; 
        line-height: 1; 
    }
    .chart-container {
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .pie-chart {
        width: 220px;
        height: 220px;
    }
    .chart-legend {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        padding: 12px;
        background: white;
        border-radius: 6px;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 10px;
    }
    .legend-color {
        width: 14px;
        height: 14px;
        border-radius: 3px;
        flex-shrink: 0;
    }
    .legend-label {
        font-weight: 600;
        flex: 1;
    }
    .legend-value {
        color: #6b7280;
        font-weight: 600;
    }
    .category-header { 
        background: rgba(${colorRgb}, 0.1); 
        font-weight: bold; 
        color: ${colorPrincipal}; 
        border-left: 3px solid ${colorPrincipal}; 
    }
    .footer { 
        margin-top: 18px; 
        padding-top: 10px; 
        border-top: 1px solid #e5e7eb; 
        text-align: center; 
        font-size: 9px; 
        color: #9ca3af; 
    }
    @media print {
        body { 
            background: white; 
            padding: 0; 
            margin: 0;
        }
        .container { 
            padding: 12px 20px;
            max-width: 100%;
        }
        .section {
            page-break-inside: avoid;
            margin-bottom: 12px;
        }
        .cost-summary {
            page-break-inside: avoid;
        }
        table {
            page-break-inside: avoid;
        }
        @page {
            size: letter;
            margin: 0.35in 0.35in;
        }
    }
</style>
</head>
<body>
<div class="container">

    <!-- ENCABEZADO -->
    <div class="header">
        <div>
            <h1>üí∞ REPORTE DE COSTOS</h1>
            <div class="header-subtitle">An√°lisis Detallado de Costos de Mezcla</div>
        </div>
        <div>
            ${logoHtml.replace('max-height:45px;max-width:150px', 'max-height:65px;max-width:220px')}
            <div class="header-info" style="margin-top: 4px;">
                ${new Date().toLocaleDateString('es-ES', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                })}
            </div>
        </div>
    </div>

    <!-- INFORMACI√ìN DEL MIX -->
    <div class="section">
        <div class="section-title">üìã Informaci√≥n del Mix Design</div>
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Nombre</div>
                <div class="info-value">${mix.nombre}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Cliente</div>
                <div class="info-value">${clienteNombre}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Proyecto</div>
                <div class="info-value">${proyectoNombre}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Fecha</div>
                <div class="info-value">${new Date(mix.fecha || mix.fechaCreacion).toLocaleDateString('es-ES')}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Resistencia</div>
                <div class="info-value" style="color: #16a34a;">${mix.resistencia} PSI</div>
            </div>
            <div class="info-item">
                <div class="info-label">Slump</div>
                <div class="info-value">${mix.slump} in</div>
            </div>
            <div class="info-item">
                <div class="info-label">Relaci√≥n W/C</div>
                <div class="info-value">${r.wc.toFixed(3)}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Rendimiento</div>
                <div class="info-value">${r.rendimiento.toFixed(2)} ft¬≥</div>
            </div>
        </div>
    </div>

    <!-- RESUMEN DE COSTO TOTAL CON GR√ÅFICO -->
    <div class="cost-summary">
        <div class="cost-summary-inner">
            <div class="cost-summary-left">
                <!-- Costo Total arriba -->
                <div class="cost-summary-total">
                    <div class="cost-summary-title">Costo Total por Yarda C√∫bica</div>
                    <div class="cost-summary-value">$${r.costoTotal.toFixed(2)}</div>
                </div>
                
                <!-- Leyendas din√°micas -->
                <div class="chart-legend">
                    ${chartData.map(item => `
                    <div class="legend-item">
                        <div class="legend-color" style="background: ${item.color}"></div>
                        <span class="legend-label">${item.label}</span>
                        <span class="legend-value">${item.value.toFixed(1)}%</span>
                    </div>`).join('')}
                </div>
            </div>
            
            <!-- Gr√°fico de pie a la derecha -->
            <div class="chart-container">
                <svg class="pie-chart" viewBox="0 0 200 200">
                    ${pieChartSVG}
                </svg>
            </div>
        </div>
    </div>

    <!-- DESGLOSE DETALLADO -->
    <div class="section">
        <div class="section-title">üìä Desglose Detallado de Costos</div>
        <table>
            <thead>
                <tr>
                    <th>Material</th>
                    <th>Cantidad</th>
                    <th>Precio Unitario</th>
                    <th>Costo</th>
                    <th>% del Total</th>
                </tr>
            </thead>
            <tbody>
                <!-- CEMENTO + SCMs -->
                <tr class="category-header">
                    <td colspan="5"><strong>üèóÔ∏è CEMENTO${hasSCMCosto ? ' &amp; CEMENTICIOS SUPLEMENTARIOS (SCMs)' : ''}</strong></td>
                </tr>
                <tr>
                    <td class="material-name">${mix.tipoCemento || 'Tipo I'}${hasSCMCosto ? ' (Portland)' : ''}</td>
                    <td>${r.cemento.peso.toFixed(1)} lb (${r.sacosCemento.toFixed(2)} sacos)</td>
                    <td>$${(mix.precioCemento || 0).toFixed(2)}/saco</td>
                    <td class="cost-value">$${r.cemento.costo.toFixed(2)}</td>
                    <td class="pct-value">${pctCemento.toFixed(1)}%</td>
                </tr>
                ${[1,2,3].map(i => {
                    const s = r['scm'+i];
                    if (!s || s.peso <= 0 || !s.tipo) return '';
                    const pctScm = ((s.costo||0) / r.costoTotal * 100);
                    const precScm = mix['precioScm'+i] || mix['precioSCM'+i] || 0;
                    return `<tr style="background:#f5f3ff">
                        <td class="material-name">${s.tipo} <span style="font-size:9px;color:#7c3aed">(SCM ${i})</span></td>
                        <td>${s.peso.toFixed(1)} lb (${((s.peso/94)||0).toFixed(2)} sacos)</td>
                        <td>$${precScm.toFixed(2)}/saco</td>
                        <td class="cost-value">$${(s.costo||0).toFixed(2)}</td>
                        <td class="pct-value">${pctScm.toFixed(1)}%</td>
                    </tr>`;
                }).join('')}
                ${hasSCMCosto ? `<tr style="background:#ddd6fe;font-weight:600">
                    <td style="color:#5b21b6">Total Cementicio (Portland + SCMs)</td>
                    <td style="color:#5b21b6">${(r.totalCementicio||r.cemento.peso).toFixed(1)} lb</td>
                    <td></td>
                    <td class="cost-value" style="color:#5b21b6">$${((r.cemento.costo||0)+costoSCMs).toFixed(2)}</td>
                    <td class="pct-value" style="color:#5b21b6">${(pctCemento+pctSCMs).toFixed(1)}%</td>
                </tr>` : ''}

                <!-- AGREGADOS -->
                <tr class="category-header">
                    <td colspan="5"><strong>ü™® AGREGADOS</strong></td>
                </tr>
                ${r.grueso.peso > 0 ? `
                <tr>
                    <td class="material-name">Agregado Grueso</td>
                    <td>${r.grueso.peso.toFixed(1)} lb</td>
                    <td>$${(mix.precioGrueso || 0).toFixed(2)}/ton</td>
                    <td class="cost-value">$${r.grueso.costo.toFixed(2)}</td>
                    <td class="pct-value">${((r.grueso.costo / r.costoTotal) * 100).toFixed(1)}%</td>
                </tr>` : ''}
                ${r.intermedio.peso > 0 ? `
                <tr>
                    <td class="material-name">Agregado Intermedio</td>
                    <td>${r.intermedio.peso.toFixed(1)} lb</td>
                    <td>$${(mix.precioIntermedio || 0).toFixed(2)}/ton</td>
                    <td class="cost-value">$${r.intermedio.costo.toFixed(2)}</td>
                    <td class="pct-value">${((r.intermedio.costo / r.costoTotal) * 100).toFixed(1)}%</td>
                </tr>` : ''}
                ${r.arena1.peso > 0 ? `
                <tr>
                    <td class="material-name">Arena 1</td>
                    <td>${r.arena1.peso.toFixed(1)} lb</td>
                    <td>$${(mix.precioArena1 || 0).toFixed(2)}/ton</td>
                    <td class="cost-value">$${r.arena1.costo.toFixed(2)}</td>
                    <td class="pct-value">${((r.arena1.costo / r.costoTotal) * 100).toFixed(1)}%</td>
                </tr>` : ''}
                ${r.arena2.peso > 0 ? `
                <tr>
                    <td class="material-name">Arena 2</td>
                    <td>${r.arena2.peso.toFixed(1)} lb</td>
                    <td>$${(mix.precioArena2 || 0).toFixed(2)}/ton</td>
                    <td class="cost-value">$${r.arena2.costo.toFixed(2)}</td>
                    <td class="pct-value">${((r.arena2.costo / r.costoTotal) * 100).toFixed(1)}%</td>
                </tr>` : ''}

                <!-- AGUA -->
                <tr class="category-header">
                    <td colspan="5"><strong>üíß AGUA</strong></td>
                </tr>
                <tr>
                    <td class="material-name">Agua Efectiva</td>
                    <td>${r.agua.peso.toFixed(1)} lb (${(r.agua.peso / 8.34).toFixed(1)} gal)</td>
                    <td>$${(mix.precioAgua || 0).toFixed(2)}/gal</td>
                    <td class="cost-value">$${r.agua.costo.toFixed(2)}</td>
                    <td class="pct-value">${pctAgua.toFixed(1)}%</td>
                </tr>

                ${(r.aditivo1.peso > 0 && r.aditivo1.nombre) || 
                  (r.aditivo2.peso > 0 && r.aditivo2.nombre) || 
                  (r.aditivo3.peso > 0 && r.aditivo3.nombre) ? `
                <!-- ADITIVOS -->
                <tr class="category-header">
                    <td colspan="5"><strong>üß™ ADITIVOS</strong></td>
                </tr>
                ${r.aditivo1.peso > 0 && r.aditivo1.nombre ? `
                <tr>
                    <td class="material-name">${r.aditivo1.nombre}</td>
                    <td>${(mix.dosisAditivo1 || 0).toFixed(2)} oz/cwt</td>
                    <td>$${(mix.precioAditivo1 || 0).toFixed(2)}/gal</td>
                    <td class="cost-value">$${r.aditivo1.costo.toFixed(2)}</td>
                    <td class="pct-value">${((r.aditivo1.costo / r.costoTotal) * 100).toFixed(1)}%</td>
                </tr>` : ''}
                ${r.aditivo2.peso > 0 && r.aditivo2.nombre ? `
                <tr>
                    <td class="material-name">${r.aditivo2.nombre}</td>
                    <td>${(mix.dosisAditivo2 || 0).toFixed(2)} oz/cwt</td>
                    <td>$${(mix.precioAditivo2 || 0).toFixed(2)}/gal</td>
                    <td class="cost-value">$${r.aditivo2.costo.toFixed(2)}</td>
                    <td class="pct-value">${((r.aditivo2.costo / r.costoTotal) * 100).toFixed(1)}%</td>
                </tr>` : ''}
                ${r.aditivo3.peso > 0 && r.aditivo3.nombre ? `
                <tr>
                    <td class="material-name">${r.aditivo3.nombre}</td>
                    <td>${(mix.dosisAditivo3 || 0).toFixed(2)} oz/cwt</td>
                    <td>$${(mix.precioAditivo3 || 0).toFixed(2)}/gal</td>
                    <td class="cost-value">$${r.aditivo3.costo.toFixed(2)}</td>
                    <td class="pct-value">${((r.aditivo3.costo / r.costoTotal) * 100).toFixed(1)}%</td>
                </tr>` : ''}
                ` : ''}

                <!-- TOTAL -->
                <tr class="total-row">
                    <td colspan="3"><strong>COSTO TOTAL</strong></td>
                    <td class="cost-value"><strong>$${r.costoTotal.toFixed(2)}</strong></td>
                    <td class="pct-value"><strong>100%</strong></td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- FOOTER -->
    <div class="footer">
        MIXTEC PRO - ${new Date().toLocaleDateString('es-ES')} ${new Date().toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'})}
    </div>

</div>

<scr` + `ipt>
    // Script simplificado - las funciones principales est√°n en el scope externo
    window.onload = function() {
        setTimeout(() => window.print(), 500);
    };
</scr` + `ipt>

</body>
</html>`;

                console.log('üìù HTML generado, abriendo ventana...');

                const win = window.open('', '_blank');
                if (!win) { 
                    alert('‚ùå Bloqueador de ventanas emergentes activo.'); 
                    return; 
                }
                
                console.log('‚úÖ Ventana abierta, escribiendo contenido...');
                win.document.write(html);
                win.document.close();
                console.log('‚úÖ Reporte completado');
                
            } catch (error) {
                console.error('‚ùå Error en generarHTMLReporteCostos:', error);
                alert('‚ùå Error al generar HTML del reporte: ' + error.message);
            }
        }














        async function guardarTrialMix() {
            // Validaci√≥n manual (form tiene novalidate)
            const mixId = parseInt(document.getElementById('trial-mixdesign').value);
            const fecha  = document.getElementById('trial-fecha').value;
            const tamanoVal = document.getElementById('trial-tamano').value;

            if (!mixId || isNaN(mixId)) {
                alert('‚ö†Ô∏è Selecciona un Mix Design antes de guardar.');
                return;
            }
            if (!fecha) {
                alert('‚ö†Ô∏è Ingresa la fecha del Trial.');
                return;
            }
            if (!tamanoVal) {
                alert('‚ö†Ô∏è Selecciona el tama√±o del batch.');
                return;
            }

            try {
                const mix = await getRecord('mixdesigns', mixId);
                if (!mix) {
                    alert('‚ö†Ô∏è Mix Design no encontrado. Selecciona uno v√°lido.');
                    return;
                }

                const editId = document.getElementById('edit-trial-id').value;

                // Generar o recuperar trialId
                let trialId;
                if (editId) {
                    const existingTrial = await getRecord('trials', parseInt(editId));
                    trialId = existingTrial ? existingTrial.trialId : await generarTrialId();
                } else {
                    trialId = await generarTrialId();
                }

                // Tama√±o del batch
                let tamano;
                if (tamanoVal === 'custom') {
                    tamano = parseFloat(document.getElementById('trial-tamano-custom').value);
                    if (!tamano || tamano <= 0) {
                        alert('‚ö†Ô∏è Ingresa un tama√±o de batch v√°lido.');
                        return;
                    }
                } else {
                    tamano = parseFloat(tamanoVal);
                }

                // Recopilar datos de cilindros (null-safe: fields may not exist if container was cleared)
                const numCilindros = parseInt(document.getElementById('trial-num-cilindros').value) || 0;
                const cilindros = [];
                // Ensure cilindro fields exist before reading
                const container = document.getElementById('cilindros-container');
                if (container && container.children.length === 0 && numCilindros > 0) {
                    generarCamposCilindros();
                }
                for (let i = 1; i <= numCilindros; i++) {
                    const elDias       = document.getElementById('cilindro-' + i + '-dias');
                    const elFecha      = document.getElementById('cilindro-' + i + '-fecha');
                    const elResistencia= document.getElementById('cilindro-' + i + '-resistencia');
                    if (!elDias) continue; // skip if element doesn't exist
                    let dias = elDias.value;
                    if (dias === 'custom') {
                        const elCustom = document.getElementById('cilindro-' + i + '-dias-custom');
                        dias = elCustom ? elCustom.value : '28';
                    }
                    cilindros.push({
                        numero:      i,
                        diasCurado:  dias,
                        fechaEnsayo: elFecha      ? elFecha.value : '',
                        resistencia: elResistencia ? parseFloat(elResistencia.value) || 0 : 0
                    });
                }

                const trial = {
                    trialId:         trialId,
                    mixDesignId:     mixId,
                    mixDesignNombre: mix.nombre,
                    fecha:           fecha,
                    hora:            document.getElementById('trial-hora').value,
                    tamano:          tamano,
                    slump:           parseFloat(document.getElementById('trial-slump').value) || 0,
                    temperatura:     parseFloat(document.getElementById('trial-temperatura').value) || 0,
                    aire:            parseFloat(document.getElementById('trial-aire').value) || 0,
                    pesoUnitario:    parseFloat(document.getElementById('trial-peso-unitario').value) || 0,
                    cilindros:       cilindros,
                    observaciones:   document.getElementById('trial-observaciones').value,
                    tecnico:         document.getElementById('trial-tecnico').value,
                    fechaCreacion:   new Date().toISOString()
                };

                if (editId) {
                    trial.id = parseInt(editId);
                    await updateRecord('trials', trial);
                    alert('‚úÖ Trial Mix actualizado: ' + trialId);
                } else {
                    await addRecord('trials', trial);
                    alert('‚úÖ Trial Mix guardado: ' + trialId);
                }

                // Actualizar UI post-guardado
                document.getElementById('trial-id-display').value = trialId;
                currentTrialData = trial;
                document.getElementById('btn-reporte-trial').disabled = false;
                document.getElementById('btn-qr-trial').disabled = false;

                loadTrials();
                updateDashboard();

            } catch (error) {
                console.error('Error guardando trial:', error);
                alert('‚ùå Error al guardar: ' + (error.message || error));
            }
        }

        async function loadTrials() {
            const trials = await getAllRecords('trials');
            const container = document.getElementById('lista-trials');
            
            if (trials.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay trial mixes registrados</div>';
                return;
            }
            
            let html = '<table><thead><tr><th>Trial ID</th><th>Mix Design</th><th>Tama√±o</th><th>Slump</th><th>Temp</th><th>Aire</th><th>Cilindros</th><th>Fecha</th><th>Acciones</th></tr></thead><tbody>';
            trials.forEach(t => {
                html += `<tr>
                    <td><span class="trial-badge">${t.trialId}</span></td>
                    <td><strong>${t.mixDesignNombre}</strong></td>
                    <td>${t.tamano} ft¬≥</td>
                    <td>${t.slump || '-'} in</td>
                    <td>${t.temperatura || '-'} ¬∞F</td>
                    <td>${t.aire || '-'} %</td>
                    <td>${t.cilindros.length}</td>
                    <td>${new Date(t.fecha).toLocaleDateString()}</td>
                    <td class="actions">
                        <button class="info" onclick="verTrial(${t.id})">Ver</button>
                        <button class="secondary" onclick="editTrial(${t.id})">Editar</button>
                        <button class="danger" onclick="deleteTrial(${t.id})">Eliminar</button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function verTrial(id) {
            const trial = await getRecord('trials', id);
            if (!trial) return;
            
            currentTrialData = trial;
            
            let resumenCilindros = '';
            trial.cilindros.forEach(cil => {
                resumenCilindros += `Cilindro ${cil.numero}: ${cil.diasCurado} d√≠as = ${cil.resistencia || 'Pendiente'} PSI\n`;
            });
            
            alert(`TRIAL MIX: ${trial.trialId}\n\n` +
                  `Mix Design: ${trial.mixDesignNombre}\n` +
                  `Tama√±o: ${trial.tamano} ft¬≥\n` +
                  `Fecha: ${new Date(trial.fecha).toLocaleDateString()}\n\n` +
                  `PROPIEDADES:\n` +
                  `Slump: ${trial.slump} in\n` +
                  `Temperatura: ${trial.temperatura} ¬∞F\n` +
                  `Aire: ${trial.aire}%\n` +
                  `Peso Unitario: ${trial.pesoUnitario} lb/ft¬≥\n\n` +
                  `CILINDROS (${trial.cilindros.length}):\n${resumenCilindros}\n` +
                  `Observaciones:\n${trial.observaciones || 'N/A'}\n\n` +
                  `T√©cnico: ${trial.tecnico || 'N/A'}`);
        }

        // ============ CALENDARIO DE ROTURAS ============
        async function cargarCalendario() {
            const trials = await getAllRecords('trials');
            const container = document.getElementById('calendario-container');
            const filtroMes = document.getElementById('filtro-mes-calendario').value;
            const filtroEstado = document.getElementById('filtro-estado-calendario').value;
            
            // Crear lista de todos los ensayos programados
            let ensayos = [];
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            
            trials.forEach(trial => {
                trial.cilindros.forEach(cilindro => {
                    const fechaTrial = new Date(trial.fecha);
                    const fechaEnsayo = new Date(fechaTrial);
                    fechaEnsayo.setDate(fechaEnsayo.getDate() + parseInt(cilindro.diasCurado));
                    fechaEnsayo.setHours(0, 0, 0, 0);
                    
                    const tieneResultado = cilindro.resistencia && cilindro.resistencia > 0;
                    const esVencido = fechaEnsayo < hoy && !tieneResultado;
                    const esHoy = fechaEnsayo.getTime() === hoy.getTime();
                    
                    let estado = 'pendiente';
                    if (tieneResultado) estado = 'completado';
                    else if (esVencido) estado = 'vencido';
                    
                    ensayos.push({
                        trialId: trial.trialId,
                        mixDesign: trial.mixDesignNombre,
                        cilindroNum: cilindro.numero,
                        diasCurado: cilindro.diasCurado,
                        fechaTrial: fechaTrial,
                        fechaEnsayo: fechaEnsayo,
                        fechaEnsayoReal: cilindro.fechaEnsayo ? new Date(cilindro.fechaEnsayo) : null,
                        resistencia: cilindro.resistencia,
                        estado: estado,
                        esHoy: esHoy,
                        tecnico: trial.tecnico || 'N/A'
                    });
                });
            });
            
            // Filtrar por mes si est√° seleccionado
            if (filtroMes) {
                const [year, month] = filtroMes.split('-');
                ensayos = ensayos.filter(e => {
                    const fecha = e.fechaEnsayo;
                    return fecha.getFullYear() == year && (fecha.getMonth() + 1) == month;
                });
            }
            
            // Filtrar por estado
            if (filtroEstado !== 'todos') {
                if (filtroEstado === 'pendientes') {
                    ensayos = ensayos.filter(e => e.estado === 'pendiente');
                } else if (filtroEstado === 'completados') {
                    ensayos = ensayos.filter(e => e.estado === 'completado');
                } else if (filtroEstado === 'vencidos') {
                    ensayos = ensayos.filter(e => e.estado === 'vencido');
                }
            }
            
            // Ordenar por fecha de ensayo
            ensayos.sort((a, b) => a.fechaEnsayo - b.fechaEnsayo);
            
            if (ensayos.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay ensayos programados para los filtros seleccionados</div>';
                return;
            }
            
            let html = '';
            ensayos.forEach(ensayo => {
                const claseEstado = ensayo.esHoy ? 'hoy' : ensayo.estado;
                const labelEstado = ensayo.esHoy ? 'HOY' : ensayo.estado.toUpperCase();
                const diasDesdeColado = Math.floor((ensayo.fechaEnsayo - ensayo.fechaTrial) / (1000 * 60 * 60 * 24));
                
                html += `
                    <div class="calendario-item ${claseEstado}">
                        <div class="calendario-header">
                            <div class="calendario-fecha">
                                üìÖ ${ensayo.fechaEnsayo.toLocaleDateString('es-ES', { 
                                    weekday: 'long', 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric' 
                                })}
                            </div>
                            <span class="calendario-status ${ensayo.estado}">${labelEstado}</span>
                        </div>
                        <div class="calendario-content">
                            <div class="calendario-detail">
                                <strong>Trial ID:</strong><br>
                                <span class="trial-badge" style="font-size: 14px; padding: 4px 8px;">${ensayo.trialId}</span>
                            </div>
                            <div class="calendario-detail">
                                <strong>Mix Design:</strong><br>
                                ${ensayo.mixDesign}
                            </div>
                            <div class="calendario-detail">
                                <strong>Cilindro:</strong><br>
                                #${ensayo.cilindroNum} - ${ensayo.diasCurado} d√≠as
                            </div>
                            <div class="calendario-detail">
                                <strong>Fecha Colado:</strong><br>
                                ${ensayo.fechaTrial.toLocaleDateString()}
                            </div>
                            <div class="calendario-detail">
                                <strong>T√©cnico:</strong><br>
                                ${ensayo.tecnico}
                            </div>
                            <div class="calendario-detail">
                                <strong>Resistencia:</strong><br>
                                ${ensayo.resistencia ? ensayo.resistencia + ' PSI' : '‚è≥ Pendiente'}
                            </div>
                        </div>
                        ${ensayo.fechaEnsayoReal ? `
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); font-size: 12px; color: var(--text-light);">
                            ‚úÖ Ensayado el: ${ensayo.fechaEnsayoReal.toLocaleDateString()}
                        </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }


        async function editTrial(id) {
            const trial = await getRecord('trials', id);
            if (!trial) return;
            
            // Cargar el select de mix designs primero
            await loadMixDesignsSelect();
            
            currentTrialData = trial;
            document.getElementById('btn-reporte-trial').disabled = false;
            document.getElementById('btn-qr-trial').disabled = false;
            
            document.getElementById('edit-trial-id').value = trial.id;
            document.getElementById('trial-id-display').value = trial.trialId;
            document.getElementById('trial-mixdesign').value = trial.mixDesignId;
            document.getElementById('trial-fecha').value = trial.fecha;
            document.getElementById('trial-hora').value = trial.hora || '';
            
            if ([1, 2, 3, 4, 5, 6.75, 13.5, 27].includes(trial.tamano)) {
                document.getElementById('trial-tamano').value = trial.tamano;
            } else {
                document.getElementById('trial-tamano').value = 'custom';
                document.getElementById('trial-tamano-custom').value = trial.tamano;
                document.getElementById('trial-tamano-custom-group').style.display = 'block';
            }
            
            document.getElementById('trial-slump').value = trial.slump;
            document.getElementById('trial-temperatura').value = trial.temperatura;
            document.getElementById('trial-aire').value = trial.aire;
            document.getElementById('trial-peso-unitario').value = trial.pesoUnitario;
            
            document.getElementById('trial-num-cilindros').value = trial.cilindros.length;
            generarCamposCilindros();
            
            trial.cilindros.forEach((cil, index) => {
                const i = index + 1;
                const diasSelect = document.getElementById(`cilindro-${i}-dias`);
                if ([7, 14, 28, 56].includes(parseInt(cil.diasCurado))) {
                    diasSelect.value = cil.diasCurado;
                } else {
                    diasSelect.value = 'custom';
                    document.getElementById(`cilindro-${i}-dias-custom`).value = cil.diasCurado;
                    document.getElementById(`cilindro-${i}-dias-custom-group`).style.display = 'block';
                }
                document.getElementById(`cilindro-${i}-fecha`).value = cil.fechaEnsayo || '';
                document.getElementById(`cilindro-${i}-resistencia`).value = cil.resistencia;
            });
            
            document.getElementById('trial-observaciones').value = trial.observaciones || '';
            document.getElementById('trial-tecnico').value = trial.tecnico || '';
            
            await cargarInfoMixDesign();
            
            switchTab('trials');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function deleteTrial(id) {
            if (confirm('¬øEliminar este trial mix?')) {
                await deleteRecord('trials', id);
                loadTrials();
                updateDashboard();
            }
        }

        function filterTrials() {
            const search = document.getElementById('search-trials').value.toLowerCase();
            document.querySelectorAll('#lista-trials table tbody tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        let currentTrialData = null;

                        async function generarReporteTrial() {
            var trialId = document.getElementById('trial-id-display').value;
            
            if (!trialId) {
                alert('‚ö†Ô∏è Primero guarda el trial mix');
                return;
            }

            var trials = await getAllRecords('trials');
            var trial = null;
            
            for (var i = 0; i < trials.length; i++) {
                if (trials[i].trialId === trialId) {
                    trial = trials[i];
                    break;
                }
            }
            
            if (!trial) {
                alert('‚ö†Ô∏è Guarda el trial primero');
                return;
            }

            var mix = await getRecord('mixdesigns', parseInt(trial.mixDesignId));
            
            var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Trial Mix Report - ' + trialId + '</title>';
            html += '<style>';
            html += 'body{font-family:Arial,sans-serif;margin:40px;background:white;color:#333}';
            html += '.header{display:flex;justify-content:space-between;align-items:center;border-bottom:3px solid #16a34a;padding-bottom:20px;margin-bottom:30px}';
            html += '.header-left h1{color:#16a34a;font-size:2em;margin:0 0 10px 0}';
            html += '.header-right img{max-width:300px;max-height:120px;height:auto}';
            html += '.info-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin:20px 0;background:#f8f9fa;padding:20px;border-radius:8px}';
            html += '.info-item{padding:10px}';
            html += '.info-item strong{color:#16a34a;display:block;margin-bottom:5px}';
            html += 'h2{color:#16a34a;margin-top:30px;font-size:1.5em;border-bottom:2px solid #16a34a;padding-bottom:10px}';
            html += 'table{width:100%;border-collapse:collapse;margin:20px 0}';
            html += 'th,td{border:1px solid #ddd;padding:12px;text-align:left}';
            html += 'th{background:#16a34a;color:white;font-weight:bold}';
            html += 'tr:nth-child(even){background:#f8f9fa}';
            html += '.chart-container{margin:30px 0;text-align:center}';
            html += 'canvas{border:1px solid #e0e0e0;border-radius:8px;background:white}';
            html += '@media print{body{margin:20px}.header{page-break-after:avoid}}';
            html += '</style></head><body>';
            
            // Header con logo
            html += '<div class="header">';
            html += '<div class="header-left">';
            html += '<h1>TRIAL MIX REPORT</h1>';
            html += '<p style="font-size:14px;color:#666;margin:0">Trial ID: <strong>' + trialId + '</strong></p>';
            html += '</div>';
            html += '<div class="header-right">';
            if (logoEmpresa) {
                html += '<img src="' + logoEmpresa + '" alt="Logo Empresa">';
            } else {
                html += '<div style="width:300px;height:100px;background:#16a34a;border-radius:8px;display:flex;align-items:center;justify-content:center;color:white;font-size:24px;font-weight:bold">MIXTEC PRO</div>';
            }
            html += '</div>';
            html += '</div>';
            
            // Informaci√≥n General
            html += '<h2>Informaci√≥n General</h2>';
            html += '<div class="info-grid">';
            html += '<div class="info-item"><strong>Mix Design Base:</strong> ' + (mix ? mix.nombre : 'N/A') + '</div>';
            html += '<div class="info-item"><strong>Fecha del Trial:</strong> ' + new Date(trial.fecha).toLocaleDateString('es-ES') + '</div>';
            html += '<div class="info-item"><strong>Hora:</strong> ' + (trial.hora || 'N/A') + '</div>';
            html += '<div class="info-item"><strong>Tama√±o del Batch:</strong> ' + trial.tamano + ' ft¬≥</div>';
            html += '<div class="info-item"><strong>T√©cnico:</strong> ' + (trial.tecnico || 'N/A') + '</div>';
            html += '<div class="info-item"><strong>Resistencia Objetivo:</strong> ' + (mix ? mix.resistencia + ' psi' : 'N/A') + '</div>';
            html += '</div>';
            
            // ‚îÄ‚îÄ Cantidades del Trial Batch (con SCMs) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (mix && mix.resultados) {
                const rT = mix.resultados;
                const factorT = (trial.tamano || 1) / 27;
                const hasSCMReport = [1,2,3].some(n => (rT['scm'+n]?.peso || 0) > 0 && rT['scm'+n]?.tipo);
                
                html += '<h2>‚öñÔ∏è Cantidades del Trial Batch (' + (trial.tamano || '-') + ' ft¬≥)</h2>';
                html += '<table>';
                html += '<thead><tr>';
                html += '<th>Material</th>';
                html += '<th style="text-align:right">Cantidad (lb)</th>';
                html += '<th style="text-align:right">Unidad Ref.</th>';
                html += '</tr></thead><tbody>';

                // Cemento
                const tipoCemRep = mix.tipoCemento || '';
                const sacosRep = (rT.cemento.peso * factorT) / 94;
                html += '<tr style="background:#eff6ff">';
                html += '<td><strong>Cemento' + (tipoCemRep ? ' (' + tipoCemRep + ')' : '') + (hasSCMReport ? ' (Portland)' : '') + '</strong></td>';
                html += '<td style="text-align:right">' + (rT.cemento.peso * factorT).toFixed(2) + ' lb</td>';
                html += '<td style="text-align:right;color:#64748b">' + sacosRep.toFixed(3) + ' sacos</td>';
                html += '</tr>';

                // SCMs
                const scmBgRep = ['#f5f3ff','#faf5ff','#ede9fe'];
                let totalCemRep = rT.cemento.peso * factorT;
                [1,2,3].forEach((n,ix) => {
                    const s = rT['scm'+n];
                    if (s && s.peso > 0 && s.tipo) {
                        totalCemRep += s.peso * factorT;
                        html += '<tr style="background:' + scmBgRep[ix] + '">';
                        html += '<td><strong>' + s.tipo + '</strong> <span style="font-size:10px;color:#7c3aed">(SCM ' + n + ')</span></td>';
                        html += '<td style="text-align:right">' + (s.peso * factorT).toFixed(2) + ' lb</td>';
                        html += '<td style="text-align:right;color:#64748b">' + (s.peso * factorT / 94).toFixed(3) + ' sacos</td>';
                        html += '</tr>';
                    }
                });

                // Total cementicio banner
                if (hasSCMReport) {
                    html += '<tr style="background:#ddd6fe;font-weight:700">';
                    html += '<td style="color:#5b21b6">üìä Total Cementicio</td>';
                    html += '<td style="text-align:right;color:#5b21b6">' + totalCemRep.toFixed(2) + ' lb</td>';
                    html += '<td style="text-align:right;color:#5b21b6">' + (totalCemRep/94).toFixed(3) + ' sacos</td>';
                    html += '</tr>';
                }

                // Agua
                html += '<tr>';
                html += '<td><strong>Agua Efectiva</strong></td>';
                html += '<td style="text-align:right">' + (rT.agua.peso * factorT).toFixed(2) + ' lb</td>';
                html += '<td style="text-align:right;color:#64748b">' + ((rT.agua.peso * factorT) / 8.34).toFixed(3) + ' gal</td>';
                html += '</tr>';

                // Grueso
                html += '<tr>';
                html += '<td><strong>Agregado Grueso</strong></td>';
                html += '<td style="text-align:right">' + (rT.grueso.peso * factorT).toFixed(2) + ' lb</td>';
                html += '<td></td>';
                html += '</tr>';

                // Intermedio
                if (rT.intermedio && rT.intermedio.peso > 0) {
                    html += '<tr>';
                    html += '<td><strong>Agregado Intermedio</strong></td>';
                    html += '<td style="text-align:right">' + (rT.intermedio.peso * factorT).toFixed(2) + ' lb</td>';
                    html += '<td></td>';
                    html += '</tr>';
                }

                // Arenas
                if (rT.arena1 && rT.arena1.peso > 0) {
                    html += '<tr>';
                    html += '<td><strong>Arena 1</strong></td>';
                    html += '<td style="text-align:right">' + (rT.arena1.peso * factorT).toFixed(2) + ' lb</td>';
                    html += '<td></td>';
                    html += '</tr>';
                }
                if (rT.arena2 && rT.arena2.peso > 0) {
                    html += '<tr>';
                    html += '<td><strong>Arena 2</strong></td>';
                    html += '<td style="text-align:right">' + (rT.arena2.peso * factorT).toFixed(2) + ' lb</td>';
                    html += '<td></td>';
                    html += '</tr>';
                }

                // Aditivos
                [1,2,3].forEach(n => {
                    const ad = rT['aditivo'+n];
                    if (ad && ad.peso > 0 && ad.nombre) {
                        const ozVal = (ad.peso * factorT * 16).toFixed(2);
                        html += '<tr style="background:#fffbeb">';
                        html += '<td><strong>' + ad.nombre + '</strong></td>';
                        html += '<td style="text-align:right">' + (ad.peso * factorT).toFixed(3) + ' lb</td>';
                        html += '<td style="text-align:right;color:#92400e">' + ozVal + ' oz</td>';
                        html += '</tr>';
                    }
                });

                // Total
                const pesoTotalRep = rT.pesoTotal ? (rT.pesoTotal * factorT).toFixed(2) : '‚Äî';
                html += '<tr style="background:#16a34a;color:white;font-weight:700">';
                html += '<td><strong>TOTAL BATCH</strong></td>';
                html += '<td style="text-align:right"><strong>' + pesoTotalRep + ' lb</strong></td>';
                html += '<td style="text-align:right;font-size:11px">' + (trial.tamano || '-') + ' ft¬≥</td>';
                html += '</tr>';

                html += '</tbody></table>';

                // W/C info row
                const wcRep  = (rT.wc || 0).toFixed(3);
                const wcmRep = (rT.wcm || rT.wc || 0).toFixed(3);
                html += '<div style="background:#f0f9ff;border-left:4px solid #2563eb;padding:10px 14px;border-radius:0 6px 6px 0;margin:10px 0;font-size:13px">';
                html += '<strong style="color:#1e40af">W/C:</strong> ' + wcRep;
                if (hasSCMReport) html += ' &nbsp;|&nbsp; <strong style="color:#5b21b6">W/CM:</strong> ' + wcmRep;
                html += '</div>';
            }

            // Propiedades del Concreto Fresco
            html += '<h2>Propiedades del Concreto Fresco</h2>';
            html += '<table>';
            html += '<thead><tr><th>Propiedad</th><th>Valor Medido</th><th>Especificaci√≥n</th></tr></thead>';
            html += '<tbody>';
            html += '<tr><td>Slump</td><td>' + (trial.slump || '-') + ' in</td><td>' + (mix ? mix.slump + ' in' : '-') + '</td></tr>';
            html += '<tr><td>Temperatura</td><td>' + (trial.temperatura || '-') + ' ¬∞F</td><td>50-90 ¬∞F</td></tr>';
            html += '<tr><td>Contenido de Aire</td><td>' + (trial.aire || '-') + ' %</td><td>' + (mix ? mix.contenidoAire + ' %' : '-') + '</td></tr>';
            html += '<tr><td>Peso Unitario</td><td>' + (trial.pesoUnitario || '-') + ' lb/ft¬≥</td><td>-</td></tr>';
            html += '</tbody></table>';
            
            // Resultados de Cilindros
            html += '<h2>Resultados de Ensayos de Compresi√≥n</h2>';
            html += '<table>';
            html += '<thead><tr><th>Cilindro</th><th>Edad (d√≠as)</th><th>Fecha de Ensayo</th><th>Resistencia (psi)</th><th>% de f\'c</th></tr></thead>';
            html += '<tbody>';

            var resistenciaObjetivo = mix ? mix.resistencia : 0;
            for (var i = 0; i < trial.cilindros.length; i++) {
                var c = trial.cilindros[i];
                var porcentaje = resistenciaObjetivo > 0 && c.resistencia ? ((c.resistencia / resistenciaObjetivo) * 100).toFixed(1) : '-';
                html += '<tr>';
                html += '<td>' + c.numero + '</td>';
                html += '<td>' + c.diasCurado + '</td>';
                html += '<td>' + (c.fechaEnsayo ? new Date(c.fechaEnsayo).toLocaleDateString('es-ES') : '-') + '</td>';
                html += '<td><strong>' + (c.resistencia || '-') + '</strong></td>';
                html += '<td>' + (porcentaje !== '-' ? porcentaje + '%' : '-') + '</td>';
                html += '</tr>';
            }

            html += '</tbody></table>';
            
            // Observaciones
            if (trial.observaciones) {
                html += '<h2>Observaciones</h2>';
                html += '<div style="background:#f8f9fa;padding:15px;border-radius:8px;border-left:4px solid #16a34a">';
                html += '<p style="margin:0;white-space:pre-wrap">' + trial.observaciones + '</p>';
                html += '</div>';
            }
            
            // Gr√°fica de Resistencia
            html += '<h2>Curva de Desarrollo de Resistencia</h2>';
            html += '<div class="chart-container">';
            html += '<canvas id="chart-resistencia" width="900" height="500"></canvas>';
            html += '</div>';
            
            html += '<p style="margin-top:40px;text-align:center;color:#666;font-size:12px">';
            html += 'Reporte generado: ' + new Date().toLocaleString('es-ES') + '</p>';
            html += '</body></html>';

            var win = window.open('', '_blank');
            if (!win) {
                alert('‚ùå Bloqueador de ventanas emergentes activado. Por favor permite ventanas emergentes para este sitio.');
                return;
            }
            
            win.document.write(html);
            win.document.close();
            
            // Dibujar gr√°fica despu√©s de que el documento est√© listo
            setTimeout(function() {
                try {
                    var canvas = win.document.getElementById('chart-resistencia');
                    if (!canvas) {
                        console.error('Canvas no encontrado');
                        return;
                    }
                    
                    var ctx = canvas.getContext('2d');
                    var padding = 80;
                    var chartWidth = canvas.width - 2 * padding;
                    var chartHeight = canvas.height - 2 * padding;
                    
                    // Preparar datos - agrupar por d√≠as de curado y calcular promedio
                    var dataByAge = {};
                    for (var i = 0; i < trial.cilindros.length; i++) {
                        var c = trial.cilindros[i];
                        if (c.resistencia && c.resistencia > 0) {
                            var age = parseInt(c.diasCurado) || 0;
                            if (!dataByAge[age]) {
                                dataByAge[age] = {
                                    sum: 0,
                                    count: 0
                                };
                            }
                            dataByAge[age].sum += parseFloat(c.resistencia);
                            dataByAge[age].count += 1;
                        }
                    }
                    
                    // Calcular promedios
                    var chartData = [];
                    for (var age in dataByAge) {
                        chartData.push({
                            age: parseInt(age),
                            strength: dataByAge[age].sum / dataByAge[age].count,
                            count: dataByAge[age].count
                        });
                    }
                    
                    if (chartData.length === 0) {
                        ctx.fillStyle = '#666';
                        ctx.font = '16px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText('No hay datos de resistencia para graficar', canvas.width / 2, canvas.height / 2);
                        return;
                    }
                    
                    // Ordenar por edad
                    chartData.sort(function(a, b) { return a.age - b.age; });
                    
                    // Calcular escalas
                    var maxAge = Math.max.apply(null, chartData.map(function(d) { return d.age; }));
                    maxAge = Math.ceil(maxAge * 1.2 / 10) * 10; // Redondear al m√∫ltiplo de 10 m√°s cercano
                    
                    var targetStrength = resistenciaObjetivo;
                    var maxDataStrength = Math.max.apply(null, chartData.map(function(d) { return d.strength; }));
                    var maxStrength = Math.max(maxDataStrength, targetStrength) * 1.2;
                    maxStrength = Math.ceil(maxStrength / 500) * 500; // Redondear al m√∫ltiplo de 500
                    
                    // Fondo blanco
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Cuadr√≠cula
                    ctx.strokeStyle = '#e0e0e0';
                    ctx.lineWidth = 1;
                    
                    // L√≠neas horizontales
                    for(var i = 0; i <= 5; i++) {
                        var y = canvas.height - padding - (i / 5) * chartHeight;
                        ctx.beginPath();
                        ctx.moveTo(padding, y);
                        ctx.lineTo(canvas.width - padding, y);
                        ctx.stroke();
                    }
                    
                    // L√≠neas verticales
                    var numVerticalLines = Math.min(10, maxAge);
                    for(var i = 0; i <= numVerticalLines; i++) {
                        var x = padding + (i / numVerticalLines) * chartWidth;
                        ctx.beginPath();
                        ctx.moveTo(x, padding);
                        ctx.lineTo(x, canvas.height - padding);
                        ctx.stroke();
                    }
                    
                    // Ejes
                    ctx.strokeStyle = '#333';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(padding, padding);
                    ctx.lineTo(padding, canvas.height - padding);
                    ctx.lineTo(canvas.width - padding, canvas.height - padding);
                    ctx.stroke();
                    
                    // Etiquetas de los ejes
                    ctx.fillStyle = '#333';
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('Edad (d√≠as)', canvas.width / 2, canvas.height - 30);
                    
                    ctx.save();
                    ctx.translate(25, canvas.height / 2);
                    ctx.rotate(-Math.PI / 2);
                    ctx.fillText('Resistencia Promedio a la Compresi√≥n (psi)', 0, 0);
                    ctx.restore();
                    
                    // L√≠nea de resistencia objetivo (f'c)
                    if (targetStrength > 0) {
                        var targetY = canvas.height - padding - (targetStrength / maxStrength) * chartHeight;
                        ctx.strokeStyle = '#ef4444';
                        ctx.lineWidth = 2;
                        ctx.setLineDash([10, 5]);
                        ctx.beginPath();
                        ctx.moveTo(padding, targetY);
                        ctx.lineTo(canvas.width - padding, targetY);
                        ctx.stroke();
                        ctx.setLineDash([]);
                        
                        ctx.fillStyle = '#ef4444';
                        ctx.font = 'bold 14px Arial';
                        ctx.textAlign = 'left';
                        ctx.fillText("f'c = " + targetStrength + " psi", padding + 10, targetY - 8);
                    }
                    
                    // Dibujar l√≠nea de datos
                    ctx.strokeStyle = '#16a34a';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    
                    for(var i = 0; i < chartData.length; i++) {
                        var point = chartData[i];
                        var x = padding + (point.age / maxAge) * chartWidth;
                        var y = canvas.height - padding - (point.strength / maxStrength) * chartHeight;
                        
                        if(i === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    }
                    ctx.stroke();
                    
                    // Dibujar puntos de datos
                    for(var i = 0; i < chartData.length; i++) {
                        var point = chartData[i];
                        var x = padding + (point.age / maxAge) * chartWidth;
                        var y = canvas.height - padding - (point.strength / maxStrength) * chartHeight;
                        
                        // Punto
                        ctx.fillStyle = '#16a34a';
                        ctx.beginPath();
                        ctx.arc(x, y, 7, 0, 2 * Math.PI);
                        ctx.fill();
                        
                        ctx.strokeStyle = 'white';
                        ctx.lineWidth = 3;
                        ctx.stroke();
                        
                        // Etiqueta del valor con indicador de promedio
                        ctx.fillStyle = '#333';
                        ctx.font = 'bold 13px Arial';
                        ctx.textAlign = 'center';
                        var label = point.strength.toFixed(0) + ' psi';
                        if (point.count > 1) {
                            label += ' (Prom.)';
                        }
                        ctx.fillText(label, x, y - 18);
                        
                        // Etiqueta de edad con contador de muestras
                        ctx.fillStyle = '#666';
                        ctx.font = '12px Arial';
                        var ageLabel = point.age + ' d√≠as';
                        if (point.count > 1) {
                            ageLabel += ' (n=' + point.count + ')';
                        }
                        ctx.fillText(ageLabel, x, canvas.height - padding + 25);
                    }
                    
                    // Escala del eje Y
                    ctx.fillStyle = '#666';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'right';
                    for(var i = 0; i <= 5; i++) {
                        var value = (maxStrength / 5) * i;
                        var y = canvas.height - padding - (i / 5) * chartHeight;
                        ctx.fillText(value.toFixed(0), padding - 15, y + 5);
                    }
                    
                } catch(error) {
                    console.error('Error dibujando gr√°fica:', error);
                }
            }, 800);
        }



                async function generarQRTrial() {
            console.log('üîç Iniciando generaci√≥n de QR Code...');
            
            const trialId = document.getElementById('trial-id-display').value;
            const mixId = document.getElementById('trial-mixdesign').value;
            
            console.log('Trial ID:', trialId);
            console.log('Mix ID:', mixId);
            
            if (!trialId) {
                alert('‚ö†Ô∏è Primero guarda el trial mix');
                return;
            }
            
            if (!mixId) {
                alert('‚ö†Ô∏è Selecciona un mix design');
                return;
            }

            try {
                // Verificar si QRCode est√° disponible
                if (typeof QRCode === 'undefined') {
                    throw new Error('Librer√≠a QRCode no est√° cargada. Recarga la p√°gina.');
                }

                // Obtener todos los datos del trial actual
                const trials = await getAllRecords('trials');
                console.log('üì¶ Trials encontrados:', trials.length);
                
                let trial = null;
                for (let i = 0; i < trials.length; i++) {
                    if (trials[i].trialId === trialId) {
                        trial = trials[i];
                        break;
                    }
                }
                
                if (!trial) {
                    alert('‚ö†Ô∏è No se encontr√≥ el trial. Aseg√∫rate de guardar el trial primero.');
                    console.error('Trial no encontrado con ID:', trialId);
                    return;
                }

                console.log('‚úÖ Trial encontrado:', trial);

                const mix = await getRecord('mixdesigns', parseInt(mixId));
                console.log('‚úÖ Mix design:', mix);
                
                // Versi√≥n COMPACTA para QR (optimizada para escaneo)
                let qrText = '=== TRIAL MIX ===\n';
                qrText += 'ID: ' + trialId + '\n';
                qrText += 'Mix: ' + (mix ? mix.nombre : 'N/A') + '\n';
                qrText += 'Fecha: ' + new Date(trial.fecha).toLocaleDateString('es-ES') + '\n';
                if (trial.hora) qrText += 'Hora: ' + trial.hora + '\n';
                if (trial.tecnico) qrText += 'Tec: ' + trial.tecnico + '\n';
                
                qrText += '\nESPECIFICACIONES:\n';
                if (mix && mix.resistencia) qrText += "f'c: " + mix.resistencia + ' psi\n';
                qrText += 'Batch: ' + trial.tamano + ' ft3\n';
                
                qrText += '\nFRESCO:\n';
                if (trial.slump) qrText += 'Slump: ' + trial.slump + ' in\n';
                if (trial.temperatura) qrText += 'Temp: ' + trial.temperatura + ' F\n';
                if (trial.aire) qrText += 'Aire: ' + trial.aire + '%\n';
                if (trial.pesoUnitario) qrText += 'PU: ' + trial.pesoUnitario + ' pcf\n';
                
                qrText += '\nRESISTENCIAS:\n';
                if (trial.cilindros && trial.cilindros.length > 0) {
                    // Agrupar por edad y calcular promedio
                    const byAge = {};
                    trial.cilindros.forEach(c => {
                        if (c.resistencia && c.resistencia > 0) {
                            const age = c.diasCurado;
                            if (!byAge[age]) {
                                byAge[age] = { sum: 0, count: 0 };
                            }
                            byAge[age].sum += parseFloat(c.resistencia);
                            byAge[age].count++;
                        }
                    });
                    
                    // Ordenar por edad
                    const ages = Object.keys(byAge).map(a => parseInt(a)).sort((a, b) => a - b);
                    ages.forEach(age => {
                        const avg = byAge[age].sum / byAge[age].count;
                        const count = byAge[age].count;
                        qrText += age + 'd: ' + avg.toFixed(0) + ' psi';
                        if (count > 1) qrText += ' (n=' + count + ')';
                        
                        // Calcular % de f'c
                        if (mix && mix.resistencia) {
                            const percent = (avg / mix.resistencia * 100).toFixed(0);
                            qrText += ' (' + percent + '%)';
                        }
                        qrText += '\n';
                    });
                } else {
                    qrText += 'Sin datos\n';
                }
                
                if (trial.observaciones && trial.observaciones.length > 0) {
                    qrText += '\nOBS: ';
                    qrText += trial.observaciones.substring(0, 80);
                    if (trial.observaciones.length > 80) qrText += '...';
                    qrText += '\n';
                }

                console.log('üìù Texto del QR generado, longitud:', qrText.length);

                const qrContainer = document.getElementById('qr-code-container');
                if (!qrContainer) {
                    throw new Error('No se encontr√≥ el contenedor del QR');
                }
                
                qrContainer.innerHTML = '';
                
                console.log('üé® Generando QR Code...');
                
                new QRCode(qrContainer, {
                    text: qrText,
                    width: 256,
                    height: 256,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.L  // L=Low for more data capacity
                });
                
                console.log('‚úÖ QR Code generado, mostrando modal...');
                
                const modal = document.getElementById('qr-modal');
                if (!modal) {
                    throw new Error('No se encontr√≥ el modal del QR');
                }
                
                modal.style.display = 'flex';
                console.log('‚úÖ Modal mostrado correctamente');
                
            } catch (error) {
                console.error('‚ùå Error generando QR:', error);
                alert('‚ùå Error al generar QR Code: ' + error.message + '\n\nAbre la consola (F12) para m√°s detalles.');
            }
        }
        
        function cerrarModalQR() {
            document.getElementById('qr-modal').style.display = 'none';
        }


        
        function createStrengthChart(canvasId, data, targetStrength) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const padding = 80;
            const chartWidth = canvas.width - 2 * padding;
            const chartHeight = canvas.height - 2 * padding;
            
            // Ordenar por edad
            data.sort((a, b) => a.age - b.age);
            
            const maxAge = Math.max(...data.map(d => d.age)) * 1.2;
            const maxStrength = Math.max(...data.map(d => d.strength), targetStrength) * 1.2;
            
            // Fondo blanco
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Ejes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.stroke();
            
            // Etiquetas
            ctx.fillStyle = '#333';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Edad (d√≠as)', canvas.width / 2, canvas.height - 20);
            
            ctx.save();
            ctx.translate(20, canvas.height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Resistencia Promedio (psi)', 0, 0);
            ctx.restore();
            
            // Cuadr√≠cula
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for(let i = 0; i <= 5; i++) {
                const y = canvas.height - padding - (i / 5) * chartHeight;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();
            }
            
            // L√≠nea de resistencia objetivo
            if (targetStrength) {
                const targetY = canvas.height - padding - (targetStrength / maxStrength) * chartHeight;
                ctx.strokeStyle = '#ef4444';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(padding, targetY);
                ctx.lineTo(canvas.width - padding, targetY);
                ctx.stroke();
                ctx.setLineDash([]);
                
                ctx.fillStyle = '#ef4444';
                ctx.font = '12px Arial';
                ctx.textAlign = 'right';
                ctx.fillText("f'c = " + targetStrength + " psi", canvas.width - padding - 10, targetY - 5);
            }
            
            // L√≠nea de datos
            if(data.length > 0) {
                ctx.strokeStyle = '#16a34a';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                data.forEach((point, index) => {
                    const x = padding + (point.age / maxAge) * chartWidth;
                    const y = canvas.height - padding - (point.strength / maxStrength) * chartHeight;
                    
                    if(index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();
                
                // Puntos
                data.forEach(point => {
                    const x = padding + (point.age / maxAge) * chartWidth;
                    const y = canvas.height - padding - (point.strength / maxStrength) * chartHeight;
                    
                    ctx.fillStyle = '#16a34a';
                    ctx.beginPath();
                    ctx.arc(x, y, 6, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    ctx.fillStyle = '#333';
                    ctx.font = 'bold 12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(point.strength.toFixed(0) + ' psi', x, y - 15);
                });
            }
            
            // Marcas eje X
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            data.forEach(point => {
                const x = padding + (point.age / maxAge) * chartWidth;
                ctx.fillText(point.age + ' d√≠as', x, canvas.height - padding + 20);
            });
            
            // Marcas eje Y
            ctx.textAlign = 'right';
            for(let i = 0; i <= 5; i++) {
                const value = (maxStrength / 5) * i;
                const y = canvas.height - padding - (i / 5) * chartHeight;
                ctx.fillText(value.toFixed(0), padding - 10, y + 5);
            }
        }

        // ============ DASHBOARD ============
        async function updateDashboard() {
            const clientes = await getAllRecords('clientes');
            const proyectos = await getAllRecords('proyectos');
            const materiales = await getAllRecords('materiales');
            const cotizaciones = await getAllRecords('cotizaciones');
            const mixdesigns = await getAllRecords('mixdesigns');
            const trials = await getAllRecords('trials');

            document.getElementById('stat-clientes').textContent = clientes.length;
            document.getElementById('stat-proyectos').textContent = proyectos.filter(p => p.estado === 'active').length;
            document.getElementById('stat-cotizaciones').textContent = cotizaciones.length;
            document.getElementById('stat-mixdesigns').textContent = mixdesigns.length;
            document.getElementById('stat-trials').textContent = trials.length;

            // Resumen de Cotizaciones por Status
            const cotizacionesPorStatus = {
                'Pendiente': 0,
                'Aprobada': 0,
                'Rechazada': 0,
                'En Revisi√≥n': 0,
                'Cancelada': 0
            };
            
            let totalYdCotizaciones = 0;
            
            cotizaciones.forEach(c => {
                const status = c.status || 'Pendiente';
                cotizacionesPorStatus[status] = (cotizacionesPorStatus[status] || 0) + 1;
                totalYdCotizaciones += (c.totalYd || 0);
            });

            const containerCotSummary = document.getElementById('dashboard-cotizaciones-summary');
            if (cotizaciones.length === 0) {
                containerCotSummary.innerHTML = '<div class="empty-state">No hay cotizaciones registradas</div>';
            } else {
                let htmlCotSummary = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <div style="font-size: 12px; color: #92400e; font-weight: bold; margin-bottom: 5px;">‚è≥ PENDIENTES</div>
                            <div style="font-size: 28px; font-weight: bold; color: #f59e0b;">${cotizacionesPorStatus['Pendiente']}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #16a34a;">
                            <div style="font-size: 12px; color: #166534; font-weight: bold; margin-bottom: 5px;">‚úÖ APROBADAS</div>
                            <div style="font-size: 28px; font-weight: bold; color: #16a34a;">${cotizacionesPorStatus['Aprobada']}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #0369a1;">
                            <div style="font-size: 12px; color: #075985; font-weight: bold; margin-bottom: 5px;">üëÅÔ∏è EN REVISI√ìN</div>
                            <div style="font-size: 28px; font-weight: bold; color: #0369a1;">${cotizacionesPorStatus['En Revisi√≥n']}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #dc2626;">
                            <div style="font-size: 12px; color: #991b1b; font-weight: bold; margin-bottom: 5px;">‚ùå RECHAZADAS</div>
                            <div style="font-size: 28px; font-weight: bold; color: #dc2626;">${cotizacionesPorStatus['Rechazada']}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #0369a1;">
                            <div style="font-size: 12px; color: #1e3a8a; font-weight: bold; margin-bottom: 5px;">üìä TOTAL YD¬≥</div>
                            <div style="font-size: 24px; font-weight: bold; color: #0369a1;">${totalYdCotizaciones.toFixed(2)} yd¬≥</div>
                        </div>
                    </div>
                `;
                
                // Cotizaciones recientes
                const recentCotizaciones = cotizaciones.slice(-5).reverse();
                htmlCotSummary += '<h3 style="margin: 20px 0 10px 0;">Cotizaciones Recientes</h3>';
                htmlCotSummary += '<table><thead><tr><th>N√∫mero</th><th>Status</th><th>Cliente</th><th>Proyecto</th><th>Total YD¬≥</th></tr></thead><tbody>';
                recentCotizaciones.forEach(c => {
                    const statusColor = {
                        'Pendiente': '#f59e0b',
                        'Aprobada': '#16a34a',
                        'Rechazada': '#dc2626',
                        'En Revisi√≥n': '#0369a1',
                        'Cancelada': '#6b7280'
                    }[c.status || 'Pendiente'];
                    htmlCotSummary += `<tr>
                        <td><strong>${c.numero}</strong></td>
                        <td><span style="background: ${statusColor}; color: white; padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: bold;">${c.status || 'Pendiente'}</span></td>
                        <td>${c.clienteNombre}</td>
                        <td>${c.proyecto}</td>
                        <td style="color: #0369a1; font-weight: bold;">${(c.totalYd || 0).toFixed(2)} yd¬≥</td>
                    </tr>`;
                });
                htmlCotSummary += '</tbody></table>';
                containerCotSummary.innerHTML = htmlCotSummary;
            }

            // Mix Designs recientes
            const recentMix = mixdesigns.slice(-5).reverse();
            const containerMix = document.getElementById('recent-mixdesigns');
            if (recentMix.length === 0) {
                containerMix.innerHTML = '<div class="empty-state">No hay mix designs</div>';
            } else {
                let htmlMix = '<table><thead><tr><th>Nombre</th><th>Resistencia</th><th>W/C</th><th>Costo</th></tr></thead><tbody>';
                recentMix.forEach(m => {
                    htmlMix += `<tr><td>${m.nombre}</td><td>${m.resistencia} PSI</td><td>${m.resultados.wc.toFixed(2)}</td><td>$${m.resultados.costoTotal.toFixed(2)}</td></tr>`;
                });
                htmlMix += '</tbody></table>';
                containerMix.innerHTML = htmlMix;
            }

            // Trials recientes
            const recentTrials = trials.slice(-5).reverse();
            const containerTrials = document.getElementById('recent-trials');
            if (recentTrials.length === 0) {
                containerTrials.innerHTML = '<div class="empty-state">No hay trial mixes</div>';
            } else {
                let htmlTrials = '<table><thead><tr><th>Trial ID</th><th>Mix Design</th><th>Tama√±o</th><th>Slump</th><th>Fecha</th></tr></thead><tbody>';
                recentTrials.forEach(t => {
                    htmlTrials += `<tr><td><span class="trial-badge">${t.trialId}</span></td><td>${t.mixDesignNombre}</td><td>${t.tamano} ft¬≥</td><td>${t.slump || '-'} in</td><td>${new Date(t.fecha).toLocaleDateString()}</td></tr>`;
                });
                htmlTrials += '</tbody></table>';
                containerTrials.innerHTML = htmlTrials;
            }
        }

        // ============ UTILIDADES ============
        
        function nuevoTrialMix() {
            clearForm('trial');
            document.getElementById('form-trial').reset();
            generarTrialId().then(id => {
                document.getElementById('trial-id-display').value = id;
            });
            document.getElementById('edit-trial-id').value = '';
            alert('‚úÖ Formulario listo para nuevo trial mix');
        }

        function clearForm(tipo) {
            const form = document.getElementById(`form-${tipo}`);
            if (form) form.reset();
            
            const editId = document.getElementById(`edit-${tipo}-id`);
            if (editId) editId.value = '';
            
            if (tipo === 'mixdesign') {
                document.getElementById('mix-results').style.display = 'none';
                currentMixResults = null;
                document.getElementById('btn-reporte').disabled = true;
                document.getElementById('btn-reporte-costos').disabled = true;
                document.getElementById('btn-mixdesign').disabled = true;
                document.getElementById('pct-arena1').value = 60;
                document.getElementById('pct-arena2').value = 40;
                calcularVolumenes();
            }
            
            if (tipo === 'trial') {
                document.getElementById('mix-design-preview').style.display = 'none';
                document.getElementById('trial-cantidades').style.display = 'none';
                document.getElementById('trial-tamano-custom-group').style.display = 'none';
                document.getElementById('trial-fecha').valueAsDate = new Date();
                currentTrialData = null;
                document.getElementById('btn-reporte-trial').disabled = true;
                document.getElementById('btn-qr-trial').disabled = true;
                generarTrialId().then(id => {
                    document.getElementById('trial-id-display').value = id;
                });
                // Regenerar campos de cilindros despu√©s de limpiar el form
                generarCamposCilindros();
            }
        }

        // ============ CARGAR ADITIVOS EN SELECTS ============
        async function cargarAditivosEnSelects() {
            const materiales = await getAllRecords('materiales');
            const aditivos = materiales.filter(m => m.categoria === 'aditivos');
            
            const selects = ['nombre-aditivo1', 'nombre-aditivo2', 'nombre-aditivo3'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const valorActual = select.value;
                select.innerHTML = '<option value="">Ninguno</option>';
                aditivos.forEach(aditivo => {
                    select.innerHTML += `<option value="${aditivo.nombre}" data-precio="${aditivo.precio || 0}">${aditivo.nombre}</option>`;
                });
                if (valorActual && aditivos.find(a => a.nombre === valorActual)) {
                    select.value = valorActual;
                }
            });
            
            // Agregar event listeners para actualizar precios cuando se selecciona un aditivo
            document.getElementById('nombre-aditivo1').addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const precio = selectedOption.getAttribute('data-precio') || 0;
                document.getElementById('precio-aditivo1').value = precio;
            });
            
            document.getElementById('nombre-aditivo2').addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const precio = selectedOption.getAttribute('data-precio') || 0;
                document.getElementById('precio-aditivo2').value = precio;
            });
            
            document.getElementById('nombre-aditivo3').addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const precio = selectedOption.getAttribute('data-precio') || 0;
                document.getElementById('precio-aditivo3').value = precio;
            });
        }


        // ============================================================
        // ========== AI OPTIMIZER MODULE ============================
        // ============================================================

        let aiOptCurrentData = null; // Stores last optimization result

        // ---- Load mix designs into AI selector ----
        async function cargarMixDesignsEnAIOptimizer() {
            const mixdesigns = await getAllRecords('mixdesigns');
            const sel = document.getElementById('ai-mixdesign-select');
            if (!sel) return;
            const prev = sel.value;
            sel.innerHTML = '<option value="">‚Äî Selecciona un mix design guardado ‚Äî</option>';
            mixdesigns.forEach(m => {
                sel.innerHTML += `<option value="${m.id}">${m.nombre} ‚Äî ${m.resistencia} PSI | W/C: ${(m.resultados.wc||0).toFixed(2)} | $${(m.resultados.costoTotal||0).toFixed(2)}/yd¬≥</option>`;
            });
            if (prev) sel.value = prev;
        }

        // ---- Gather gradation data from inputs ----
        function aiGetGradacion() {
            const g = id => parseFloat(document.getElementById(id)?.value) || 0;
            // Read blend percentages ‚Äî fall back to legacy pct-arena1/2 if new inputs absent
            const pG  = g('pct-grueso-ai')     || 35;
            const pI  = g('pct-intermedio-ai') || 15;
            const pA1 = g('pct-arena1-ai')     || g('pct-arena1') * (50/100) || 30;
            const pA2 = g('pct-arena2-ai')     || g('pct-arena2') * (50/100) || 20;
            const total = pG + pI + pA1 + pA2 || 100;
            return {
                grueso: {
                    '2in':    g('sg-2in'),
                    '1.5in':  g('sg-1.5in'),
                    '1in':    g('sg-1in'),
                    '0.75in': g('sg-0.75in'),
                    '0.5in':  g('sg-0.5in'),
                    '0.375in':g('sg-0.375in'),
                    'no4':    g('sg-4'),
                    'no8':    g('sg-8'),
                },
                intermedio: {
                    '2in':    g('si-2in'),
                    '1.5in':  g('si-1.5in'),
                    '1in':    g('si-1in'),
                    '0.75in': g('si-0.75in'),
                    '0.5in':  g('si-0.5in'),
                    '0.375in':g('si-0.375in'),
                    'no4':    g('si-4'),
                    'no8':    g('si-8'),
                },
                arena1: {
                    '0.375in':g('sa1-0.375in'),
                    'no4':    g('sa1-4'),
                    'no8':    g('sa1-8'),
                    'no16':   g('sa1-16'),
                    'no30':   g('sa1-30'),
                    'no50':   g('sa1-50'),
                    'no100':  g('sa1-100'),
                    'no200':  g('sa1-200'),
                },
                arena2: {
                    '0.375in':g('sa2-0.375in'),
                    'no4':    g('sa2-4'),
                    'no8':    g('sa2-8'),
                    'no16':   g('sa2-16'),
                    'no30':   g('sa2-30'),
                    'no50':   g('sa2-50'),
                    'no100':  g('sa2-100'),
                    'no200':  g('sa2-200'),
                },
                // Normalized fractions (sum = 1)
                pctG:  pG  / total,
                pctI:  pI  / total,
                pct1:  pA1 / total,
                pct2:  pA2 / total,
                // Raw pct for legacy compat
                pctG_raw: pG, pctI_raw: pI, pctA1_raw: pA1, pctA2_raw: pA2,
            };
        }

        // ---- Blend total indicator ----
        function aiUpdateBlendPcts(changed) {
            const g = id => parseFloat(document.getElementById(id)?.value) || 0;
            const total = g('pct-grueso-ai') + g('pct-intermedio-ai') + g('pct-arena1-ai') + g('pct-arena2-ai');
            const ind = document.getElementById('blend-total-indicator');
            if (ind) {
                const ok = Math.abs(total - 100) < 0.5;
                ind.style.color = ok ? '#16a34a' : '#dc2626';
                ind.textContent = `${ok?'‚úÖ':'‚ö†Ô∏è'} Total: ${total.toFixed(0)}%${ok?'':' ‚Äî Ajustar para que sume 100%'}`;
            }
            aiUpdateLiveChart();
        }

        // ---- Coarseness Factor (Shilstone) ----
        // CF = Q_coarse / (Q_coarse + Q_fine) * 100
        // Q_coarse = % retained above No.8 that is > 3/8" (i.e. coarse + intermediate above 3/8")
        // Q_fine   = % passing No.8 in combined aggregate
        function aiCalcCF(gd) {
            const pG = gd.pctG || 0.35, pI = gd.pctI || 0.15;
            const p1 = gd.pct1 || 0.30, p2 = gd.pct2 || 0.20;
            // % passing No.8 in each fraction
            const gNo8  = gd.grueso.no8     || 0;
            const iNo8  = gd.intermedio ? (gd.intermedio.no8 || 0) : 0;
            const fNo8  = (gd.arena1.no8||0)*p1 + (gd.arena2.no8||0)*p2;
            // Combined % passing No.8
            const combPassNo8 = gNo8*pG + iNo8*pI + fNo8;
            // Combined % retained above No.8 (material > No.8 sieve = coarse fraction)
            const combRetAboveNo8 = (100 - gNo8)*pG + (100 - iNo8)*pI;
            // Q3/4 = retained between 3/8" and No.8 in combined (Shilstone definition)
            const gNo4   = gd.grueso.no4    || 3;
            const iNo4   = gd.intermedio ? (gd.intermedio.no4 || 5) : 5;
            const gRet0375  = 100 - (gd.grueso['0.375in']   || 15);
            const iRet0375  = gd.intermedio ? 100 - (gd.intermedio['0.375in'] || 30) : 70;
            // Q345 = retained above 3/8" in combined (coarse fraction above 3/8")
            const Q345 = gRet0375*pG + iRet0375*pI;
            const CF = Q345 / (Q345 + combPassNo8) * 100;
            return Math.max(0, Math.min(100, isNaN(CF) ? 60 : CF));
        }

        // ---- Workability Factor ----
        // WF = % of combined aggregate passing No.8
        function aiCalcWF(gd) {
            const pG = gd.pctG || 0.35, pI = gd.pctI || 0.15;
            const p1 = gd.pct1 || 0.30, p2 = gd.pct2 || 0.20;
            const gNo8 = gd.grueso.no8 || 0;
            const iNo8 = gd.intermedio ? (gd.intermedio.no8 || 0) : 0;
            const fNo8 = (gd.arena1.no8||0)*p1 + (gd.arena2.no8||0)*p2;
            const WF = gNo8*pG + iNo8*pI + fNo8;
            return Math.max(0, Math.min(50, isNaN(WF) ? 35 : WF));
        }

        // ---- Get combined passing at each standard sieve ----
        function aiGetCombinedPassing(gd) {
            const pG = gd.pctG || 0.35, pI = gd.pctI || 0.15;
            const p1 = gd.pct1 || 0.30, p2 = gd.pct2 || 0.20;
            const inter = gd.intermedio || {};
            const finePass = (key) => (gd.arena1[key]||0)*p1 + (gd.arena2[key]||0)*p2;
            const interPass = (key) => (inter[key] !== undefined ? inter[key] : (key==='2in'||key==='1.5in'||key==='1in'?100:key==='0.75in'?95:key==='0.5in'?60:key==='0.375in'?30:key==='no4'?5:0));
            const coarsePass = (key) => gd.grueso[key] !== undefined ? gd.grueso[key] : (key==='2in'?100:key==='1.5in'?100:key==='1in'?85:key==='0.75in'?60:key==='0.5in'?35:key==='0.375in'?15:key==='no4'?3:0);
            const comb = (coarseKey, interKey, fineKey) =>
                coarsePass(coarseKey)*pG + interPass(interKey)*pI + finePass(fineKey);
            return {
                no200:    0*pG + 0*pI + finePass('no200'),
                no100:    0*pG + 0*pI + finePass('no100'),
                no50:     0*pG + 0*pI + finePass('no50'),
                no30:     0*pG + 0*pI + finePass('no30'),
                no16:     0*pG + 0*pI + finePass('no16'),
                no8:      coarsePass('no8')*pG + interPass('no8')*pI + finePass('no8'),
                no4:      coarsePass('no4')*pG + interPass('no4')*pI + finePass('no4'),
                '0.375in':coarsePass('0.375in')*pG + interPass('0.375in')*pI + (100)*p1 + (100)*p2,
                '0.5in':  coarsePass('0.5in')*pG  + interPass('0.5in')*pI  + 100*(p1+p2),
                '0.75in': coarsePass('0.75in')*pG + interPass('0.75in')*pI + 100*(p1+p2),
                '1in':    coarsePass('1in')*pG    + interPass('1in')*pI    + 100*(p1+p2),
                '1.5in':  coarsePass('1.5in')*pG  + interPass('1.5in')*pI  + 100*(p1+p2),
                '2in':    coarsePass('2in')*pG    + interPass('2in')*pI    + 100*(p1+p2),
            };
        }

        // ---- GRADATION CHART DRAWING ----
        function aiDrawLineChart(canvasId, labels, datasets, titleText) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const W = canvas.width, H = canvas.height;
            const pad = {t:36, r:20, b:52, l:52};
            const cW = W-pad.l-pad.r, cH = H-pad.t-pad.b;

            ctx.clearRect(0,0,W,H);
            ctx.fillStyle='#fff'; ctx.fillRect(0,0,W,H);

            // Title
            ctx.fillStyle='#1e293b'; ctx.font='bold 12px Arial';
            ctx.textAlign='center'; ctx.fillText(titleText, W/2, 22);

            // Grid lines (Y: 0-100)
            for (let i = 0; i <= 5; i++) {
                const y = pad.t + (i/5)*cH;
                ctx.strokeStyle='#e2e8f0'; ctx.lineWidth=1;
                ctx.beginPath(); ctx.moveTo(pad.l,y); ctx.lineTo(pad.l+cW,y); ctx.stroke();
                ctx.fillStyle='#64748b'; ctx.font='10px Arial'; ctx.textAlign='right';
                ctx.fillText((100-i*20)+'%', pad.l-6, y+4);
            }

            // X grid and labels
            labels.forEach((lbl, i) => {
                const x = pad.l + (i/(labels.length-1))*cW;
                ctx.strokeStyle='#e2e8f0'; ctx.lineWidth=1;
                ctx.beginPath(); ctx.moveTo(x,pad.t); ctx.lineTo(x,pad.t+cH); ctx.stroke();
                ctx.fillStyle='#64748b'; ctx.font='9px Arial'; ctx.textAlign='center';
                ctx.fillText(lbl, x, pad.t+cH+14);
            });

            // Axes
            ctx.strokeStyle='#94a3b8'; ctx.lineWidth=1.5;
            ctx.beginPath(); ctx.moveTo(pad.l,pad.t); ctx.lineTo(pad.l,pad.t+cH);
            ctx.lineTo(pad.l+cW,pad.t+cH); ctx.stroke();

            // Datasets
            datasets.forEach(ds => {
                ctx.setLineDash(ds.dash ? [6,3] : []);
                ctx.strokeStyle=ds.color; ctx.lineWidth=ds.width||2;
                ctx.beginPath();
                ds.values.forEach((v,i) => {
                    const x = pad.l+(i/(labels.length-1))*cW;
                    const y = pad.t + cH - (Math.min(100,Math.max(0,v))/100)*cH;
                    i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
                });
                ctx.stroke();
                ctx.setLineDash([]);
            });

            // Legend
            let lx = pad.l;
            datasets.forEach(ds => {
                ctx.fillStyle=ds.color; ctx.fillRect(lx, pad.t+cH+28, 14, 7);
                ctx.fillStyle='#374151'; ctx.font='9px Arial'; ctx.textAlign='left';
                ctx.fillText(ds.label, lx+17, pad.t+cH+35);
                lx += ctx.measureText(ds.label).width + 35;
            });

            // Axis label
            ctx.fillStyle='#64748b'; ctx.font='10px Arial'; ctx.textAlign='center';
            ctx.fillText('Tamiz', pad.l+cW/2, H-4);
        }

        // ---- 0.45 Power Chart ----
        function aiDraw045Chart(canvasId, origPts, optPts) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const W = canvas.width, H = canvas.height;
            const pad = {t:40, r:30, b:55, l:62};
            const cW = W-pad.l-pad.r, cH = H-pad.t-pad.b;

            ctx.clearRect(0,0,W,H);
            ctx.fillStyle='#fff'; ctx.fillRect(0,0,W,H);

            ctx.fillStyle='#1e293b'; ctx.font='bold 12px Arial'; ctx.textAlign='center';
            ctx.fillText('Combined Aggregate Gradation ‚Äî 0.45 Power Chart (ACI 211)', W/2, 24);

            // Sieve openings in mm
            const sieves = [0.075, 0.15, 0.3, 0.6, 1.18, 2.36, 4.75, 9.5, 12.5, 19.0, 25.4, 37.5, 50.0];
            const labels  = ['#200','#100','#50','#30','#16','#8','#4','3/8"','1/2"','3/4"','1"','1¬Ω"','2"'];
            const power045 = s => Math.pow(s, 0.45);
            const xVals = sieves.map(power045);
            const xMin = xVals[0], xMax = xVals[xVals.length-1];
            const xPx = v => pad.l + (power045(v)-xMin)/(xMax-xMin)*cW;
            const yPx = p => pad.t + cH - Math.min(1,Math.max(0,p/100))*cH;

            // Grid
            for (let i=0;i<=5;i++) {
                const y = pad.t+(i/5)*cH;
                ctx.strokeStyle='#e2e8f0'; ctx.lineWidth=1;
                ctx.beginPath(); ctx.moveTo(pad.l,y); ctx.lineTo(pad.l+cW,y); ctx.stroke();
                ctx.fillStyle='#64748b'; ctx.font='10px Arial'; ctx.textAlign='right';
                ctx.fillText((100-i*20)+'%', pad.l-6, y+4);
            }
            sieves.forEach((s,i) => {
                const x = xPx(s);
                ctx.strokeStyle='#e2e8f0'; ctx.lineWidth=1;
                ctx.beginPath(); ctx.moveTo(x,pad.t); ctx.lineTo(x,pad.t+cH); ctx.stroke();
                ctx.fillStyle='#64748b'; ctx.font='9px Arial'; ctx.textAlign='center';
                ctx.fillText(labels[i], x, pad.t+cH+14);
            });

            // Axes
            ctx.strokeStyle='#94a3b8'; ctx.lineWidth=1.5;
            ctx.beginPath(); ctx.moveTo(pad.l,pad.t); ctx.lineTo(pad.l,pad.t+cH);
            ctx.lineTo(pad.l+cW,pad.t+cH); ctx.stroke();

            // Maximum Density Line (straight line = ideal on 0.45 power chart)
            const maxSizeMM = 19.0; // 3/4" typical max size
            ctx.strokeStyle='#dc2626'; ctx.lineWidth=2; ctx.setLineDash([8,4]);
            ctx.beginPath();
            ctx.moveTo(xPx(sieves[0]), yPx(Math.pow(sieves[0]/maxSizeMM,0.45)*100));
            sieves.forEach(s => {
                ctx.lineTo(xPx(s), yPx(Math.pow(s/maxSizeMM,0.45)*100));
            });
            ctx.stroke(); ctx.setLineDash([]);

            // Original points
            if (origPts && origPts.length) {
                ctx.strokeStyle='#2563eb'; ctx.lineWidth=2.5; ctx.setLineDash([]);
                ctx.beginPath();
                origPts.forEach((pt,i) => {
                    const x = xPx(sieves[i]), y = yPx(pt);
                    i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
                });
                ctx.stroke();
                // Dots
                origPts.forEach((pt,i) => {
                    ctx.fillStyle='#2563eb';
                    ctx.beginPath();
                    ctx.arc(xPx(sieves[i]), yPx(pt), 3, 0, 2*Math.PI);
                    ctx.fill();
                });
            }

            // Optimized points
            if (optPts && optPts.length) {
                ctx.strokeStyle='#10b981'; ctx.lineWidth=2.5;
                ctx.beginPath();
                optPts.forEach((pt,i) => {
                    const x = xPx(sieves[i]), y = yPx(pt);
                    i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
                });
                ctx.stroke();
                optPts.forEach((pt,i) => {
                    ctx.fillStyle='#10b981';
                    ctx.beginPath();
                    ctx.arc(xPx(sieves[i]), yPx(pt), 3, 0, 2*Math.PI);
                    ctx.fill();
                });
            }

            // Legend
            const items = [
                {color:'#dc2626', label:'Max Density Line', dash:true},
                {color:'#2563eb', label:'Gradaci√≥n Original'},
            ];
            if (optPts && optPts.length) items.push({color:'#10b981', label:'AI Optimizado'});
            let lx = pad.l;
            items.forEach(item => {
                if (item.dash) ctx.setLineDash([6,3]); else ctx.setLineDash([]);
                ctx.strokeStyle=item.color; ctx.lineWidth=2;
                ctx.beginPath(); ctx.moveTo(lx, H-28); ctx.lineTo(lx+18, H-28); ctx.stroke();
                ctx.setLineDash([]);
                ctx.fillStyle='#374151'; ctx.font='10px Arial'; ctx.textAlign='left';
                ctx.fillText(item.label, lx+22, H-24);
                lx += ctx.measureText(item.label).width + 50;
            });

            // Axis labels
            ctx.fillStyle='#64748b'; ctx.font='10px Arial'; ctx.textAlign='center';
            ctx.fillText('Tama√±o Tamiz (escala 0.45 power)', W/2, H-8);
            ctx.save(); ctx.translate(14, pad.t+cH/2); ctx.rotate(-Math.PI/2);
            ctx.fillText('% Pasando', 0, 0); ctx.restore();
        }

        // ---- Coarseness Factor Chart (Shilstone) ----
        function aiDrawCoarsenessChart(origCF, origWF, optCF, optWF) {
            const canvas = document.getElementById('chart-coarseness');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const W = canvas.width, H = canvas.height;
            const pad = {t:45, r:30, b:60, l:68};
            const cW = W-pad.l-pad.r, cH = H-pad.t-pad.b;

            ctx.clearRect(0,0,W,H);
            ctx.fillStyle='#fff'; ctx.fillRect(0,0,W,H);
            ctx.fillStyle='#1e293b'; ctx.font='bold 12px Arial'; ctx.textAlign='center';
            ctx.fillText('Coarseness Factor Chart ‚Äî M√©todo Shilstone', W/2, 26);

            // CF: 0-100 (X), WF: 0-50 (Y)
            const xS = cf => pad.l + (cf/100)*cW;
            const yS = wf => pad.t + cH - (wf/50)*cH;

            // Grid
            for(let i=0;i<=5;i++){
                const y = pad.t+(i/5)*cH;
                ctx.strokeStyle='#e2e8f0'; ctx.lineWidth=1;
                ctx.beginPath(); ctx.moveTo(pad.l,y); ctx.lineTo(pad.l+cW,y); ctx.stroke();
                ctx.fillStyle='#64748b'; ctx.font='10px Arial'; ctx.textAlign='right';
                ctx.fillText((50-i*10), pad.l-6, y+4);
            }
            for(let i=0;i<=5;i++){
                const x = pad.l+(i/5)*cW;
                ctx.strokeStyle='#e2e8f0'; ctx.lineWidth=1;
                ctx.beginPath(); ctx.moveTo(x,pad.t); ctx.lineTo(x,pad.t+cH); ctx.stroke();
                ctx.fillStyle='#64748b'; ctx.font='10px Arial'; ctx.textAlign='center';
                ctx.fillText(i*20, x, pad.t+cH+16);
            }

            // Axes
            ctx.strokeStyle='#94a3b8'; ctx.lineWidth=1.5;
            ctx.beginPath(); ctx.moveTo(pad.l,pad.t); ctx.lineTo(pad.l,pad.t+cH);
            ctx.lineTo(pad.l+cW,pad.t+cH); ctx.stroke();

            // Zone II ‚Äî Recommended (CF 55-75, WF 32-44) ‚Äî Green
            ctx.fillStyle='rgba(16,185,129,0.12)';
            ctx.fillRect(xS(55), yS(44), xS(75)-xS(55), yS(32)-yS(44));
            ctx.strokeStyle='#10b981'; ctx.lineWidth=1.5; ctx.setLineDash([5,3]);
            ctx.strokeRect(xS(55), yS(44), xS(75)-xS(55), yS(32)-yS(44));
            ctx.setLineDash([]);
            ctx.fillStyle='#065f46'; ctx.font='bold 11px Arial'; ctx.textAlign='center';
            ctx.fillText('Zone II', xS(65), yS(39));
            ctx.font='9px Arial'; ctx.fillText('(Recommended)', xS(65), yS(37));

            // Zone I ‚Äî Rocky/Harsh (CF > 75)
            ctx.fillStyle='rgba(239,68,68,0.08)';
            ctx.fillRect(xS(75), yS(50), xS(100)-xS(75), yS(20)-yS(50));
            ctx.fillStyle='#991b1b'; ctx.font='10px Arial'; ctx.textAlign='center';
            ctx.fillText('Zone I', xS(87), yS(40));
            ctx.font='9px Arial'; ctx.fillText('Rocky/Harsh', xS(87), yS(38));

            // Zone III ‚Äî Sandy/Over-sanded (CF < 55)
            ctx.fillStyle='rgba(245,158,11,0.10)';
            ctx.fillRect(xS(35), yS(50), xS(55)-xS(35), yS(20)-yS(50));
            ctx.fillStyle='#92400e'; ctx.font='10px Arial'; ctx.textAlign='center';
            ctx.fillText('Zone III', xS(45), yS(40));
            ctx.font='9px Arial'; ctx.fillText('Sandy', xS(45), yS(38));

            // Zone IV ‚Äî Mortar-rich (high WF)
            ctx.fillStyle='rgba(99,102,241,0.08)';
            ctx.fillRect(xS(35), yS(50), xS(100)-xS(35), yS(44)-yS(50));
            ctx.fillStyle='#4338ca'; ctx.font='9px Arial'; ctx.textAlign='left';
            ctx.fillText('Zone IV (Mortar-rich)', xS(36), yS(47));

            // Zone V ‚Äî Gap-graded (low WF)
            ctx.fillStyle='rgba(107,114,128,0.08)';
            ctx.fillRect(xS(35), yS(32), xS(100)-xS(35), yS(20)-yS(32));
            ctx.fillStyle='#374151'; ctx.font='9px Arial'; ctx.textAlign='left';
            ctx.fillText('Zone V (Gap-graded)', xS(36), yS(28));

            // Original point
            const drawPoint = (cf, wf, color, label) => {
                const x = xS(cf), y = yS(wf);
                ctx.fillStyle = color;
                ctx.beginPath(); ctx.arc(x, y, 9, 0, 2*Math.PI); ctx.fill();
                ctx.fillStyle='white'; ctx.font='bold 9px Arial'; ctx.textAlign='center';
                ctx.fillText(label, x, y+3);
                ctx.fillStyle=color; ctx.font='bold 10px Arial'; ctx.textAlign='left';
                ctx.fillText(`CF:${cf.toFixed(0)} WF:${wf.toFixed(1)}`, x+12, y+4);
            };

            if (origCF !== undefined) drawPoint(origCF, origWF, '#2563eb', 'O');
            if (optCF  !== undefined) drawPoint(optCF,  optWF,  '#10b981', 'A');

            // Axis labels
            ctx.fillStyle='#64748b'; ctx.font='10px Arial'; ctx.textAlign='center';
            ctx.fillText('Coarseness Factor (CF) ‚Äî % Retained > No.8 in Coarse Fraction', W/2, H-10);
            ctx.save(); ctx.translate(14, pad.t+cH/2); ctx.rotate(-Math.PI/2);
            ctx.fillText('Workability Factor (WF) ‚Äî % Passing No.8', 0, 0); ctx.restore();

            // Legend
            ctx.fillStyle='#2563eb'; ctx.beginPath();
            ctx.arc(pad.l, H-30, 7, 0, 2*Math.PI); ctx.fill();
            ctx.fillStyle='#374151'; ctx.font='10px Arial'; ctx.textAlign='left';
            ctx.fillText('O = Original', pad.l+12, H-26);
            if (optCF !== undefined) {
                ctx.fillStyle='#10b981'; ctx.beginPath();
                ctx.arc(pad.l+110, H-30, 7, 0, 2*Math.PI); ctx.fill();
                ctx.fillStyle='#374151';
                ctx.fillText('A = AI Optimizado', pad.l+122, H-26);
            }
        }

        // ---- Bar Chart Comparison ----
        function aiDrawBarChart(origR, optProps) {
            const canvas = document.getElementById('chart-ai-materiales');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const W = canvas.width, H = canvas.height;
            const pad = {t:30, r:20, b:70, l:58};
            const cW = W-pad.l-pad.r, cH = H-pad.t-pad.b;

            ctx.clearRect(0,0,W,H);
            ctx.fillStyle='#fff'; ctx.fillRect(0,0,W,H);

            const data = [
                {label:'Cemento', orig:origR.cemento.peso||0, opt:optProps.cemento_lb||0},
                {label:'Agua', orig:origR.agua.peso||0, opt:optProps.agua_lb||0},
                {label:'Grueso', orig:origR.grueso.peso||0, opt:optProps.grueso_lb||0},
                {label:'Arena 1', orig:origR.arena1.peso||0, opt:optProps.arena1_lb||0},
                {label:'Arena 2', orig:origR.arena2.peso||0, opt:optProps.arena2_lb||0},
            ];

            const maxV = Math.max(...data.flatMap(d=>[d.orig,d.opt])) * 1.1;
            const groupW = cW / data.length;
            const bW = groupW * 0.35;

            // Grid
            for (let i=0;i<=4;i++){
                const y = pad.t+(i/4)*cH;
                ctx.strokeStyle='#e2e8f0'; ctx.lineWidth=1;
                ctx.beginPath(); ctx.moveTo(pad.l,y); ctx.lineTo(pad.l+cW,y); ctx.stroke();
                ctx.fillStyle='#64748b'; ctx.font='9px Arial'; ctx.textAlign='right';
                ctx.fillText(((1-i/4)*maxV).toFixed(0), pad.l-5, y+3);
            }

            data.forEach((d,i) => {
                const gx = pad.l + i*groupW + groupW/2;
                // Original
                const oh = (d.orig/maxV)*cH;
                ctx.fillStyle='rgba(37,99,235,0.8)';
                ctx.fillRect(gx-bW-2, pad.t+cH-oh, bW, oh);
                // Optimized
                const nh = (d.opt/maxV)*cH;
                ctx.fillStyle='rgba(16,185,129,0.85)';
                ctx.fillRect(gx+2, pad.t+cH-nh, bW, nh);
                // Label
                ctx.fillStyle='#374151'; ctx.font='9px Arial'; ctx.textAlign='center';
                ctx.fillText(d.label, gx, pad.t+cH+13);
            });

            // Legend
            ctx.fillStyle='rgba(37,99,235,0.8)'; ctx.fillRect(pad.l, H-25, 12, 10);
            ctx.fillStyle='#374151'; ctx.font='10px Arial'; ctx.textAlign='left';
            ctx.fillText('Original', pad.l+15, H-17);
            ctx.fillStyle='rgba(16,185,129,0.85)'; ctx.fillRect(pad.l+80, H-25, 12, 10);
            ctx.fillText('AI Optimizado', pad.l+95, H-17);
        }

        // ---- Radar Chart ----
        function aiDrawRadar(scoresOrig, scoresOpt) {
            const canvas = document.getElementById('chart-ai-radar');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const W = canvas.width, H = canvas.height;
            const cx = W/2, cy = H/2+5, R = Math.min(W,H)/2 - 50;

            ctx.clearRect(0,0,W,H);
            ctx.fillStyle='#fff'; ctx.fillRect(0,0,W,H);

            const axes = ['overall','resistencia','trabajabilidad','gradacion','eficiencia_cemento','durabilidad','costo'];
            const lbls  = ['Overall','Resistencia','Trabajabilidad','Gradaci√≥n','Ef.Cemento','Durabilidad','Costo'];
            const n = axes.length;
            const angle = i => (i/n)*2*Math.PI - Math.PI/2;

            // Grid rings
            [20,40,60,80,100].forEach(ring => {
                ctx.beginPath(); ctx.strokeStyle='#e2e8f0'; ctx.lineWidth=1;
                axes.forEach((_,i) => {
                    const r = (ring/100)*R;
                    const a = angle(i);
                    i===0 ? ctx.moveTo(cx+r*Math.cos(a), cy+r*Math.sin(a))
                          : ctx.lineTo(cx+r*Math.cos(a), cy+r*Math.sin(a));
                });
                ctx.closePath(); ctx.stroke();
            });

            // Spokes
            axes.forEach((_,i) => {
                const a = angle(i);
                ctx.strokeStyle='#cbd5e1'; ctx.lineWidth=1;
                ctx.beginPath(); ctx.moveTo(cx,cy);
                ctx.lineTo(cx+R*Math.cos(a), cy+R*Math.sin(a)); ctx.stroke();
                // Labels
                const lx = cx+(R+22)*Math.cos(a), ly = cy+(R+22)*Math.sin(a);
                ctx.fillStyle='#374151'; ctx.font='bold 9px Arial'; ctx.textAlign='center';
                ctx.fillText(lbls[i], lx, ly+3);
            });

            const drawPoly = (scores, color, fill) => {
                ctx.beginPath();
                axes.forEach((key,i) => {
                    const v = Math.min(100,Math.max(0,scores[key]||0))/100;
                    const a = angle(i);
                    i===0 ? ctx.moveTo(cx+v*R*Math.cos(a), cy+v*R*Math.sin(a))
                          : ctx.lineTo(cx+v*R*Math.cos(a), cy+v*R*Math.sin(a));
                });
                ctx.closePath();
                ctx.fillStyle = fill; ctx.fill();
                ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.stroke();
            };

            drawPoly(scoresOrig, '#2563eb', 'rgba(37,99,235,0.2)');
            drawPoly(scoresOpt,  '#10b981', 'rgba(16,185,129,0.2)');

            // Legend
            ctx.fillStyle='#2563eb'; ctx.fillRect(15, H-28, 12, 10);
            ctx.fillStyle='#374151'; ctx.font='10px Arial'; ctx.textAlign='left';
            ctx.fillText('Original', 30, H-20);
            ctx.fillStyle='#10b981'; ctx.fillRect(100, H-28, 12, 10);
            ctx.fillText('AI Optimizado', 115, H-20);
        }

        // ---- MAIN: GRAFICAR GRADACION ----
        function aiGraficarGradacion() {
            const gd = aiGetGradacion();
            const p1 = gd.pct1, p2 = gd.pct2;

            // Coarse chart
            aiDrawLineChart('chart-grad-grueso',
                ['2"','1¬Ω"','1"','¬æ"','¬Ω"','‚Öú"','#4','#8'],
                [
                    {label:'Grueso', values:[gd.grueso['2in'],gd.grueso['1.5in'],gd.grueso['1in'],gd.grueso['0.75in'],gd.grueso['0.5in'],gd.grueso['0.375in'],gd.grueso.no4,gd.grueso.no8], color:'#2563eb', width:2.5},
                    {label:'ASTM Upper (Size 67)', values:[100,100,100,100,90,40,20,5], color:'#ef4444', dash:true},
                    {label:'ASTM Lower (Size 67)', values:[100,90,70,20,0,0,0,0], color:'#f59e0b', dash:true, width:1.5},
                ],
                'Curva Gradaci√≥n ‚Äî Agregado Grueso'
            );

            // Fine combined chart
            const a1vals = [gd.arena1['0.375in'],gd.arena1.no4,gd.arena1.no8,gd.arena1.no16,gd.arena1.no30,gd.arena1.no50,gd.arena1.no100,gd.arena1.no200];
            const a2vals = [gd.arena2['0.375in'],gd.arena2.no4,gd.arena2.no8,gd.arena2.no16,gd.arena2.no30,gd.arena2.no50,gd.arena2.no100,gd.arena2.no200];
            const combFine = a1vals.map((v,i) => v*p1 + a2vals[i]*p2);
            aiDrawLineChart('chart-grad-arena',
                ['‚Öú"','#4','#8','#16','#30','#50','#100','#200'],
                [
                    {label:'Arena 1', values:a1vals, color:'#f59e0b', width:2},
                    {label:'Arena 2', values:a2vals, color:'#10b981', width:2},
                    {label:'Combinada', values:combFine, color:'#7c3aed', width:3},
                    {label:'ASTM C33 Max', values:[100,100,100,85,70,60,30,3], color:'#ef4444', dash:true, width:1.5},
                    {label:'ASTM C33 Min', values:[100,95,80,50,25,10,2,0], color:'#94a3b8', dash:true, width:1.5},
                ],
                'Curva Gradaci√≥n ‚Äî Arenas (ASTM C33)'
            );

            // 0.45 Power chart (original only)
            const comb = aiGetCombinedPassing(gd);
            const pts045 = [comb.no200,comb.no100,comb.no50,comb.no30,comb.no16,comb.no8,comb.no4,comb['0.375in'],comb['0.5in'],comb['0.75in'],comb['1in'],comb['1.5in'],comb['2in']];
            aiDraw045Chart('chart-045power', pts045, null);
        }

        // ---- BUILD PROMPT ----
        function aiBuildPrompt(mix, gd, objetivo, exposicion, aplicacion, colocacion, origCF, origWF) {
            const r = mix.resultados;
            return `Eres un experto en tecnolog√≠a del concreto. Analiza y optimiza el siguiente mix design seg√∫n ACI 211.1, ACI 318, ACI 301, ASTM C150, ASTM C33, ASTM C494, y el M√©todo Shilstone.

MIX DESIGN ORIGINAL:
- Nombre: ${mix.nombre}
- Resistencia objetivo f'c: ${mix.resistencia} PSI
- Slump objetivo: ${mix.slump} in
- TMA: ${mix.tma} in
- Tipo Cemento: ${mix.tipoCemento}
- W/C original: ${r.wc.toFixed(3)}
- Aire: ${mix.contenidoAire||2.0}%

PROPORCIONES ORIGINALES (lb/yd¬≥):
- Cemento: ${r.cemento.peso.toFixed(1)}
- Agua Efectiva: ${r.agua.peso.toFixed(1)}
- Agregado Grueso: ${r.grueso.peso.toFixed(1)}
- Agregado Intermedio: ${r.intermedio.peso.toFixed(1)}
- Arena 1 (${mix.pctArena1||60}%): ${r.arena1.peso.toFixed(1)} ‚Äî MF: ${mix.mfArena1||2.8}
- Arena 2 (${mix.pctArena2||40}%): ${r.arena2.peso.toFixed(1)} ‚Äî MF: ${mix.mfArena2||3.2}
- MF Combinado: ${mix.mfCombinado||3.0}
- Sacos cemento: ${r.sacosCemento.toFixed(2)} sac/yd¬≥
- Costo total: $${r.costoTotal.toFixed(2)}/yd¬≥

AN√ÅLISIS SHILSTONE (calculado):
- Coarseness Factor (CF): ${origCF.toFixed(1)}
- Workability Factor (WF): ${origWF.toFixed(1)}

GRADACI√ìN INGRESADA:
Grueso (% pasando): 2"=${gd.grueso['2in']}, 1.5"=${gd.grueso['1.5in']}, 1"=${gd.grueso['1in']}, 3/4"=${gd.grueso['0.75in']}, 1/2"=${gd.grueso['0.5in']}, 3/8"=${gd.grueso['0.375in']}, #4=${gd.grueso.no4}, #8=${gd.grueso.no8}
Arena1 (% pasando): 3/8"=${gd.arena1['0.375in']}, #4=${gd.arena1.no4}, #8=${gd.arena1.no8}, #16=${gd.arena1.no16}, #30=${gd.arena1.no30}, #50=${gd.arena1.no50}, #100=${gd.arena1.no100}, #200=${gd.arena1.no200}
Arena2 (% pasando): 3/8"=${gd.arena2['0.375in']}, #4=${gd.arena2.no4}, #8=${gd.arena2.no8}, #16=${gd.arena2.no16}, #30=${gd.arena2.no30}, #50=${gd.arena2.no50}, #100=${gd.arena2.no100}, #200=${gd.arena2.no200}
Blend: Arena1=${(gd.pct1*100).toFixed(0)}%, Arena2=${(gd.pct2*100).toFixed(0)}%

PAR√ÅMETROS DE OPTIMIZACI√ìN:
- Objetivo: ${objetivo}
- Exposici√≥n ambiental: ${exposicion}
- Aplicaci√≥n estructural: ${aplicacion}
- M√©todo colocaci√≥n: ${colocacion}

Responde √öNICAMENTE con JSON v√°lido (sin markdown) con esta estructura:
{
  "scores_original": {"overall":<0-100>,"resistencia":<0-100>,"trabajabilidad":<0-100>,"gradacion":<0-100>,"eficiencia_cemento":<0-100>,"durabilidad":<0-100>,"costo":<0-100>},
  "scores_optimizado": {"overall":<0-100>,"resistencia":<0-100>,"trabajabilidad":<0-100>,"gradacion":<0-100>,"eficiencia_cemento":<0-100>,"durabilidad":<0-100>,"costo":<0-100>},
  "proporciones_optimizadas": {
    "cemento_lb":<number>,"agua_lb":<number>,"grueso_lb":<number>,
    "intermedio_lb":<number>,"arena1_lb":<number>,"arena2_lb":<number>,
    "pct_arena1":<0-100>,"pct_arena2":<0-100>,
    "wc_ratio":<number>,"aire_pct":<number>,"costo_estimado":<number>,
    "cf_optimizado":<number>,"wf_optimizado":<number>,
    "combined_passing_045":[<13 values matching sieves #200 to 2inch>]
  },
  "parametros": {
    "wc_original":${r.wc.toFixed(3)},"wc_optimizado":<number>,
    "slump_original":${mix.slump},"slump_esperado":<number>,
    "resistencia_original":${mix.resistencia},"resistencia_esperada":<number>,
    "cf_original":${origCF.toFixed(1)},"cf_optimizado":<number>,
    "wf_original":${origWF.toFixed(1)},"wf_optimizado":<number>,
    "sacos_original":${r.sacosCemento.toFixed(2)},"sacos_optimizado":<number>,
    "costo_original":${r.costoTotal.toFixed(2)},"costo_optimizado":<number>,
    "mf_combinado_original":${mix.mfCombinado||3.0},"mf_combinado_optimizado":<number>
  },
  "analisis": {
    "diagnostico":"<3-4 oraciones t√©cnicas sobre la mezcla original>",
    "problemas":["<problema 1>","<problema 2>"],
    "logica_optimizacion":"<3-4 oraciones explicando la optimizaci√≥n>",
    "beneficios":["<beneficio 1>","<beneficio 2>"],
    "zona_shilstone_original":"<Zone I|II|III|IV|V>",
    "zona_shilstone_optimizado":"<Zone I|II|III|IV|V>",
    "well_graded":true,
    "mf_recomendado":<number>
  },
  "recomendaciones":[
    {"categoria":"<Cemento|Agua|Agregados|Gradaci√≥n|Aditivos|Proceso|Durabilidad>","titulo":"<string>","descripcion":"<string>","estandar":"<ACI/ASTM ref>","prioridad":"<Alta|Media|Baja>"}
  ],
  "advertencias":[
    {"nivel":"<error|warning|info>","mensaje":"<string>","estandar":"<string>"}
  ]
}`;
        }

        // ---- MAIN: EJECUTAR AI OPTIMIZER ----
        async function ejecutarAIOptimizer() {
            const mixId = parseInt(document.getElementById('ai-mixdesign-select').value);
            if (!mixId) {
                alert('‚ö†Ô∏è Por favor selecciona un Mix Design para optimizar.');
                return;
            }

            const mix = await getRecord('mixdesigns', mixId);
            if (!mix || !mix.resultados) {
                alert('‚ùå Mix Design no encontrado o sin resultados calculados.');
                return;
            }

            const objetivo   = document.getElementById('ai-objetivo').value;
            const exposicion = document.getElementById('ai-exposicion').value;
            const aplicacion = document.getElementById('ai-aplicacion-struct').value;
            const colocacion = document.getElementById('ai-colocacion').value;
            const gd = aiGetGradacion();

            // Compute Shilstone factors
            const origCF = aiCalcCF(gd);
            const origWF = aiCalcWF(gd);

            // Show results card with loading
            document.getElementById('ai-results-card').style.display = 'block';
            document.getElementById('ai-loading-state').style.display = 'block';
            document.getElementById('ai-results-content').style.display = 'none';
            document.getElementById('ai-results-card').scrollIntoView({behavior:'smooth'});

            const log = msg => {
                const el = document.getElementById('ai-log');
                if (el) el.innerHTML += `> ${msg}<br>`;
            };
            document.getElementById('ai-log').innerHTML = '';

            log(`Mix seleccionado: ${mix.nombre} | ${mix.resistencia} PSI`);
            log(`W/C: ${mix.resultados.wc.toFixed(3)} | Cemento: ${mix.resultados.cemento.peso.toFixed(0)} lb/yd¬≥`);
            log(`Coarseness Factor calculado: ${origCF.toFixed(1)}`);
            log(`Workability Factor calculado: ${origWF.toFixed(1)}`);
            log(`Enviando a Claude AI (claude-sonnet-4-20250514)...`);

            const prompt = aiBuildPrompt(mix, gd, objetivo, exposicion, aplicacion, colocacion, origCF, origWF);

            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 4000,
                        system: "Eres un ingeniero experto en tecnolog√≠a del concreto. Respondes SIEMPRE en formato JSON puro sin markdown. Sin comentarios, sin backticks, solo JSON v√°lido.",
                        messages: [{role: "user", content: prompt}]
                    })
                });

                if (!response.ok) {
                    const err = await response.text();
                    throw new Error(`API Error ${response.status}: ${err}`);
                }

                const data = await response.json();
                log(`Respuesta recibida. Procesando resultados...`);

                const rawText = data.content.map(c => c.text||'').join('');
                // Clean possible markdown fences
                const cleanText = rawText.replace(/^```(?:json)?/gm,'').replace(/```$/gm,'').trim();

                let aiResult;
                try {
                    aiResult = JSON.parse(cleanText);
                } catch(pe) {
                    // Attempt to extract JSON
                    const m = cleanText.match(/\{[\s\S]*\}/);
                    if (m) aiResult = JSON.parse(m[0]);
                    else throw new Error(`No se pudo parsear JSON: ${pe.message}. Respuesta: ${cleanText.slice(0,200)}`);
                }

                log(`‚úÖ Optimizaci√≥n completada. Renderizando resultados...`);
                aiOptCurrentData = {mix, aiResult, gd, origCF, origWF};

                // Hide loading, show content
                document.getElementById('ai-loading-state').style.display = 'none';
                document.getElementById('ai-results-content').style.display = 'block';

                aiRenderResults(mix, aiResult, gd, origCF, origWF);
                document.getElementById('btn-export-ai').disabled = false;
                document.getElementById('btn-apply-opt').disabled = false;

            } catch (err) {
                log(`‚ùå ERROR: ${err.message}`);
                console.error('AI Optimizer Error:', err);
                // Keep loading state visible with error message
            }
        }

        // ---- RENDER RESULTS ----
        function aiRenderResults(mix, ai, gd, origCF, origWF) {
            const r   = mix.resultados;
            const opt = ai.proporciones_optimizadas;
            const so  = ai.scores_original  || {};
            const sn  = ai.scores_optimizado || {};

            // ---- SCORES GRID ----
            const scoreItems = [
                {key:'overall',            label:'‚≠ê Overall',       icon:'‚≠ê'},
                {key:'resistencia',        label:'üí™ Resistencia',   icon:'üí™'},
                {key:'trabajabilidad',     label:'üåä Trabajabilidad',icon:'üåä'},
                {key:'gradacion',          label:'üìä Gradaci√≥n',     icon:'üìä'},
                {key:'eficiencia_cemento', label:'üè≠ Ef.Cemento',    icon:'üè≠'},
                {key:'durabilidad',        label:'üõ°Ô∏è Durabilidad',   icon:'üõ°Ô∏è'},
                {key:'costo',              label:'üí∞ Costo',         icon:'üí∞'},
            ];

            document.getElementById('ai-scores-grid').innerHTML = scoreItems.map(item => {
                const o = so[item.key]||0, n = sn[item.key]||0;
                const d = n - o;
                const ds = d>0 ? `+${d}` : `${d}`;
                const dc = d>0 ? '#10b981' : d<0 ? '#ef4444' : '#64748b';
                const bc = n>=80 ? '#10b981' : n>=60 ? '#f59e0b' : '#ef4444';
                return `<div class="ai-score-card" style="border-color:${bc}30">
                    <div style="font-size:1.3em;margin-bottom:4px">${item.icon}</div>
                    <div style="font-size:11px;color:#64748b;font-weight:600;margin-bottom:8px">${item.label.split(' ').slice(1).join(' ')}</div>
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:6px">
                        <div style="text-align:center">
                            <div style="font-size:10px;color:#94a3b8">Orig</div>
                            <div style="font-size:1.5em;font-weight:800;color:${o>=80?'#10b981':o>=60?'#f59e0b':'#ef4444'}">${o}</div>
                        </div>
                        <div style="color:${dc};font-weight:800;font-size:1.1em">${ds}</div>
                        <div style="text-align:center">
                            <div style="font-size:10px;color:#94a3b8">AI</div>
                            <div style="font-size:1.5em;font-weight:800;color:${bc}">${n}</div>
                        </div>
                    </div>
                    <div style="background:#e2e8f0;border-radius:4px;height:5px;margin-top:8px">
                        <div style="background:${bc};height:100%;border-radius:4px;width:${n}%;transition:width 0.5s"></div>
                    </div>
                </div>`;
            }).join('');

            // ---- COMPARATIVA TABLE ----
            const mats = [
                {name:'Cemento',           orig:r.cemento.peso||0,    opt:opt.cemento_lb||0,    better:'lower'},
                {name:'Agua Efectiva',      orig:r.agua.peso||0,       opt:opt.agua_lb||0,       better:'lower'},
                {name:'Agregado Grueso',    orig:r.grueso.peso||0,     opt:opt.grueso_lb||0,     better:'neutral'},
                {name:'Ag. Intermedio',     orig:r.intermedio.peso||0, opt:opt.intermedio_lb||0, better:'neutral'},
                {name:'Arena 1',            orig:r.arena1.peso||0,     opt:opt.arena1_lb||0,     better:'neutral'},
                {name:'Arena 2',            orig:r.arena2.peso||0,     opt:opt.arena2_lb||0,     better:'neutral'},
            ];

            document.getElementById('ai-comparativa-tbody').innerHTML = mats.map(m => {
                const diff = m.opt - m.orig;
                const pct  = m.orig > 0 ? ((diff/m.orig)*100).toFixed(1) : '0.0';
                const cls = m.better === 'lower' ? (diff < -0.5 ? 'better-val' : diff > 0.5 ? 'worse-val' : 'neutral-val') : 'neutral-val';
                const arrow = diff < -0.5 ? '‚ñº' : diff > 0.5 ? '‚ñ≤' : '‚Äî';
                let eval_;
                if (m.name==='Cemento') eval_ = diff<-1?'‚úÖ Menor cemento':diff>1?'‚ö†Ô∏è Mayor cemento':'‚úÖ Sin cambio';
                else if (m.name==='Agua Efectiva') eval_ = diff<-1?'‚úÖ Menor W/C':diff>1?'‚ö†Ô∏è Mayor W/C':'‚úÖ Sin cambio';
                else eval_ = Math.abs(diff)<5?'‚Äî Ajuste menor':diff<-5?'‚ÑπÔ∏è Reducci√≥n':'‚ÑπÔ∏è Incremento';
                return `<tr>
                    <td><strong>${m.name}</strong></td>
                    <td style="text-align:right">${m.orig.toFixed(1)}</td>
                    <td style="text-align:right" class="${cls}">${m.opt.toFixed(1)}</td>
                    <td style="text-align:right" class="${cls}">${arrow} ${Math.abs(diff).toFixed(1)}</td>
                    <td style="text-align:right" class="${cls}">${pct}%</td>
                    <td>${eval_}</td>
                </tr>`;
            }).join('') + `<tr style="background:#f0f9ff;font-weight:700">
                <td colspan="6" style="padding:8px 12px;color:#1e40af;font-size:12px">
                    üìä Blend Optimizado: Grueso ${opt.pct_grueso||'‚Äî'}% / Intermedio ${opt.pct_intermedio||'‚Äî'}% / Arena1 ${opt.pct_arena1||'‚Äî'}% / Arena2 ${opt.pct_arena2||'‚Äî'}%
                    &nbsp;|&nbsp; CF: ${(ai.parametros?.cf_original||origCF).toFixed(1)} ‚Üí <strong>${(ai.parametros?.cf_optimizado||optCF).toFixed(1)}</strong>
                    &nbsp;|&nbsp; WF: ${(ai.parametros?.wf_original||origWF).toFixed(1)} ‚Üí <strong>${(ai.parametros?.wf_optimizado||optWF).toFixed(1)}</strong>
                    &nbsp;|&nbsp; ${ai.analisis?.zona_shilstone_original||'‚Äî'} ‚Üí <strong style="color:#10b981">${ai.analisis?.zona_shilstone_optimizado||'‚Äî'}</strong>
                </td>
            </tr>`;

            // ---- PARAMETERS COMPARISON ----
            const pc = ai.parametros || {};
            const paramItems = [
                {label:"W/C Ratio",          orig:pc.wc_original||r.wc,            opt:pc.wc_optimizado||r.wc,          unit:'',      lowerBetter:true,  fmt:3},
                {label:"f'c Estimada (Abrams)", orig:pc.resistencia_original||mix.resistencia, opt:pc.resistencia_esperada||mix.resistencia, unit:' PSI', lowerBetter:false, fmt:0, note:'Ley de Abrams: f\'c = 14000/4^(w/c)'},
                {label:"f'c Dise√±o",         orig:mix.resistencia,                  opt:mix.resistencia,                 unit:' PSI', lowerBetter:false, fmt:0, neutral:true},
                {label:'Slump (in)',          orig:pc.slump_original||mix.slump,     opt:pc.slump_esperado||mix.slump,    unit:' in',  lowerBetter:false, fmt:1},
                {label:'Coarseness Factor',   orig:pc.cf_original||origCF,           opt:pc.cf_optimizado||origCF,        unit:'',     lowerBetter:false, fmt:1},
                {label:'Workability Factor',  orig:pc.wf_original||origWF,           opt:pc.wf_optimizado||origWF,        unit:'',     lowerBetter:false, fmt:1},
                {label:'MF Combinado',        orig:pc.mf_combinado_original||mix.mfCombinado||3.0, opt:pc.mf_combinado_optimizado||3.0, unit:'', lowerBetter:false, fmt:2},
                {label:'Sacos/yd¬≥',           orig:pc.sacos_original||r.sacosCemento, opt:pc.sacos_optimizado||r.sacosCemento, unit:' sac', lowerBetter:true, fmt:2},
                {label:'Costo/yd¬≥',           orig:pc.costo_original||r.costoTotal,  opt:pc.costo_optimizado||r.costoTotal,   unit:'',    lowerBetter:true,  fmt:2, prefix:'$'},
            ];

            document.getElementById('ai-params-grid').innerHTML = paramItems.map(p => {
                const diff = p.opt - p.orig;
                const isNeutralItem = p.neutral || Math.abs(diff) < 0.01;
                const improved = isNeutralItem ? false : (p.lowerBetter ? diff <= -0.01 : diff >= 0.01);
                const color = isNeutralItem ? '#64748b' : improved ? '#10b981' : '#ef4444';
                const icon  = isNeutralItem ? '‚Äî' : improved ? '‚úÖ' : '‚ö†Ô∏è';
                const ds    = diff > 0 ? `+${diff.toFixed(p.fmt)}` : diff.toFixed(p.fmt);
                const pre   = p.prefix || '';
                return `<div class="ai-param-card" style="border-color:${color}">
                    <div style="font-weight:700;font-size:13px;color:#374151;margin-bottom:6px">${p.label}</div>
                    ${p.note ? `<div style="font-size:9px;color:#94a3b8;margin-bottom:6px;font-style:italic">${p.note}</div>` : ''}
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div>
                            <div style="font-size:10px;color:#94a3b8">Original</div>
                            <div style="font-size:1.2em;font-weight:700;color:#1e293b">${pre}${Number(p.orig).toFixed(p.fmt)}${p.unit}</div>
                        </div>
                        <div style="color:#94a3b8;font-size:1.2em">‚Üí</div>
                        <div>
                            <div style="font-size:10px;color:#94a3b8">Optimizado</div>
                            <div style="font-size:1.2em;font-weight:700;color:${color}">${pre}${Number(p.opt).toFixed(p.fmt)}${p.unit}</div>
                        </div>
                    </div>
                    <div style="text-align:right;font-size:11px;color:${color};margin-top:6px">${icon} ${isNeutralItem ? 'Sin cambio' : ds+p.unit}</div>
                </div>`;
            }).join('');

            // ---- CHARTS ----
            aiDrawBarChart(r, opt);
            aiDrawRadar(so, sn);

            // 0.45 Power Chart with comparison
            const combOrig = aiGetCombinedPassing(gd);
            const ptsOrig = [combOrig.no200,combOrig.no100,combOrig.no50,combOrig.no30,combOrig.no16,combOrig.no8,combOrig.no4,combOrig['0.375in'],combOrig['0.5in'],combOrig['0.75in'],combOrig['1in'],combOrig['1.5in'],combOrig['2in']];
            const ptsOpt = opt.combined_passing_045 || null;
            aiDraw045Chart('chart-045power-compare', ptsOrig, ptsOpt);

            // Coarseness Factor Chart ‚Äî pass both original AND optimized points
            const optCF = parseFloat(pc.cf_optimizado) || parseFloat(opt.cf_optimizado) || origCF;
            const optWF = parseFloat(pc.wf_optimizado) || parseFloat(opt.wf_optimizado) || origWF;
            aiDrawCoarsenessChart(origCF, origWF, optCF, optWF);

            // Shilstone info panel
            const zoneInfo = {
                'Zone I':   {color:'#fee2e2', border:'#ef4444', text:'Rocky / Harsh ‚Äî Mezcla con exceso de material grueso. Riesgo de segregaci√≥n y acabado dif√≠cil.'},
                'Zone II':  {color:'#dcfce7', border:'#10b981', text:'Zona √ìptima ‚Äî Buena trabajabilidad, resistencia y econom√≠a. Objetivo de dise√±o per ACI 211.'},
                'Zone III': {color:'#fef3c7', border:'#f59e0b', text:'Sandy / Over-sanded ‚Äî Exceso de arena. Mayor demanda de agua y cemento. Costo elevado.'},
                'Zone IV':  {color:'#dbeafe', border:'#2563eb', text:'Mortar-rich ‚Äî Alto contenido de finos. Buena trabajabilidad pero mayor costo y posible fisuras.'},
                'Zone V':   {color:'#f3f4f6', border:'#6b7280', text:'Gap-graded ‚Äî Distribuci√≥n discontinua. Posible segregaci√≥n y baja densidad.'},
            };
            const zan = ai.analisis || {};
            const zoO = zan.zona_shilstone_original || 'Zone II';
            const zoN = zan.zona_shilstone_optimizado || 'Zone II';
            const ziO = zoneInfo[zoO] || zoneInfo['Zone II'];
            const ziN = zoneInfo[zoN] || zoneInfo['Zone II'];
            document.getElementById('ai-shilstone-info').innerHTML = `
                <h4 style="color:#374151;margin-bottom:15px">üìç Zonas Shilstone</h4>
                <div style="background:${ziO.color};border-left:4px solid ${ziO.border};padding:12px;border-radius:0 6px 6px 0;margin-bottom:10px">
                    <div style="font-weight:700;color:#374151">Original: ${zoO}</div>
                    <div style="font-size:12px;color:#64748b;margin-top:4px">${ziO.text}</div>
                </div>
                <div style="background:${ziN.color};border-left:4px solid ${ziN.border};padding:12px;border-radius:0 6px 6px 0;margin-bottom:15px">
                    <div style="font-weight:700;color:#374151">AI Optimizado: ${zoN}</div>
                    <div style="font-size:12px;color:#64748b;margin-top:4px">${ziN.text}</div>
                </div>
                <div style="font-size:12px;color:#64748b">
                    <strong>CF Original:</strong> ${origCF.toFixed(1)} | <strong>WF Original:</strong> ${origWF.toFixed(1)}<br>
                    <strong>CF Optimizado:</strong> ${optCF.toFixed(1)} | <strong>WF Optimizado:</strong> ${optWF.toFixed(1)}<br>
                    <br><strong>Referencia:</strong> Shilstone JM (1990). Concrete Mixture Optimization. Concrete International.
                </div>
            `;

            // ---- AN√ÅLISIS ----
            const an = zan;
            document.getElementById('ai-analisis').innerHTML = `
                <div style="background:#f0f9ff;border-left:4px solid #2563eb;padding:18px;border-radius:0 8px 8px 0;margin-bottom:15px">
                    <h4 style="color:#1e40af;margin-bottom:10px">üîç Diagn√≥stico de la Mezcla Original</h4>
                    <p style="color:#374151;line-height:1.7">${an.diagnostico||'N/A'}</p>
                    ${(an.problemas||[]).length ? `<div style="margin-top:12px">
                        <strong style="color:#dc2626">‚ö†Ô∏è Problemas Identificados:</strong>
                        <ul style="margin:8px 0 0;padding-left:20px;color:#374151">
                            ${an.problemas.map(p=>`<li style="margin-bottom:4px">${p}</li>`).join('')}
                        </ul>
                    </div>` : ''}
                </div>
                <div style="background:#f0fdf4;border-left:4px solid #10b981;padding:18px;border-radius:0 8px 8px 0;margin-bottom:15px">
                    <h4 style="color:#065f46;margin-bottom:10px">üöÄ Estrategia de Optimizaci√≥n</h4>
                    <p style="color:#374151;line-height:1.7">${an.logica_optimizacion||'N/A'}</p>
                    ${(an.beneficios||[]).length ? `<div style="margin-top:12px">
                        <strong style="color:#059669">‚úÖ Beneficios Esperados:</strong>
                        <ul style="margin:8px 0 0;padding-left:20px;color:#374151">
                            ${an.beneficios.map(b=>`<li style="margin-bottom:4px">${b}</li>`).join('')}
                        </ul>
                    </div>` : ''}
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:12px">
                    <div style="background:#fef9ff;border:1px solid #d8b4fe;border-radius:8px;padding:14px;text-align:center">
                        <div style="font-size:11px;color:#6d28d9;font-weight:700">MF Combinado √ìptimo</div>
                        <div style="font-size:2em;font-weight:800;color:#7c3aed">${an.mf_recomendado||'2.8-3.2'}</div>
                        <div style="font-size:10px;color:#94a3b8">ACI 211.1 Ref.</div>
                    </div>
                    <div style="background:${an.well_graded?'#f0fdf4':'#fff7ed'};border:1px solid ${an.well_graded?'#86efac':'#fed7aa'};border-radius:8px;padding:14px;text-align:center">
                        <div style="font-size:11px;color:${an.well_graded?'#166534':'#c2410c'};font-weight:700">Gradaci√≥n</div>
                        <div style="font-size:1.5em;font-weight:800;color:${an.well_graded?'#16a34a':'#ea580c'}">${an.well_graded?'‚úÖ Well-Graded':'‚ö†Ô∏è Gap-Graded'}</div>
                        <div style="font-size:10px;color:#94a3b8">ASTM C33</div>
                    </div>
                    <div style="background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px;padding:14px;text-align:center">
                        <div style="font-size:11px;color:#0369a1;font-weight:700">Zona Shilstone Target</div>
                        <div style="font-size:1.5em;font-weight:800;color:#0284c7">${zoN}</div>
                        <div style="font-size:10px;color:#94a3b8">Shilstone Method</div>
                    </div>
                </div>
            `;

            // ---- RECOMMENDATIONS ----
            const catColors = {Alta:'#ef4444',Media:'#f59e0b',Baja:'#10b981'};
            const catIcons  = {Cemento:'üè≠',Agua:'üíß',Agregados:'ü™®',Gradaci√≥n:'üìä',Aditivos:'‚öóÔ∏è',Proceso:'‚öôÔ∏è',Durabilidad:'üõ°Ô∏è'};
            document.getElementById('ai-recomendaciones').innerHTML = (ai.recomendaciones||[]).map(rec => `
                <div class="ai-rec-card" style="border-left:4px solid ${catColors[rec.prioridad]||'#6d28d9'}">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;flex-wrap:wrap;gap:6px">
                        <span style="font-weight:700;color:#1e293b;font-size:15px">${catIcons[rec.categoria]||'üìã'} ${rec.titulo}</span>
                        <div style="display:flex;gap:6px;flex-shrink:0">
                            <span style="background:${catColors[rec.prioridad]||'#6d28d9'}20;color:${catColors[rec.prioridad]||'#6d28d9'};padding:2px 10px;border-radius:12px;font-size:11px;font-weight:700">${rec.prioridad}</span>
                            <span style="background:#e0e7ff;color:#4338ca;padding:2px 10px;border-radius:12px;font-size:11px;font-weight:600">${rec.estandar}</span>
                        </div>
                    </div>
                    <p style="color:#64748b;font-size:14px;line-height:1.6;margin:0">${rec.descripcion}</p>
                </div>
            `).join('') || '<p style="color:#64748b">No hay recomendaciones adicionales.</p>';

            // ---- WARNINGS ----
            const warnTypes = {
                error:   {bg:'#fee2e2', border:'#ef4444', icon:'üö®', textColor:'#991b1b'},
                warning: {bg:'#fef3c7', border:'#f59e0b', icon:'‚ö†Ô∏è', textColor:'#92400e'},
                info:    {bg:'#dbeafe', border:'#2563eb', icon:'‚ÑπÔ∏è', textColor:'#1e40af'},
            };
            if ((ai.advertencias||[]).length > 0) {
                document.getElementById('ai-warnings').innerHTML = `
                    <h3>‚ö†Ô∏è Advertencias y Notas</h3>
                    ${ai.advertencias.map(w => {
                        const t = warnTypes[w.nivel] || warnTypes.info;
                        return `<div style="background:${t.bg};border-left:4px solid ${t.border};padding:12px 15px;border-radius:0 6px 6px 0;margin-bottom:8px">
                            <span>${t.icon}</span>
                            <span style="color:${t.textColor};margin-left:8px">${w.mensaje}</span>
                            ${w.estandar ? `<span style="font-size:11px;color:#64748b;margin-left:8px">(${w.estandar})</span>` : ''}
                        </div>`;
                    }).join('')}`;
            }
        }

        // ---- EXPORT REPORT ----
        async function exportarReporteAI() {
            if (!aiOptCurrentData) { alert('No hay datos para exportar.'); return; }
            const {mix, aiResult, gd, origCF, origWF} = aiOptCurrentData;
            const r = mix.resultados, opt = aiResult.proporciones_optimizadas;
            const so = aiResult.scores_original||{}, sn = aiResult.scores_optimizado||{};
            const pc = aiResult.parametros||{};

            const html = `<!DOCTYPE html>
<html lang="es"><head><meta charset="UTF-8">
<title>AI Mix Optimization ‚Äî ${mix.nombre}</title>
<style>
body{font-family:Arial,sans-serif;margin:40px;color:#333;background:#fff;font-size:14px}
h1{color:#6d28d9;border-bottom:3px solid #6d28d9;padding-bottom:8px;margin-bottom:20px}
h2{color:#1e40af;margin-top:28px;border-bottom:1px solid #e2e8f0;padding-bottom:6px}
h3{color:#374151;margin-top:18px}
table{width:100%;border-collapse:collapse;margin:12px 0}
th{background:#6d28d9;color:white;padding:9px 12px;text-align:left;font-size:13px}
td{padding:9px 12px;border-bottom:1px solid #e2e8f0;font-size:13px}
tr:nth-child(even) td{background:#f8fafc}
.score-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin:12px 0}
.score-box{border:2px solid #e2e8f0;border-radius:6px;padding:10px;text-align:center}
.better{color:#10b981;font-weight:700} .worse{color:#ef4444;font-weight:700}
.rec{border-left:4px solid #6d28d9;background:#faf5ff;padding:12px 15px;margin:10px 0;border-radius:0 6px 6px 0}
.warn-w{border-left:4px solid #f59e0b;background:#fef3c7;padding:10px 12px;margin:8px 0}
.warn-e{border-left:4px solid #ef4444;background:#fee2e2;padding:10px 12px;margin:8px 0}
.warn-i{border-left:4px solid #2563eb;background:#dbeafe;padding:10px 12px;margin:8px 0}
.info-box{background:#f8fafc;border-radius:6px;padding:14px;border:1px solid #e2e8f0;margin:8px 0}
@media print{body{margin:20px;font-size:12px} h1{font-size:18px}}
</style></head><body>
<h1>ü§ñ AI Mix Design Optimization Report</h1>
<p><strong>Mix:</strong> ${mix.nombre} &nbsp;|&nbsp; <strong>Generado:</strong> ${new Date().toLocaleString('es-ES')}</p>
<p><strong>Resistencia:</strong> ${mix.resistencia} PSI &nbsp;|&nbsp; <strong>W/C Original:</strong> ${r.wc.toFixed(3)} &nbsp;|&nbsp; <strong>Costo Original:</strong> $${r.costoTotal.toFixed(2)}/yd¬≥</p>

<h2>‚≠ê Scores de Calidad</h2>
<div class="score-grid">
${['overall','resistencia','trabajabilidad','gradacion','eficiencia_cemento','durabilidad','costo'].map(k=>{
    const d=(sn[k]||0)-(so[k]||0);
    return `<div class="score-box"><div style="font-size:11px;color:#64748b">${k}</div>
    <div style="font-size:20px;font-weight:800">${so[k]||0} ‚Üí <span class="${d>=0?'better':'worse'}">${sn[k]||0}</span></div>
    <div style="font-size:11px;color:${d>=0?'#10b981':'#ef4444'}">${d>=0?'+':''}${d}</div></div>`;
}).join('')}
</div>

<h2>‚öñÔ∏è Proporciones Comparadas (lb/yd¬≥)</h2>
<table><thead><tr><th>Material</th><th>Original</th><th>AI Optimizado</th><th>Œî</th><th>%</th></tr></thead><tbody>
${[
    {n:'Cemento',o:r.cemento.peso||0,p:opt.cemento_lb||0},
    {n:'Agua',o:r.agua.peso||0,p:opt.agua_lb||0},
    {n:'Ag. Grueso',o:r.grueso.peso||0,p:opt.grueso_lb||0},
    {n:'Ag. Intermedio',o:r.intermedio.peso||0,p:opt.intermedio_lb||0},
    {n:'Arena 1',o:r.arena1.peso||0,p:opt.arena1_lb||0},
    {n:'Arena 2',o:r.arena2.peso||0,p:opt.arena2_lb||0},
].map(m=>{
    const d=m.p-m.o; const pct=m.o>0?((d/m.o)*100).toFixed(1):'0.0';
    const cls=(m.n==='Cemento'||m.n==='Agua')&&d<0?'better':d>0&&(m.n==='Cemento'||m.n==='Agua')?'worse':'';
    return `<tr><td><strong>${m.n}</strong></td><td>${m.o.toFixed(1)}</td>
    <td class="${cls}">${m.p.toFixed(1)}</td>
    <td class="${cls}">${d>0?'+':''}${d.toFixed(1)}</td>
    <td class="${cls}">${pct}%</td></tr>`;
}).join('')}
</tbody></table>

<h2>üìê Par√°metros T√©cnicos</h2>
<table><thead><tr><th>Par√°metro</th><th>Original</th><th>AI Optimizado</th><th>Evaluaci√≥n</th></tr></thead><tbody>
${[
    {n:'W/C Ratio',o:pc.wc_original||r.wc,p:pc.wc_optimizado||r.wc,lb:true,f:3},
    {n:'Slump (in)',o:pc.slump_original||mix.slump,p:pc.slump_esperado||mix.slump,lb:false,f:1},
    {n:'Resistencia Esperada (PSI)',o:pc.resistencia_original||mix.resistencia,p:pc.resistencia_esperada||mix.resistencia,lb:false,f:0},
    {n:'Coarseness Factor (CF)',o:pc.cf_original||origCF,p:pc.cf_optimizado||origCF,lb:false,f:1},
    {n:'Workability Factor (WF)',o:pc.wf_original||origWF,p:pc.wf_optimizado||origWF,lb:false,f:1},
    {n:'Sacos Cemento/yd¬≥',o:pc.sacos_original||r.sacosCemento,p:pc.sacos_optimizado||r.sacosCemento,lb:true,f:2},
    {n:'Costo/yd¬≥ ($)',o:pc.costo_original||r.costoTotal,p:pc.costo_optimizado||r.costoTotal,lb:true,f:2},
].map(p=>{
    const d=p.p-p.o; const impr=p.lb?d<=-0.01:d>=0.01;
    const ev=Math.abs(d)<0.01?'‚úÖ Sin cambio':impr?'‚úÖ Mejorado':'‚ö†Ô∏è Revisar';
    return `<tr><td>${p.n}</td><td>${Number(p.o).toFixed(p.f)}</td>
    <td class="${Math.abs(d)<0.01?'':impr?'better':'worse'}">${Number(p.p).toFixed(p.f)}</td>
    <td>${ev}</td></tr>`;
}).join('')}
</tbody></table>

<h2>üß† An√°lisis T√©cnico</h2>
<div class="info-box"><strong>Diagn√≥stico:</strong><p>${(aiResult.analisis||{}).diagnostico||''}</p></div>
${((aiResult.analisis||{}).problemas||[]).length?`<div class="info-box" style="border-color:#fca5a5"><strong>‚ö†Ô∏è Problemas Identificados:</strong><ul>${(aiResult.analisis.problemas||[]).map(p=>`<li>${p}</li>`).join('')}</ul></div>`:''}
<div class="info-box" style="border-color:#86efac"><strong>üöÄ Estrategia Optimizaci√≥n:</strong><p>${(aiResult.analisis||{}).logica_optimizacion||''}</p></div>
${((aiResult.analisis||{}).beneficios||[]).length?`<div class="info-box"><strong>‚úÖ Beneficios Esperados:</strong><ul>${(aiResult.analisis.beneficios||[]).map(b=>`<li>${b}</li>`).join('')}</ul></div>`:''}

<h2>‚úÖ Recomendaciones</h2>
${(aiResult.recomendaciones||[]).map(rec=>`<div class="rec">
<strong>${rec.titulo}</strong> <span style="background:#e0e7ff;color:#4338ca;padding:1px 8px;border-radius:10px;font-size:11px">${rec.estandar}</span>
<span style="background:#fef3c7;padding:1px 8px;border-radius:10px;font-size:11px;margin-left:4px">${rec.prioridad}</span>
<p style="margin:8px 0 0;color:#64748b">${rec.descripcion}</p>
</div>`).join('')}

${(aiResult.advertencias||[]).length?`<h2>‚ö†Ô∏è Advertencias</h2>
${(aiResult.advertencias||[]).map(w=>`<div class="warn-${w.nivel}">${w.mensaje} ${w.estandar?`(${w.estandar})`:''}</div>`).join('')}`:''}

<p style="margin-top:40px;text-align:center;color:#94a3b8;font-size:11px;border-top:1px solid #e2e8f0;padding-top:15px">
Sistema de Optimizaci√≥n AI de Concreto ‚Äî ACI 211.1 / ACI 318 / ASTM C33 / M√©todo Shilstone | ${new Date().toLocaleString('es-ES')}
</p>
</body></html>`;

            const blob = new Blob([html], {type:'text/html'});
            const url  = URL.createObjectURL(blob);
            const a    = document.createElement('a');
            a.href = url;
            a.download = `AI_Optimization_${mix.nombre.replace(/[^a-zA-Z0-9]/g,'_')}_${new Date().toISOString().slice(0,10)}.html`;
            document.body.appendChild(a); a.click();
            document.body.removeChild(a); URL.revokeObjectURL(url);
        }

        // ---- APPLY OPTIMIZED PROPORTIONS ----
        async function aplicarPropuestasOptimizadas() {
            if (!aiOptCurrentData) return;
            const {mix, aiResult} = aiOptCurrentData;
            const opt = aiResult.proporciones_optimizadas;

            if (!confirm(`¬øCrear un nuevo Mix Design con las proporciones optimizadas?\nSe abrir√° el formulario de Mix Design con los valores sugeridos.`)) return;

            // Switch to mix design tab and pre-fill
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab')[5].classList.add('active'); // Mix Design tab
            document.getElementById('tab-mixdesign').classList.add('active');

            // Pre-fill form
            setTimeout(() => {
                const safe = (id, val) => { const el = document.getElementById(id); if (el && val !== undefined) el.value = val; };
                safe('mix-nombre',     mix.nombre + ' ‚Äî AI Optimizado');
                safe('peso-cemento',   opt.cemento_lb?.toFixed(1));
                safe('peso-agua',      opt.agua_lb?.toFixed(1));
                safe('peso-grueso',    opt.grueso_lb?.toFixed(1));
                safe('peso-intermedio',opt.intermedio_lb?.toFixed(1));
                safe('pct-arena1',     opt.pct_arena1?.toFixed(0));
                safe('pct-arena2',     opt.pct_arena2?.toFixed(0));
                safe('contenido-aire', opt.aire_pct?.toFixed(1));
                safe('mix-resistencia',mix.resistencia);
                safe('mix-slump',      mix.slump);
                safe('mix-tma',        mix.tma);
                safe('tipo-cemento',   mix.tipoCemento);
                // Copy GE, abs, humidity from original
                ['ge','abs','hum'].forEach(p => {
                    ['cemento','grueso','intermedio','arena1','arena2'].forEach(m2 => {
                        const fid = `${p}-${m2}`, val = document.getElementById(fid)?.value;
                    });
                });
                alert('‚úÖ Formulario Mix Design pre-llenado con proporciones AI optimizadas.\nRevisa y ajusta los valores de gravedad espec√≠fica, absorci√≥n y humedad antes de calcular.');
                window.scrollTo({top:0, behavior:'smooth'});
            }, 200);
        }

        // ============================================================
        // ====  LIVE WORKABILITY vs COARSENESS CHART  ================
        // ============================================================
        function aiDrawLiveCFChart(cf, wf) {
            const canvas = document.getElementById('chart-wf-cf-live');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const W = canvas.width, H = canvas.height;
            const pad = {t:40, r:25, b:55, l:60};
            const cW = W-pad.l-pad.r, cH = H-pad.t-pad.b;

            ctx.clearRect(0,0,W,H);
            ctx.fillStyle='#faf5ff'; ctx.fillRect(0,0,W,H);

            // CF: X 0-100 | WF: Y 0-50
            const xS = v => pad.l + (v/100)*cW;
            const yS = v => pad.t + cH - (v/50)*cH;

            // Grid
            ctx.strokeStyle='#e2e8f0'; ctx.lineWidth=1;
            for(let i=0;i<=5;i++){
                const y=pad.t+(i/5)*cH;
                ctx.beginPath(); ctx.moveTo(pad.l,y); ctx.lineTo(pad.l+cW,y); ctx.stroke();
                ctx.fillStyle='#6b7280'; ctx.font='10px Arial'; ctx.textAlign='right';
                ctx.fillText((50-i*10), pad.l-6, y+3);
            }
            for(let i=0;i<=5;i++){
                const x=pad.l+(i/5)*cW;
                ctx.beginPath(); ctx.moveTo(x,pad.t); ctx.lineTo(x,pad.t+cH); ctx.stroke();
                ctx.fillStyle='#6b7280'; ctx.font='10px Arial'; ctx.textAlign='center';
                ctx.fillText(i*20, x, pad.t+cH+16);
            }

            // Zone backgrounds
            // Zone IV ‚Äî Mortar-rich (WF > 44) ‚Äî entire width
            ctx.fillStyle='rgba(99,102,241,0.08)';
            ctx.fillRect(xS(30), yS(50), xS(100)-xS(30), yS(44)-yS(50));
            // Zone V ‚Äî Gap-graded (WF < 32) ‚Äî entire width
            ctx.fillStyle='rgba(107,114,128,0.08)';
            ctx.fillRect(xS(30), yS(32), xS(100)-xS(30), yS(20)-yS(32));
            // Zone I ‚Äî Rocky/Harsh (CF > 75)
            ctx.fillStyle='rgba(239,68,68,0.09)';
            ctx.fillRect(xS(75), yS(44), xS(100)-xS(75), yS(32)-yS(44));
            // Zone III ‚Äî Sandy (CF < 55)
            ctx.fillStyle='rgba(245,158,11,0.10)';
            ctx.fillRect(xS(30), yS(44), xS(55)-xS(30), yS(32)-yS(44));
            // Zone II ‚Äî Optimal (CF 55-75, WF 32-44) ‚Äî GREEN
            ctx.fillStyle='rgba(16,185,129,0.15)';
            ctx.fillRect(xS(55), yS(44), xS(75)-xS(55), yS(32)-yS(44));
            ctx.strokeStyle='#10b981'; ctx.lineWidth=2; ctx.setLineDash([5,3]);
            ctx.strokeRect(xS(55), yS(44), xS(75)-xS(55), yS(32)-yS(44));
            ctx.setLineDash([]);

            // Zone labels
            const zoneLabel = (text, sub, x, y, color) => {
                ctx.fillStyle=color; ctx.font='bold 10px Arial'; ctx.textAlign='center';
                ctx.fillText(text, xS(x), yS(y));
                ctx.font='9px Arial'; ctx.fillText(sub, xS(x), yS(y)-12);
            };
            zoneLabel('Zone II','Optimal', 65, 38, '#065f46');
            zoneLabel('Zone I','Rocky', 87, 38, '#991b1b');
            zoneLabel('Zone III','Sandy', 43, 38, '#92400e');
            ctx.fillStyle='#3730a3'; ctx.font='9px Arial'; ctx.textAlign='left';
            ctx.fillText('Zone IV ‚Äî Mortar-rich (WF>44)', xS(31), yS(47));
            ctx.fillStyle='#374151'; ctx.textAlign='left';
            ctx.fillText('Zone V ‚Äî Gap-graded (WF<32)', xS(31), yS(29));

            // Axes
            ctx.strokeStyle='#7c3aed'; ctx.lineWidth=2; ctx.setLineDash([]);
            ctx.beginPath(); ctx.moveTo(pad.l,pad.t); ctx.lineTo(pad.l,pad.t+cH);
            ctx.lineTo(pad.l+cW,pad.t+cH); ctx.stroke();

            // Title
            ctx.fillStyle='#4c1d95'; ctx.font='bold 12px Arial'; ctx.textAlign='center';
            ctx.fillText('Coarseness Factor Chart ‚Äî M√©todo Shilstone', W/2, 22);

            // Axis labels
            ctx.fillStyle='#64748b'; ctx.font='10px Arial'; ctx.textAlign='center';
            ctx.fillText('Coarseness Factor (CF) ‚Äî % Q3/4 en fracci√≥n combinada', W/2, H-8);
            ctx.save(); ctx.translate(13, pad.t+cH/2); ctx.rotate(-Math.PI/2);
            ctx.fillText('Workability Factor (WF) ‚Äî % Pasa No.8', 0, 0); ctx.restore();

            // Plot current point with glow
            if (cf !== null && wf !== null && !isNaN(cf) && !isNaN(wf)) {
                const px = xS(Math.max(0,Math.min(100,cf)));
                const py = yS(Math.max(0,Math.min(50,wf)));
                // Glow
                ctx.shadowColor='#7c3aed'; ctx.shadowBlur=18;
                ctx.fillStyle='#7c3aed';
                ctx.beginPath(); ctx.arc(px,py,11,0,2*Math.PI); ctx.fill();
                ctx.shadowBlur=0;
                ctx.fillStyle='white'; ctx.font='bold 9px Arial'; ctx.textAlign='center';
                ctx.fillText('‚ú¶', px, py+3);
                // Label
                ctx.fillStyle='#4c1d95'; ctx.font='bold 11px Arial'; ctx.textAlign='left';
                const lx = px+14 > pad.l+cW-80 ? px-95 : px+14;
                ctx.fillText(`CF: ${cf.toFixed(1)}`, lx, py-3);
                ctx.fillText(`WF: ${wf.toFixed(1)}`, lx, py+11);
            }

            // Legend
            ctx.fillStyle='#7c3aed'; ctx.beginPath(); ctx.arc(pad.l+6, H-14, 6,0,2*Math.PI); ctx.fill();
            ctx.fillStyle='#374151'; ctx.font='10px Arial'; ctx.textAlign='left';
            ctx.fillText('Tu mezcla actual', pad.l+16, H-10);
        }

        // Auto-update live chart when sieve inputs change
        function aiUpdateLiveChart() {
            try {
                const gd = aiGetGradacion();
                const cf = aiCalcCF(gd);
                const wf = aiCalcWF(gd);
                aiDrawLiveCFChart(cf, wf);
                // Update panel values
                document.getElementById('live-cf-val').textContent = cf.toFixed(1);
                document.getElementById('live-wf-val').textContent = wf.toFixed(1);
                // Determine zone
                let zone, zoneBg, zoneColor, zoneDesc;
                if (cf >= 55 && cf <= 75 && wf >= 32 && wf <= 44) {
                    zone='Zone II ‚Äî √ìptima'; zoneBg='#dcfce7'; zoneColor='#166534';
                    zoneDesc='Excelente trabajabilidad, resistencia y econom√≠a. Objetivo ACI 211.';
                } else if (wf > 44) {
                    zone='Zone IV ‚Äî Mortero Rico'; zoneBg='#dbeafe'; zoneColor='#1e40af';
                    zoneDesc='Alto contenido de finos. Buena trabajabilidad pero mayor costo y posibles fisuras por retracci√≥n.';
                } else if (wf < 32) {
                    zone='Zone V ‚Äî Gap-Graded'; zoneBg='#f3f4f6'; zoneColor='#374151';
                    zoneDesc='Distribuci√≥n discontinua. Posible segregaci√≥n y baja densidad. Revisar curva gradaci√≥n.';
                } else if (cf > 75) {
                    zone='Zone I ‚Äî Rocky/Harsh'; zoneBg='#fee2e2'; zoneColor='#991b1b';
                    zoneDesc='Exceso de material grueso. Riesgo de segregaci√≥n y acabado dif√≠cil. Aumentar arena.';
                } else {
                    zone='Zone III ‚Äî Over-Sanded'; zoneBg='#fef3c7'; zoneColor='#92400e';
                    zoneDesc='Exceso de arena. Mayor demanda de agua y cemento. Reducir % finos o ajustar blend.';
                }
                const badge = document.getElementById('live-zona-badge');
                const desc  = document.getElementById('live-zona-desc');
                badge.style.background = zoneBg;
                badge.style.color = zoneColor;
                badge.textContent = zone;
                desc.textContent = zoneDesc;
            } catch(e) {
                aiDrawLiveCFChart(null, null);
            }
        }

        // Attach live update listeners to all sieve inputs
        function aiAttachSieveLiveListeners() {
            const ids = [
                'sg-2in','sg-1.5in','sg-1in','sg-0.75in','sg-0.5in','sg-0.375in','sg-4','sg-8',
                'si-2in','si-1.5in','si-1in','si-0.75in','si-0.5in','si-0.375in','si-4','si-8',
                'sa1-0.375in','sa1-4','sa1-8','sa1-16','sa1-30','sa1-50','sa1-100','sa1-200',
                'sa2-0.375in','sa2-4','sa2-8','sa2-16','sa2-30','sa2-50','sa2-100','sa2-200',
                'pct-grueso-ai','pct-intermedio-ai','pct-arena1-ai','pct-arena2-ai'
            ];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', aiUpdateLiveChart);
            });
            // Initial draw
            aiDrawLiveCFChart(null, null);
        }

        // ============================================================
        // ====  LOCAL OPTIMIZATION ENGINE  ===========================
        // ============================================================
        function ejecutarOptimizacionLocal() {
            const mixId = parseInt(document.getElementById('ai-mixdesign-select').value);
            if (!mixId) { alert('‚ö†Ô∏è Por favor selecciona un Mix Design para optimizar.'); return; }

            getRecord('mixdesigns', mixId).then(mix => {
                if (!mix || !mix.resultados) {
                    alert('‚ùå Mix Design no encontrado o sin resultados calculados.');
                    return;
                }

                const objetivo   = document.getElementById('ai-objetivo').value;
                const exposicion = document.getElementById('ai-exposicion').value;
                const aplicacion = document.getElementById('ai-aplicacion-struct').value;
                const colocacion = document.getElementById('ai-colocacion').value;
                const gd = aiGetGradacion();
                const origCF = aiCalcCF(gd);
                const origWF = aiCalcWF(gd);

                // Show loading
                document.getElementById('ai-results-card').style.display = 'block';
                document.getElementById('ai-loading-state').style.display = 'block';
                document.getElementById('ai-results-content').style.display = 'none';
                document.getElementById('ai-results-card').scrollIntoView({behavior:'smooth'});

                const log = msg => {
                    const el = document.getElementById('ai-log');
                    if (el) el.innerHTML += `> ${msg}<br>`;
                };
                document.getElementById('ai-log').innerHTML = '';

                log(`Mix: ${mix.nombre} | ${mix.resistencia} PSI`);
                log(`W/C: ${mix.resultados.wc.toFixed(3)} | Cemento: ${mix.resultados.cemento.peso.toFixed(0)} lb/yd¬≥`);
                log(`Coarseness Factor: ${origCF.toFixed(1)} | Workability Factor: ${origWF.toFixed(1)}`);
                log(`Objetivo: ${objetivo} | Exposici√≥n: ${exposicion}`);
                log(`Calculando con Motor Local ACI 211.1 / Shilstone...`);

                setTimeout(() => {
                    try {
                        const aiResult = localOptimizationEngine(mix, gd, objetivo, exposicion, aplicacion, colocacion, origCF, origWF);
                        log(`‚úÖ Optimizaci√≥n completada. Renderizando resultados...`);
                        aiOptCurrentData = {mix, aiResult, gd, origCF, origWF};

                        document.getElementById('ai-loading-state').style.display = 'none';
                        document.getElementById('ai-results-content').style.display = 'block';

                        aiRenderResults(mix, aiResult, gd, origCF, origWF);
                        document.getElementById('btn-export-ai').disabled = false;
                        document.getElementById('btn-apply-opt').disabled = false;
                    } catch(err) {
                        log(`‚ùå ERROR: ${err.message}`);
                        console.error('Local Optimizer Error:', err);
                    }
                }, 400);
            });
        }

        // ============================================================
        // ====  ABRAMS LAW ‚Äî f'c estimada desde W/C  =================
        // Abrams: f'c = A / B^(w/c)   calibrado a PSI
        // A‚âà14000, B‚âà4.0 para cemento Tipo I (aprox ASTM C150)
        // ============================================================
        function abramsFC(wc) {
            return Math.round(14000 / Math.pow(4.0, wc));
        }
        // Inverse Abrams: target W/C to achieve fc
        function abramsWC(fc_target) {
            return Math.log(14000 / fc_target) / Math.log(4.0);
        }

        // ---- The optimization engine ‚Äî fully differentiated by objective ----
        function localOptimizationEngine(mix, gd, objetivo, exposicion, aplicacion, colocacion, origCF, origWF) {
            const r = mix.resultados;
            const wc_orig   = r.wc || 0.5;
            const fc_design = mix.resistencia || 3000;
            const slump     = parseFloat(mix.slump) || 4;
            const tma       = parseFloat(mix.tma) || 0.75;
            const tipoCemento = mix.tipoCemento || 'Tipo I';

            // ---- ACI 211.1: water demand by slump & TMA ----
            // Approximate non-air-entrained (lb/yd¬≥)
            const waterDemandTable = {
                0.375: {1:350,2:335,3:315,4:300,5:290},
                0.5:   {1:335,2:325,3:305,4:295,5:280},
                0.75:  {1:315,2:300,3:285,4:275,5:265},
                1.0:   {1:300,2:285,3:270,4:260,5:250},
                1.5:   {1:275,2:260,3:250,4:240,5:235},
            };
            const closestTMA = [0.375,0.5,0.75,1.0,1.5].reduce((a,b) => Math.abs(b-tma)<Math.abs(a-tma)?b:a);
            const slumpKey = Math.min(5, Math.max(1, Math.round(slump)));
            const waterDemandBase = (waterDemandTable[closestTMA]||{})[slumpKey] || r.agua.peso || 280;

            // ---- W/C limits by exposure (ACI 318-19 Table 19.3.2) ----
            const wcMaxByExposure = {mild:0.60, moderate:0.55, severe:0.45, marine:0.40, sulfate:0.45};
            const wcMax = wcMaxByExposure[exposicion] || 0.55;
            // ACI 318 minimum f'c by exposure
            const fcMinByExposure = {mild:2500, moderate:3000, severe:4000, marine:4500, sulfate:4000};
            const fcMin = fcMinByExposure[exposicion] || 2500;
            const fc_required = Math.max(fc_design, fcMin);

            // ---- Abrams-law based f'c estimates ----
            const fc_orig_est = abramsFC(wc_orig);   // estimated strength at original W/C
            const fcOverdesign = fc_orig_est - fc_design; // how much margin exists

            // ============================================================
            // OBJECTIVE-SPECIFIC STRATEGY
            // Each objective gets a unique W/C, water, cement, and agg logic
            // ============================================================
            let wcTarget, waterOpt, slumpOpt, strategy;

            if (objetivo === 'strength') {
                // Push W/C down to achieve maximum practical strength
                // Target: ~20% over required fc (ACI over-design factor)
                const fc_target_strength = fc_design * 1.25;
                wcTarget = Math.min(wc_orig, abramsWC(fc_target_strength));
                wcTarget = Math.max(wcTarget, 0.30); // practical minimum
                // Reduce water proportionally, keep slump via HRWR suggestion
                waterOpt = waterDemandBase * 0.92; // assume Type F reducer
                slumpOpt = slump;
                strategy = `Maximizar Resistencia: W/C reducida a ${wcTarget.toFixed(3)} para alcanzar f'c estimada de ${abramsFC(wcTarget).toLocaleString()} PSI (Ley de Abrams). Se asume reductor de agua Tipo F (ASTM C494) para mantener slump. Cemento aumentado para compensar menor W/C.`;

            } else if (objetivo === 'cost') {
                // Maximize W/C up to exposure limit (less cement, same strength)
                // Use existing overdesign margin if any
                const fc_for_cost = Math.max(fc_required * 1.10, fc_design); // keep 10% margin
                const wc_cost = abramsWC(fc_for_cost);
                wcTarget = Math.min(wc_cost, wcMax, wc_orig + 0.04);
                wcTarget = Math.min(wcTarget, wcMax);
                // Increase coarse aggregate ‚Äî reduces paste volume = cost
                waterOpt = waterDemandBase * 1.00; // no change in water
                slumpOpt = slump;
                strategy = `Minimizar Costo: W/C ajustada a ${wcTarget.toFixed(3)} usando margen de sobredise√±o (f'c estimada original: ${fc_orig_est.toLocaleString()} PSI vs requerida: ${fc_design.toLocaleString()} PSI). Mayor contenido de grueso reduce volumen de pasta. Ahorro estimado en cemento.`;

            } else if (objetivo === 'workability') {
                // Keep W/C, increase water demand slightly, target WF higher (38-44)
                wcTarget = Math.min(wc_orig, wcMax);
                waterOpt = waterDemandBase * 1.03; // slightly more water for workability
                slumpOpt = Math.min(slump + 1, 7);
                strategy = `Maximizar Trabajabilidad: W/C mantenida en ${wcTarget.toFixed(3)} con ligero aumento de agua (demanda ACI 211.1). Target WF=38-44 (Zone II alto). Para bombeo se asegura m√≠nimo WF=37. Slump esperado ${slumpOpt}".`;

            } else if (objetivo === 'durability') {
                // Strict W/C below exposure limit, lower water, high cement
                wcTarget = Math.min(wc_orig, wcMax - 0.03);
                wcTarget = Math.max(wcTarget, 0.32);
                waterOpt = waterDemandBase * 0.95; // reduce water for durability
                slumpOpt = Math.max(slump - 0.5, 2);
                strategy = `Maximizar Durabilidad: W/C reducida a ${wcTarget.toFixed(3)}, estrictamente menor al m√°ximo ACI 318 de ${wcMax} para exposici√≥n ${exposicion}. Agua reducida para menor porosidad. f'c estimada: ${abramsFC(wcTarget).toLocaleString()} PSI.`;

            } else if (objetivo === 'sustainability') {
                // Use overdesign margin to reduce cement ‚Äî SCM replacement
                // W/C can increase slightly if fc_orig_est >> fc_design
                const fc_sust = Math.max(fc_required * 1.05, fc_design);
                const wc_sust = abramsWC(fc_sust);
                wcTarget = Math.min(wc_sust, wcMax, wc_orig + 0.06);
                wcTarget = Math.min(wcTarget, wcMax);
                waterOpt = waterDemandBase * 0.97;
                slumpOpt = slump;
                strategy = `Sostenibilidad: W/C optimizada a ${wcTarget.toFixed(3)} usando margen de sobredise√±o. Reducci√≥n de cemento de ${Math.round((r.cemento.peso||500)-(waterOpt/wcTarget))} lb/yd¬≥. Recomienda reemplazo 20-25% cemento con puzolana/GGBS. f'c estimada: ${abramsFC(wcTarget).toLocaleString()} PSI.`;

            } else if (objetivo === 'shilstone_zone2') {
                // Zone II iterative solver ‚Äî handled in aggregate section below
                wcTarget = Math.min(wc_orig, wcMax);
                waterOpt = waterDemandBase;
                slumpOpt = slump;
                strategy = `Optimizaci√≥n Shilstone Zone II: b√∫squeda iterativa de proporciones de blend (Grueso/Intermedio/Arena1/Arena2) que minimicen la distancia al centro de Zone II (CF=65, WF=38). W/C mantenida en ${wcTarget.toFixed(3)}. Se ajustan las 4 fracciones de agregado conservando la proporci√≥n total de pasta (cemento y agua).`;
            } else {
                // balanced ‚Äî meet exposure limit, target Zone II, minimize waste
                const wc_bal = Math.min(wc_orig, wcMax);
                wcTarget = wc_bal;
                waterOpt = waterDemandBase * 0.98;
                slumpOpt = slump;
                strategy = `Optimizaci√≥n Balanceada: W/C ajustada a ${wcTarget.toFixed(3)} cumpliendo exposici√≥n ${exposicion} (ACI 318 m√°x: ${wcMax}). Balance entre resistencia, trabajabilidad y costo. f'c estimada: ${abramsFC(wcTarget).toLocaleString()} PSI.`;
            }

            wcTarget = parseFloat(Math.min(wcTarget, wcMax).toFixed(3));
            const cementOpt = waterOpt / wcTarget;
            const fc_est_orig = abramsFC(wc_orig);
            const fc_est_opt  = abramsFC(wcTarget);

            // ---- Shilstone target per objective ----
            const shilstoneTarget = {
                strength:       {cfMin:58, cfMax:70, wfMin:33, wfMax:40},
                cost:           {cfMin:62, cfMax:76, wfMin:32, wfMax:40},
                workability:    {cfMin:55, cfMax:68, wfMin:37, wfMax:45},
                durability:     {cfMin:58, cfMax:72, wfMin:34, wfMax:42},
                sustainability: {cfMin:60, cfMax:74, wfMin:33, wfMax:41},
                balanced:       {cfMin:55, cfMax:75, wfMin:32, wfMax:44},
                shilstone_zone2:{cfMin:60, cfMax:70, wfMin:35, wfMax:42},
            };
            const st = shilstoneTarget[objetivo] || shilstoneTarget.balanced;
            const cfCenter = (st.cfMin + st.cfMax) / 2;  // e.g. 65
            const wfCenter = (st.wfMin + st.wfMax) / 2;  // e.g. 38

            // Starting blend fractions
            let pGNew = gd.pctG, pINew = gd.pctI, pct1New = gd.pct1, pct2New = gd.pct2;

            if (objetivo === 'shilstone_zone2') {
                // ---- Iterative grid search: 4D blend ‚Üí minimize distance to Zone II center ----
                // Constraints: all >= 5%, sum = 1, grueso+inter >= 30%, fine >= 20%
                let bestDist = Infinity, bestG = pGNew, bestI = pINew, best1 = pct1New, best2 = pct2New;
                const step = 0.05;
                for (let g = 0.20; g <= 0.55; g += step) {
                    for (let i = 0.05; i <= 0.30; i += step) {
                        for (let a1 = 0.10; a1 <= 0.55; a1 += step) {
                            const a2 = 1 - g - i - a1;
                            if (a2 < 0.05 || a2 > 0.55) continue;
                            const testGd = {...gd, pctG:g, pctI:i, pct1:a1, pct2:a2};
                            const testCF = aiCalcCF(testGd);
                            const testWF = aiCalcWF(testGd);
                            // Distance to Zone II center, penalize out-of-zone
                            const cfPenalty = testCF < st.cfMin ? (st.cfMin - testCF)*2 : testCF > st.cfMax ? (testCF - st.cfMax)*2 : 0;
                            const wfPenalty = testWF < st.wfMin ? (st.wfMin - testWF)*3 : testWF > st.wfMax ? (testWF - st.wfMax)*3 : 0;
                            const dist = Math.pow(testCF - cfCenter, 2) + Math.pow((testWF - wfCenter)*2, 2) + cfPenalty*10 + wfPenalty*10;
                            if (dist < bestDist) { bestDist = dist; bestG=g; bestI=i; best1=a1; best2=a2; }
                        }
                    }
                }
                pGNew = bestG; pINew = bestI; pct1New = best1; pct2New = bestG+bestI+best1 > 0.95 ? 1-bestG-bestI-best1 : best2;
                // Refine with smaller step around best
                const rStep = 0.01;
                for (let g = Math.max(0.15, bestG-0.06); g <= Math.min(0.55, bestG+0.06); g += rStep) {
                    for (let i = Math.max(0.05, bestI-0.06); i <= Math.min(0.30, bestI+0.06); i += rStep) {
                        for (let a1 = Math.max(0.10, best1-0.06); a1 <= Math.min(0.55, best1+0.06); a1 += rStep) {
                            const a2 = 1 - g - i - a1;
                            if (a2 < 0.05 || a2 > 0.55) continue;
                            const testGd = {...gd, pctG:g, pctI:i, pct1:a1, pct2:a2};
                            const testCF = aiCalcCF(testGd);
                            const testWF = aiCalcWF(testGd);
                            const cfPenalty = testCF < st.cfMin ? (st.cfMin - testCF)*2 : testCF > st.cfMax ? (testCF - st.cfMax)*2 : 0;
                            const wfPenalty = testWF < st.wfMin ? (st.wfMin - testWF)*3 : testWF > st.wfMax ? (testWF - st.wfMax)*3 : 0;
                            const dist = Math.pow(testCF - cfCenter, 2) + Math.pow((testWF - wfCenter)*2, 2) + cfPenalty*10 + wfPenalty*10;
                            if (dist < bestDist) { bestDist = dist; pGNew=g; pINew=i; pct1New=a1; pct2New=a2; }
                        }
                    }
                }
            } else {
                // For other objectives: adjust blend based on CF/WF direction
                if (origCF > st.cfMax) {
                    pGNew = Math.max(0.20, gd.pctG - 0.05);
                    pINew = Math.max(0.05, gd.pctI - 0.03);
                    pct1New = Math.min(0.50, gd.pct1 + 0.05);
                } else if (origCF < st.cfMin) {
                    pGNew = Math.min(0.50, gd.pctG + 0.04);
                    pINew = Math.min(0.25, gd.pctI + 0.02);
                    pct1New = Math.max(0.15, gd.pct1 - 0.04);
                }
                if (origWF > st.wfMax) {
                    pct1New = Math.max(0.15, pct1New - 0.04);
                    pGNew   = Math.min(0.50, pGNew + 0.03);
                } else if (origWF < st.wfMin) {
                    pct1New = Math.min(0.50, pct1New + 0.04);
                }
                if (objetivo === 'workability' && colocacion === 'pump') pct1New = Math.min(0.55, pct1New + 0.04);
                if (objetivo === 'cost') { pGNew = Math.min(0.50, pGNew + 0.03); pINew = Math.min(0.25, pINew + 0.02); }
                if (objetivo === 'durability') { pGNew = Math.min(0.45, Math.max(0.25, pGNew)); pINew = Math.min(0.20, Math.max(0.10, pINew)); }
                // Re-normalize
                const rawTotal = pGNew + pINew + pct1New;
                if (rawTotal >= 1) { pGNew *= 0.9/rawTotal; pINew *= 0.9/rawTotal; pct1New *= 0.9/rawTotal; }
                pct2New = Math.max(0.05, 1 - pGNew - pINew - pct1New);
                const t2 = pGNew + pINew + pct1New + pct2New;
                pGNew /= t2; pINew /= t2; pct1New /= t2; pct2New /= t2;
            }

            // Normalize final blend to sum exactly 1
            const blendSum = pGNew + pINew + pct1New + pct2New;
            pGNew   = parseFloat((pGNew   / blendSum).toFixed(4));
            pINew   = parseFloat((pINew   / blendSum).toFixed(4));
            pct1New = parseFloat((pct1New / blendSum).toFixed(4));
            pct2New = parseFloat(Math.max(0.05, 1 - pGNew - pINew - pct1New).toFixed(4));

            const gdOpt = {...gd, pctG: pGNew, pctI: pINew, pct1: pct1New, pct2: pct2New};
            const optCF = aiCalcCF(gdOpt);
            const optWF = aiCalcWF(gdOpt);

            // ---- Aggregate weights ----
            const grossOrig  = r.grueso.peso     || 0;
            const interOrig  = r.intermedio.peso || 0;
            const arena1Orig = r.arena1.peso     || 0;
            const arena2Orig = r.arena2.peso     || 0;
            const totalAgg   = grossOrig + interOrig + arena1Orig + arena2Orig;

            // Redistribute total aggregate by optimized fractions
            const coarseMult = {
                strength: 0.97, cost: 1.05, workability: 0.94,
                durability: 1.00, sustainability: 1.02, balanced: 1.00, shilstone_zone2: 1.00,
            }[objetivo] || 1.0;

            const grossOpt  = totalAgg * pGNew  * coarseMult;
            const interOpt  = totalAgg * pINew  * coarseMult;
            const arena1Opt = totalAgg * pct1New;
            const arena2Opt = totalAgg * pct2New;

            // ---- Cost model ----
            // Cost driven by: cement price (~$0.18/lb), aggregates (~$0.02/lb), water (~$0.001/lb)
            const costPerLbCement = 0.18, costPerLbAgg = 0.02, costPerLbWater = 0.001;
            const costOrig = (r.cemento.peso||500)*costPerLbCement + (r.agua.peso||280)*costPerLbWater
                           + (grossOrig+interOrig+arena1Orig+arena2Orig)*costPerLbAgg;
            const costOpt  = cementOpt*costPerLbCement + waterOpt*costPerLbWater
                           + (grossOpt+interOpt+arena1Opt+arena2Opt)*costPerLbAgg;
            // Use actual saved cost or fallback to r.costoTotal proportional
            const costOptFinal = r.costoTotal ? r.costoTotal * (costOpt / Math.max(costOrig, costOpt)) : costOpt;

            // ---- Zones ----
            const getZone = (cf, wf) => {
                if (wf > 44) return 'Zone IV';
                if (wf < 32) return 'Zone V';
                if (cf > 75) return 'Zone I';
                if (cf < 55) return 'Zone III';
                return 'Zone II';
            };
            const zoneOrig = getZone(origCF, origWF);
            const zoneOpt  = getZone(optCF, optWF);

            // ---- Scores (objective-aware) ----
            const scoreOrig = calcLocalScores(r.cemento.peso||500, r.agua.peso||280, wc_orig, origCF, origWF,
                                              fc_design, fc_est_orig, r.costoTotal||costOrig, r.sacosCemento||(r.cemento.peso/94), objetivo, exposicion);
            const scoreOpt  = calcLocalScores(cementOpt, waterOpt, wcTarget, optCF, optWF,
                                              fc_design, fc_est_opt, costOptFinal, cementOpt/94, objetivo, exposicion);

            // ---- Slump adjustment note ----
            const slumpNote = wcTarget < wc_orig - 0.02 ? ` Reducci√≥n de W/C puede afectar trabajabilidad ‚Äî verificar slump objetivo ${slump}".` : '';

            // ---- Recommendations by objective ----
            const recs = [];

            // Exposure-based
            if (wc_orig > wcMax) recs.push({categoria:'Durabilidad',titulo:`W/C excede l√≠mite ACI 318 para exposici√≥n ${exposicion}`,descripcion:`W/C=${wc_orig.toFixed(3)} > m√°ximo ${wcMax}. Reducir agua libre o aumentar cemento. Riesgo de ataque qu√≠mico y permeabilidad excesiva.`,estandar:'ACI 318-19 ¬ß19.3.2',prioridad:'Alta'});
            if (exposicion==='marine'||exposicion==='sulfate') recs.push({categoria:'Cemento',titulo:'Cemento resistente ‚Äî Tipo II/V o SCM',descripcion:'Exposici√≥n agresiva requiere Cemento Tipo II (moderado sulfato) o Tipo V (alta resistencia). Alternativa: GGBS 40-50% o ceniza volante Clase F 20-30%.',estandar:'ACI 318-19 / ASTM C150',prioridad:'Alta'});

            // Objective-specific
            if (objetivo==='strength') {
                recs.push({categoria:'Cemento',titulo:'Reducir W/C ‚Äî Ley de Abrams',descripcion:`W/C ${wcTarget.toFixed(3)} proyecta f'c‚âà${abramsFC(wcTarget).toLocaleString()} PSI vs original ‚âà${fc_est_orig.toLocaleString()} PSI. Usar reductor de agua Tipo F para mantener slump sin agua adicional.`,estandar:'ACI 211.1 / ASTM C494',prioridad:'Alta'});
                recs.push({categoria:'Proceso',titulo:'Curado intensivo para alta resistencia',descripcion:'Curado h√∫medo continuo 14 d√≠as m√≠nimo. Temperatura curado ‚â• 15¬∞C. Resistencia a 28 d√≠as puede incrementar 15-20% con curado adecuado vs curado est√°ndar.',estandar:'ACI 308R',prioridad:'Alta'});
            }
            if (objetivo==='cost') {
                recs.push({categoria:'Agregados',titulo:'Maximizar contenido de grueso ‚Äî ACI 211.1',descripcion:`Aumentar grueso de ${grossOrig.toFixed(0)} a ${grossOpt.toFixed(0)} lb/yd¬≥. Cada saco menos de cemento ‚âà $${(0.18*94).toFixed(0)} de ahorro/yd¬≥. CF objetivo ${st.cfMin}-${st.cfMax}.`,estandar:'ACI 211.1-91',prioridad:'Alta'});
                if (fcOverdesign > 500) recs.push({categoria:'Eficiencia',titulo:`Usar margen de sobredise√±o ‚Äî ${fcOverdesign.toLocaleString()} PSI de exceso`,descripcion:`f'c estimada original (${fc_est_orig.toLocaleString()} PSI) supera en ${fcOverdesign.toLocaleString()} PSI el dise√±o (${fc_design.toLocaleString()} PSI). Aumentar W/C a ${wcTarget.toFixed(3)} sin comprometer seguridad.`,estandar:'ACI 318-19',prioridad:'Media'});
            }
            if (objetivo==='workability') {
                if (colocacion==='pump') recs.push({categoria:'Proceso',titulo:'Requisitos de bombeo ‚Äî WF m√≠nimo 37',descripcion:`WF=${origWF.toFixed(1)} ${origWF<37?'‚Äî BAJO para bombeo.':' ‚Äî adecuado.'}  Para concreto bombeado: WF‚â•37, slump ‚â•4", cemento ‚â•564 lb/yd¬≥ (6 sacos), evitar gap-grading.`,estandar:'ACI 304.2R',prioridad:'Alta'});
                recs.push({categoria:'Aditivos',titulo:'Plastificante o Superplastificante',descripcion:'Para mayor trabajabilidad sin sacrificar W/C: usar plastificante ASTM C494 Tipo A (10-15% m√°s slump) o superplastificante Tipo F (slump flow >500mm) con menor relaci√≥n A/C.',estandar:'ASTM C494 Tipo A/F',prioridad:'Media'});
            }
            if (objetivo==='durability') {
                recs.push({categoria:'Durabilidad',titulo:'Baja W/C ‚Äî Permeabilidad reducida',descripcion:`W/C ${wcTarget.toFixed(3)} reduce permeabilidad al cloruro a <1000 coulombs (RCPT). Para exposici√≥n marina verificar cobertura m√≠nima de acero 2.5" y usar inhibidor de corrosi√≥n.`,estandar:'ASTM C1202 / ACI 201.2R',prioridad:'Alta'});
                recs.push({categoria:'Aditivos',titulo:'Micros√≠lice para densificaci√≥n',descripcion:'Adici√≥n de 5-8% micros√≠lice (s√≠lica fume) reduce permeabilidad 10x, aumenta resistencia 20% y protege contra √°lcali-s√≠lice. Cr√≠tico en exposici√≥n marina/sulfato.',estandar:'ASTM C1240 / ACI 234R',prioridad:'Alta'});
            }
            if (objetivo==='sustainability') {
                recs.push({categoria:'Sostenibilidad',titulo:'Reemplazo parcial de cemento ‚Äî SCM',descripcion:`Reducir cemento de ${(r.cemento.peso||500).toFixed(0)} a ${cementOpt.toFixed(0)} lb/yd¬≥. Reemplazar 20-25% con ceniza volante Clase F (ASTM C618) o 30-40% GGBS (ASTM C989). Reduce CO‚ÇÇ hasta 40%.`,estandar:'ACI 232.2R / ASTM C618',prioridad:'Alta'});
                recs.push({categoria:'Sostenibilidad',titulo:'Optimizar gradaci√≥n para m√≠nimo cemento',descripcion:'Gradaci√≥n bien dosificada (Zone II Shilstone) reduce demanda de pasta y por ende de cemento. Cada 1% de mejora en CF/WF puede reducir 0.3-0.5 sacos/yd¬≥.',estandar:'Shilstone JM (1990)',prioridad:'Media'});
            }

            // Universal recommendations
            if (origCF > 75) recs.push({categoria:'Gradaci√≥n',titulo:'CF > 75 ‚Äî Mezcla Rocky/Harsh',descripcion:`CF=${origCF.toFixed(1)}: exceso de material grueso. Aumentar % arena fina hasta CF ${st.cfMin}-${st.cfMax}. Riesgo de segregaci√≥n, acabado dif√≠cil y baja trabajabilidad en bomba.`,estandar:'Shilstone JM (1990)',prioridad:'Alta'});
            if (origCF < 55) recs.push({categoria:'Gradaci√≥n',titulo:'CF < 55 ‚Äî Over-Sanded',descripcion:`CF=${origCF.toFixed(1)}: exceso de arena. Mayor demanda de agua y cemento. Aumentar grueso para llevar CF a ${st.cfMin}-${st.cfMax}.`,estandar:'Shilstone JM (1990)',prioridad:'Media'});
            if (origWF > 44) recs.push({categoria:'Gradaci√≥n',titulo:'WF > 44 ‚Äî Exceso de finos',descripcion:`WF=${origWF.toFixed(1)}: mezcla mortar-rich. Riesgo de retracci√≥n pl√°stica y fisuras. Ajustar blend de arenas para WF ${st.wfMin}-${st.wfMax}.`,estandar:'ACI 211.1 / Shilstone',prioridad:'Media'});
            if (origWF < 32) recs.push({categoria:'Gradaci√≥n',titulo:'WF < 32 ‚Äî D√©ficit de finos',descripcion:`WF=${origWF.toFixed(1)}: posible gap-grading. Revisar continuidad de la curva de gradaci√≥n. Puede causar segregaci√≥n y baja densidad.`,estandar:'ASTM C33',prioridad:'Media'});
            recs.push({categoria:'Proceso',titulo:'Verificar con Trial Mix',descripcion:'Toda optimizaci√≥n de proporciones debe validarse con mezclas de prueba (trial mixes). Realizar ensayos de slump (ASTM C143), aire (ASTM C231) y cilindros a 7 y 28 d√≠as.',estandar:'ACI 301-16',prioridad:'Media'});

            // ---- Warnings ----
            const warns = [];
            if (wcTarget < wc_orig - 0.015) warns.push({nivel:'info',mensaje:`W/C reducida de ${wc_orig.toFixed(3)} ‚Üí ${wcTarget.toFixed(3)}. f'c estimada mejora de ${fc_est_orig.toLocaleString()} a ${fc_est_opt.toLocaleString()} PSI (Ley de Abrams). Verificar slump con ASTM C143.${slumpNote}`,estandar:'ACI 211.1 / Abrams'});
            if (wcTarget > wc_orig + 0.015) warns.push({nivel:'warning',mensaje:`W/C aumentada de ${wc_orig.toFixed(3)} ‚Üí ${wcTarget.toFixed(3)}. f'c estimada: ${fc_est_opt.toLocaleString()} PSI. Confirmar que cumple f'cr requerida con factor de seguridad ACI 318.`,estandar:'ACI 318-19 ¬ß26.4'});
            if (wc_orig > wcMax) warns.push({nivel:'error',mensaje:`‚ö†Ô∏è W/C original (${wc_orig.toFixed(3)}) excede m√°ximo ACI 318 de ${wcMax} para exposici√≥n ${exposicion}. Mezcla NO CUMPLE requisitos de durabilidad.`,estandar:'ACI 318-19 Tabla 19.3.2'});
            if (zoneOrig !== 'Zone II') warns.push({nivel:'warning',mensaje:`Mezcla original en ${zoneOrig} (CF=${origCF.toFixed(1)}, WF=${origWF.toFixed(1)}). Zona recomendada: II (CF 55-75, WF 32-44).`,estandar:'Shilstone JM (1990)'});
            if (zoneOpt === 'Zone II')  warns.push({nivel:'info',mensaje:`‚úÖ Optimizaci√≥n alcanza ${zoneOpt} (CF=${optCF.toFixed(1)}, WF=${optWF.toFixed(1)}) ‚Äî Mezcla bien graduada.`,estandar:'Shilstone JM (1990)'});
            if (fc_est_orig > fc_design * 1.35) warns.push({nivel:'info',mensaje:`f'c estimada original (${fc_est_orig.toLocaleString()} PSI) excede dise√±o en ${Math.round((fc_est_orig/fc_design-1)*100)}%. Existe margen para optimizar.`,estandar:'Ley de Abrams'});
            if (colocacion==='pump' && optWF < 36) warns.push({nivel:'warning',mensaje:`WF=${optWF.toFixed(1)} puede ser bajo para bombeo. Recomendado WF‚â•37. Considerar plastificante o ajuste de blend.`,estandar:'ACI 304.2R'});

            // ---- Combined 0.45 power ----
            const combOpt = aiGetCombinedPassing(gdOpt);
            const combined045Opt = [combOpt.no200,combOpt.no100,combOpt.no50,combOpt.no30,combOpt.no16,combOpt.no8,combOpt.no4,combOpt['0.375in'],combOpt['0.5in'],combOpt['0.75in'],combOpt['1in'],combOpt['1.5in'],combOpt['2in']];

            // ---- MF combinado ----
            const mfArena1 = parseFloat(mix.mfArena1) || 2.8;
            const mfArena2 = parseFloat(mix.mfArena2) || 3.2;
            const mfOrig   = mfArena1 * gd.pct1 + mfArena2 * gd.pct2;
            const mfOpt    = mfArena1 * pct1New + mfArena2 * pct2New;

            // ---- Diagnostics text ----
            const diagnostico = `La mezcla "${mix.nombre}" dise√±ada para ${fc_design.toLocaleString()} PSI tiene W/C=${wc_orig.toFixed(3)}, proyectando f'c‚âà${fc_est_orig.toLocaleString()} PSI por Ley de Abrams ‚Äî ${fcOverdesign>0?`sobredise√±o de ${fcOverdesign.toLocaleString()} PSI`:'revisar d√©ficit de resistencia'}. Con ${(r.sacosCemento||r.cemento.peso/94).toFixed(2)} sacos/yd¬≥ de ${tipoCemento} y blend Grueso:${(gd.pctG*100).toFixed(0)}% / Inter:${(gd.pctI*100).toFixed(0)}% / Arena1:${(gd.pct1*100).toFixed(0)}% / Arena2:${(gd.pct2*100).toFixed(0)}%, la mezcla se ubica en ${zoneOrig} del diagrama Shilstone (CF=${origCF.toFixed(1)}, WF=${origWF.toFixed(1)}).`;
            const logica_opt = strategy + ` Blend optimizado: Grueso ${(pGNew*100).toFixed(1)}% / Inter ${(pINew*100).toFixed(1)}% / Arena1 ${(pct1New*100).toFixed(1)}% / Arena2 ${(pct2New*100).toFixed(1)}%. Resultado: CF ${origCF.toFixed(1)}‚Üí${optCF.toFixed(1)}, WF ${origWF.toFixed(1)}‚Üí${optWF.toFixed(1)} (${zoneOrig}‚Üí${zoneOpt}).`;

            return {
                scores_original:  scoreOrig,
                scores_optimizado: scoreOpt,
                proporciones_optimizadas: {
                    cemento_lb:    parseFloat(cementOpt.toFixed(1)),
                    agua_lb:       parseFloat(waterOpt.toFixed(1)),
                    grueso_lb:     parseFloat(grossOpt.toFixed(1)),
                    intermedio_lb: parseFloat(interOpt.toFixed(1)),
                    arena1_lb:     parseFloat(arena1Opt.toFixed(1)),
                    arena2_lb:     parseFloat(arena2Opt.toFixed(1)),
                    pct_grueso:    parseFloat((pGNew*100).toFixed(1)),
                    pct_intermedio:parseFloat((pINew*100).toFixed(1)),
                    pct_arena1:    parseFloat((pct1New*100).toFixed(1)),
                    pct_arena2:    parseFloat((pct2New*100).toFixed(1)),
                    wc_ratio:      wcTarget,
                    aire_pct:      mix.contenidoAire || 2.0,
                    costo_estimado: parseFloat(costOptFinal.toFixed(2)),
                    cf_optimizado:  parseFloat(optCF.toFixed(1)),
                    wf_optimizado:  parseFloat(optWF.toFixed(1)),
                    combined_passing_045: combined045Opt,
                },
                parametros: {
                    wc_original: wc_orig, wc_optimizado: wcTarget,
                    slump_original: slump, slump_esperado: slumpOpt,
                    resistencia_original: fc_est_orig, resistencia_esperada: fc_est_opt,
                    cf_original: parseFloat(origCF.toFixed(1)), cf_optimizado: parseFloat(optCF.toFixed(1)),
                    wf_original: parseFloat(origWF.toFixed(1)), wf_optimizado: parseFloat(optWF.toFixed(1)),
                    sacos_original: parseFloat((r.sacosCemento||r.cemento.peso/94).toFixed(2)),
                    sacos_optimizado: parseFloat((cementOpt/94).toFixed(2)),
                    costo_original: r.costoTotal || parseFloat(costOrig.toFixed(2)),
                    costo_optimizado: parseFloat(costOptFinal.toFixed(2)),
                    mf_combinado_original: parseFloat(mfOrig.toFixed(2)),
                    mf_combinado_optimizado: parseFloat(mfOpt.toFixed(2)),
                },
                analisis: {
                    diagnostico,
                    problemas: (() => {
                        const p = [];
                        if (wc_orig > wcMax) p.push(`W/C ${wc_orig.toFixed(3)} excede l√≠mite ACI 318 (${wcMax}) para exposici√≥n ${exposicion}`);
                        if (zoneOrig !== 'Zone II') p.push(`Gradaci√≥n en ${zoneOrig} ‚Äî CF=${origCF.toFixed(1)}, WF=${origWF.toFixed(1)} fuera de Zone II`);
                        if (origCF > 75) p.push('Mezcla Rocky/Harsh ‚Äî riesgo de segregaci√≥n y acabado dif√≠cil');
                        if (origCF < 55) p.push('Mezcla Over-Sanded ‚Äî mayor demanda de agua y cemento');
                        if (origWF > 44) p.push('Exceso de finos ‚Äî riesgo de retracci√≥n pl√°stica');
                        if (origWF < 32) p.push('D√©ficit de finos ‚Äî posible gap-grading');
                        if (colocacion==='pump'&&origWF<36) p.push(`WF=${origWF.toFixed(1)} insuficiente para bombeo (m√≠n 36-37)`);
                        if (fc_est_orig < fc_design * 0.95) p.push(`f'c estimada (${fc_est_orig.toLocaleString()} PSI) por debajo del dise√±o (${fc_design.toLocaleString()} PSI)`);
                        return p;
                    })(),
                    logica_optimizacion: logica_opt,
                    beneficios: (() => {
                        const b = [];
                        if (Math.abs(wcTarget - wc_orig) > 0.01) {
                            if (wcTarget < wc_orig) b.push(`W/C reducida ${wc_orig.toFixed(3)}‚Üí${wcTarget.toFixed(3)}: f'c proyectada mejora de ${fc_est_orig.toLocaleString()} a ${fc_est_opt.toLocaleString()} PSI`);
                            else b.push(`W/C ajustada ${wc_orig.toFixed(3)}‚Üí${wcTarget.toFixed(3)}: optimizaci√≥n de costo con f'c=${fc_est_opt.toLocaleString()} PSI ‚Äî a√∫n cumple dise√±o`);
                        }
                        if (zoneOpt === 'Zone II') b.push('Mezcla alcanza Zone II Shilstone ‚Äî gradaci√≥n √≥ptima');
                        else if (zoneOrig !== zoneOpt) b.push(`Mezcla se mueve de ${zoneOrig} ‚Üí ${zoneOpt}`);
                        if (cementOpt < (r.cemento.peso||500) - 5) b.push(`Cemento reducido ${(r.cemento.peso||500).toFixed(0)}‚Üí${cementOpt.toFixed(0)} lb/yd¬≥ (${((1-cementOpt/(r.cemento.peso||500))*100).toFixed(1)}% menos)`);
                        if (cementOpt > (r.cemento.peso||500) + 5) b.push(`Cemento aumentado ${(r.cemento.peso||500).toFixed(0)}‚Üí${cementOpt.toFixed(0)} lb/yd¬≥ para mayor resistencia`);
                        const cDiff = costOptFinal - (r.costoTotal||0);
                        if (cDiff < -1) b.push(`Reducci√≥n de costo estimada: $${Math.abs(cDiff).toFixed(2)}/yd¬≥`);
                        b.push(`Blend arenas ${(pct1New*100).toFixed(0)}%/${(pct2New*100).toFixed(0)}% optimizado para gradaci√≥n continua (0.45 Power Chart)`);
                        return b;
                    })(),
                    zona_shilstone_original: zoneOrig,
                    zona_shilstone_optimizado: zoneOpt,
                    well_graded: zoneOpt === 'Zone II',
                    mf_recomendado: parseFloat(mfOpt.toFixed(2)),
                },
                recomendaciones: recs,
                advertencias: warns,
            };
        }

        // ---- Scores ‚Äî each dimension is objective-aware ----
        function calcLocalScores(cement, water, wc, cf, wf, fc_design, fc_est, costo, sacos, objetivo, exposicion) {
            const wcMaxE = {mild:0.60, moderate:0.55, severe:0.45, marine:0.40, sulfate:0.45};
            const wcLim  = wcMaxE[exposicion] || 0.55;

            // Resistance score: based on Abrams estimated strength vs design
            const fc_ratio = fc_est / fc_design;
            const resScore = fc_ratio >= 1.30 ? 95
                           : fc_ratio >= 1.15 ? 88
                           : fc_ratio >= 1.00 ? 78
                           : fc_ratio >= 0.90 ? 60 : 42;

            // Gradation ‚Äî proximity to Zone II
            const cfOk = cf >= 55 && cf <= 75;
            const wfOk = wf >= 32 && wf <= 44;
            const cfDist = cfOk ? 0 : Math.min(Math.abs(cf-55), Math.abs(cf-75));
            const wfDist = wfOk ? 0 : Math.min(Math.abs(wf-32), Math.abs(wf-44));
            const gradScore = cfOk && wfOk ? 92 : Math.max(25, 92 - cfDist*2 - wfDist*3);

            // Workability: WF proximity to 36-44
            const wfScore = wf >= 36 && wf <= 44 ? 93
                          : wf >= 32 && wf <= 48 ? 76
                          : wf >= 28 && wf <= 52 ? 58 : 38;

            // Durability: W/C vs exposure limit
            const durScore = wc <= wcLim - 0.05 ? 95
                           : wc <= wcLim ? 82
                           : wc <= wcLim + 0.05 ? 62 : 40;

            // Cement efficiency
            const cemEff = sacos <= 4.5 ? 95 : sacos <= 5.5 ? 85 : sacos <= 6.5 ? 72
                         : sacos <= 7.5 ? 58 : sacos <= 8.5 ? 44 : 30;

            // Cost: lower is better ‚Äî normalize to typical range $60-$140/yd¬≥
            const costNorm = costo <= 65 ? 95 : costo <= 80 ? 85 : costo <= 95 ? 72
                           : costo <= 115 ? 58 : costo <= 135 ? 44 : 30;

            // Objective-specific weights ‚Äî VERY different per objective
            const weightMap = {
                //                    res  trab  grad  dur  cemEff  cost
                balanced:          [0.18, 0.18, 0.20, 0.18, 0.13, 0.13],
                strength:          [0.40, 0.08, 0.18, 0.18, 0.08, 0.08],
                cost:              [0.08, 0.10, 0.15, 0.12, 0.25, 0.30],
                workability:       [0.10, 0.38, 0.22, 0.12, 0.10, 0.08],
                durability:        [0.18, 0.08, 0.18, 0.40, 0.10, 0.06],
                sustainability:    [0.12, 0.10, 0.18, 0.15, 0.30, 0.15],
                shilstone_zone2:   [0.10, 0.20, 0.50, 0.10, 0.05, 0.05],
            };
            const w = weightMap[objetivo] || weightMap.balanced;
            const scores = [resScore, wfScore, gradScore, durScore, cemEff, costNorm];
            const overall = Math.min(99, Math.round(scores.reduce((s,v,i) => s + v*w[i], 0)));

            return {
                overall,
                resistencia:        resScore,
                trabajabilidad:     wfScore,
                gradacion:          gradScore,
                eficiencia_cemento: cemEff,
                durabilidad:        durScore,
                costo:              costNorm,
            };
        }

        // ---- KEEP OLD API VERSION AVAILABLE (now calls local) ----
        async function ejecutarAIOptimizer() { ejecutarOptimizacionLocal(); }

        // ============================================================
        // END AI OPTIMIZER MODULE
        // ============================================================


        // ============ INICIALIZACI√ìN ============
        document.getElementById('mix-fecha').valueAsDate = new Date();
        document.getElementById('trial-fecha').valueAsDate = new Date();
        
        // Listener para recalcular fechas de rotura cuando cambia la fecha del trial
        document.getElementById('trial-fecha').addEventListener('change', function() {
            const numCilindros = parseInt(document.getElementById('trial-num-cilindros').value) || 0;
            for (let i = 1; i <= numCilindros; i++) {
                calcularFechaRotura(i);
            }
        });
        
        // Inicializar filtro de calendario con mes actual
        const hoy = new Date();
        const mesActual = hoy.toISOString().slice(0, 7);
        document.getElementById('filtro-mes-calendario').value = mesActual;
        
        // ============ AN√ÅLISIS DE DATA ============
        
        let analisisChart = null;
        let selectedAnalisisMixes = [];

        async function loadAnalisisData() {
            const trials = await getAllRecords('trials');
            const mixdesigns = await getAllRecords('mixdesigns');
            
            const analisisData = [];
            
            for (const trial of trials) {
                if (!trial.cilindros || trial.cilindros.length === 0) continue;
                
                const mixDesign = mixdesigns.find(m => m.id === trial.mixDesignId);
                const resistenciaObjetivo = mixDesign ? mixDesign.resistencia : 3000;
                
                trial.cilindros.forEach(cilindro => {
                    if (cilindro.resistencia && cilindro.resistencia > 0) {
                        analisisData.push({
                            trialId: trial.id,
                            trialName: trial.trialId || `Trial-${trial.id}`,
                            mixName: mixDesign ? mixDesign.nombre : 'N/A',
                            diasCurado: parseInt(cilindro.diasCurado) || 0,
                            resistencia: parseFloat(cilindro.resistencia),
                            resistenciaObjetivo: resistenciaObjetivo,
                            eficiencia: (parseFloat(cilindro.resistencia) / resistenciaObjetivo * 100).toFixed(1),
                            fechaRotura: cilindro.fechaRotura,
                            fechaColado: trial.fecha
                        });
                    }
                });
            }
            
            return analisisData;
        }

        async function updateAnalisisMixFilter() {
            const trials = await getAllRecords('trials');
            const mixdesigns = await getAllRecords('mixdesigns');
            const container = document.getElementById('analisis-mix-checkboxes');
            
            if (!container) return;
            
            container.innerHTML = '';
            
            trials.forEach(trial => {
                if (!trial.cilindros || trial.cilindros.length === 0) return;
                
                const mixDesign = mixdesigns.find(m => m.id === trial.mixDesignId);
                const isChecked = selectedAnalisisMixes.length === 0 || selectedAnalisisMixes.includes(trial.id);
                
                const label = document.createElement('label');
                label.style.cssText = 'display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 5px; border-radius: 4px;';
                label.innerHTML = `
                    <input type="checkbox" value="${trial.id}" ${isChecked ? 'checked' : ''} onchange="handleAnalisisMixFilterChange(this)">
                    <span>${trial.trialId || `Trial-${trial.id}`} - ${mixDesign ? mixDesign.nombre : 'N/A'}</span>
                `;
                
                label.onmouseover = () => label.style.background = '#f0f0f0';
                label.onmouseout = () => label.style.background = 'transparent';
                
                container.appendChild(label);
            });
            
            updateAnalisisMixFilterLabel();
        }

        function toggleAnalisisMixFilter() {
            const dropdown = document.getElementById('analisis-mix-dropdown');
            if (dropdown) dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }

        function handleAnalisisMixFilterChange(checkbox) {
            const value = checkbox.value;
            const allCheckbox = document.querySelector('#analisis-mix-dropdown input[value="all"]');
            
            if (value === 'all') {
                const checkboxes = document.querySelectorAll('#analisis-mix-checkboxes input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = checkbox.checked);
                selectedAnalisisMixes = checkbox.checked ? [] : ['none'];
            } else {
                if (checkbox.checked) {
                    if (selectedAnalisisMixes.includes('none')) selectedAnalisisMixes = [];
                    if (!selectedAnalisisMixes.includes(parseInt(value))) {
                        selectedAnalisisMixes.push(parseInt(value));
                    }
                } else {
                    selectedAnalisisMixes = selectedAnalisisMixes.filter(id => id !== parseInt(value));
                    if (allCheckbox) allCheckbox.checked = false;
                }
                
                const checkboxes = document.querySelectorAll('#analisis-mix-checkboxes input[type="checkbox"]');
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                if (allCheckbox) allCheckbox.checked = allChecked;
                
                if (selectedAnalisisMixes.length === 0) {
                    selectedAnalisisMixes = [];
                    if (allCheckbox) allCheckbox.checked = true;
                }
            }
            
            updateAnalisisMixFilterLabel();
        }

        function updateAnalisisMixFilterLabel() {
            const label = document.getElementById('analisis-filter-label');
            if (!label) return;
            
            const checkboxes = document.querySelectorAll('#analisis-mix-checkboxes input[type="checkbox"]:checked');
            const totalCheckboxes = document.querySelectorAll('#analisis-mix-checkboxes input[type="checkbox"]');
            
            if (selectedAnalisisMixes.length === 0 || checkboxes.length === totalCheckboxes.length) {
                label.textContent = 'Todas las mezclas';
            } else {
                label.textContent = `${checkboxes.length} mezcla(s) seleccionada(s)`;
            }
        }

        async function updateAnalisisCharts() {
            const allData = await loadAnalisisData();
            const viewType = document.getElementById('analisis-view-type').value;
            
            let filteredData = allData;
            if (selectedAnalisisMixes.length > 0 && !selectedAnalisisMixes.includes('none')) {
                filteredData = allData.filter(d => selectedAnalisisMixes.includes(d.trialId));
            }
            
            if (filteredData.length === 0) {
                alert('‚ö†Ô∏è No hay datos para mostrar. Aseg√∫rate de tener Trial Mixes con cilindros rotos.');
                return;
            }
            
            updateAnalisisStats(filteredData);
            
            if (viewType === 'evolution') {
                renderEvolutionChart(filteredData);
            } else if (viewType === 'efficiency') {
                renderEfficiencyChart(filteredData);
            } else if (viewType === 'comparison') {
                renderComparisonChart(filteredData);
            }
            
            renderAnalisisTable(filteredData);
        }

        function updateAnalisisStats(data) {
            const container = document.getElementById('analisis-stats');
            if (!container) return;
            
            const totalTests = data.length;
            const avgResistencia = data.reduce((sum, d) => sum + d.resistencia, 0) / totalTests;
            const avgEficiencia = data.reduce((sum, d) => sum + parseFloat(d.eficiencia), 0) / totalTests;
            const maxResistencia = Math.max(...data.map(d => d.resistencia));
            const uniqueTrials = [...new Set(data.map(d => d.trialId))].length;
            
            container.innerHTML = `
                <div style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #16a34a;">
                    <div style="font-size: 12px; color: #166534; font-weight: bold; margin-bottom: 5px;">üß™ TOTAL ENSAYOS</div>
                    <div style="font-size: 28px; font-weight: bold; color: #16a34a;">${totalTests}</div>
                </div>
                <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #0369a1;">
                    <div style="font-size: 12px; color: #075985; font-weight: bold; margin-bottom: 5px;">üìä TRIAL MIXES</div>
                    <div style="font-size: 28px; font-weight: bold; color: #0369a1;">${uniqueTrials}</div>
                </div>
                <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <div style="font-size: 12px; color: #92400e; font-weight: bold; margin-bottom: 5px;">üí™ PROMEDIO RESISTENCIA</div>
                    <div style="font-size: 28px; font-weight: bold; color: #f59e0b;">${avgResistencia.toFixed(0)} PSI</div>
                </div>
                <div style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #4f46e5;">
                    <div style="font-size: 12px; color: #3730a3; font-weight: bold; margin-bottom: 5px;">üìà EFICIENCIA PROMEDIO</div>
                    <div style="font-size: 28px; font-weight: bold; color: #4f46e5;">${avgEficiencia.toFixed(1)}%</div>
                </div>
                <div style="background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #ec4899;">
                    <div style="font-size: 12px; color: #9f1239; font-weight: bold; margin-bottom: 5px;">üèÜ M√ÅXIMA RESISTENCIA</div>
                    <div style="font-size: 28px; font-weight: bold; color: #ec4899;">${maxResistencia.toFixed(0)} PSI</div>
                </div>
            `;
        }

        function renderEvolutionChart(data) {
            const groupedData = {};
            
            data.forEach(d => {
                if (!groupedData[d.trialName]) groupedData[d.trialName] = {};
                if (!groupedData[d.trialName][d.diasCurado]) groupedData[d.trialName][d.diasCurado] = [];
                groupedData[d.trialName][d.diasCurado].push(d.resistencia);
            });
            
            const datasets = [];
            const colors = ['#16a34a', '#0369a1', '#f59e0b', '#ec4899', '#8b5cf6', '#14b8a6'];
            let colorIndex = 0;
            
            Object.keys(groupedData).forEach(trialName => {
                const points = [];
                Object.keys(groupedData[trialName]).sort((a, b) => a - b).forEach(dias => {
                    const resistencias = groupedData[trialName][dias];
                    const avg = resistencias.reduce((sum, r) => sum + r, 0) / resistencias.length;
                    points.push({ x: parseInt(dias), y: avg });
                });
                
                datasets.push({
                    label: trialName,
                    data: points,
                    borderColor: colors[colorIndex % colors.length],
                    backgroundColor: colors[colorIndex % colors.length] + '33',
                    tension: 0.4,
                    pointRadius: 6,
                    pointHoverRadius: 8
                });
                colorIndex++;
            });
            
            renderChart({
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Evoluci√≥n de Resistencia (PSI) vs D√≠as de Curado', font: { size: 16, weight: 'bold' } },
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        x: { type: 'linear', title: { display: true, text: 'D√≠as de Curado' }, ticks: { stepSize: 7 } },
                        y: { title: { display: true, text: 'Resistencia (PSI)' }, beginAtZero: true }
                    }
                }
            });
        }

        function renderEfficiencyChart(data) {
            const groupedData = {};
            
            data.forEach(d => {
                if (!groupedData[d.trialName]) groupedData[d.trialName] = {};
                if (!groupedData[d.trialName][d.diasCurado]) groupedData[d.trialName][d.diasCurado] = [];
                groupedData[d.trialName][d.diasCurado].push(parseFloat(d.eficiencia));
            });
            
            const datasets = [];
            const colors = ['#16a34a', '#0369a1', '#f59e0b', '#ec4899', '#8b5cf6', '#14b8a6'];
            let colorIndex = 0;
            
            Object.keys(groupedData).forEach(trialName => {
                const points = [];
                Object.keys(groupedData[trialName]).sort((a, b) => a - b).forEach(dias => {
                    const eficiencias = groupedData[trialName][dias];
                    const avg = eficiencias.reduce((sum, e) => sum + e, 0) / eficiencias.length;
                    points.push({ x: parseInt(dias), y: avg });
                });
                
                datasets.push({
                    label: trialName,
                    data: points,
                    borderColor: colors[colorIndex % colors.length],
                    backgroundColor: colors[colorIndex % colors.length] + '33',
                    tension: 0.4,
                    pointRadius: 6,
                    pointHoverRadius: 8
                });
                colorIndex++;
            });
            
            datasets.push({
                label: '100% f\'c',
                data: [{ x: 0, y: 100 }, { x: 28, y: 100 }],
                borderColor: '#dc2626',
                borderDash: [5, 5],
                pointRadius: 0,
                borderWidth: 2
            });
            
            renderChart({
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: '% de Resistencia Alcanzada (f\'c) vs D√≠as de Curado', font: { size: 16, weight: 'bold' } },
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        x: { type: 'linear', title: { display: true, text: 'D√≠as de Curado' }, ticks: { stepSize: 7 } },
                        y: { title: { display: true, text: '% de f\'c' }, beginAtZero: true }
                    }
                }
            });
        }

        function renderComparisonChart(data) {
            const groupedData = {};
            
            data.forEach(d => {
                if (!groupedData[d.trialName]) groupedData[d.trialName] = [];
                groupedData[d.trialName].push(d.resistencia);
            });
            
            const labels = Object.keys(groupedData);
            const avgData = labels.map(label => {
                const resistencias = groupedData[label];
                return resistencias.reduce((sum, r) => sum + r, 0) / resistencias.length;
            });
            
            renderChart({
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Resistencia Promedio (PSI)',
                        data: avgData,
                        backgroundColor: '#16a34a',
                        borderColor: '#15803d',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Comparaci√≥n de Resistencia Promedio entre Trial Mixes', font: { size: 16, weight: 'bold' } },
                        legend: { display: false }
                    },
                    scales: {
                        y: { title: { display: true, text: 'Resistencia Promedio (PSI)' }, beginAtZero: true }
                    }
                }
            });
        }

        function renderChart(config) {
            const canvas = document.getElementById('analisis-chart-main');
            if (!canvas) return;
            
            if (analisisChart) {
                analisisChart.destroy();
            }
            
            analisisChart = new Chart(canvas, config);
        }

        function renderAnalisisTable(data) {
            const container = document.getElementById('analisis-table-container');
            if (!container) return;
            
            const groupedByTrial = {};
            data.forEach(d => {
                if (!groupedByTrial[d.trialName]) groupedByTrial[d.trialName] = [];
                groupedByTrial[d.trialName].push(d);
            });
            
            let html = '';
            
            Object.keys(groupedByTrial).forEach(trialName => {
                const trialData = groupedByTrial[trialName];
                const avgResistencia = trialData.reduce((sum, d) => sum + d.resistencia, 0) / trialData.length;
                const avgEficiencia = trialData.reduce((sum, d) => sum + parseFloat(d.eficiencia), 0) / trialData.length;
                
                html += `
                    <h4 style="margin: 20px 0 10px 0; color: #16a34a;">${trialName} - Mix: ${trialData[0].mixName}</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>D√≠as Curado</th>
                                <th>Resistencia (PSI)</th>
                                <th>f'c Objetivo</th>
                                <th>% Eficiencia</th>
                                <th>Fecha Rotura</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                trialData.sort((a, b) => a.diasCurado - b.diasCurado).forEach(d => {
                    const colorEficiencia = parseFloat(d.eficiencia) >= 100 ? '#16a34a' : parseFloat(d.eficiencia) >= 80 ? '#f59e0b' : '#dc2626';
                    html += `
                        <tr>
                            <td style="text-align: center;"><strong>${d.diasCurado} d√≠as</strong></td>
                            <td style="text-align: center; font-weight: bold;">${d.resistencia.toFixed(0)} PSI</td>
                            <td style="text-align: center;">${d.resistenciaObjetivo} PSI</td>
                            <td style="text-align: center; color: ${colorEficiencia}; font-weight: bold;">${d.eficiencia}%</td>
                            <td style="text-align: center;">${d.fechaRotura || 'N/A'}</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                        <tfoot>
                            <tr style="background: #f0fdf4; font-weight: bold;">
                                <td>PROMEDIO</td>
                                <td style="text-align: center; color: #16a34a;">${avgResistencia.toFixed(0)} PSI</td>
                                <td></td>
                                <td style="text-align: center; color: #16a34a;">${avgEficiencia.toFixed(1)}%</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                `;
            });
            
            container.innerHTML = html || '<div class="empty-state">No hay datos para mostrar</div>';
        }

        async function exportarAnalisisPDF() {
            alert('üìÑ Exportando an√°lisis a PDF...\n\nPor ahora puedes usar Ctrl+P para imprimir esta secci√≥n.');
            window.print();
        }
        
        // ============ FIN AN√ÅLISIS DE DATA ============
        
        initDB().then(async () => {
            console.log('‚úÖ Base de datos inicializada');
            cargarLogoGuardado();
            cargarAplicaciones();
            updateDashboard();
            calcularVolumenes();
            cargarAditivosEnSelects();
            setTimeout(async function() {
                const mixId = await generarMixId();
                const elem = document.getElementById('mix-id-display');
                if (elem) elem.value = mixId;
            }, 500);
            
            // Generar Trial ID inicial
            const trialId = await generarTrialId();
            document.getElementById('trial-id-display').value = trialId;
            
            // Generar campos de cilindros inicial
            generarCamposCilindros();
            
            // Inicializar cotizaciones
            const cotNumero = await generarNumeroCotizacion();
            document.getElementById('cotizacion-numero').value = cotNumero;
            document.getElementById('cotizacion-fecha').valueAsDate = new Date();
            const validaHasta = new Date();
            validaHasta.setDate(validaHasta.getDate() + 30);
            document.getElementById('cotizacion-valida-hasta').valueAsDate = validaHasta;
            
        }).catch(error => {
            console.error('‚ùå Error:', error);
        });
    </script>

    
        <!-- ===== AI OPTIMIZER TAB ===== -->
        <div id="tab-ai-optimizer" class="tab-content">

            <!-- TOP CARD: Setup -->
            <div class="card">
                <h2>ü§ñ AI Mix Design Optimizer</h2>
                <div class="alert info">
                    <span>üß†</span>
                    <div>
                        <strong>Optimizaci√≥n Inteligente ‚Äî ACI 211.1 / ACI 318 / ASTM C33 / Shilstone Method</strong><br>
                        Selecciona un Mix Design, ingresa la gradaci√≥n de tus agregados y la IA analizar√°:
                        trabajabilidad vs coarseness, well-graded gradation (0.45 Power Chart), eficiencia de cemento,
                        durabilidad y mejores pr√°cticas de la industria. Obtendr√°s una comparativa completa Original vs Optimizado.
                    </div>
                </div>

                <div class="form-grid cols-2" style="margin-bottom:15px">
                    <div class="form-group">
                        <label>üìã Seleccionar Mix Design a Optimizar *</label>
                        <select id="ai-mixdesign-select" style="width:100%">
                            <option value="">‚Äî Selecciona un mix design guardado ‚Äî</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üéØ Objetivo de Optimizaci√≥n</label>
                        <select id="ai-objetivo">
                            <option value="balanced">‚öñÔ∏è Balanceado (Resistencia + Costo + Trabajabilidad)</option>
                            <option value="shilstone_zone2">üéØ Llevar Mezcla a Zone II ‚Äî Shilstone</option>
                            <option value="cost">üí∞ Minimizar Costo</option>
                            <option value="strength">üí™ Maximizar Resistencia</option>
                            <option value="workability">üåä Maximizar Trabajabilidad</option>
                            <option value="durability">üõ°Ô∏è Maximizar Durabilidad</option>
                            <option value="sustainability">üå± Sostenibilidad (Menor Contenido de Cemento)</option>
                        </select>
                    </div>
                </div>
                <div class="form-grid cols-3">
                    <div class="form-group">
                        <label>‚òÅÔ∏è Exposici√≥n Ambiental</label>
                        <select id="ai-exposicion">
                            <option value="mild">Mild ‚Äî Interior / Seco</option>
                            <option value="moderate">Moderate ‚Äî Humedad moderada</option>
                            <option value="severe">Severe ‚Äî Congelaci√≥n / Deshielo</option>
                            <option value="marine">Marine ‚Äî Ambiente marino / Cloruros</option>
                            <option value="sulfate">Sulfate ‚Äî Suelos / Agua sulfatada</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üèóÔ∏è Aplicaci√≥n Estructural</label>
                        <select id="ai-aplicacion-struct">
                            <option value="slab">Losa / Slab on Grade</option>
                            <option value="column">Columna / Column</option>
                            <option value="beam">Viga / Beam</option>
                            <option value="wall">Muro / Shear Wall</option>
                            <option value="foundation">Cimiento / Foundation</option>
                            <option value="pavement">Pavimento / Pavement</option>
                            <option value="precast">Prefabricado / Precast</option>
                            <option value="mass">Concreto Masivo / Mass Concrete</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üöß M√©todo de Colocaci√≥n</label>
                        <select id="ai-colocacion">
                            <option value="pump">Bomba / Pump</option>
                            <option value="bucket">Balde / Skip Bucket</option>
                            <option value="conveyor">Correa Transportadora</option>
                            <option value="direct">Descarga Directa / Direct Chute</option>
                            <option value="shotcrete">Shotcrete / Gunite</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- GRADATION CARD -->
            <div class="card">
                <h2>üìä Gradaci√≥n de Agregados ‚Äî Sieve Analysis</h2>
                <div class="alert info">
                    <span>‚ÑπÔ∏è</span>
                    <div>
                        Ingresa el <strong>% Pasando</strong> para cada tamiz (ASTM C136). 
                        Los l√≠mites ASTM C33 se grafican autom√°ticamente. 
                        Usa el bot√≥n <strong>Graficar</strong> para ver las curvas y el 0.45 Power Chart antes de optimizar.
                    </div>
                </div>

                <!-- Blend % inputs -->
                <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:14px 20px;margin-bottom:16px">
                    <div style="font-weight:700;color:#374151;margin-bottom:12px;font-size:14px">‚öñÔ∏è Proporciones de Blend (%) ‚Äî Suma debe ser 100%</div>
                    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;align-items:end">
                        <div>
                            <label style="font-size:12px;color:#1e40af;font-weight:700">ü™® Ag. Grueso %</label>
                            <input type="number" id="pct-grueso-ai" min="0" max="100" step="1" value="35"
                                style="width:100%;padding:8px;border:2px solid #93c5fd;border-radius:6px;font-size:14px;font-weight:700;text-align:center"
                                oninput="aiUpdateBlendPcts('grueso')">
                        </div>
                        <div>
                            <label style="font-size:12px;color:#7c3aed;font-weight:700">üü£ Ag. Intermedio %</label>
                            <input type="number" id="pct-intermedio-ai" min="0" max="100" step="1" value="15"
                                style="width:100%;padding:8px;border:2px solid #c4b5fd;border-radius:6px;font-size:14px;font-weight:700;text-align:center"
                                oninput="aiUpdateBlendPcts('intermedio')">
                        </div>
                        <div>
                            <label style="font-size:12px;color:#92400e;font-weight:700">üèñÔ∏è Arena 1 %</label>
                            <input type="number" id="pct-arena1-ai" min="0" max="100" step="1" value="30"
                                style="width:100%;padding:8px;border:2px solid #fcd34d;border-radius:6px;font-size:14px;font-weight:700;text-align:center"
                                oninput="aiUpdateBlendPcts('arena1')">
                        </div>
                        <div>
                            <label style="font-size:12px;color:#166534;font-weight:700">üèñÔ∏è Arena 2 %</label>
                            <input type="number" id="pct-arena2-ai" min="0" max="100" step="1" value="20"
                                style="width:100%;padding:8px;border:2px solid #86efac;border-radius:6px;font-size:14px;font-weight:700;text-align:center"
                                oninput="aiUpdateBlendPcts('arena2')">
                        </div>
                    </div>
                    <div id="blend-total-indicator" style="margin-top:10px;text-align:center;font-weight:700;font-size:13px;color:#16a34a">
                        ‚úÖ Total: 100%
                    </div>
                </div>

                <!-- Sieve tables ‚Äî 4 columns -->
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:16px;margin-bottom:20px">
                    <!-- COARSE -->
                    <div>
                        <div style="background:#dbeafe;padding:10px;border-radius:6px;margin-bottom:10px;font-weight:700;color:#1e40af;text-align:center">
                            ü™® Ag. Grueso<br><small style="font-weight:400;font-size:11px">ASTM C33 ‚Äî % Pasando</small>
                        </div>
                        <table class="grade-table" style="font-size:12px">
                            <thead><tr><th>Tamiz</th><th>% Pas.</th><th>Min</th><th>Max</th></tr></thead>
                            <tbody>
                                <tr><td>2"</td><td><input type="number" class="sieve-input" id="sg-2in" min="0" max="100" step="0.1" value="100"></td><td>100</td><td>100</td></tr>
                                <tr><td>1¬Ω"</td><td><input type="number" class="sieve-input" id="sg-1.5in" min="0" max="100" step="0.1" value="100"></td><td>90</td><td>100</td></tr>
                                <tr><td>1"</td><td><input type="number" class="sieve-input" id="sg-1in" min="0" max="100" step="0.1" value="85"></td><td>‚Äî</td><td>‚Äî</td></tr>
                                <tr><td>¬æ"</td><td><input type="number" class="sieve-input" id="sg-0.75in" min="0" max="100" step="0.1" value="60"></td><td>20</td><td>55</td></tr>
                                <tr><td>¬Ω"</td><td><input type="number" class="sieve-input" id="sg-0.5in" min="0" max="100" step="0.1" value="35"></td><td>‚Äî</td><td>‚Äî</td></tr>
                                <tr><td>‚Öú"</td><td><input type="number" class="sieve-input" id="sg-0.375in" min="0" max="100" step="0.1" value="15"></td><td>0</td><td>15</td></tr>
                                <tr><td>No.4</td><td><input type="number" class="sieve-input" id="sg-4" min="0" max="100" step="0.1" value="3"></td><td>0</td><td>5</td></tr>
                                <tr><td>No.8</td><td><input type="number" class="sieve-input" id="sg-8" min="0" max="100" step="0.1" value="0"></td><td>0</td><td>0</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- INTERMEDIATE -->
                    <div>
                        <div style="background:#ede9fe;padding:10px;border-radius:6px;margin-bottom:10px;font-weight:700;color:#5b21b6;text-align:center">
                            üü£ Ag. Intermedio<br><small style="font-weight:400;font-size:11px">ASTM C33 Size 8/89 ‚Äî % Pas.</small>
                        </div>
                        <table class="grade-table" style="font-size:12px">
                            <thead><tr><th>Tamiz</th><th>% Pas.</th><th>Min</th><th>Max</th></tr></thead>
                            <tbody>
                                <tr><td>2"</td><td><input type="number" class="sieve-input" id="si-2in" min="0" max="100" step="0.1" value="100"></td><td>100</td><td>100</td></tr>
                                <tr><td>1¬Ω"</td><td><input type="number" class="sieve-input" id="si-1.5in" min="0" max="100" step="0.1" value="100"></td><td>100</td><td>100</td></tr>
                                <tr><td>1"</td><td><input type="number" class="sieve-input" id="si-1in" min="0" max="100" step="0.1" value="100"></td><td>85</td><td>100</td></tr>
                                <tr><td>¬æ"</td><td><input type="number" class="sieve-input" id="si-0.75in" min="0" max="100" step="0.1" value="95"></td><td>‚Äî</td><td>‚Äî</td></tr>
                                <tr><td>¬Ω"</td><td><input type="number" class="sieve-input" id="si-0.5in" min="0" max="100" step="0.1" value="60"></td><td>10</td><td>55</td></tr>
                                <tr><td>‚Öú"</td><td><input type="number" class="sieve-input" id="si-0.375in" min="0" max="100" step="0.1" value="30"></td><td>0</td><td>30</td></tr>
                                <tr><td>No.4</td><td><input type="number" class="sieve-input" id="si-4" min="0" max="100" step="0.1" value="5"></td><td>0</td><td>10</td></tr>
                                <tr><td>No.8</td><td><input type="number" class="sieve-input" id="si-8" min="0" max="100" step="0.1" value="0"></td><td>0</td><td>5</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- FINE 1 -->
                    <div>
                        <div style="background:#fef3c7;padding:10px;border-radius:6px;margin-bottom:10px;font-weight:700;color:#92400e;text-align:center">
                            üèñÔ∏è Arena 1<br><small style="font-weight:400;font-size:11px">ASTM C33 ‚Äî % Pasando</small>
                        </div>
                        <table class="grade-table" style="font-size:12px">
                            <thead><tr><th>Tamiz</th><th>% Pas.</th><th>Min</th><th>Max</th></tr></thead>
                            <tbody>
                                <tr><td>‚Öú"</td><td><input type="number" class="sieve-input" id="sa1-0.375in" min="0" max="100" step="0.1" value="100"></td><td>100</td><td>100</td></tr>
                                <tr><td>No.4</td><td><input type="number" class="sieve-input" id="sa1-4" min="0" max="100" step="0.1" value="98"></td><td>95</td><td>100</td></tr>
                                <tr><td>No.8</td><td><input type="number" class="sieve-input" id="sa1-8" min="0" max="100" step="0.1" value="82"></td><td>80</td><td>100</td></tr>
                                <tr><td>No.16</td><td><input type="number" class="sieve-input" id="sa1-16" min="0" max="100" step="0.1" value="62"></td><td>50</td><td>85</td></tr>
                                <tr><td>No.30</td><td><input type="number" class="sieve-input" id="sa1-30" min="0" max="100" step="0.1" value="42"></td><td>25</td><td>60</td></tr>
                                <tr><td>No.50</td><td><input type="number" class="sieve-input" id="sa1-50" min="0" max="100" step="0.1" value="18"></td><td>10</td><td>30</td></tr>
                                <tr><td>No.100</td><td><input type="number" class="sieve-input" id="sa1-100" min="0" max="100" step="0.1" value="5"></td><td>2</td><td>10</td></tr>
                                <tr><td>No.200</td><td><input type="number" class="sieve-input" id="sa1-200" min="0" max="100" step="0.1" value="1.5"></td><td>0</td><td>3</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- FINE 2 -->
                    <div>
                        <div style="background:#dcfce7;padding:10px;border-radius:6px;margin-bottom:10px;font-weight:700;color:#166534;text-align:center">
                            üèñÔ∏è Arena 2<br><small style="font-weight:400;font-size:11px">ASTM C33 ‚Äî % Pasando</small>
                        </div>
                        <table class="grade-table" style="font-size:12px">
                            <thead><tr><th>Tamiz</th><th>% Pas.</th><th>Min</th><th>Max</th></tr></thead>
                            <tbody>
                                <tr><td>‚Öú"</td><td><input type="number" class="sieve-input" id="sa2-0.375in" min="0" max="100" step="0.1" value="100"></td><td>100</td><td>100</td></tr>
                                <tr><td>No.4</td><td><input type="number" class="sieve-input" id="sa2-4" min="0" max="100" step="0.1" value="100"></td><td>95</td><td>100</td></tr>
                                <tr><td>No.8</td><td><input type="number" class="sieve-input" id="sa2-8" min="0" max="100" step="0.1" value="96"></td><td>80</td><td>100</td></tr>
                                <tr><td>No.16</td><td><input type="number" class="sieve-input" id="sa2-16" min="0" max="100" step="0.1" value="78"></td><td>50</td><td>85</td></tr>
                                <tr><td>No.30</td><td><input type="number" class="sieve-input" id="sa2-30" min="0" max="100" step="0.1" value="55"></td><td>25</td><td>60</td></tr>
                                <tr><td>No.50</td><td><input type="number" class="sieve-input" id="sa2-50" min="0" max="100" step="0.1" value="28"></td><td>10</td><td>30</td></tr>
                                <tr><td>No.100</td><td><input type="number" class="sieve-input" id="sa2-100" min="0" max="100" step="0.1" value="8"></td><td>2</td><td>10</td></tr>
                                <tr><td>No.200</td><td><input type="number" class="sieve-input" id="sa2-200" min="0" max="100" step="0.1" value="2"></td><td>0</td><td>3</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Gradation Charts Row 1 -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
                    <div>
                        <h4 style="text-align:center;color:#1e40af;margin-bottom:8px">Curva Gradaci√≥n ‚Äî Ag. Grueso (ASTM C33)</h4>
                        <canvas id="chart-grad-grueso" width="500" height="280" style="width:100%;border:1px solid #e2e8f0;border-radius:8px;background:white"></canvas>
                    </div>
                    <div>
                        <h4 style="text-align:center;color:#92400e;margin-bottom:8px">Curva Gradaci√≥n ‚Äî Arenas Combinadas (ASTM C33)</h4>
                        <canvas id="chart-grad-arena" width="500" height="280" style="width:100%;border:1px solid #e2e8f0;border-radius:8px;background:white"></canvas>
                    </div>
                </div>

                <!-- 0.45 Power Chart -->
                <div style="margin-bottom:20px">
                    <h4 style="text-align:center;color:#6d28d9;margin-bottom:8px">0.45 Power Chart ‚Äî Combined Aggregate Gradation (ACI 211 / ASTM C29)</h4>
                    <canvas id="chart-045power" width="900" height="320" style="width:100%;border:1px solid #e2e8f0;border-radius:8px;background:white"></canvas>
                </div>

                <!-- LIVE Workability vs Coarseness Chart -->
                <div style="display:grid;grid-template-columns:2fr 1fr;gap:20px;margin-bottom:20px">
                    <div>
                        <h4 style="text-align:center;color:#7c3aed;margin-bottom:8px">
                            üìç Workability Factor vs Coarseness Factor ‚Äî M√©todo Shilstone (Tiempo Real)
                        </h4>
                        <canvas id="chart-wf-cf-live" width="600" height="340" style="width:100%;border:2px solid #c4b5fd;border-radius:8px;background:white"></canvas>
                    </div>
                    <div id="wf-cf-live-panel" style="background:#faf5ff;border:2px solid #c4b5fd;border-radius:10px;padding:20px;display:flex;flex-direction:column;justify-content:center">
                        <h4 style="color:#6d28d9;margin-bottom:14px;text-align:center">üìä Valores Actuales</h4>
                        <div id="wf-cf-live-vals" style="text-align:center">
                            <div style="margin-bottom:12px">
                                <div style="font-size:11px;color:#94a3b8;font-weight:600;text-transform:uppercase">Coarseness Factor</div>
                                <div id="live-cf-val" style="font-size:2.2em;font-weight:800;color:#7c3aed">‚Äî</div>
                                <div style="font-size:11px;color:#64748b">Objetivo: 55‚Äì75</div>
                            </div>
                            <div style="margin-bottom:12px">
                                <div style="font-size:11px;color:#94a3b8;font-weight:600;text-transform:uppercase">Workability Factor</div>
                                <div id="live-wf-val" style="font-size:2.2em;font-weight:800;color:#4f46e5">‚Äî</div>
                                <div style="font-size:11px;color:#64748b">Objetivo: 32‚Äì44</div>
                            </div>
                            <div id="live-zona-badge" style="margin-top:10px;padding:10px;border-radius:8px;background:#e0e7ff;color:#3730a3;font-weight:700;font-size:14px">
                                Ingresa gradaci√≥n para ver la zona
                            </div>
                            <div id="live-zona-desc" style="margin-top:8px;font-size:11px;color:#64748b;line-height:1.5"></div>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button type="button" onclick="aiGraficarGradacion()" class="info" style="padding:12px 24px">
                        üìä Graficar Gradaci√≥n y 0.45 Power Chart
                    </button>
                    <button type="button" id="btn-ai-run" onclick="ejecutarOptimizacionLocal()" 
                        style="background:linear-gradient(135deg,#7c3aed,#4f46e5);color:white;border:none;padding:14px 32px;border-radius:6px;font-size:16px;font-weight:600;cursor:pointer;transition:all 0.3s;box-shadow:0 4px 15px rgba(124,58,237,0.4)">
                        ‚ö° Ejecutar Optimizaci√≥n (Motor Local ACI/Shilstone)
                    </button>
                </div>
            </div>

            <!-- AI RESULTS CARD -->
            <div class="card" id="ai-results-card" style="display:none">
                <h2>‚ö° Resultados ‚Äî Optimizaci√≥n Local ACI / Shilstone</h2>

                <!-- Loading State -->
                <div id="ai-loading-state" style="display:none;text-align:center;padding:50px 20px">
                    <div class="ai-loading-spinner"></div>
                    <div style="margin-top:20px;font-size:1.1em;color:#6d28d9;font-weight:600">Calculando optimizaci√≥n...</div>
                    <div style="color:#64748b;margin-top:8px;font-size:14px">Analizando mezcla seg√∫n ACI 211.1, ACI 318, ASTM C33, M√©todo Shilstone</div>
                    <div style="margin-top:20px;background:#f1f5f9;border-radius:8px;padding:15px;text-align:left;max-width:480px;margin-left:auto;margin-right:auto">
                        <div style="font-size:11px;color:#64748b;font-family:monospace;line-height:1.8" id="ai-log"></div>
                    </div>
                </div>

                <!-- Results Content -->
                <div id="ai-results-content" style="display:none">

                    <!-- SCORES GRID -->
                    <h3>‚≠ê Scores de Calidad ‚Äî Original vs AI Optimizado</h3>
                    <div id="ai-scores-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:25px"></div>

                    <!-- MAIN COMPARISON TABLE -->
                    <h3>‚öñÔ∏è Comparativa de Proporciones (lb/yd¬≥)</h3>
                    <div style="overflow-x:auto">
                        <table>
                            <thead>
                                <tr>
                                    <th>Material</th>
                                    <th>Original (lb/yd¬≥)</th>
                                    <th>AI Optimizado (lb/yd¬≥)</th>
                                    <th>Œî Diferencia</th>
                                    <th>% Cambio</th>
                                    <th>Evaluaci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="ai-comparativa-tbody"></tbody>
                        </table>
                    </div>

                    <!-- PARAMETERS COMPARISON -->
                    <h3>üìê Par√°metros T√©cnicos Comparados</h3>
                    <div id="ai-params-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:15px;margin:15px 0"></div>

                    <!-- CHARTS ROW -->
                    <h3>üìä Gr√°ficos Comparativos</h3>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:15px 0">
                        <div>
                            <h4 style="text-align:center;margin-bottom:8px;color:#374151">Distribuci√≥n de Materiales ‚Äî Original vs Optimizado</h4>
                            <canvas id="chart-ai-materiales" width="500" height="280" style="width:100%;border:1px solid #e2e8f0;border-radius:8px;background:white"></canvas>
                        </div>
                        <div>
                            <h4 style="text-align:center;margin-bottom:8px;color:#374151">Radar de Scores de Calidad</h4>
                            <canvas id="chart-ai-radar" width="500" height="280" style="width:100%;border:1px solid #e2e8f0;border-radius:8px;background:white"></canvas>
                        </div>
                    </div>

                    <!-- 0.45 POWER CHART COMPARISON -->
                    <h4 style="text-align:center;color:#6d28d9;margin:15px 0 8px">0.45 Power Chart ‚Äî Original vs Optimizado</h4>
                    <canvas id="chart-045power-compare" width="900" height="320" style="width:100%;border:1px solid #e2e8f0;border-radius:8px;background:white;margin-bottom:20px"></canvas>

                    <!-- COARSENESS FACTOR CHART -->
                    <h3>üî≤ Coarseness Factor Chart ‚Äî M√©todo Shilstone</h3>
                    <div style="display:grid;grid-template-columns:2fr 1fr;gap:20px">
                        <canvas id="chart-coarseness" width="600" height="380" style="width:100%;border:1px solid #e2e8f0;border-radius:8px;background:white"></canvas>
                        <div id="ai-shilstone-info" style="background:#f8fafc;border-radius:8px;padding:20px"></div>
                    </div>

                    <!-- ANALYSIS -->
                    <h3>üß† An√°lisis T√©cnico Detallado</h3>
                    <div id="ai-analisis"></div>

                    <!-- RECOMMENDATIONS -->
                    <h3>‚úÖ Recomendaciones ‚Äî ACI / ASTM / Mejores Pr√°cticas</h3>
                    <div id="ai-recomendaciones"></div>

                    <!-- WARNINGS -->
                    <div id="ai-warnings"></div>

                    <!-- EXPORT BUTTON -->
                    <div class="button-group" style="margin-top:20px">
                        <button type="button" id="btn-export-ai" onclick="exportarReporteAI()" class="secondary" disabled>
                            üìÑ Exportar Reporte Completo (HTML)
                        </button>
                        <button type="button" onclick="aplicarPropuestasOptimizadas()" 
                            style="background:#7c3aed;color:white;border:none;padding:12px 24px;border-radius:6px;font-weight:600;cursor:pointer"
                            id="btn-apply-opt">
                            ‚ö° Crear Mix Design con Proporciones Optimizadas
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- ===== END AI OPTIMIZER TAB ===== -->

<!-- Modal para Nuevo Cliente R√°pido -->
    <div id="modal-cliente-rapido" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center">
        <div style="background:white;padding:30px;border-radius:12px;max-width:500px;width:90%;box-shadow:0 10px 40px rgba(0,0,0,0.3)">
            <h2 style="color:#16a34a;margin-bottom:20px">Nuevo Cliente</h2>
            <div class="form-group">
                <label>Nombre del Cliente *</label>
                <input type="text" id="nuevo-cliente-nombre" placeholder="Ej: Constructora ABC">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="nuevo-cliente-email" placeholder="contacto@empresa.com">
            </div>
            <div class="form-group">
                <label>Tel√©fono</label>
                <input type="tel" id="nuevo-cliente-telefono" placeholder="787-123-4567">
            </div>
            <div style="display:flex;gap:10px;margin-top:20px">
                <button class="btn success" onclick="guardarClienteRapido()">üíæ Guardar</button>
                <button class="btn secondary" onclick="cerrarModalCliente()">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <div id="modal-proyecto-rapido" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center">
        <div style="background:white;padding:30px;border-radius:12px;max-width:500px;width:90%;box-shadow:0 10px 40px rgba(0,0,0,0.3)">
            <h2 style="color:#16a34a;margin-bottom:20px">Nuevo Proyecto</h2>
            <div class="form-group">
                <label>Cliente *</label>
                <select id="nuevo-proyecto-cliente">
                    <option value="">Seleccionar cliente...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Nombre del Proyecto *</label>
                <input type="text" id="nuevo-proyecto-nombre" placeholder="Ej: Torre Residencial XYZ">
            </div>
            <div class="form-group">
                <label>Ubicaci√≥n</label>
                <input type="text" id="nuevo-proyecto-ubicacion" placeholder="Ej: San Juan, PR">
            </div>
            <div style="display:flex;gap:10px;margin-top:20px">
                <button class="btn success" onclick="guardarProyectoRapido()">üíæ Guardar</button>
                <button class="btn secondary" onclick="cerrarModalProyecto()">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <div id="qr-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center">
        <div style="background:white;padding:30px;border-radius:12px;max-width:400px;width:90%;box-shadow:0 10px 40px rgba(0,0,0,0.3);text-align:center">
            <h2 style="color:#16a34a;margin-bottom:20px">üì± QR Code - Trial Mix</h2>
            <div id="qr-code-container" style="display:flex;justify-content:center;margin:20px 0"></div>
            <p style="font-size:14px;color:#666;margin-bottom:20px">Escanea este c√≥digo para ver los detalles del trial mix</p>
            <button class="btn secondary" onclick="cerrarModalQR()">Cerrar</button>
        </div>
    </div>

</body>
</html>
